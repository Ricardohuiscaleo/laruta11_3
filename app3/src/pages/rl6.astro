---
const title = 'RL6 - Sistema de Cr√©ditos Militares';
const description = 'Cr√©dito exclusivo para militares del Regimiento Log√≠stico N¬∞6';
const usuario = (Astro.locals as any)?.user || null;

const GRADOS_MILITARES = [
  'SLTP', 'Cabo 2¬∞', 'Cabo 1¬∞', 'Cabo', 'Sargento 2¬∞', 'Sargento 1¬∞', 'Suboficial', 'Suboficial Mayor',
  'Subteniente', 'Teniente', 'Capit√°n', 'Mayor', 'Teniente Coronel', 'Coronel'
];
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="https://laruta11-images.s3.amazonaws.com/menu/logo.png" />
    <meta property="og:type" content="website" />
  </head>
  <body class="bg-white text-gray-900">
    <!-- HEADER -->
    <header class="fixed top-0 w-full bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 shadow-lg z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://laruta11-images.s3.amazonaws.com/menu/logo.png" alt="La Ruta 11" class="h-10 w-auto" />
          <img src="/rl6logo.png" alt="RL6" class="h-10 w-auto" />
        </div>
        <nav class="hidden md:flex gap-8 text-sm font-semibold">
          <a href="#beneficios" class="text-gray-300 hover:text-amber-400 transition duration-300">Beneficios</a>
          <a href="#registro" class="text-gray-300 hover:text-amber-400 transition duration-300">Registro</a>
          <a href="#contacto" class="text-gray-300 hover:text-amber-400 transition duration-300">Contacto</a>
        </nav>
        <button id="menuBtn" class="md:hidden text-gray-300 hover:text-amber-400">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
      <nav id="mobileMenu" class="hidden md:hidden bg-slate-800 border-t border-slate-700">
        <a href="#beneficios" class="block px-4 py-3 text-gray-300 hover:bg-slate-700 hover:text-amber-400 transition">Beneficios</a>
        <a href="#registro" class="block px-4 py-3 text-gray-300 hover:bg-slate-700 hover:text-amber-400 transition">Registro</a>
        <a href="#contacto" class="block px-4 py-3 text-gray-300 hover:bg-slate-700 hover:text-amber-400 transition">Contacto</a>
      </nav>
    </header>

    <!-- HERO SECTION -->
    <section class="pt-32 pb-20 px-4 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 relative overflow-hidden">
      <div class="absolute inset-0 opacity-10">
        <div class="absolute top-10 right-10 w-72 h-72 bg-amber-500 rounded-full blur-3xl"></div>
        <div class="absolute bottom-10 left-10 w-72 h-72 bg-blue-500 rounded-full blur-3xl"></div>
      </div>
      <div class="max-w-4xl mx-auto text-center relative z-10">
        <div class="mb-6 inline-block px-4 py-2 bg-amber-500/20 border border-amber-400/50 rounded-full">
          <span class="text-amber-300 font-semibold text-sm">üéñÔ∏è Sistema Exclusivo RL6</span>
        </div>
        <h1 class="text-5xl md:text-7xl font-black mb-6 text-white leading-tight">
          El l√°piz aguanta todo ‚úèÔ∏è
        </h1>
        <p class="text-xl md:text-2xl text-gray-300 mb-8 max-w-2xl mx-auto font-light">
          Cr√©dito exclusivo "RL6". Compra en La Ruta 11 y paga el 21.
        </p>
        <a href="#registro" class="inline-block px-8 py-4 bg-gradient-to-r from-amber-500 to-amber-600 text-white font-bold rounded-lg hover:shadow-2xl hover:shadow-amber-500/50 transition duration-300 transform hover:scale-105">
          Solicitar Cr√©dito Ahora ‚Üí
        </a>
      </div>
    </section>

    <!-- BENEFICIOS -->
    <section id="beneficios" class="py-20 px-4 bg-white">
      <div class="max-w-6xl mx-auto">
        <div class="text-center mb-16">
          <h2 class="text-4xl md:text-5xl font-black text-slate-900 mb-4">¬øPor qu√© RL6?</h2>
          <p class="text-gray-600 text-lg">Beneficios exclusivos dise√±ados para ti</p>
        </div>
        <div class="grid md:grid-cols-3 gap-8">
          <div class="p-8 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200 hover:shadow-xl transition duration-300 transform hover:-translate-y-2">
            <div class="text-5xl mb-4">‚ö°</div>
            <h3 class="text-xl font-bold mb-3 text-slate-900">Aprobaci√≥n R√°pida</h3>
            <p class="text-gray-700">Proceso simple y seguro. Validaci√≥n por nuestro equipo en m√°ximo 24 horas.</p>
          </div>
          <div class="p-8 bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl border border-amber-200 hover:shadow-xl transition duration-300 transform hover:-translate-y-2">
            <div class="text-5xl mb-4">üí≥</div>
            <h3 class="text-xl font-bold mb-3 text-slate-900">L√≠mite Inicial</h3>
            <p class="text-gray-700">Cr√©dito inicial desde $50.000, genera cashback en cada compra, aumento de cupo evaluado seg√∫n comportamiento de pago cada 3 meses.</p>
          </div>
          <div class="p-8 bg-gradient-to-br from-green-50 to-green-100 rounded-2xl border border-green-200 hover:shadow-xl transition duration-300 transform hover:-translate-y-2">
            <div class="text-5xl mb-4">üõçÔ∏è</div>
            <h3 class="text-xl font-bold mb-3 text-slate-900">√ösalo Inmediatamente</h3>
            <p class="text-gray-700">Una vez aprobado, usa tu cr√©dito en La Ruta 11 y comercios asociados.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- INSTRUCCIONES IMPORTANTES -->
    <section class="py-16 px-4 bg-gradient-to-br from-amber-50 to-orange-50">
      <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 border-2 border-amber-300">
          <div class="flex items-center gap-3 mb-6">
            <div class="text-4xl">‚ö†Ô∏è</div>
            <h2 class="text-3xl font-black text-slate-900">Instrucciones Importantes</h2>
          </div>
          <div class="space-y-6">
            <div class="flex gap-4">
              <div class="flex-shrink-0 w-8 h-8 bg-amber-500 text-white rounded-full flex items-center justify-center font-bold">1</div>
              <div>
                <h3 class="font-bold text-lg text-slate-900 mb-2">üë§ Debes tener cuenta en La Ruta 11</h3>
                <p class="text-gray-700">Antes de solicitar el cr√©dito RL6, debes estar registrado en nuestra app. Si a√∫n no tienes cuenta, reg√≠strate primero y luego vuelve a esta p√°gina.</p>
              </div>
            </div>
            <div class="flex gap-4">
              <div class="flex-shrink-0 w-8 h-8 bg-amber-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
              <div>
                <h3 class="font-bold text-lg text-slate-900 mb-2">üìù Completa el formulario con datos reales</h3>
                <p class="text-gray-700">Necesitamos tu RUT, grado militar, unidad de trabajo y fotos de tu carnet militar (frontal, trasero y selfie). Toda la informaci√≥n ser√° verificada manualmente.</p>
              </div>
            </div>
            <div class="flex gap-4">
              <div class="flex-shrink-0 w-8 h-8 bg-amber-500 text-white rounded-full flex items-center justify-center font-bold">3</div>
              <div>
                <h3 class="font-bold text-lg text-slate-900 mb-2">‚è≥ Espera la aprobaci√≥n (m√°x 24 horas)</h3>
                <p class="text-gray-700">Nuestro equipo revisar√° tu solicitud y te contactar√° para confirmar. Recibir√°s un email cuando tu cr√©dito sea aprobado.</p>
              </div>
            </div>
            <div class="flex gap-4 bg-red-50 p-4 rounded-lg border-2 border-red-200">
              <div class="flex-shrink-0 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center font-bold">4</div>
              <div>
                <h3 class="font-bold text-lg text-red-700 mb-2">üîÑ IMPORTANTE: Cierra sesi√≥n y vuelve a iniciar</h3>
                <p class="text-red-600 font-medium">Una vez aprobado tu cr√©dito, debes <strong>cerrar sesi√≥n</strong> en la app y <strong>volver a iniciar sesi√≥n</strong> para que se cargue tu cr√©dito disponible. Sin este paso, no podr√°s usar tu cr√©dito.</p>
              </div>
            </div>
            <div class="flex gap-4">
              <div class="flex-shrink-0 w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold">5</div>
              <div>
                <h3 class="font-bold text-lg text-slate-900 mb-2">üéâ ¬°Listo! Usa tu cr√©dito</h3>
                <p class="text-gray-700">Despu√©s de iniciar sesi√≥n nuevamente, ver√°s tu cr√©dito disponible en el checkout. Podr√°s seleccionar "Entrega en Cuartel" y "Pagar con Cr√©dito RL6".</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- REGISTRO SECTION -->
    <section id="registro" class="py-20 px-4 bg-gradient-to-br from-slate-50 to-slate-100">
      <div class="max-w-2xl mx-auto">
        <div class="text-center mb-12">
          <h2 class="text-4xl md:text-5xl font-black text-slate-900 mb-4">Solicitar Cr√©dito</h2>
          <p class="text-gray-600 text-lg">Completa el formulario en 4 pasos simples</p>
        </div>
        
        <div class="bg-white rounded-2xl shadow-2xl p-8 border border-gray-100">
          <!-- Barra de progreso -->
          <div class="mb-8">
            <div class="flex justify-between mb-2">
              <span class="text-sm font-bold text-gray-700"><span id="stepNum">1</span>/4</span>
              <span class="text-sm text-gray-600" id="stepTitle">Datos Personales</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div id="progressBar" class="bg-gradient-to-r from-amber-500 to-amber-600 h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
            </div>
          </div>

          <!-- PASO 0: Verificaci√≥n de sesi√≥n -->
          <div id="paso0" class="paso-form text-center">
            <div id="noLogueado" class="hidden">
              <div class="mb-6">
                <div class="text-6xl mb-4">üéñÔ∏è</div>
                <h3 class="text-2xl font-bold mb-4 text-slate-900">Primero reg√≠strate en La Ruta 11</h3>
                <p class="text-gray-600 mb-6">Para solicitar el cr√©dito RL6, necesitas tener una cuenta en nuestra app.</p>
              </div>
              <button id="btnAbrirLogin" class="px-8 py-4 bg-gradient-to-r from-amber-500 to-amber-600 text-white font-bold rounded-lg hover:shadow-lg transition duration-300 transform hover:scale-105">Registrarme / Iniciar Sesi√≥n</button>
              <p class="text-sm text-gray-500 mt-4">Luego podr√°s solicitar tu cr√©dito RL6</p>
            </div>
            <div id="siLogueado" class="hidden">
              <div class="mb-6">
                <div class="text-6xl mb-4">üëã</div>
                <h3 class="text-2xl font-bold mb-4 text-slate-900">Hola <span id="nombreUsuario"></span></h3>
                <p class="text-gray-600 mb-6">Ya est√°s registrado en La Ruta 11. Contin√∫a para solicitar tu cr√©dito RL6.</p>
              </div>
              <button type="button" id="btnContinuar" class="px-8 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-lg hover:shadow-lg transition duration-300 transform hover:scale-105">Continuar ‚Üí</button>
            </div>
          </div>

          <form id="formMultiPaso" enctype="multipart/form-data" class="space-y-4 hidden">
            <!-- PASO 1: Datos Personales -->
            <div id="paso1" class="paso-form">
              <h3 class="text-lg font-bold mb-4 text-slate-900">Datos Personales</h3>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                <input type="text" name="nombre" placeholder="Tu nombre completo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" name="email" placeholder="tu@email.com" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a *</label>
                <input type="password" name="password" placeholder="M√≠nimo 8 caracteres" required minlength="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label>
                <input type="tel" name="telefono" placeholder="+56 9 1234 5678" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" />
              </div>
            </div>

            <!-- PASO 2: Informaci√≥n Militar + Selfie -->
            <div id="paso2" class="paso-form hidden">
              <h3 class="text-lg font-bold mb-4 text-slate-900">Informaci√≥n Militar</h3>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">RUT *</label>
                <input type="text" id="inputRut" name="rut" placeholder="12.345.678-9" required maxlength="12" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent font-bold" />
                <p id="rutMessage" class="text-xs mt-1 hidden"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Grado Militar *</label>
                <select name="grado_militar" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                  <option value="">Selecciona tu grado</option>
                  {GRADOS_MILITARES.map(grado => <option value={grado}>{grado}</option>)}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Unidad de Trabajo *</label>
                <select id="selectUnidad" name="unidad_trabajo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                  <option value="">Selecciona tu unidad</option>
                  <option value="Compa√±√≠a Plana Mayor y Log√≠stica">Compa√±√≠a Plana Mayor y Log√≠stica</option>
                  <option value="S-1">S-1</option>
                  <option value="S-2">S-2</option>
                  <option value="S-3">S-3</option>
                  <option value="S-4">S-4</option>
                  <option value="Compa√±√≠a de Abastecimiento">Compa√±√≠a de Abastecimiento</option>
                  <option value="Compa√±√≠a de Mantenimiento">Compa√±√≠a de Mantenimiento</option>
                  <option value="Compa√±√≠a de Transporte">Compa√±√≠a de Transporte</option>
                  <option value="Compa√±√≠a de Sanidad y Veterinaria">Compa√±√≠a de Sanidad y Veterinaria</option>
                  <option value="Compa√±√≠a de Protecci√≥n">Compa√±√≠a de Protecci√≥n</option>
                  <option value="Compa√±√≠a Maestranza">Compa√±√≠a Maestranza</option>
                  <option value="Unidad de Cuartel">Unidad de Cuartel</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Selfie (Foto de tu cara) *</label>
                <input type="file" name="selfie" accept="image/*" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" />
                <p class="text-xs text-gray-500 mt-1">Foto clara de tu rostro (JPG, PNG)</p>
              </div>
            </div>

            <!-- PASO 3: Domicilio + Carnets -->
            <div id="paso3" class="paso-form hidden">
              <h3 class="text-lg font-bold mb-4 text-slate-900">Informaci√≥n Particular</h3>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n Completa *</label>
                <textarea name="domicilio_particular" placeholder="Calle, n√∫mero, ciudad, regi√≥n" required rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Carnet Frontal *</label>
                <input type="file" name="carnet_frontal" accept="image/*" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" />
                <p class="text-xs text-gray-500 mt-1">Foto clara del frente de tu carnet</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Carnet Posterior *</label>
                <input type="file" name="carnet_trasero" accept="image/*" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent" />
                <p class="text-xs text-gray-500 mt-1">Foto clara del reverso de tu carnet</p>
              </div>
            </div>

            <!-- PASO 4: Confirmaci√≥n -->
            <div id="paso4" class="paso-form hidden">
              <h3 class="text-lg font-bold mb-4 text-slate-900">Confirmaci√≥n</h3>
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-amber-900">Revisa tus datos antes de enviar. Nuestro equipo validar√° tu solicitud en m√°ximo 24 horas.</p>
              </div>
              <div id="resumenDatos" class="bg-gray-50 rounded-lg p-4 text-sm space-y-2 text-gray-700"></div>
            </div>

            <!-- Botones de navegaci√≥n -->
            <div class="flex gap-3 mt-6">
              <button type="button" id="btnAnterior" class="hidden flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition">Anterior</button>
              <button type="button" id="btnSiguiente" class="flex-1 bg-gradient-to-r from-amber-500 to-amber-600 hover:shadow-lg text-white font-bold py-2 rounded-lg transition duration-300 transform hover:scale-105">Siguiente</button>
              <button type="submit" id="btnEnviar" class="hidden flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:shadow-lg text-white font-bold py-2 rounded-lg transition duration-300 transform hover:scale-105">Enviar Solicitud</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer id="contacto" class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white py-16 px-4">
      <div class="max-w-6xl mx-auto">
        <div class="grid md:grid-cols-3 gap-12 mb-12">
          <div>
            <h4 class="font-black text-lg mb-4 text-amber-400">La Ruta 11</h4>
            <p class="text-gray-400 text-sm leading-relaxed">Cr√©dito exclusivo RL6.</p>
          </div>
          <div>
            <h4 class="font-black text-lg mb-4 text-amber-400">Enlaces R√°pidos</h4>
            <ul class="space-y-2 text-sm text-gray-400">
              <li><a href="#beneficios" class="hover:text-amber-400 transition duration-300">Beneficios</a></li>
              <li><a href="#registro" class="hover:text-amber-400 transition duration-300">Registro</a></li>
              <li><a href="/" class="hover:text-amber-400 transition duration-300">Volver a La Ruta 11</a></li>
            </ul>
          </div>
          <div>
            <h4 class="font-black text-lg mb-4 text-amber-400">Contacto</h4>
            <p class="text-gray-400 text-sm mb-4">Para consultas sobre tu solicitud, contacta a nuestro equipo.</p>
            <a href="https://wa.me/56936227422" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 bg-gradient-to-r from-green-500 to-green-600 hover:shadow-lg text-white px-4 py-2 rounded-lg text-sm font-bold transition duration-300 transform hover:scale-105">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
              </svg>
              WhatsApp
            </a>
          </div>
        </div>
        <div class="border-t border-slate-700 pt-8 text-center text-gray-500 text-sm">
          <p>&copy; 2026 La Ruta 11 ‚Ä¢ Sistema RL6 ‚Ä¢ Todos los derechos reservados</p>
        </div>
      </div>
    </footer>



    <script>
      var pasoActual = 0;
      var totalPasos = 3;
      var usuarioLogueado = null;

      // Verificar sesi√≥n al cargar
      try {
        var userData = localStorage.getItem('ruta11_user');
        if (userData) {
          usuarioLogueado = JSON.parse(userData);
        }
        
        // Verificar si viene de redirect despu√©s de login
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('login') === 'success') {
          // Limpiar URL
          window.history.replaceState({}, document.title, window.location.pathname);
          // Recargar datos del usuario
          var storedUser = localStorage.getItem('ruta11_user');
          if (storedUser) {
            usuarioLogueado = JSON.parse(storedUser);
          }
        }
      } catch (e) {
        console.error('Error al leer localStorage:', e);
      }

      // Mostrar pantalla seg√∫n estado de sesi√≥n
      var siLogueado = document.getElementById('siLogueado');
      var noLogueado = document.getElementById('noLogueado');
      var nombreUsuario = document.getElementById('nombreUsuario');
      
      if (usuarioLogueado && siLogueado && nombreUsuario) {
        siLogueado.classList.remove('hidden');
        var primerNombre = String(usuarioLogueado['nombre'] || '').split(' ')[0];
        nombreUsuario.textContent = primerNombre;
      } else if (noLogueado) {
        noLogueado.classList.remove('hidden');
      }
      var btnSiguiente = document.getElementById('btnSiguiente');
      var btnAnterior = document.getElementById('btnAnterior');
      var btnEnviar = document.getElementById('btnEnviar');
      var form = document.getElementById('formMultiPaso');

      function mostrarPaso(paso) {
        var pasos = document.querySelectorAll('.paso-form');
        for (var i = 0; i < pasos.length; i++) {
          pasos[i].classList.add('hidden');
        }
        var pasoEl = document.getElementById('paso' + paso);
        if (pasoEl) pasoEl.classList.remove('hidden');
        
        var stepNum = document.getElementById('stepNum');
        var progressBar = document.getElementById('progressBar');
        var stepTitle = document.getElementById('stepTitle');
        
        if (stepNum) stepNum.textContent = paso;
        if (progressBar) progressBar.style.width = (paso / totalPasos * 100) + '%';
        
        var titulos = ['Datos Personales', 'Informaci√≥n Militar', 'Domicilio y Carnets', 'Confirmaci√≥n'];
        if (stepTitle) stepTitle.textContent = titulos[paso - 1];
        
        if (btnAnterior) btnAnterior.classList.toggle('hidden', paso === 1);
        if (btnSiguiente) btnSiguiente.classList.toggle('hidden', paso === totalPasos);
        if (btnEnviar) btnEnviar.classList.toggle('hidden', paso !== totalPasos);

        if (paso === totalPasos) mostrarResumen();
      }

      function mostrarResumen() {
        var formEl = document.getElementById('formMultiPaso');
        if (!formEl) return;
        var resumenDatos = document.getElementById('resumenDatos');
        if (!resumenDatos) return;
        
        var html = '';
        var inputs = formEl.querySelectorAll('input, textarea, select');
        for (var i = 0; i < inputs.length; i++) {
          var el = inputs[i];
          var name = el.getAttribute('name');
          var val = '';
          if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
            val = el['value'] || '';
          }
          if (name && val && name.indexOf('selfie') === -1 && name.indexOf('carnet') === -1) {
            html += '<div><strong>' + name + ':</strong> ' + val + '</div>';
          }
        }
        resumenDatos.innerHTML = html;
      }

      var btnContinuar = document.getElementById('btnContinuar');
      if (btnContinuar) {
        btnContinuar.addEventListener('click', function() {
          var paso0 = document.getElementById('paso0');
          var formMultiPaso = document.getElementById('formMultiPaso');
          if (paso0) paso0.classList.add('hidden');
          if (formMultiPaso) formMultiPaso.classList.remove('hidden');
          
          // Pre-llenar datos del usuario logueado
          if (usuarioLogueado) {
            var inputNombre = document.querySelector('input[name="nombre"]');
            var inputEmail = document.querySelector('input[name="email"]');
            var inputPassword = document.querySelector('input[name="password"]');
            var inputTelefono = document.querySelector('input[name="telefono"]');
            
            if (inputNombre && inputNombre.tagName === 'INPUT') inputNombre['value'] = usuarioLogueado['nombre'] || '';
            if (inputEmail && inputEmail.tagName === 'INPUT') inputEmail['value'] = usuarioLogueado['email'] || '';
            if (inputTelefono && inputTelefono.tagName === 'INPUT') inputTelefono['value'] = usuarioLogueado['telefono'] || '';
            
            // Si es usuario Google, ocultar campo password y remover required
            if (usuarioLogueado['google_id'] && inputPassword) {
              inputPassword.removeAttribute('required');
              var passwordDiv = inputPassword.parentElement;
              if (passwordDiv) passwordDiv.style.display = 'none';
            }
          }
          
          // Agregar validaci√≥n en tiempo real a todos los inputs
          var allInputs = formMultiPaso.querySelectorAll('input[required], select[required], textarea[required]');
          for (var i = 0; i < allInputs.length; i++) {
            allInputs[i].addEventListener('input', function() {
              var errorId = 'error-' + (this.name || this.id);
              var existingError = document.getElementById(errorId);
              
              if (this.value && this.value.trim() !== '') {
                this.classList.remove('border-red-500', 'bg-red-50');
                this.classList.add('border-green-500');
                if (existingError) existingError.remove();
              } else {
                this.classList.remove('border-green-500');
                this.classList.add('border-gray-300');
              }
            });
          }
          
          pasoActual = 1;
          mostrarPaso(1);
        });
      }

      if (btnSiguiente) {
        btnSiguiente.addEventListener('click', function() {
          // Validar campos del paso actual antes de avanzar
          var pasoActualEl = document.getElementById('paso' + pasoActual);
          if (pasoActualEl) {
            var inputs = pasoActualEl.querySelectorAll('input[required], select[required], textarea[required]');
            var todosValidos = true;
            
            for (var i = 0; i < inputs.length; i++) {
              var input = inputs[i];
              var errorId = 'error-' + (input.name || input.id || i);
              var existingError = document.getElementById(errorId);
              
              // Remover error previo
              if (existingError) existingError.remove();
              
              // Validar
              if (!input.value || input.value.trim() === '') {
                todosValidos = false;
                input.classList.add('border-red-500', 'bg-red-50');
                input.classList.remove('border-gray-300');
                
                // Crear mensaje de error
                var errorMsg = document.createElement('p');
                errorMsg.id = errorId;
                errorMsg.className = 'text-red-600 text-xs mt-1 font-medium';
                errorMsg.innerHTML = '‚ö†Ô∏è Este campo es obligatorio';
                input.parentElement.appendChild(errorMsg);
                
                // Shake animation
                input.style.animation = 'shake 0.3s';
                setTimeout(function() { input.style.animation = ''; }, 300);
              } else {
                input.classList.remove('border-red-500', 'bg-red-50');
                input.classList.add('border-green-500');
              }
            }
            
            if (!todosValidos) {
              // Scroll al primer campo con error
              var primerError = pasoActualEl.querySelector('.border-red-500');
              if (primerError) primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
              return;
            }
          }
          
          if (pasoActual < totalPasos) {
            pasoActual++;
            mostrarPaso(pasoActual);
          }
        });
      }

      // Validar RUT en tiempo real
      var inputRut = document.getElementById('inputRut');
      var rutMessage = document.getElementById('rutMessage');
      var rutValido = false;
      
      if (inputRut) {
        // Formatear RUT mientras se escribe
        inputRut.addEventListener('input', function(e) {
          if (!e.target) return;
          var target = e.target as HTMLInputElement;
          var valor = target['value'].replace(/[^0-9kK]/g, '');
          var formateado = '';
          
          if (valor.length > 1) {
            var cuerpo = valor.slice(0, -1);
            var dv = valor.slice(-1).toUpperCase();
            
            // Agregar puntos cada 3 d√≠gitos
            cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            formateado = cuerpo + '-' + dv;
          } else {
            formateado = valor;
          }
          
          target['value'] = formateado;
        });
        
        inputRut.addEventListener('blur', async function() {
          if (!inputRut) return;
          var rut = inputRut['value'].replace(/[^0-9kK]/g, '');
          if (!rut || rut.length < 8) return;
          
          try {
            var formData = new FormData();
            formData.append('rut', rut);
            
            var response = await fetch('/api/rl6/check_rut.php', {
              method: 'POST',
              body: formData
            });
            
            var result = await response.json();
            
            if (result.exists) {
              rutValido = false;
              if (rutMessage) {
                rutMessage.classList.remove('hidden', 'text-green-600');
                rutMessage.classList.add('text-red-600');
                var statusMsg = result.status === 'aprobado' ? 'aprobada' : 
                               result.status === 'rechazado' ? 'rechazada' : 'en revisi√≥n';
                rutMessage.textContent = '‚ö†Ô∏è Este RUT ya est√° registrado (solicitud ' + statusMsg + '). Contacta a soporte: +56 9 3622 7422';
              }
              if (inputRut) {
                inputRut.classList.add('border-red-500');
                inputRut.classList.remove('border-gray-300');
              }
            } else {
              rutValido = true;
              if (rutMessage) {
                rutMessage.classList.remove('hidden', 'text-red-600');
                rutMessage.classList.add('text-green-600');
                rutMessage.textContent = '‚úì RUT ok.';
              }
              if (inputRut) {
                inputRut.classList.add('border-green-500');
                inputRut.classList.remove('border-gray-300', 'border-red-500');
              }
            }
          } catch (error) {
            console.error('Error validando RUT:', error);
          }
        });
      }

      if (btnAnterior) {
        btnAnterior.addEventListener('click', function() {
          if (pasoActual > 1) {
            pasoActual--;
            mostrarPaso(pasoActual);
          }
        });
      }

      var formEl = document.getElementById('formMultiPaso');
      if (formEl && formEl.tagName === 'FORM') {
        var formElement = formEl as HTMLFormElement;
        formElement.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          if (!usuarioLogueado || !usuarioLogueado['id']) {
            alert('Error: Usuario no identificado');
            return;
          }
          
          // Validar RUT antes de enviar
          if (!rutValido) {
            alert('‚ö†Ô∏è No puedes continuar. Este RUT ya est√° registrado en nuestro sistema.');
            return;
          }
          
          var btnEnviar = document.getElementById('btnEnviar');
          if (btnEnviar) {
            btnEnviar.setAttribute('disabled', 'true');
            btnEnviar.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
          }
          
          var formData = new FormData(formElement);
          formData.append('user_id', usuarioLogueado['id']);
          
          var unidadSelect = document.getElementById('selectUnidad');
          if (unidadSelect && unidadSelect['value']) {
            formData.set('unidad_trabajo', unidadSelect['value']);
          }
          
          try {
            var response = await fetch('/api/rl6/register_militar.php', {
              method: 'POST',
              body: formData
            });
            
            var result = await response.json();
            
            if (result.success) {
              alert('‚úÖ ' + result.message);
              
              // Actualizar localStorage con datos militares
              if (usuarioLogueado) {
                var updatedUser = Object.assign({}, usuarioLogueado, {
                  es_militar_rl6: 1,
                  rut: result.data?.rut || '',
                  grado_militar: result.data?.grado_militar || '',
                  credito_aprobado: 0
                });
                localStorage.setItem('ruta11_user', JSON.stringify(updatedUser));
              }
              
              window.location.href = '/';
            } else {
              // Verificar si hay bloqueo con cron√≥metro
              if (result.blocked_until && result.remaining_seconds) {
                mostrarCronometroBloqueo(result.remaining_seconds);
              } else {
                alert('‚ùå Error: ' + result.error);
              }
              if (btnEnviar) {
                btnEnviar.removeAttribute('disabled');
                btnEnviar.textContent = 'Enviar Solicitud';
              }
            }
          } catch (error) {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
            if (btnEnviar) {
              btnEnviar.removeAttribute('disabled');
              btnEnviar.textContent = 'Enviar Solicitud';
            }
          }
        });
      }

      var menuBtn = document.getElementById('menuBtn');
      var mobileMenu = document.getElementById('mobileMenu');
      if (menuBtn) {
        menuBtn.addEventListener('click', function() {
          if (mobileMenu) mobileMenu.classList.toggle('hidden');
        });
      }
      var links = document.querySelectorAll('#mobileMenu a');
      for (var i = 0; i < links.length; i++) {
        links[i].addEventListener('click', function() {
          if (mobileMenu) mobileMenu.classList.add('hidden');
        });
      }

      // Redirigir a p√°gina principal para login
      var btnAbrirLogin = document.getElementById('btnAbrirLogin');
      if (btnAbrirLogin) {
        btnAbrirLogin.addEventListener('click', function() {
          // Guardar que viene de RL6 para redirigir despu√©s
          localStorage.setItem('rl6_redirect', 'true');
          window.location.href = '/?login=required';
        });
      }

      // Funci√≥n para mostrar cron√≥metro de bloqueo
      function mostrarCronometroBloqueo(seconds) {
        var modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
        modal.innerHTML = `
          <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
            <div class="text-6xl mb-4">‚è±Ô∏è</div>
            <h3 class="text-2xl font-bold text-slate-900 mb-4">Demasiados Intentos</h3>
            <p class="text-gray-600 mb-6">Espera <span id="countdown" class="font-bold text-red-600"></span> para intentar nuevamente</p>
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
              <p class="text-sm text-amber-900 mb-2">üîë ¬øTienes un c√≥digo de desbloqueo?</p>
              <input type="text" id="unlockCode" placeholder="Ingresa el c√≥digo" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2" />
              <button id="btnUnlock" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg">Desbloquear</button>
            </div>
            <button id="btnCerrarModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cerrar</button>
          </div>
        `;
        document.body.appendChild(modal);
        
        var countdownEl = document.getElementById('countdown');
        var remaining = seconds;
        
        function updateCountdown() {
          var mins = Math.floor(remaining / 60);
          var secs = remaining % 60;
          countdownEl.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
          
          if (remaining <= 0) {
            document.body.removeChild(modal);
            return;
          }
          remaining--;
          setTimeout(updateCountdown, 1000);
        }
        updateCountdown();
        
        document.getElementById('btnCerrarModal').addEventListener('click', function() {
          document.body.removeChild(modal);
        });
        
        document.getElementById('btnUnlock').addEventListener('click', async function() {
          var code = document.getElementById('unlockCode').value;
          if (!code) {
            alert('‚ö†Ô∏è Ingresa un c√≥digo');
            return;
          }
          
          var formData = new FormData();
          formData.append('unlock_code', code);
          formData.append('user_id', usuarioLogueado['id']);
          
          try {
            var response = await fetch('/api/rl6/register_militar.php', {
              method: 'POST',
              body: formData
            });
            var result = await response.json();
            
            if (result.success || !result.blocked_until) {
              alert('‚úÖ Desbloqueado correctamente');
              document.body.removeChild(modal);
            } else {
              alert('‚ùå C√≥digo incorrecto');
            }
          } catch (error) {
            alert('‚ùå Error: ' + error.message);
          }
        });
      }


    </script>

    <style is:global>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        margin: 0;
        padding: 0;
      }
      html {
        scroll-behavior: smooth;
      }
      input, select, textarea {
        transition: all 0.3s ease;
      }
      input:focus, select:focus, textarea:focus {
        box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      section {
        animation: fadeIn 0.6s ease-out;
      }
    </style>
  </body>
</html>
