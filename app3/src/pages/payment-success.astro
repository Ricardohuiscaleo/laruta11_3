---
const orderRef = Astro.url.searchParams.get('order');
const amount = Astro.url.searchParams.get('amount');
---

<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>¬°Pago Exitoso! - La Ruta 11</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .bg-gradient-to-br { background: linear-gradient(to bottom right, #f0fdf4, #eff6ff); }
        .min-h-screen { min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .max-w-md { max-width: 28rem; }
        .text-center { text-align: center; }
        .mb-8 { margin-bottom: 2rem; }
        .w-16 { width: 4rem; }
        .h-16 { height: 4rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .font-bold { font-weight: 700; }
        .text-gray-800 { color: #1f2937; }
        .bg-white { background-color: #ffffff; }
        .rounded-2xl { border-radius: 1rem; }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .p-6 { padding: 1.5rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .w-20 { width: 5rem; }
        .h-20 { height: 5rem; }
        .bg-green-100 { background-color: #dcfce7; }
        .rounded-full { border-radius: 9999px; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .w-10 { width: 2.5rem; }
        .h-10 { height: 2.5rem; }
        .text-green-500 { color: #22c55e; }
        .mb-2 { margin-bottom: 0.5rem; }
        .text-gray-600 { color: #4b5563; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .justify-between { justify-content: space-between; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .border-b { border-bottom-width: 1px; }
        .border-gray-100 { border-color: #f3f4f6; }
        .font-semibold { font-weight: 600; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-green-600 { color: #16a34a; }
        .text-green-800 { color: #166534; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .font-medium { font-weight: 500; }
        .bg-orange-50 { background-color: #fff7ed; }
        .rounded-lg { border-radius: 0.5rem; }
        .p-4 { padding: 1rem; }
        .w-5 { width: 1.25rem; }
        .h-5 { height: 1.25rem; }
        .text-orange-500 { color: #f97316; }
        .mr-2 { margin-right: 0.5rem; }
        .text-orange-600 { color: #ea580c; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .block { display: block; }
        .w-full { width: 100%; }
        .bg-green-500 { background-color: #22c55e; }
        .hover\:bg-green-600:hover { background-color: #16a34a; }
        .text-white { color: #ffffff; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .hover\:bg-gray-200:hover { background-color: #e5e7eb; }
        .bg-orange-500 { background-color: #f97316; }
        .hover\:bg-orange-600:hover { background-color: #ea580c; }
        .mt-8 { margin-top: 2rem; }
        .text-gray-500 { color: #6b7280; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .pointer-events-none { pointer-events: none; }
        .z-10 { z-index: 10; }
        .absolute { position: absolute; }
        .w-2 { width: 0.5rem; }
        .h-2 { height: 0.5rem; }
        .relative { position: relative; }
        .overflow-hidden { overflow: hidden; }
        button { cursor: pointer; border: none; }
        button:hover { opacity: 0.9; }
        

    </style>
    <link rel="icon" type="image/png" href="https://laruta11-images.s3.amazonaws.com/menu/logo.png">
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">

    
    <div class="container mx-auto px-4 py-8 max-w-md">
        <div class="text-center mb-8">
            <img src="https://laruta11-images.s3.amazonaws.com/menu/logo.png" alt="La Ruta 11" class="w-16 h-16 mx-auto mb-4" onerror="this.style.display='none'">
            <h1 class="text-2xl font-bold text-gray-800">La Ruta 11</h1>
        </div>

        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 relative overflow-hidden">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Pago Exitoso!</h2>
                <p class="text-gray-600">Tu pedido ha sido confirmado</p>
            </div>

            <div class="space-y-4 mb-6">
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-gray-600">Pedido:</span>
                    <span class="font-semibold text-gray-800" id="order-number">Cargando...</span>
                </div>
                
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-gray-600">Total:</span>
                    <span class="font-bold text-green-600 text-lg" id="order-amount">Cargando...</span>
                </div>
                
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-gray-600">M√©todo:</span>
                    <span class="font-semibold text-gray-800">Webpay</span>
                </div>
                
                <div class="flex justify-between items-center py-2">
                    <span class="text-gray-600">Estado:</span>
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        ‚úì Confirmado
                    </span>
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">üõí Productos Comprados</h3>
                <div id="products-list" class="space-y-2">
                    <p class="text-gray-600 text-sm">Cargando productos...</p>
                </div>
            </div>

            <div id="delivery-info">
                <!-- Informaci√≥n de delivery se carga din√°micamente -->
            </div>
            
            <div class="bg-orange-50 rounded-lg p-4 mb-6">
                <div class="flex items-center mb-2">
                    <svg class="w-5 h-5 text-orange-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="font-semibold text-gray-800">Tiempo Estimado</h3>
                </div>
                <p class="text-orange-600 font-medium">25-35 minutos</p>
            </div>
        </div>

        <div class="space-y-3">
            <a 
                href="#"
                id="whatsapp-link"
                target="_blank"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl transition-colors flex items-center justify-center"
            >
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                </svg>
                Terminar Pedido (WhatsApp)
            </a>
        </div>

        <div class="text-center mt-8 text-gray-500 text-sm">
            <p>Gracias por elegir La Ruta 11!</p>
            <p>Recibir√°s notificaciones sobre el estado de tu pedido</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Obtener par√°metros de TUU
            const urlParams = new URLSearchParams(window.location.search);
            const orderRef = urlParams.get('x_reference') || urlParams.get('order');
            const amount = urlParams.get('x_amount') || urlParams.get('amount');
            const transactionId = urlParams.get('x_transaction_id');
            const timestamp = urlParams.get('x_timestamp');
            const message = urlParams.get('x_message') || 'Transaccion aprobada';
            const accountId = urlParams.get('x_account_id');
            const currency = urlParams.get('x_currency') || 'CLP';
            const signature = urlParams.get('x_signature');
            
            const orderNumberEl = document.getElementById('order-number');
            const orderAmountEl = document.getElementById('order-amount');
            
            if (orderNumberEl && orderRef) orderNumberEl.textContent = orderRef;
            if (orderAmountEl && amount) orderAmountEl.textContent = `$${parseInt(amount).toLocaleString('es-CL')}`;
            
            // Obtener productos y datos de delivery del pedido
            let orderProducts = [];
            let customerNotes = '';
            let deliveryInfo = {};
            if (orderRef) {
                try {
                    const productsResponse = await fetch(`https://app.laruta11.cl/api/tuu/get_order_products_with_extras.php?order=${orderRef}`);
                    const productsData = await productsResponse.json();
                    if (productsData.success) {
                        orderProducts = productsData.products;
                        customerNotes = productsData.customer_notes || '';
                        displayProducts(orderProducts);
                    }
                    
                    // Obtener datos de delivery
                    const deliveryResponse = await fetch(`https://app.laruta11.cl/api/tuu/get_order_delivery.php?order=${orderRef}`);
                    const deliveryData = await deliveryResponse.json();
                    if (deliveryData.success) {
                        deliveryInfo = deliveryData.delivery;
                        displayDeliveryInfo(deliveryInfo);
                    }
                } catch (error) {
                    console.log('Error obteniendo datos del pedido:', error);
                    // Fallback: mostrar mensaje si no se pueden cargar productos
                    const productsList = document.getElementById('products-list');
                    if (productsList) {
                        productsList.innerHTML = '<p class="text-gray-600 text-sm">No se pudieron cargar los productos</p>';
                    }
                }
            }
            
            // Registrar pago exitoso usando la API correcta de TUU
            if (orderRef) {
                try {
                    const response = await fetch('https://app.laruta11.cl/api/tuu/register_success.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            order: orderRef,
                            transaction_id: transactionId,
                            amount: amount,
                            timestamp: timestamp,
                            message: message,
                            account_id: accountId,
                            currency: currency,
                            signature: signature,
                            result: 'completed'
                        })
                    });
                    
                    const result = await response.json();
                    console.log('Pago registrado:', result);
                } catch (error) {
                    console.log('Error registrando pago:', error);
                }
            }
            
            // Actualizar enlace de WhatsApp con productos
            const whatsappLink = document.getElementById('whatsapp-link');
            if (whatsappLink && orderRef && amount) {
                let message = `*PEDIDO PAGADO - LA RUTA 11*\n\n*Pedido:* ${orderRef}\n*Estado:* Pago confirmado\n*Total:* $${parseInt(amount).toLocaleString('es-CL')}\n*M√©todo:* TUU/Webpay\n\n`;
                
                // Usar productos de la base de datos
                if (orderProducts.length > 0) {
                    message += `*PRODUCTOS:*\n`;
                    orderProducts.forEach((item, index) => {
                        message += `${index + 1}. ${item['product_name'] || item['name']} x${item['quantity']} - $${(item['price'] * item['quantity']).toLocaleString('es-CL')}\n`;
                        
                        // Agregar personalizaciones si existen
                        if (item['combo_data']) {
                            try {
                                const comboData = typeof item['combo_data'] === 'string' ? JSON.parse(item['combo_data']) : item['combo_data'];
                                
                                // Combos
                                if (comboData.fixed_items || comboData.selections) {
                                    const includeItems = [];
                                    
                                    if (comboData.fixed_items) {
                                        comboData.fixed_items.forEach(fixed => {
                                            includeItems.push(`${item['quantity']}x ${fixed.product_name || fixed.name}`);
                                        });
                                    }
                                    
                                    if (comboData.selections) {
                                        Object.values(comboData.selections).forEach(selection => {
                                            if (Array.isArray(selection)) {
                                                selection.forEach(sel => includeItems.push(`${item['quantity']}x ${sel.name}`));
                                            } else {
                                                includeItems.push(`${item['quantity']}x ${selection.name}`);
                                            }
                                        });
                                    }
                                    
                                    if (includeItems.length > 0) {
                                        message += `   Incluye: ${includeItems.join(', ')}\n`;
                                    }
                                }
                                
                                // Personalizaciones
                                if (comboData.customizations) {
                                    const customItems = comboData.customizations.map(custom => 
                                        `${custom.quantity}x ${custom.name}`
                                    );
                                    if (customItems.length > 0) {
                                        message += `   Incluye: ${customItems.join(', ')}\n`;
                                    }
                                }
                            } catch (e) {
                                console.error('Error parsing combo_data:', e);
                            }
                        }
                    });
                    message += `\n`;

                } else {
                    // Fallback al carrito local si no hay productos de BD
                    try {
                        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                        if (cart.length > 0) {
                            message += `*PRODUCTOS:*\n`;
                            cart.forEach((item, index) => {
                                message += `${index + 1}. ${item.name} x${item.quantity} - $${(item.price * item.quantity).toLocaleString('es-CL')}\n`;
                            });
                            message += `\n`;
                        }
                    } catch (e) {}
                }
                
                // Agregar informaci√≥n de delivery
                if (deliveryInfo && 'delivery_type' in deliveryInfo) {
                    message += `*TIPO DE ENTREGA:* ${deliveryInfo.delivery_type === 'delivery' ? 'üö¥ Delivery' : 'üè™ Retiro en local'}\n`;
                    
                    // Agregar hora programada si existe
                    if ('scheduled_time' in deliveryInfo && deliveryInfo.scheduled_time && 'is_scheduled' in deliveryInfo && deliveryInfo.is_scheduled) {
                        const scheduledDate = new Date(deliveryInfo.scheduled_time);
                        const options = { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
                        const formattedDate = scheduledDate.toLocaleDateString('es-CL', options);
                        message += `*‚è∞ PEDIDO PROGRAMADO:* ${formattedDate}\n`;
                    }
                    
                    if (deliveryInfo.delivery_type === 'delivery' && 'delivery_address' in deliveryInfo && deliveryInfo.delivery_address) {
                        message += `*DIRECCI√ìN:* ${deliveryInfo.delivery_address}\n`;
                    }
                    
                    if (deliveryInfo.delivery_type === 'pickup' && 'special_instructions' in deliveryInfo && deliveryInfo.special_instructions) {
                        message += `*HORARIO RETIRO:* ${deliveryInfo.special_instructions}\n`;
                    }
                    
                    if ('delivery_fee' in deliveryInfo && deliveryInfo.delivery_fee && Number(deliveryInfo.delivery_fee) > 0) {
                        message += `*COSTO DELIVERY:* $${parseInt(String(deliveryInfo.delivery_fee)).toLocaleString('es-CL')}\n`;
                    }
                    message += `\n`;
                }
                
                // Agregar notas del cliente si existen
                if (customerNotes && customerNotes.trim()) {
                    message += `*NOTAS DEL CLIENTE:*\n${customerNotes.trim()}\n\n`;
                }
                
                message += `Pedido realizado y pagado desde la app web.\nPor favor confirmar recepci√≥n y tiempo de entrega.`;
                (whatsappLink as HTMLAnchorElement).href = `https://wa.me/56936227422?text=${encodeURIComponent(message)}`;
            }
            
            // Limpiar carrito despu√©s del pago exitoso
            setTimeout(() => {
                localStorage.removeItem('cart');
                localStorage.removeItem('cartCount');
            }, 2000);
            
            function displayProducts(products) {
                const productsList = document.getElementById('products-list');
                if (!productsList || !products.length) return;
                
                productsList.innerHTML = products.map(item => {
                    let html = `
                        <div class="py-1">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-700">${item.product_name || item.name || 'Producto'} x${item.quantity || 1}</span>
                                <span class="font-semibold text-gray-800">$${((item.price || 0) * (item.quantity || 1)).toLocaleString('es-CL')}</span>
                            </div>`;
                    
                    // Agregar personalizaciones si existen
                    if (item.combo_data) {
                        try {
                            const comboData = typeof item.combo_data === 'string' ? JSON.parse(item.combo_data) : item.combo_data;
                            const includeItems = [];
                            
                            // Combos
                            if (comboData.fixed_items) {
                                comboData.fixed_items.forEach(fixed => {
                                    includeItems.push(`${item.quantity}x ${fixed.product_name || fixed.name}`);
                                });
                            }
                            
                            if (comboData.selections) {
                                Object.values(comboData.selections).forEach(selection => {
                                    if (Array.isArray(selection)) {
                                        selection.forEach(sel => includeItems.push(`${item.quantity}x ${sel.name}`));
                                    } else {
                                        includeItems.push(`${item.quantity}x ${selection.name}`);
                                    }
                                });
                            }
                            
                            // Personalizaciones
                            if (comboData.customizations) {
                                comboData.customizations.forEach(custom => {
                                    includeItems.push(`${custom.quantity}x ${custom.name}`);
                                });
                            }
                            
                            if (includeItems.length > 0) {
                                html += `<div class="text-xs text-gray-500 mt-1">Incluye: ${includeItems.join(', ')}</div>`;
                            }
                        } catch (e) {
                            console.error('Error parsing combo_data:', e);
                        }
                    }
                    
                    html += `</div>`;
                    return html;
                }).join('');
            }
            
            function displayDeliveryInfo(delivery) {
                const deliveryInfoEl = document.getElementById('delivery-info');
                if (!deliveryInfoEl || !delivery || !('delivery_type' in delivery)) return;
                
                let html = '';
                if (delivery.delivery_type === 'delivery') {
                    html = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-blue-600">üö¥</span>
                                <span class="font-semibold text-blue-800">Delivery a domicilio</span>
                            </div>
                            ${'delivery_address' in delivery && delivery.delivery_address ? `<p class="text-sm text-blue-700"><strong>Direcci√≥n:</strong> ${delivery.delivery_address}</p>` : ''}
                            ${'delivery_fee' in delivery && Number(delivery.delivery_fee) > 0 ? `<p class="text-sm text-blue-700"><strong>Costo delivery:</strong> $${parseInt(String(delivery.delivery_fee)).toLocaleString('es-CL')}</p>` : ''}
                        </div>
                    `;
                } else if (delivery.delivery_type === 'pickup') {
                    html = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-green-600">üè™</span>
                                <span class="font-semibold text-green-800">Retiro en local</span>
                            </div>
                            ${'special_instructions' in delivery && delivery.special_instructions ? `<p class="text-sm text-green-700"><strong>Horario:</strong> ${delivery.special_instructions}</p>` : ''}
                        </div>
                    `;
                }
                deliveryInfoEl.innerHTML = html;
            }
            

        });
    </script>
</body>
</html>