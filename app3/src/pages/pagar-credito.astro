---
const user_id = Astro.url.searchParams.get('user_id');
---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagar Cr√©dito RL6 - La Ruta 11</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); min-height: 100vh; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { text-align: center; margin-bottom: 24px; }
        .logo { width: 60px; height: 60px; margin: 0 auto 12px; }
        h1 { font-size: 24px; color: #111827; margin-bottom: 4px; }
        .subtitle { color: #6b7280; font-size: 14px; }
        .info-box { background: #f3f4f6; border-radius: 12px; padding: 16px; margin: 20px 0; }
        .info-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 14px; }
        .label { color: #6b7280; }
        .value { font-weight: 600; color: #111827; }
        .amount { font-size: 32px; font-weight: 800; color: #ea580c; text-align: center; margin: 20px 0; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #f97316 0%, #dc2626 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(249, 115, 22, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .alert { padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 14px; }
        .alert-info { background: #dbeafe; color: #1e40af; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .loading { text-align: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f4f6; border-top-color: #f97316; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .footer { text-align: center; color: #9ca3af; font-size: 12px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="color: #9ca3af; margin-top: 16px;">Cargando informaci√≥n...</p>
        </div>

        <div id="content" class="card" style="display: none;">
            <div class="header">
                <img src="https://laruta11-images.s3.amazonaws.com/menu/logo.png" alt="La Ruta 11" class="logo">
                <h1>Pagar Cr√©dito RL6</h1>
                <p class="subtitle">üéñÔ∏è Cr√©dito exclusivo militar</p>
            </div>

            <div class="info-box">
                <div class="info-row">
                    <span class="label">Nombre:</span>
                    <span class="value" id="userName"></span>
                </div>
                <div class="info-row">
                    <span class="label">Grado:</span>
                    <span class="value" id="userGrado"></span>
                </div>
                <div class="info-row">
                    <span class="label">Unidad:</span>
                    <span class="value" id="userUnidad"></span>
                </div>
            </div>

            <div class="amount" id="amount">$0</div>

            <div class="alert alert-info">
                ‚ÑπÔ∏è Ser√°s redirigido a Webpay para completar el pago de forma segura.
            </div>

            <button id="payBtn" class="btn btn-primary" onclick="procesarPago()">
                üí≥ Pagar con Webpay
            </button>

            <div class="footer">
                <p>üìç Yumbel 2629, Arica, Chile</p>
                <p>üìû +56 9 3622 7422</p>
            </div>
        </div>

        <div id="error" class="card" style="display: none;">
            <div class="alert alert-error" id="errorMsg"></div>
            <button class="btn btn-primary" onclick="window.location.reload()">Reintentar</button>
        </div>
    </div>

    <script define:vars={{ user_id }}>
        const userId = user_id || new URLSearchParams(window.location.search).get('user_id');
        
        if (!userId) {
            showError('ID de usuario no proporcionado');
        } else {
            loadCreditInfo();
        }

        async function loadCreditInfo() {
            try {
                const response = await fetch(`/api/rl6/get_credit.php?user_id=${userId}`);
                const data = await response.json();
                
                if (!data.success) {
                    showError(data.error || 'Error al cargar informaci√≥n');
                    return;
                }

                const credit = data.credit;
                
                if (credit.credito_usado <= 0) {
                    showError('No tienes saldo pendiente de pago');
                    return;
                }

                document.getElementById('userName').textContent = credit.nombre;
                document.getElementById('userGrado').textContent = credit.grado_militar;
                document.getElementById('userUnidad').textContent = credit.unidad_trabajo;
                document.getElementById('amount').textContent = '$' + parseInt(credit.credito_usado).toLocaleString('es-CL');

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                showError('Error de conexi√≥n');
            }
        }

        async function procesarPago() {
            const btn = document.getElementById('payBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Procesando...';

            try {
                const response = await fetch('/api/rl6/create_payment.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();

                if (data.success) {
                    window.location.href = data.payment_url;
                } else {
                    showError(data.error || 'Error al procesar pago');
                    btn.disabled = false;
                    btn.innerHTML = 'üí≥ Pagar con Webpay';
                }
            } catch (error) {
                showError('Error de conexi√≥n');
                btn.disabled = false;
                btn.innerHTML = 'üí≥ Pagar con Webpay';
            }
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('errorMsg').textContent = msg;
        }
    </script>
</body>
</html>
