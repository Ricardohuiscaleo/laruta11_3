---
export const prerender = false;
import Sidebar from '../../../components/Sidebar.astro';
---

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/icon.png">
    <title>Seguimiento QR - Jobs Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">

    <Sidebar currentPage="qr" pageTitle="Seguimiento QR" />

    <!-- Main Content -->
    <main class="lg:pl-64">
        <div class="px-4 py-8 lg:px-8">
            
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-2xl font-bold text-gray-900">Seguimiento QR - Link de Empleos</h1>
                <p class="mt-2 text-gray-600">Monitoreo de vistas y estadÃ­sticas del cÃ³digo QR</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Vistas Totales -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Vistas Totales</p>
                            <p id="total-views" class="text-3xl font-bold text-gray-900">66</p>
                        </div>
                    </div>
                </div>

                <!-- Vistas Hoy -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Vistas Hoy</p>
                            <p id="today-views" class="text-3xl font-bold text-gray-900">29</p>
                        </div>
                    </div>
                </div>

                <!-- Ãšltima Vista -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-lg">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Ãšltima Vista</p>
                            <p id="last-view" class="text-lg font-bold text-gray-900">31/07/2025 17:36</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QR Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Poster Preview -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Vista Previa del Poster</h3>
                    <div class="text-center">
                        <div class="inline-block p-4 bg-gray-50 rounded-lg border border-gray-300">
                            <img id="poster-preview" src="/api/tracker/generate_qr_poster.php" alt="Poster con QR" class="max-w-full h-64 object-contain rounded">
                        </div>
                        <p class="mt-3 text-sm text-gray-500">Poster listo para imprimir o compartir</p>
                        <p class="mt-1 text-xs text-gray-400">https://ruta11app.agenterag.com/jobs/</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Acciones</h3>
                    <div class="space-y-3">
                        <button id="download-poster" class="w-full bg-orange-600 text-white px-4 py-3 rounded-md hover:bg-orange-700 transition-colors font-medium">
                            ðŸ“„ Descargar Poster Completo
                        </button>
                        <button id="download-qr" class="w-full bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 transition-colors">
                            Descargar Solo QR (.PNG)
                        </button>
                        <button id="copy-link" class="w-full bg-gray-600 text-white px-4 py-3 rounded-md hover:bg-gray-700 transition-colors">
                            Copiar Link
                        </button>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="mt-8 bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Mapa de Ubicaciones</h3>
                <div id="qr-map" class="w-full h-96 rounded-lg border border-gray-300"></div>
            </div>
        </div>
    </main>

    <script>
        // Load QR stats
        async function loadQRStats() {
            try {
                const response = await fetch('/api/tracker/get_qr_stats.php');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-views').textContent = data.stats.total_views;
                    document.getElementById('today-views').textContent = data.stats.today_views;
                    document.getElementById('last-view').textContent = data.stats.last_view;
                }
            } catch (error) {
                console.error('Error loading QR stats:', error);
            }
        }

        // Initialize map
        window.initMap = function() {
            const mapElement = document.getElementById('qr-map');
            if (!mapElement) return;
            
            const map = new google.maps.Map(mapElement, {
                zoom: 10,
                center: { lat: -18.4746, lng: -70.3127 },
                mapTypeId: 'roadmap'
            });
            
            // Load locations
            fetch('/api/tracker/get_qr_locations.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.locations.length > 0) {
                        data.locations.forEach(location => {
                            new google.maps.Marker({
                                position: { lat: location.lat, lng: location.lng },
                                map: map,
                                title: `${location.views} vista${location.views > 1 ? 's' : ''}`,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: Math.max(10, location.views * 4),
                                    fillColor: '#f59e0b',
                                    fillOpacity: 0.8,
                                    strokeColor: '#d97706',
                                    strokeWeight: 2
                                }
                            });
                        });
                    }
                });
        };

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadQRStats);
    </script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAcK15oZ84Puu5Nc4wDQT_Wyht0xqkbO-A&callback=initMap"></script>
</body>
</html>