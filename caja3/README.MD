# La Ruta 11 - Sistema de GestiÃ³n de Restaurante

## ğŸš€ ConfiguraciÃ³n y EjecuciÃ³n del Proyecto

### Requisitos Previos
- Node.js (versiÃ³n 18 o superior)
- Visual Studio Code o editor preferido
- Servidor web con PHP y MySQL

### InstalaciÃ³n

1. **Clonar/Descargar el proyecto**
```bash
git clone [repositorio]
cd ruta11app
```

2. **Instalar dependencias**
```bash
npm install
```

3. **Configurar base de datos**
- Importar estructura de BD desde `api/setup_tables.php`
- Configurar credenciales en `api/config.php`

4. **Iniciar desarrollo**
```bash
npm run dev
```

5. **Acceder a la aplicaciÃ³n**
- Frontend: `http://localhost:4321`
- Admin: `http://localhost:4321/admin`
- Caja: `http://localhost:4321/caja`

# Sistema de Combos - Plan de ImplementaciÃ³n

## ğŸ“‹ Resumen del Requerimiento

Implementar un sistema completo de combos que permita:
- Gestionar combos como conjunto de productos (completo + papas + bebida)
- Seleccionar bebidas especÃ­ficas en el carrito (APP y CAJA)
- Descuento automÃ¡tico de inventario por ingredientes y productos
- CÃ¡lculo automÃ¡tico de costos basado en recetas e ingredientes

## ğŸ¯ Objetivos

### 1. **GestiÃ³n de Combos en Admin**
- Agregar productos a combos considerando solo su costo
- Especial atenciÃ³n a bebidas en combos
- Recetas de combos con ingredientes e insumos (excepto bebidas)

### 2. **Experiencia de Usuario (APP/CAJA)**
- SelecciÃ³n de bebidas especÃ­ficas para combos
- Descuento automÃ¡tico de inventario al comprar
- Vista de carrito mejorada para combos

### 3. **Control de Inventario**
- Descuento de ingredientes segÃºn receta del combo
- Descuento de productos especÃ­ficos (bebidas seleccionadas)
- Ajuste automÃ¡tico de stock de productos basado en ingredientes

## ğŸ—ï¸ Arquitectura del Sistema

### **Base de Datos**

#### Nuevas Tablas Necesarias:
```sql
-- Tabla principal de combos
CREATE TABLE combos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    image_url VARCHAR(500),
    category_id INT DEFAULT 8,
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

-- Productos que componen cada combo
CREATE TABLE combo_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    combo_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT DEFAULT 1,
    is_selectable TINYINT(1) DEFAULT 0,
    selection_group VARCHAR(50),
    FOREIGN KEY (combo_id) REFERENCES combos(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES productos(id)
);

-- Opciones seleccionables para grupos (ej: bebidas)
CREATE TABLE combo_selections (
    id INT AUTO_INCREMENT PRIMARY KEY,
    combo_id INT NOT NULL,
    selection_group VARCHAR(50) NOT NULL,
    product_id INT NOT NULL,
    additional_price DECIMAL(10,2) DEFAULT 0,
    FOREIGN KEY (combo_id) REFERENCES combos(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES productos(id)
);
```

## ğŸ“ Plan de ImplementaciÃ³n

### **Fase 1: Backend - GestiÃ³n de Combos**

#### 1.1 APIs para Combos
- `api/setup_combo_tables.php` - Configurar tablas
- `api/get_combos.php` - Obtener combos con productos
- `api/save_combo.php` - Crear/editar combos
- `api/delete_combo.php` - Eliminar combos
- ModificaciÃ³n en `api/process_sale_inventory.php` - Manejo de inventario

#### 1.2 Modificar Editor de Productos
- Detectar si `category_id = 8` (Combos)
- Mostrar secciÃ³n "GestiÃ³n de Combo" 
- Permitir agregar productos con costo especÃ­fico
- Marcar bebidas como seleccionables

### **Fase 2: Frontend Admin - Editor de Combos**

#### 2.1 Interfaz de GestiÃ³n
- `src/pages/admin/combos.astro` - GestiÃ³n de combos (admin)
- Lista de productos actuales
- BotÃ³n "Agregar Producto"
- Checkbox "Es seleccionable" para bebidas
- Campo costo especÃ­fico

#### 2.2 Modal de SelecciÃ³n de Productos
- Lista de todos los productos disponibles
- Filtro por categorÃ­a (especial para bebidas)
- Campo para cantidad y costo especÃ­fico
- Checkbox para marcar como seleccionable

### **Fase 3: Frontend Usuario - Carrito de Combos**

#### 3.1 DetecciÃ³n de Combos en APP/CAJA
- ModificaciÃ³n en `src/pages/caja/index.astro` - Selector de combos
- ModificaciÃ³n en `src/pages/index.astro` - IntegraciÃ³n en app principal
- Modal de personalizaciÃ³n
- Productos fijos del combo
- SelecciÃ³n de bebidas disponibles
- ConfirmaciÃ³n de selecciÃ³n

#### 3.2 Vista de Carrito Mejorada
- Mostrar combo como item principal
- Listar productos incluidos
- Destacar selecciones personalizables
- Precio total del combo

### **Fase 4: Sistema de Inventario**

#### 4.1 Descuento al Procesar Venta
- Descontar ingredientes segÃºn receta del combo
- Descontar productos seleccionados (bebidas)
- IntegraciÃ³n completa con `process_sale_inventory.php`

#### 4.2 CÃ¡lculo de Stock Disponible
- Considerar ingredientes disponibles para combos
- Considerar productos seleccionables disponibles
- Mostrar stock real del combo

## ğŸ”§ Archivos a Modificar/Crear

### **Nuevos Archivos**
1. `api/setup_combo_tables.php`
2. `api/get_combos.php`
3. `api/save_combo.php`
4. `api/delete_combo.php`
5. `src/pages/admin/combos.astro`

### **Archivos a Modificar**
1. `src/pages/admin/edit-product.astro` - Agregar gestiÃ³n de combos
2. `src/pages/caja/index.astro` - Integrar selector de combos
3. `src/pages/index.astro` - Integrar selector de combos en APP
4. `api/process_sale_inventory.php` - Manejar inventario de combos
5. `api/get_productos.php` - Incluir informaciÃ³n de combos

## ğŸ“Š Flujo de Datos

### **CreaciÃ³n de Combo (Admin)**
1. Usuario selecciona categorÃ­a "Combos"
2. Sistema detecta `is_combo = true`
3. Muestra interfaz de gestiÃ³n de combo
4. Admin agrega productos con costos especÃ­ficos
5. Marca bebidas como seleccionables
6. Sistema calcula costo total del combo

### **Compra de Combo (Usuario)**
1. Usuario selecciona combo en APP/CAJA
2. Sistema muestra productos incluidos
3. Usuario selecciona bebida especÃ­fica
4. Se agrega al carrito con selecciones
5. Al pagar, se descuenta inventario:
   - Ingredientes segÃºn receta del combo
   - Productos seleccionados especÃ­ficos

### **Control de Stock**
1. Stock de combo = MIN(stock_ingredientes, stock_productos_seleccionables)
2. Al vender combo:
   - Descontar ingredientes de receta
   - Descontar productos seleccionados
   - Recalcular stock disponible

## âš¡ ImplementaciÃ³n Prioritaria

### **Sprint 1 (Backend)**
- [ ] Crear tablas de base de datos
- [ ] APIs bÃ¡sicas de gestiÃ³n de combos
- [ ] Modificar process_sale_inventory.php

### **Sprint 2 (Admin)**
- [ ] Modificar edit-product.astro
- [ ] Crear interfaz de gestiÃ³n de combos
- [ ] Sistema de cÃ¡lculo de costos

### **Sprint 3 (Frontend Usuario)**
- [ ] Integrar selector en CAJA
- [ ] Integrar selector en APP
- [ ] Vista de carrito mejorada

### **Sprint 4 (Testing & OptimizaciÃ³n)**
- [ ] Pruebas de inventario
- [ ] OptimizaciÃ³n de performance
- [ ] DocumentaciÃ³n final

## ğŸ¯ Casos de Uso Ejemplo

### **Combo Completo Tradicional**
- **Productos**: Completo Tradicional + Papas Medianas + Bebida (seleccionable)
- **Receta**: Ingredientes del completo + ingredientes de papas
- **SelecciÃ³n**: Usuario elige entre Coca-Cola, Sprite, Fanta
- **Inventario**: Descuenta ingredientes + bebida especÃ­fica seleccionada

### **Combo Hamburguesa Especial**
- **Productos**: Hamburguesa + Papas + Bebida + Salsa (seleccionable)
- **Receta**: Ingredientes de hamburguesa + papas
- **SelecciÃ³n**: Usuario elige bebida y tipo de salsa
- **Inventario**: Descuenta segÃºn receta + productos seleccionados

## ğŸ“ˆ Beneficios Esperados

1. **GestiÃ³n Simplificada**: Admin puede crear combos fÃ¡cilmente
2. **Experiencia Mejorada**: Usuarios pueden personalizar combos
3. **Control Preciso**: Inventario se maneja automÃ¡ticamente
4. **Costos Exactos**: CÃ¡lculo automÃ¡tico basado en ingredientes reales
5. **Escalabilidad**: Sistema flexible para nuevos tipos de combos

---

**Nota**: Este plan se implementarÃ¡ de forma incremental, asegurando que cada fase funcione correctamente antes de proceder a la siguiente.

## Deployment en Hostinger (PWA)

### Preparar para ProducciÃ³n

1. Construye el proyecto:
```bash
npm run build
```

2. Sube la carpeta `dist` completa a tu hosting Hostinger via FTP/cPanel

3. Configura tu dominio para apuntar a la carpeta donde subiste los archivos

### Backend PHP/MySQL

1. Crea una carpeta `api` en tu hosting
2. Configura la conexiÃ³n a MySQL en tus archivos PHP
3. Actualiza la URL en `components/api.js` con tu dominio real

### CaracterÃ­sticas PWA Incluidas

- âœ… Optimizado para mÃ³viles
- âœ… Carga rÃ¡pida
- âœ… Funciona offline (bÃ¡sico)
- âœ… Instalable como app
- âœ… Responsive design
- âœ… Sistema de Control de Calidad integrado
- âœ… GestiÃ³n de sesiones persistentes con cookies
- âœ… Analytics avanzado con tracking de usuarios

### Cache Busting

El sistema implementa tÃ©cnicas de "Cache Busting" para garantizar que los datos mostrados siempre estÃ©n actualizados en tiempo real:

- âœ… **Timestamps Ãºnicos** en todas las llamadas API
- âœ… **Headers anti-cachÃ©** en respuestas del servidor
- âœ… **BotÃ³n refresh** que limpia cachÃ© completo
- âœ… **ParÃ¡metros dinÃ¡micos** para evitar cachÃ© del navegador
- âœ… **Versionado automÃ¡tico** de assets estÃ¡ticos

## Estructura Actual del Proyecto

### Frontend (React/Astro)
- AplicaciÃ³n de menÃº con tarjetas de productos
- Loader inicial con logo
- Carrito de compras funcional
- Modales para detalles de productos
- NavegaciÃ³n por categorÃ­as
- ImÃ¡genes locales para productos principales
- **Sistema de Control de Calidad** (`/admin/calidad`)
  - Checklists para Maestro Planchero y Cajero
  - Respuestas SÃ­/No con observaciones
  - Subida de fotos evidencia comprimidas
  - CÃ¡lculo automÃ¡tico de scores de calidad

### Backend PHP/MySQL

**ConfiguraciÃ³n de Base de Datos** (`config.php`):
- **Base de Datos Principal (APP)**: `u958525313_app`
- **Usuario**: `u958525313_app`
- **ContraseÃ±a**: `wEzho0-hujzoz-cevzin`
- **Servidor**: localhost
- API Gemini integrada
- BÃºsqueda automÃ¡tica de config.php hasta 5 niveles

**API Endpoints Disponibles** (`api/` - 80+ archivos PHP):

**Productos:**
- `get_productos.php` - Obtener productos
- `add_producto.php` - Agregar producto
- `update_producto.php` - Actualizar producto
- `create_producto.php` - Crear producto

**Ingredientes y Recetas:**
- `get_ingredientes.php` - Obtener ingredientes
- `save_ingrediente.php` - Guardar ingrediente
- `get_recetas.php` - Obtener recetas
- `update_receta.php` - Actualizar receta

**CategorÃ­as:**
- `get_categories.php` - Obtener categorÃ­as
- `save_category.php` - Guardar categorÃ­a
- `categorias_hardcoded.php` - CategorÃ­as predefinidas

**Proyecciones Financieras:**
- `proyeccion.php` - ProyecciÃ³n bÃ¡sica
- `proyeccion_v2.php` - ProyecciÃ³n v2
- `proyeccion_v3.php` - ProyecciÃ³n v3
- `get_proyeccion.php` - Obtener proyecciÃ³n
- `save_proyeccion.php` - Guardar proyecciÃ³n

**Ventas:**
- `registrar_venta.php` - Registrar venta
- `ventas_update.php` - Actualizar ventas
- `ventas_get_all.php` - Obtener todas las ventas

**Dashboard y KPIs:**
- `get_dashboard_kpis.php` - Obtener KPIs
- `setup_dashboard_tables.php` - Configurar tablas

**Testing y Debug:**
- `test_api.php` - Probar API
- `test_connection.php` - Probar conexiÃ³n
- `debug_db_connection.php` - Debug conexiÃ³n DB

**Control de Calidad:**
- `get_questions.php` - Obtener preguntas por rol desde `quality_questions`
- `save_checklist.php` - Guardar checklists en `quality_checklists`
- `get_quality_score.php` - Obtener promedio de calidad para dashboard
- Tabla `quality_questions` - 20 preguntas (14 planchero + 6 cajero)
- Tabla `quality_checklists` - Almacena respuestas y scores
- CompresiÃ³n automÃ¡tica de imÃ¡genes evidencia
- IntegraciÃ³n con sistema de subida AWS existente

**Concurso/Torneo:**
- `get_concurso_live.php` - Obtener estado actual del torneo
- `update_concurso_state.php` - Actualizar estado del torneo
- Sistema de torneo eliminatorio 8 participantes
- Control manual de progresiÃ³n de etapas
- Vista en tiempo real con actualizaciÃ³n cada 1 segundo

**Setup y ConfiguraciÃ³n:**
- `setup_tables.php` - Configurar tablas
- `check_config.php` - Verificar configuraciÃ³n
- `save_config.php` - Guardar configuraciÃ³n

### ImÃ¡genes de Productos (`public/`)
- `icon.png` - Logo de la aplicaciÃ³n
- `Completo-italiano.png` - Completo Tradicional
- `completo-talquino.png` - Completo Talquino
- `salchi-papas.png` - Salchipapas
- `papas-ruta11.png` - Papas Ruta 11
- `toma-provoleta.png` - Tomahawk Provoleta
- `tomahawk-full.png` - Tomahawk Full Ruta 11

## Sistema de Control de Calidad

### Funcionalidades
- **Checklists Diarios**: Maestro Planchero (14 preguntas) y Cajero (6 preguntas)
- **Secciones Organizadas**: Pre-Servicio, Durante Servicio, Post-Servicio
- **Respuestas Estructuradas**: SÃ­/No + observaciones de texto libre
- **Evidencia FotogrÃ¡fica**: CompresiÃ³n automÃ¡tica y subida a AWS S3
- **Scoring AutomÃ¡tico**: CÃ¡lculo de porcentaje de calidad por rol
- **Dashboard Integration**: Promedio de calidad visible en dashboard principal
- **HistÃ³rico**: Un checklist por dÃ­a por rol (actualizable)
- **Base de Datos**: Usa `u958525313_app` (no Calcularuta11)

### Base de Datos

**Tabla de Preguntas:**
```sql
CREATE TABLE quality_questions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    role ENUM('planchero', 'cajero') NOT NULL,
    question TEXT NOT NULL,
    requires_photo TINYINT(1) DEFAULT 0,
    order_index INT NOT NULL,
    active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Tabla de Respuestas:**
```sql
CREATE TABLE quality_checklists (
    id INT AUTO_INCREMENT PRIMARY KEY,
    role ENUM('planchero', 'cajero') NOT NULL,
    checklist_date DATE NOT NULL,
    responses JSON NOT NULL,
    total_questions INT NOT NULL,
    passed_questions INT NOT NULL,
    score_percentage DECIMAL(5,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_role_date (role, checklist_date)
);
```

### Acceso y CaracterÃ­sticas
- **URL**: `/admin/calidad` (integrado en SaaS admin)
- **NavegaciÃ³n**: BotÃ³n "Control Calidad" en menÃº admin
- **Responsive**: Optimizado para mÃ³viles y tablets
- **Acordeones**: Secciones colapsables para mejor UX
- **Progreso Visual**: Barra de progreso en tiempo real
- **Persistencia**: LocalStorage guarda progreso automÃ¡ticamente
- **Dashboard**: MÃ©trica "Calidad Promedio" en dashboard principal
- **API Endpoints**: 3 APIs dedicados para funcionalidad completa

## Sistema de Concurso/Torneo EN VIVO

### Funcionalidades Principales
- **Torneo Eliminatorio**: 8 participantes â†’ Cuartos â†’ Semifinales â†’ Final â†’ CampeÃ³n
- **Admin Panel** (`/concurso/admin`): Control total del torneo
- **Vista EN VIVO** (`/concurso/live`): TransmisiÃ³n en tiempo real
- **Control Manual**: Admin decide cuÃ¡ndo avanzar cada etapa
- **ActualizaciÃ³n Tiempo Real**: Datos se actualizan cada 1 segundo

### Panel de AdministraciÃ³n
- **Participantes**: 8 concursantes con seeds del 1-8
- **Enfrentamientos**: SelecciÃ³n manual de ganadores por click
- **Estados Visuales**: ğŸŸ¢ Activo, ğŸ”´ Eliminado, ğŸ‘‘ CampeÃ³n
- **Control de Etapas**: BotÃ³n "â¡ï¸ Avanzar a Siguiente Etapa"
- **Botones de Control**:
  - â–¶ï¸ Iniciar Torneo
  - ğŸ”„ Reiniciar Todo
  - â¡ï¸ Avanzar a Siguiente Etapa (manual)

### Vista EN VIVO (PÃºblico)
- **Formato Piramidal**: CampeÃ³n â†’ Final â†’ Semifinales â†’ Cuartos
- **Layout Responsivo**: Adaptado para pantallas completas
- **Animaciones Suaves**: Transiciones fluidas en todos los cambios
- **Indicadores Visuales**:
  - ğŸŸ¢ Fondo verde + escala para ganadores
  - ğŸ”´ "EN VIVO" para matches activos
  - ğŸ·ï¸ Tag "GANADOR" amarillo
  - ğŸ‘‘ Corona animada para campeÃ³n
- **Nombres de Pila**: Solo primer nombre para mejor legibilidad
- **Placeholders**: "Sin foto" en espacios de imÃ¡genes 4:5

### API Endpoints del Concurso
- `get_concurso_live.php` - Obtener estado actual del torneo
- `update_concurso_state.php` - Actualizar estado del torneo

### CaracterÃ­sticas TÃ©cnicas
- **ActualizaciÃ³n AutomÃ¡tica**: Polling cada 1000ms (tiempo real)
- **Cache Busting**: Timestamps Ãºnicos para datos frescos
- **Responsive Design**: Clamps y viewport units para escalabilidad
- **Animaciones CSS**: Keyframes para efectos visuales
- **Estado Persistente**: Datos guardados en base de datos
- **Control Manual**: Admin tiene control total sobre progresiÃ³n

### Flujo del Torneo
1. **PreparaciÃ³n**: Admin configura participantes
2. **Cuartos de Final**: 8 â†’ 4 participantes
3. **Control Manual**: Admin hace click "Avanzar a Siguiente Etapa"
4. **Semifinales**: 4 â†’ 2 participantes
5. **Control Manual**: Admin hace click "Avanzar a Siguiente Etapa"
6. **Final**: 2 â†’ 1 participante
7. **CampeÃ³n**: Se declara automÃ¡ticamente

### URLs del Sistema
- **Admin**: `/concurso/admin` - Panel de control
- **Live**: `/concurso/live` - Vista pÃºblica en tiempo real

## ğŸ› Bug CrÃ­tico Resuelto: Referencias en Foreach PHP

### DescripciÃ³n del Problema

**SÃ­ntoma**: En la pÃ¡gina de detalle de ventas (`/ventas-detalle`), al cargar Ã³rdenes de un turno especÃ­fico, algunas Ã³rdenes aparecÃ­an duplicadas mientras que otras faltaban completamente.

**Ejemplo del Bug**:
- Query SQL devolvÃ­a correctamente 6 Ã³rdenes: `[609, 608, 607, 606, 605, 604]`
- API PHP devolvÃ­a 6 Ã³rdenes pero con datos incorrectos: `[609, 608, 607, 606, 605, 605]` (605 duplicado, 604 faltante)

### Causa RaÃ­z

El problema estaba en `api/get_sales_detail.php` en el siguiente cÃ³digo:

```php
// âŒ CÃ“DIGO CON BUG
foreach ($orders as $key => &$order) {
    // Procesar orden...
    $order['items'] = $items;
}
// La referencia &$order persiste aquÃ­

// MÃ¡s adelante en el cÃ³digo...
foreach ($orders as $order) {
    // Este loop sobrescribe el Ãºltimo elemento
    // porque &$order todavÃ­a apunta al Ãºltimo elemento del array
}
```

**Â¿Por quÃ© ocurre?**

Cuando usas `foreach ($array as &$variable)` con el operador de referencia `&`, PHP crea una referencia que **persiste despuÃ©s de que el loop termina**. Si luego usas otra variable con el mismo nombre en otro loop, esa variable sobrescribirÃ¡ el Ãºltimo elemento del array original.

### SoluciÃ³n Implementada

```php
// âœ… CÃ“DIGO CORREGIDO
foreach ($orders as $key => &$order) {
    // Procesar orden...
    $order['items'] = $items;
}
unset($order); // ğŸ”‘ CRÃTICO: Liberar la referencia

// Ahora es seguro usar $order en otros loops
foreach ($orders as $order) {
    // Ya no hay problema de sobrescritura
}
```

### LecciÃ³n Aprendida

**Regla de Oro en PHP**: Siempre que uses referencias en foreach (`&$variable`), debes llamar `unset($variable)` inmediatamente despuÃ©s del loop para liberar la referencia.

```php
// âœ… PATRÃ“N CORRECTO
foreach ($array as &$item) {
    // Modificar $item
}
unset($item); // Siempre liberar la referencia

// âŒ PATRÃ“N INCORRECTO
foreach ($array as &$item) {
    // Modificar $item
}
// Falta unset($item) - BUG POTENCIAL
```

### Impacto

- **Antes**: Ã“rdenes duplicadas/faltantes en detalle de ventas
- **DespuÃ©s**: Todas las Ã³rdenes se muestran correctamente sin duplicados
- **Archivos Afectados**: `api/get_sales_detail.php` (lÃ­nea despuÃ©s del foreach con referencia)

### Referencias

- [PHP Manual: foreach](https://www.php.net/manual/es/control-structures.foreach.php)
- [PHP Bug: Reference in foreach](https://stackoverflow.com/questions/3307409/php-pass-by-reference-in-foreach)

---

**Fecha de ResoluciÃ³n**: Enero 2025  
**Severidad**: ğŸ”´ CrÃ­tica (pÃ©rdida de datos en reportes)

