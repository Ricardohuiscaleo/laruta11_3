---
import MenuApp from '../components/MenuApp.jsx';
---

<html lang="es">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/x-icon" href="/icon.ico" />
		<link rel="icon" type="image/png" href="https://laruta11-images.s3.amazonaws.com/menu/logo-optimized.jpg" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
		<meta name="generator" content={Astro.generator} />
		<title>La Ruta 11 - Menú Digital</title>
		
		<!-- PWA Configuration -->
		<link rel="manifest" href="/manifest.json">
		<meta name="theme-color" content="#ffffff">
		<meta name="description" content="Menú digital de La Ruta 11. Completos, hamburguesas, churrascos y más.">
		
		<!-- Open Graph Meta Tags -->
		<meta property="og:title" content="La Ruta 11 - Menú Digital">
		<meta property="og:description" content="Menú digital de La Ruta 11. Completos, hamburguesas, churrascos y más.">
		<meta property="og:image" content="https://laruta11-images.s3.amazonaws.com/menu/logo-optimized.jpg">
		<meta property="og:url" content="https://app.laruta11.cl">
		<meta property="og:type" content="website">
		<meta property="og:site_name" content="La Ruta 11">
		
		<!-- Twitter Card -->
		<meta name="twitter:card" content="summary_large_image">
		<meta name="twitter:title" content="La Ruta 11 - Menú Digital">
		<meta name="twitter:description" content="Menú digital de La Ruta 11. Completos, hamburguesas, churrascos y más.">
		<meta name="twitter:image" content="https://laruta11-images.s3.amazonaws.com/menu/logo-optimized.jpg">
		
		<!-- iOS PWA Support -->
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="default">
		<meta name="apple-mobile-web-app-title" content="La Ruta 11">
		<link rel="apple-touch-icon" href="https://laruta11-images.s3.amazonaws.com/menu/logo-optimized.jpg">
		
		<!-- Android PWA Support -->
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="application-name" content="La Ruta 11">
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
	</head>
	<body>
		<div id="auth-check" style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: Inter, sans-serif;">
			<div style="text-align: center;">
				<img src="https://laruta11-images.s3.amazonaws.com/menu/logo-optimized.jpg" style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 20px;" />
				<div>Verificando acceso...</div>
			</div>
		</div>
		<div id="app-content" style="display: none;">
			<MenuApp client:only="react" />
		</div>
		<script>
			// Cookie utilities
			const CookieManager = {
				set(name, value, days = 30) {
					const expires = new Date(Date.now() + days * 864e5).toUTCString();
					document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; SameSite=Lax`;
				},
				
				get(name) {
					const cookieValue = document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1];
					return cookieValue ? decodeURIComponent(cookieValue) : null;
				},
				
				remove(name) {
					document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
				}
			};
			
			// User Session Manager
			const UserSession = {
				init() {
					let userId = CookieManager.get('user_id');
					if (!userId) {
						userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
						CookieManager.set('user_id', userId, 365); // 1 año
					}
					return userId;
				},
				
				getUserId() {
					return CookieManager.get('user_id');
				},
				
				saveUserData(data) {
					CookieManager.set('user_name', data.name || '', 90);
					CookieManager.set('user_phone', data.phone || '', 90);
					CookieManager.set('user_address', data.address || '', 90);
				},
				
				getUserData() {
					return {
						id: this.getUserId(),
						name: CookieManager.get('user_name'),
						phone: CookieManager.get('user_phone'),
						address: CookieManager.get('user_address')
					};
				}
			};
			
			// Advanced Analytics System
			const Analytics = {
				sessionId: sessionStorage.getItem('visit_session') || Date.now() + '-' + Math.random().toString(36).substr(2, 9),
				userId: null,
				pageStartTime: Date.now(),
				scrollDepth: 0,
				
				init() {
					this.userId = UserSession.init();
					sessionStorage.setItem('visit_session', this.sessionId);
					this.trackVisit();
					this.setupEventListeners();
				},
				
				trackVisit() {
					const visitData = {
						page_url: window.location.href,
						session_id: this.sessionId,
						user_id: this.userId,
						timestamp: new Date().toISOString(),
						screen_resolution: `${screen.width}x${screen.height}`,
						viewport_size: `${window.innerWidth}x${window.innerHeight}`,
						timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
						language: navigator.language,
						platform: navigator.platform
					};
					
					if (navigator.geolocation) {
						navigator.geolocation.getCurrentPosition(
							position => {
								(visitData as any).latitude = position.coords.latitude;
								(visitData as any).longitude = position.coords.longitude;
								this.sendData('/api/app/track_visit.php', visitData);
							},
							() => this.sendData('/api/app/track_visit.php', visitData),
							{ timeout: 5000 }
						);
					} else {
						this.sendData('/api/app/track_visit.php', visitData);
					}
				},
				
				setupEventListeners() {
					// Track clicks on all elements
					document.addEventListener('click', (e) => {
						const element = e.target as HTMLElement;
						if (!element) return;
						
						const productId = element.closest('[data-product-id]')?.getAttribute('data-product-id');
						const categoryId = element.closest('[data-category-id]')?.getAttribute('data-category-id');
						
						this.trackInteraction({
							action_type: 'click',
							element_type: element.tagName?.toLowerCase() || 'unknown',
							element_id: element.id || element.className || '',
							element_text: element.textContent?.substring(0, 100) || '',
							product_id: productId,
							category_id: categoryId
						});
					});
					
					// Track scroll depth
					window.addEventListener('scroll', () => {
						const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
						if (scrollPercent > this.scrollDepth) {
							this.scrollDepth = scrollPercent;
						}
					});
					
					// Track page exit
					window.addEventListener('beforeunload', () => {
						const timeSpent = Math.round((Date.now() - this.pageStartTime) / 1000);
						navigator.sendBeacon('/api/app/track_journey.php', JSON.stringify({
							session_id: this.sessionId,
							page_url: window.location.href,
							time_spent: timeSpent,
							scroll_depth: this.scrollDepth,
							exit_page: true
						}));
					});
				},
				
				trackInteraction(data) {
					data.session_id = this.sessionId;
					data.page_url = window.location.href;
					this.sendData('/api/app/track_interaction.php', data);
				},
				
				trackProductView(productId, productName) {
					this.trackInteraction({
						action_type: 'view',
						element_type: 'product',
						product_id: productId,
						product_name: productName
					});
				},
				
				trackAddToCart(productId, productName) {
					this.trackInteraction({
						action_type: 'add_to_cart',
						element_type: 'product',
						product_id: productId,
						product_name: productName
					});
				},
				
				sendData(url, data) {
					fetch(url, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(data)
					}).catch(() => {});
				}
			};
			
			// Auth Check
			const AuthManager = {
				checkAuth() {
					const session = localStorage.getItem('caja_session');
					if (!session) {
						window.location.href = '/login';
						return false;
					}
					
					try {
						const sessionData = JSON.parse(session);
						const isExpired = Date.now() - sessionData.timestamp > 8 * 60 * 60 * 1000; // 8 horas
						
						if (isExpired) {
							localStorage.removeItem('caja_session');
							window.location.href = '/login';
							return false;
						}
						
						return true;
					} catch {
						localStorage.removeItem('caja_session');
						window.location.href = '/login';
						return false;
					}
				},
				
				showApp() {
					const authCheck = document.getElementById('auth-check');
					const appContent = document.getElementById('app-content');
					if (authCheck) authCheck.style.display = 'none';
					if (appContent) appContent.style.display = 'block';
				}
			};
			
			// Initialize app
			const initApp = () => {
				if (AuthManager.checkAuth()) {
					AuthManager.showApp();
					Analytics.init();
				}
			};
			
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', initApp);
			} else {
				initApp();
			}
			
			// Make utilities globally available
			(window as any).Analytics = Analytics;
			(window as any).UserSession = UserSession;
			(window as any).CookieManager = CookieManager;
			(window as any).AuthManager = AuthManager;
		</script>
	</body>
</html>
<style is:global>
	body {
		font-family: 'Inter', sans-serif;
		background-color: #ffffff !important;
		background: #ffffff !important;
	}
	html {
		background-color: #ffffff !important;
		background: #ffffff !important;
	}
	* {
		box-sizing: border-box;
	}
</style>
