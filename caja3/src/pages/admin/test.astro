---
---
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test APIs - Admin La Ruta 11</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f8f9fa; min-height: 100vh; }

    .container { max-width: calc(100% - clamp(10px, 2vw, 20px)); margin: clamp(1rem, 3vw, 2rem) clamp(5px, 1vw, 10px); padding: 0; }
    .api-table { background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid #dee2e6; }
    .table { width: 100%; border-collapse: collapse; font-size: clamp(0.75rem, 1.2vw, 0.875rem); }
    .table th { background: #f8f9fa; padding: clamp(0.75rem, 1.5vw, 1rem); text-align: left; font-weight: 600; color: #212529; border: 1px solid #dee2e6; font-size: clamp(0.75rem, 1.1vw, 0.8125rem); text-transform: uppercase; letter-spacing: 0.5px; }
    .table td { padding: clamp(0.75rem, 1.5vw, 1rem); border-right: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6; vertical-align: middle; color: #495057; }
    .table td:first-child { border-left: 1px solid #dee2e6; }
    .table tr:hover { background: #f8f9fa; }
    .table tr:nth-child(even) { background: #fdfdfd; }
    .table tr:nth-child(even):hover { background: #f1f3f4; }
    .api-name { font-weight: 600; color: #212529; font-size: clamp(0.8rem, 1.3vw, 0.9rem); }
    .api-category { display: inline-block; padding: clamp(0.25rem, 0.8vw, 0.375rem) clamp(0.5rem, 1.2vw, 0.75rem); border-radius: 4px; font-size: clamp(0.625rem, 1vw, 0.75rem); font-weight: 500; color: white; text-transform: uppercase; letter-spacing: 0.25px; }
    .api-method { font-family: 'SF Mono', Monaco, monospace; font-size: clamp(0.625rem, 1vw, 0.75rem); padding: clamp(0.25rem, 0.8vw, 0.375rem) clamp(0.5rem, 1.2vw, 0.75rem); border-radius: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.25px; }
    .method-get { background: #28a745; color: white; }
    .method-post { background: #ffc107; color: #212529; }
    .api-url { font-family: 'SF Mono', Monaco, monospace; font-size: clamp(0.625rem, 1.1vw, 0.75rem); color: #6c757d; background: #f8f9fa; padding: clamp(0.375rem, 1vw, 0.5rem); border-radius: 4px; border: 1px solid #dee2e6; word-break: break-all; }
    .api-status { padding: clamp(0.25rem, 0.8vw, 0.375rem) clamp(0.5rem, 1.2vw, 0.75rem); border-radius: 4px; font-size: clamp(0.625rem, 1vw, 0.75rem); font-weight: 500; text-transform: uppercase; letter-spacing: 0.25px; }
    .status-loading { background: #ffc107; color: #212529; }
    .status-success { background: #28a745; color: white; }
    .status-error { background: #dc3545; color: white; }
    .test-btn { background: #007bff; color: white; border: none; padding: clamp(0.375rem, 1vw, 0.5rem) clamp(0.75rem, 1.5vw, 1rem); border-radius: 4px; cursor: pointer; font-size: clamp(0.75rem, 1.1vw, 0.875rem); font-weight: 500; transition: background-color 0.2s ease; }
    .test-btn:hover { background: #0056b3; }
    .test-btn:disabled { background: #6c757d; cursor: not-allowed; }
    .details-btn { background: #6c757d; color: white; border: none; padding: clamp(0.25rem, 0.8vw, 0.375rem) clamp(0.5rem, 1.2vw, 0.75rem); border-radius: 4px; cursor: pointer; font-size: clamp(0.625rem, 1vw, 0.75rem); margin-left: clamp(0.25rem, 0.8vw, 0.5rem); font-weight: 500; transition: background-color 0.2s ease; }
    .details-btn:hover { background: #5a6268; }
    .response { margin-top: clamp(0.5rem, 1.2vw, 0.75rem); padding: clamp(0.75rem, 1.5vw, 1rem); background: #f8f9fa; border-radius: 6px; font-family: 'SF Mono', Monaco, monospace; font-size: clamp(0.625rem, 1vw, 0.75rem); max-height: clamp(200px, 30vh, 300px); overflow-y: auto; display: none; color: #495057; border: 1px solid #dee2e6; }
    .response-success { border-left: 4px solid #28a745; background: #f8fff9; }
    .response-error { border-left: 4px solid #dc3545; background: #fff8f8; }
    .error-summary { color: #dc3545; font-size: clamp(0.75rem, 1.2vw, 0.875rem); font-weight: 500; }
    .success-summary { color: #28a745; font-size: clamp(0.75rem, 1.2vw, 0.875rem); font-weight: 500; }
    .test-all { background: #28a745; color: white; border: none; padding: clamp(0.75rem, 2vw, 1rem) clamp(1.5rem, 3vw, 2rem); border-radius: 6px; cursor: pointer; font-size: clamp(0.875rem, 1.3vw, 1rem); font-weight: 600; margin-bottom: clamp(1rem, 2.5vw, 2rem); transition: background-color 0.2s ease; }
    .test-all:hover { background: #218838; }
  </style>
</head>
<body>
  <div class="container" style="margin-top: clamp(1rem, 2vw, 1.5rem);">
    <button class="test-all" id="testAllBtn">üöÄ Testear Todas las APIs</button>
    
    <div class="api-table">
      <table class="table">
        <thead>
          <tr>
            <th>API</th>
            <th>Descripci√≥n</th>
            <th>Categor√≠a</th>
            <th>M√©todo</th>
            <th>Endpoint</th>
            <th>Estado</th>
            <th>Resultado</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="apiTableBody">
          <!-- APIs se cargar√°n aqu√≠ -->
        </tbody>
      </table>
    </div>
  </div>
  
  <script>
    // @ts-nocheck
    const apis = [
      { name: 'Test Connection', description: 'Prueba conexi√≥n a base de datos', url: '/api/test_connection.php', method: 'GET', category: 'Core' },
      { name: 'Check Config', description: 'Verifica configuraci√≥n del sistema', url: '/api/check_config.php', method: 'GET', category: 'Core' },
      { name: 'API Status', description: 'Estado general de las APIs', url: '/api/api_status.php', method: 'GET', category: 'Core' },
      { name: 'Check Tables', description: 'Verifica existencia de tablas', url: '/api/app/check_tables.php', method: 'GET', category: 'Core' },
      { name: 'Products - Lista', description: 'Obtiene lista de productos', url: '/api/get_productos.php', method: 'GET', category: 'Products' },
      { name: 'Products - Categories', description: 'Obtiene categor√≠as de productos', url: '/api/get_categories.php', method: 'GET', category: 'Products' },
      { name: 'Admin - Check Auth', description: 'Verifica autenticaci√≥n de admin', url: '/api/check_admin_auth.php', method: 'GET', category: 'Admin' },
      { name: 'Admin - Dashboard', description: 'Datos del dashboard administrativo', url: '/api/admin_dashboard.php', method: 'GET', category: 'Admin' },
      { name: 'Analytics - Check Tables', description: 'Verifica tablas de analytics', url: '/api/app/check_tables.php', method: 'GET', category: 'Analytics' },
      { name: 'Analytics - M√©tricas', description: 'M√©tricas de visitantes y ventas', url: '/api/app/get_analytics.php', method: 'GET', category: 'Analytics' },
      { name: 'Analytics - Track Visit', description: 'Registra visita de usuario', url: '/api/app/track_visit.php', method: 'POST', category: 'Analytics', data: { page_url: 'test', session_id: 'test123' } },
      { name: 'Users - Lista', description: 'Lista de usuarios registrados', url: '/api/users/get_users.php', method: 'GET', category: 'Users' },
      { name: 'Auth - Check Session', description: 'Verifica sesi√≥n de usuario', url: '/api/auth/check_session.php', method: 'GET', category: 'Auth' },
      { name: 'TUU - Get Reports', description: 'Reportes de pagos TUU', url: (() => {
        const today = new Date();
        const endDate = new Date(today);
        endDate.setDate(today.getDate() - 1);
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 30);
        return `/api/tuu/get_reports.php?start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}`;
      })(), method: 'GET', category: 'TUU' },
      { name: 'TUU - Check Status', description: 'Estado de la pasarela TUU', url: '/api/tuu/check_status.php', method: 'GET', category: 'TUU' },
      { name: 'TUU - Create Payment', description: 'Crear pago simple', url: '/api/tuu/create_payment_simple.php', method: 'POST', category: 'TUU', data: { amount: 1000, customer_name: 'Test User', customer_phone: '+56912345678', customer_email: 'test@test.com' } },
      { name: 'TUU - Get Config', description: 'Configuraci√≥n de TUU', url: '/api/tuu/get_config.php', method: 'GET', category: 'TUU' },
      { name: 'TUU - Save Config', description: 'Guardar configuraci√≥n TUU', url: '/api/tuu/save_config.php', method: 'POST', category: 'TUU', data: { test_mode: true } },
      { name: 'TUU - Get Devices', description: 'Dispositivos TUU registrados', url: '/api/tuu/get_devices.php', method: 'GET', category: 'TUU' },
      { name: 'TUU - Sync Reports', description: 'Sincronizar reportes TUU', url: '/api/tuu/sync_reports.php', method: 'GET', category: 'TUU' },
      { name: 'TUU - Callback', description: 'Callback de pagos TUU', url: '/api/tuu/callback.php', method: 'POST', category: 'TUU', data: { order_id: 'test123', status: 'completed' } },
      { name: 'TUU - Webhook', description: 'Webhook de notificaciones TUU', url: '/api/tuu/webhook.php', method: 'POST', category: 'TUU', data: { event: 'payment.completed' } },
      { name: 'Location - Get Location', description: 'Obtiene ubicaci√≥n del local', url: '/api/location/get_location.php', method: 'GET', category: 'Location' }
    ];
    
    const categoryColors = {
      'Analytics': '#007bff',
      'Users': '#28a745', 
      'Auth': '#ffc107',
      'Admin': '#dc3545',
      'Products': '#6f42c1',
      'TUU': '#17a2b8',
      'Core': '#6c757d',
      'Location': '#fd7e14'
    };
    
    function renderAPIs() {
      const tbody = document.getElementById('apiTableBody');
      if (!tbody) return;
      tbody.innerHTML = apis.map((api, index) => `
        <tr>
          <td>
            <div class="api-name">${api.name}</div>
            <div class="response" id="response-${index}"></div>
          </td>
          <td>
            <div style="font-size: 0.875rem; color: #6b7280;">${api.description || '-'}</div>
          </td>
          <td>
            <span class="api-category" style="background-color: ${categoryColors[api.category] || '#6b7280'}">${api.category}</span>
          </td>
          <td>
            <span class="api-method ${api.method.toLowerCase() === 'get' ? 'method-get' : 'method-post'}">${api.method}</span>
          </td>
          <td>
            <div class="api-url">${api.url}</div>
          </td>
          <td>
            <span class="api-status status-loading" id="status-${index}">‚è≥ Pendiente</span>
          </td>
          <td>
            <div id="result-${index}">-</div>
          </td>
          <td>
            <button class="test-btn" data-index="${index}" id="btn-${index}">üß™ Test</button>
            <button class="details-btn" data-index="${index}" id="details-${index}" style="display:none">Ver</button>
          </td>
        </tr>
      `).join('');
    }
    
    async function testAPI(index) {
      const api = apis[index];
      const statusEl = document.getElementById('status-' + index);
      const responseEl = document.getElementById('response-' + index);
      const resultEl = document.getElementById('result-' + index);
      const btnEl = document.getElementById('btn-' + index);
      const detailsBtn = document.getElementById('details-' + index);
      
      if (!statusEl || !responseEl || !btnEl || !resultEl) return;
      
      statusEl.textContent = 'üîÑ Probando...';
      statusEl.className = 'api-status status-loading';
      btnEl.setAttribute('disabled', 'true');
      resultEl.textContent = 'Probando...';
      responseEl.style.display = 'none';
      detailsBtn.style.display = 'none';
      
      try {
        const options = {
          method: api.method,
          headers: { 'Content-Type': 'application/json' }
        };
        
        if (api.data && api.method === 'POST') {
          options.body = JSON.stringify(api.data);
        }
        
        const startTime = Date.now();
        const response = await fetch(api.url, options);
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        let responseData;
        try {
          responseData = await response.json();
        } catch {
          responseData = await response.text();
        }
        
        if (response.ok) {
          statusEl.textContent = '‚úÖ OK (' + responseTime + 'ms)';
          statusEl.className = 'api-status status-success';
          responseEl.className = 'response response-success';
          
          let summary = '√âxito';
          if (typeof responseData === 'object' && responseData) {
            if (responseData.success) summary = '√âxito: ' + (responseData.message || 'OK');
            else if (responseData.data) summary = 'Datos obtenidos (' + (Array.isArray(responseData.data) ? responseData.data.length + ' items' : 'objeto') + ')';
            else if (responseData.authenticated !== undefined) summary = responseData.authenticated ? 'Autenticado' : 'No autenticado';
          }
          resultEl.innerHTML = '<div class="success-summary">' + summary + '</div>';
        } else {
          statusEl.textContent = '‚ùå Error ' + response.status;
          statusEl.className = 'api-status status-error';
          responseEl.className = 'response response-error';
          
          let errorMsg = 'Error HTTP ' + response.status;
          if (response.status === 404) errorMsg = 'API no encontrada';
          else if (response.status === 500) errorMsg = 'Error interno del servidor';
          else if (response.status === 403) errorMsg = 'Acceso denegado';
          
          resultEl.innerHTML = '<div class="error-summary">' + errorMsg + '</div>';
        }
        
        responseEl.textContent = JSON.stringify(responseData, null, 2);
        detailsBtn.style.display = 'inline-block';
        
      } catch (error) {
        statusEl.textContent = '‚ùå Error';
        statusEl.className = 'api-status status-error';
        responseEl.className = 'response response-error';
        responseEl.textContent = 'Error: ' + error.message;
        
        let errorMsg = 'Error de conexi√≥n';
        if (error.message.includes('fetch')) errorMsg = 'No se pudo conectar';
        else if (error.message.includes('JSON')) errorMsg = 'Respuesta inv√°lida';
        
        resultEl.innerHTML = '<div class="error-summary">' + errorMsg + '</div>';
        detailsBtn.style.display = 'inline-block';
      }
      
      btnEl.removeAttribute('disabled');
    }
    
    async function testAllAPIs() {
      const testAllBtn = document.querySelector('.test-all');
      if (!testAllBtn) return;
      
      testAllBtn.setAttribute('disabled', 'true');
      testAllBtn.textContent = 'üîÑ Probando todas las APIs...'
      
      for (let i = 0; i < apis.length; i++) {
        await testAPI(i);
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
      testAllBtn.removeAttribute('disabled');
      testAllBtn.textContent = 'üöÄ Testear Todas las APIs';
      
      const successCount = document.querySelectorAll('.status-success').length;
      const errorCount = document.querySelectorAll('.status-error').length;
      
      alert('‚úÖ Pruebas completadas!\n\n‚úÖ Exitosas: ' + successCount + '\n‚ùå Con errores: ' + errorCount + '\nüìä Total: ' + apis.length);
    }
    
    // Debug: Script cargado
    console.log('üöÄ Script cargado correctamente');
    
    // Renderizar y configurar eventos
    renderAPIs();
    console.log('üìã Tabla renderizada con', apis.length, 'APIs');
    
    // Configurar event listeners
    document.addEventListener('click', function(e) {
      if (!e.target) return;
      const target = e.target;
      console.log('üëÜ Click detectado en:', target);
      
      if (target.className && target.className.includes('test-btn')) {
        const index = parseInt(target.getAttribute('data-index') || '0');
        console.log('üß™ Testeando API index:', index);
        testAPI(index);
      }
      
      if (target.className && target.className.includes('details-btn')) {
        const index = parseInt(target.getAttribute('data-index') || '0');
        const responseEl = document.getElementById('response-' + index);
        if (responseEl) {
          responseEl.style.display = responseEl.style.display === 'none' ? 'block' : 'none';
          target.textContent = responseEl.style.display === 'none' ? 'Ver' : 'Ocultar';
        }
      }
      
      if (target.id === 'testAllBtn') {
        console.log('üöÄ Testeando todas las APIs');
        testAllAPIs();
      }
    });
    
    console.log('‚úÖ Event listeners configurados');
  </script>
</body>
</html>