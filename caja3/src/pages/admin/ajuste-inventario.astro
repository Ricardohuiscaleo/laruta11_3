---
---
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ajuste Inventario - La Ruta 11</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="max-w-4xl mx-auto px-4 py-6">

  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Ajuste de Inventario</h1>
      <p class="text-gray-500 text-sm">Edita las cantidades en markdown y aplica el ajuste</p>
    </div>
    <a href="/admin/inventario" class="text-sm text-gray-500 hover:text-gray-700">‚Üê Volver</a>
  </div>

  <!-- Paso 1: Copiar estado actual -->
  <div class="bg-white rounded-xl border border-gray-200 p-5 mb-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-gray-800">1. Estado actual del inventario</h2>
      <button id="btnCopiar"
        class="flex items-center gap-2 bg-gray-800 text-white text-sm px-4 py-2 rounded-lg hover:bg-gray-700 transition">
        üìã Copiar como Markdown
      </button>
    </div>
    <p class="text-sm text-gray-500">Copia el inventario actual, p√©galo abajo y edita las cantidades que quieras ajustar.</p>
    <div id="copyFeedback" class="hidden mt-2 text-sm text-green-600 font-medium">‚úÖ Copiado al portapapeles</div>
  </div>

  <!-- Paso 2: Editor markdown -->
  <div class="bg-white rounded-xl border border-gray-200 p-5 mb-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-gray-800">2. Edita las cantidades</h2>
      <span class="text-xs text-gray-400">Formato: <code class="bg-gray-100 px-1 rounded">- Nombre: cantidad unidad</code></span>
    </div>
    <textarea id="mdEditor"
      class="w-full h-72 font-mono text-sm border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-orange-400 resize-y"
      placeholder="# Ajuste Inventario 2026-02-21&#10;&#10;## Carnes&#10;- Carne molida: 5.5 kg&#10;- Pollo: 3 kg&#10;&#10;## Bebidas&#10;- Coca-Cola 350ml: 48 unidad"></textarea>
    <button id="btnPreview"
      class="mt-3 bg-orange-500 text-white px-5 py-2 rounded-lg hover:bg-orange-600 transition font-medium">
      üëÅ Ver Preview de Cambios
    </button>
  </div>

  <!-- Paso 3: Preview -->
  <div id="previewSection" class="hidden bg-white rounded-xl border border-gray-200 p-5 mb-4">
    <h2 class="font-semibold text-gray-800 mb-4">3. Preview de cambios</h2>

    <div id="notFoundAlert" class="hidden mb-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800"></div>

    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b text-left text-gray-500 text-xs uppercase">
            <th class="pb-2 pr-4">Ingrediente</th>
            <th class="pb-2 pr-4 text-right">Actual</th>
            <th class="pb-2 pr-4 text-center">‚Üí</th>
            <th class="pb-2 pr-4 text-right">Nuevo</th>
            <th class="pb-2 text-center">Cambio</th>
          </tr>
        </thead>
        <tbody id="previewTable"></tbody>
      </table>
    </div>

    <div class="flex items-center justify-between mt-5 pt-4 border-t">
      <p id="previewSummary" class="text-sm text-gray-500"></p>
      <button id="btnApply"
        class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition font-medium">
        ‚úÖ Aplicar Ajuste
      </button>
    </div>
  </div>

  <!-- Resultado -->
  <div id="resultSection" class="hidden bg-green-50 border border-green-200 rounded-xl p-5 text-center">
    <div class="text-3xl mb-2">‚úÖ</div>
    <p id="resultMsg" class="font-semibold text-green-800"></p>
  </div>

</div>

<script>
  const btnCopiar  = document.getElementById('btnCopiar');
  const btnPreview = document.getElementById('btnPreview');
  const btnApply   = document.getElementById('btnApply');
  const mdEditor   = document.getElementById('mdEditor');

  // Copiar inventario actual como markdown
  btnCopiar.addEventListener('click', async () => {
    btnCopiar.disabled = true;
    btnCopiar.textContent = '‚è≥ Cargando...';
    try {
      const res = await fetch('/api/inventario_markdown_export.php');
      const data = await res.json();
      if (data.markdown) {
        await navigator.clipboard.writeText(data.markdown);
        mdEditor.value = data.markdown;
        document.getElementById('copyFeedback').classList.remove('hidden');
        setTimeout(() => document.getElementById('copyFeedback').classList.add('hidden'), 3000);
      }
    } catch(e) {
      alert('Error al cargar inventario');
    } finally {
      btnCopiar.disabled = false;
      btnCopiar.textContent = 'üìã Copiar como Markdown';
    }
  });

  // Preview
  btnPreview.addEventListener('click', async () => {
    const md = mdEditor.value.trim();
    if (!md) return alert('Pega el markdown primero');

    btnPreview.textContent = '‚è≥ Analizando...';
    btnPreview.disabled = true;

    try {
      const res = await fetch('/api/inventario_markdown_apply.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ markdown: md, apply: false })
      });
      const data = await res.json();
      if (data.error) return alert('Error: ' + data.error);

      renderPreview(data);
      document.getElementById('previewSection').classList.remove('hidden');
      document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
    } catch(e) {
      alert('Error al procesar');
    } finally {
      btnPreview.textContent = 'üëÅ Ver Preview de Cambios';
      btnPreview.disabled = false;
    }
  });

  function renderPreview({ changes, not_found }) {
    const tbody = document.getElementById('previewTable');
    tbody.innerHTML = '';

    const changed = changes.filter(c => c.changed);
    const unchanged = changes.filter(c => !c.changed);

    // Primero los que cambian
    [...changed, ...unchanged].forEach(c => {
      const diff = c.new_stock - c.old_stock;
      const diffStr = diff > 0 ? `+${diff.toFixed(2)}` : diff.toFixed(2);
      const rowClass = !c.changed ? 'opacity-40' : diff > 0 ? '' : diff < 0 ? '' : '';
      const diffColor = diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-600' : 'text-gray-400';
      const badge = !c.changed
        ? '<span class="text-xs text-gray-400">sin cambio</span>'
        : diff > 0
          ? `<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">${diffStr} ${c.unit}</span>`
          : `<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">${diffStr} ${c.unit}</span>`;

      tbody.innerHTML += `
        <tr class="border-b border-gray-50 ${rowClass}">
          <td class="py-2 pr-4 font-medium text-gray-800">${c.name}</td>
          <td class="py-2 pr-4 text-right text-gray-500">${c.old_stock} ${c.unit}</td>
          <td class="py-2 pr-4 text-center text-gray-300">‚Üí</td>
          <td class="py-2 pr-4 text-right font-semibold ${c.changed ? 'text-gray-900' : 'text-gray-400'}">${c.new_stock} ${c.unit}</td>
          <td class="py-2 text-center">${badge}</td>
        </tr>`;
    });

    // No encontrados
    const notFoundAlert = document.getElementById('notFoundAlert');
    if (not_found.length > 0) {
      notFoundAlert.classList.remove('hidden');
      notFoundAlert.innerHTML = `‚ö†Ô∏è No encontrados en BD (se ignorar√°n): <strong>${not_found.join(', ')}</strong>`;
    } else {
      notFoundAlert.classList.add('hidden');
    }

    const summary = document.getElementById('previewSummary');
    summary.textContent = `${changed.length} cambio(s) de ${changes.length} ingrediente(s) detectados`;
  }

  // Aplicar
  btnApply.addEventListener('click', async () => {
    if (!confirm('¬øConfirmas aplicar el ajuste de inventario?')) return;

    btnApply.disabled = true;
    btnApply.textContent = '‚è≥ Aplicando...';

    try {
      const res = await fetch('/api/inventario_markdown_apply.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ markdown: mdEditor.value, apply: true })
      });
      const data = await res.json();

      document.getElementById('previewSection').classList.add('hidden');
      const result = document.getElementById('resultSection');
      result.classList.remove('hidden');
      document.getElementById('resultMsg').textContent = `Ajuste aplicado: ${data.updated} ingrediente(s) actualizados`;
      result.scrollIntoView({ behavior: 'smooth' });
    } catch(e) {
      alert('Error al aplicar');
    } finally {
      btnApply.disabled = false;
      btnApply.textContent = '‚úÖ Aplicar Ajuste';
    }
  });
</script>
</body>
</html>
