---
---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Correos - La Ruta 11</title>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white border-b sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-900">üìß Gestor de Correos</h1>
                    <p class="text-sm text-gray-500 mt-1">Estados de cuenta RL6</p>
                </div>
                <div class="flex items-center gap-2">
                    <div id="gmailStatus" class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-full text-sm">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                        <span class="hidden sm:inline text-gray-600">Verificando...</span>
                    </div>
                    <div class="relative">
                        <button id="menuBtn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Men√∫">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                        <div id="menuDropdown" class="hidden absolute right-0 mt-1 w-52 bg-white border rounded-xl shadow-lg z-50 py-1">
                            <button id="btnInformeStatus" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                                üìã Copiar Informe de Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-6">
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white shadow-lg">
                <p class="text-[10px] uppercase tracking-wide opacity-90 mb-1">Clientes</p>
                <p id="statClientes" class="text-2xl sm:text-3xl font-bold truncate">-</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white shadow-lg">
                <p class="text-[10px] uppercase tracking-wide opacity-90 mb-1">Cr√©dito Total</p>
                <p id="statCreditoTotal" class="text-2xl sm:text-3xl font-bold truncate">-</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white shadow-lg">
                <p class="text-[10px] uppercase tracking-wide opacity-90 mb-1">Cobranza</p>
                <p id="statCobranza" class="text-2xl sm:text-3xl font-bold truncate">-</p>
                <p class="text-[9px] opacity-75 mt-1">solo morosos</p>
            </div>
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 text-white shadow-lg">
                <p class="text-[10px] uppercase tracking-wide opacity-90 mb-1">Morosos</p>
                <p id="statMorosos" class="text-2xl sm:text-3xl font-bold truncate">-</p>
            </div>
        </div>

        <!-- Daily Stats -->
        <div class="bg-white rounded-xl shadow-sm border p-4">
            <h2 class="text-base font-semibold text-gray-900 mb-3">üí≥ Pagos de Hoy</h2>
            <div class="grid grid-cols-2 gap-3">
                <div class="text-center p-3 bg-emerald-50 rounded-lg">
                    <p class="text-xs font-medium text-emerald-600 mb-1">Usuarios</p>
                    <p id="statPagaronHoy" class="text-2xl sm:text-3xl font-bold text-emerald-700 truncate">-</p>
                </div>
                <div class="text-center p-3 bg-teal-50 rounded-lg">
                    <p class="text-xs font-medium text-teal-600 mb-1">Total</p>
                    <p id="statTotalPagado" class="text-2xl sm:text-3xl font-bold text-teal-700 truncate">-</p>
                </div>
            </div>
        </div>

        <!-- Historic Stats -->
        <div class="bg-white rounded-xl shadow-sm border p-4">
            <h2 class="text-base font-semibold text-gray-900 mb-3">üìà Hist√≥rico</h2>
            <div class="grid grid-cols-2 gap-3">
                <div class="text-center p-3 bg-indigo-50 rounded-lg">
                    <p class="text-xs font-medium text-indigo-600 mb-1">Usuarios</p>
                    <p id="statUsuariosPagaronTotal" class="text-2xl sm:text-3xl font-bold text-indigo-700 truncate">-</p>
                </div>
                <div class="text-center p-3 bg-cyan-50 rounded-lg">
                    <p class="text-xs font-medium text-cyan-600 mb-1">Monto</p>
                    <p id="statMontoPagadoTotal" class="text-2xl sm:text-3xl font-bold text-cyan-700 truncate">-</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
            <div class="border-b">
                <nav class="flex -mb-px overflow-x-auto">
                    <button data-action="showTab" data-tab="users" id="tab-users" 
                        class="tab-btn flex-1 sm:flex-none px-6 py-3 text-sm font-medium border-b-2 border-orange-500 text-orange-600 whitespace-nowrap">
                        üë• Usuarios
                    </button>
                    <button data-action="showTab" data-tab="morosos" id="tab-morosos" 
                        class="tab-btn flex-1 sm:flex-none px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">
                        üë∫ Morosos <span id="morososBadge" class="ml-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 hidden"></span>
                    </button>
                    <button data-action="showTab" data-tab="personal" id="tab-personal" 
                        class="tab-btn flex-1 sm:flex-none px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">
                        üë∑ Personal
                    </button>
                    <button data-action="showTab" data-tab="test" id="tab-test" 
                        class="tab-btn flex-1 sm:flex-none px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 whitespace-nowrap">
                        üß™ Prueba
                    </button>
                </nav>
            </div>

            <!-- Users Tab -->
            <div id="content-users" class="tab-content p-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Usuarios con Cr√©dito</h3>
                    <button data-action="sendMassive" id="btnSendMassive"
                        class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2.5 rounded-lg font-medium text-sm transition-colors w-full sm:w-auto">
                        üì§ Enviar a Todos (<span id="sendMassiveCount">0</span>)
                    </button>
                </div>
                <div class="flex gap-2 mb-4">
                    <button data-filter="todos" id="filter-todos"
                        class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gray-800 text-white">Todos</button>
                    <button data-filter="morosos" id="filter-morosos"
                        class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-red-100 hover:text-red-700">üî¥ Morosos</button>
                    <button data-filter="al_dia" id="filter-al_dia"
                        class="filter-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-green-100 hover:text-green-700">‚úÖ Al d√≠a</button>
                </div>
                <div id="usersList" class="space-y-3">
                    <div class="text-center text-gray-400 py-12">
                        <div class="animate-spin w-8 h-8 border-4 border-gray-200 border-t-orange-500 rounded-full mx-auto mb-3"></div>
                        <p>Cargando usuarios...</p>
                    </div>
                </div>
            </div>

            <!-- Morosos Tab -->
            <div id="content-morosos" class="tab-content p-6 hidden">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Morosos</h3>
                        <p class="text-sm text-gray-500 mt-1">Deuda pendiente despu√©s del d√≠a 21 ‚Äî <span id="avisoVencimiento" class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">cargando...</span></p>
                    </div>
                    <button data-action="sendMassiveMorosos"
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-2.5 rounded-lg font-medium text-sm transition-colors w-full sm:w-auto">
                        ‚ö†Ô∏è Cobrar a Todos
                    </button>
                </div>
                <div id="morososList" class="space-y-3">
                    <div class="text-center text-gray-400 py-12">Cargando...</div>
                </div>
            </div>

            <!-- Personal Tab -->
            <div id="content-personal" class="tab-content p-6 hidden">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">üí∞ Liquidaci√≥n de Personal</h3>
                        <p class="text-sm text-gray-500 mt-1">Env√≠a confirmaci√≥n de pago a colaboradores</p>
                    </div>
                </div>

                <!-- Selector mes + colaborador -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Mes</label>
                        <input type="month" id="personalMes" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent" />
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Colaborador</label>
                        <select id="personalSelector" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="previewPersonalEmail()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">üëÅÔ∏è Preview</button>
                        <button onclick="sendPersonalEmail()" id="btnSendPersonal" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">üìß Enviar</button>
                    </div>
                </div>

                <!-- Preview inline -->
                <div id="personalPreviewContainer" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-semibold text-gray-700">Vista previa del email</p>
                        <button onclick="document.getElementById('personalPreviewContainer').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-sm">‚úï Cerrar</button>
                    </div>
                    <iframe id="personalPreviewFrame" class="w-full h-96 border border-gray-200 rounded-lg"></iframe>
                </div>

                <!-- Lista colaboradores con estado -->
                <div id="personalList" class="space-y-3 mt-4"></div>
            </div>

            <!-- Test Tab -->
            <div id="content-test" class="tab-content p-6 hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Enviar Email de Prueba</h3>
                <form id="emailForm" class="space-y-4 max-w-2xl">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="emailTo" required 
                            class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-transparent" 
                            placeholder="destinatario@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asunto</label>
                        <input type="text" id="emailSubject" required 
                            class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-transparent" 
                            placeholder="Asunto del correo">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mensaje</label>
                        <textarea id="emailBody" rows="6" required 
                            class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-orange-500 focus:border-transparent" 
                            placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                    </div>
                    <button type="submit" 
                        class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 rounded-lg transition-colors">
                        üìß Enviar Email
                    </button>
                </form>
            </div>
        </div>

        <div id="statusMessage" class="hidden"></div>
    </main>

    <!-- Preview Modal -->
    <div id="previewModal" class="hidden fixed inset-0 bg-black/50 z-50 p-4 overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center">
            <div class="bg-white rounded-xl w-full max-w-4xl shadow-2xl">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">üëÅÔ∏è Preview</h3>
                    <button data-action="closePreview" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <iframe id="previewFrame" class="w-full h-[60vh] sm:h-[70vh]"></iframe>
                <div class="flex gap-3 p-4 border-t">
                    <button data-action="closePreview" 
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2.5 rounded-lg transition-colors">
                        Cerrar
                    </button>
                    <button data-action="sendFromPreview" 
                        class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2.5 rounded-lg transition-colors">
                        üìß Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Payment Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black/50 z-50 p-4 overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center">
            <div class="bg-white rounded-xl w-full max-w-md shadow-2xl">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">üí∞ Pago Manual</h3>
                    <button data-action="closePayment" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="p-6">
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-2">Usuario</p>
                        <p id="payUserName" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-2">Monto a Pagar</p>
                        <p id="payAmount" class="text-3xl font-bold text-green-600"></p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">M√©todo de Pago</label>
                        <select id="payMethod" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="transfer">Transferencia Bancaria</option>
                            <option value="cash">Efectivo</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notas (opcional)</label>
                        <textarea id="payNotes" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Ej: Transferencia desde cuenta corriente..."></textarea>
                    </div>
                    
                    <!-- Process Steps -->
                    <div id="processSteps" class="hidden mb-6 space-y-3">
                        <div id="step1" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                            <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-bold">1</div>
                            <span class="text-sm text-gray-600">Registrando transacci√≥n...</span>
                        </div>
                        <div id="step2" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                            <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-bold">2</div>
                            <span class="text-sm text-gray-600">Actualizando cr√©dito...</span>
                        </div>
                        <div id="step3" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                            <div class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-bold">3</div>
                            <span class="text-sm text-gray-600">Enviando email...</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 p-4 border-t">
                    <button data-action="closePayment" 
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2.5 rounded-lg transition-colors">
                        Cancelar
                    </button>
                    <button data-action="confirmPayment" 
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 rounded-lg transition-colors">
                        üí∞ Confirmar Pago
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // @ts-nocheck
        let currentUserId = null;
        let users = [];
        let currentPaymentData = null;

        function renderMorososCard(user) {
            return `
                <div class="bg-red-50 border border-red-300 rounded-lg p-4">
                    <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-gray-900">${user.nombre}</h4>
                            <p class="text-sm text-gray-600">${user.email}</p>
                            <p class="text-xs text-gray-500 mt-1">${user.grado_militar} - ${user.unidad_trabajo}</p>
                            ${user.fecha_ultimo_pago ? `<p class="text-xs text-red-500 mt-1">√öltimo pago: ${user.fecha_ultimo_pago}</p>` : '<p class="text-xs text-red-500 mt-1">Sin pagos registrados</p>'}
                            <div class="mt-2 inline-flex items-center gap-2 bg-red-100 rounded px-3 py-1">
                                <span class="text-xs text-red-600">Debe:</span>
                                <span class="font-bold text-red-700">$${user.credito_usado.toLocaleString('es-CL')}</span>
                            </div>
                        </div>
                        <div class="flex sm:flex-col gap-2">
                            <button data-action="preview" data-user-id="${user.id}"
                                class="flex-1 sm:flex-none bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                Preview
                            </button>
                            <button data-action="send" data-user-id="${user.id}"
                                class="flex-1 sm:flex-none bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                ‚ö†Ô∏è Cobrar
                            </button>
                            <button data-action="whatsapp" data-nombre="${user.nombre}" data-monto="${user.saldo_pagar}" data-grado="${user.grado_militar || ''}" data-dias-mora="${Math.max(0, new Date().getDate() - 21)}"
                                class="flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                üí¨ WhatsApp
                            </button>
                            <button data-action="payManual" data-user-id="${user.id}" data-user-name="${user.nombre}" data-amount="${user.credito_usado}"
                                class="flex-1 sm:flex-none bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                üí∞ Pagar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            const tab = btn.getAttribute('data-tab');
            const userId = btn.getAttribute('data-user-id');
            
            if (action === 'showTab' && tab) showTab(tab);
            if (action === 'sendMassive') sendMassive();
            if (action === 'sendMassiveMorosos') sendMassiveMorosos();
            if (action === 'closePreview') closePreview();
            if (action === 'sendFromPreview') sendFromPreview();
            if (action === 'preview' && userId) previewEmail(parseInt(userId));
            if (action === 'send' && userId) sendEmail(parseInt(userId));
            if (action === 'payManual') openPaymentModal(btn);
            if (action === 'whatsapp') {
                const nombre = btn.dataset.nombre;
                const monto = parseInt(btn.dataset.monto).toLocaleString('es-CL');
                const grado = btn.dataset.grado ? btn.dataset.grado + ' ' : '';
                const diasMora = parseInt(btn.dataset.diasMora || 0);
                const moraLine = diasMora > 0
                    ? `‚ö†Ô∏è *Vencido hace ${diasMora} d√≠a${diasMora === 1 ? '' : 's'}* ‚Äî regulariza cuanto antes`
                    : `‚ö†Ô∏è *Pago vencido* ‚Äî regulariza cuanto antes`;
                const msg = `üîî *Recordatorio de Pago ‚Äî La Ruta 11*

Hola *${grado}${nombre}* üëã

> Tienes un saldo pendiente en tu cr√©dito RL6

*Monto a pagar:* $${monto}
${moraLine}

*C√≥mo pagar:*
1. Ingresa a _app.laruta11.cl_
2. Ve a Perfil ‚Üí Cr√©dito
3. Haz clic en ‚ÄúPagar Cr√©dito‚Äù

_La Ruta 11 ‚Äî Foodtruck_ ‚ú®`;
                navigator.clipboard.writeText(msg).then(() => {
                    const orig = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Copiado';
                    btn.disabled = true;
                    setTimeout(() => { btn.innerHTML = orig; btn.disabled = false; }, 2000);
                });
            }
            if (action === 'closePayment') closePaymentModal();
            if (action === 'confirmPayment') processManualPayment();
        });

        window.addEventListener('DOMContentLoaded', () => {
            checkGmailStatus();
            loadUsers();
            loadDailyStats();

            // Hamburger menu
            const menuBtn = document.getElementById('menuBtn');
            const menuDropdown = document.getElementById('menuDropdown');
            menuBtn.addEventListener('click', (e) => { e.stopPropagation(); menuDropdown.classList.toggle('hidden'); });
            document.addEventListener('click', () => menuDropdown.classList.add('hidden'));

            document.getElementById('btnInformeStatus').addEventListener('click', () => {
                menuDropdown.classList.add('hidden');
                if (!users.length) return alert('Cargando datos...');
                const hoy = new Date().toLocaleDateString('es-CL', { day: 'numeric', month: 'long', year: 'numeric' });
                const mesActual = new Date().toISOString().slice(0, 7);
                const proximoMes = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 21)
                    .toLocaleDateString('es-CL', { day: 'numeric', month: 'long' });
                const morosos = users.filter(u => u.es_moroso);
                const pagaronEsteMes = users.filter(u => !u.es_moroso && u.fecha_ultimo_pago?.startsWith(mesActual));
                const conDeudaVigente = users.filter(u => !u.es_moroso && !u.fecha_ultimo_pago?.startsWith(mesActual) && u.credito_usado > 0);
                const sinUso = users.filter(u => !u.es_moroso && u.credito_usado <= 0 && !u.fecha_ultimo_pago);
                const totalDeuda = morosos.reduce((s, u) => s + u.saldo_pagar, 0);
                const totalPagado = pagaronEsteMes.reduce((s, u) => s + u.pagado_este_mes, 0);
                const day = new Date().getDate();
                const diasMora = Math.max(0, day - 21);

                let lines = [`üìä *Informe RL6 ‚Äî La Ruta 11*`, `_${hoy}_`, ``];
                lines.push(`*Resumen General*`);
                lines.push(`- Clientes activos: *${users.length}*`);
                lines.push(`- Morosos: *${morosos.length}*`);
                lines.push(`- Pagaron este mes: *${pagaronEsteMes.length}*`);
                lines.push(`- Cr√©dito vigente (cobrar 21/${proximoMes}): *${conDeudaVigente.length}*`);
                lines.push(`- Sin uso de cr√©dito: *${sinUso.length}*`);
                lines.push(`- Total cobranza pendiente: *$${totalDeuda.toLocaleString('es-CL')}*`);
                lines.push(`- Total recaudado este mes: *$${totalPagado.toLocaleString('es-CL')}*`);

                if (morosos.length) {
                    lines.push(``, `*üî¥ Morosos (${diasMora} d√≠a${diasMora===1?'':'s'} en mora)*`);
                    morosos.forEach(u => {
                        const grado = u.grado_militar ? u.grado_militar + ' ' : '';
                        lines.push(`- ${grado}${u.nombre}: *$${u.saldo_pagar.toLocaleString('es-CL')}*`);
                    });
                }

                if (pagaronEsteMes.length) {
                    lines.push(``, `*‚úÖ Pagaron este mes*`);
                    pagaronEsteMes.forEach(u => {
                        const grado = u.grado_militar ? u.grado_militar + ' ' : '';
                        const monto = u.pagado_este_mes > 0 ? ` ‚Äî $${u.pagado_este_mes.toLocaleString('es-CL')}` : '';
                        const deuda = u.credito_usado > 0 ? ` _(cobrar el ${proximoMes} $${u.credito_usado.toLocaleString('es-CL')})_` : '';
                        lines.push(`- ${grado}${u.nombre} _(${u.fecha_ultimo_pago})_${monto}${deuda}`);
                    });
                    lines.push(`> *Total recaudado: $${totalPagado.toLocaleString('es-CL')}*`);
                }

                if (conDeudaVigente.length) {
                    lines.push(``, `*üü° Cr√©dito vigente (cobrar el ${proximoMes})*`);
                    conDeudaVigente.forEach(u => {
                        const grado = u.grado_militar ? u.grado_militar + ' ' : '';
                        lines.push(`- ${grado}${u.nombre}: $${u.credito_usado.toLocaleString('es-CL')}`);
                    });
                }

                if (sinUso.length) {
                    lines.push(``, `*‚ö™ Sin uso de cr√©dito*`);
                    sinUso.forEach(u => {
                        const grado = u.grado_militar ? u.grado_militar + ' ' : '';
                        lines.push(`- ${grado}${u.nombre}`);
                    });
                }

                lines.push(``, `_La Ruta 11 ‚Äî Foodtruck_ ‚ú®`);

                navigator.clipboard.writeText(lines.join('\n')).then(() => {
                    const btn = document.getElementById('btnInformeStatus');
                    btn.textContent = '‚úÖ Copiado';
                    setTimeout(() => { btn.textContent = 'üìã Copiar Informe de Status'; }, 2000);
                });
            });
        });

        async function checkGmailStatus() {
            const statusDiv = document.getElementById('gmailStatus');
            try {
                const response = await fetch('/api/gmail/check_token.php');
                const result = await response.json();
                if (result.access_token) {
                    statusDiv.innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full"></div><span class="hidden sm:inline text-green-700 font-medium">Conectado</span>';
                    statusDiv.className = 'flex items-center gap-2 px-3 py-2 bg-green-50 rounded-full text-sm';
                } else {
                    statusDiv.innerHTML = '<div class="w-2 h-2 bg-red-500 rounded-full"></div><span class="hidden sm:inline text-red-700 font-medium">Error</span>';
                    statusDiv.className = 'flex items-center gap-2 px-3 py-2 bg-red-50 rounded-full text-sm';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="w-2 h-2 bg-red-500 rounded-full"></div><span class="hidden sm:inline text-red-700 font-medium">Error</span>';
                statusDiv.className = 'flex items-center gap-2 px-3 py-2 bg-red-50 rounded-full text-sm';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/gmail/get_rl6_users.php');
                const result = await response.json();
                if (result.success) {
                    users = result.users;
                    window.vencioEsteMes = result.vencio_este_mes;
                    window.diaVencimiento = result.dia_vencimiento;
                    renderUsers(users);
                    // Mostrar aviso si a√∫n no vence
                    const aviso = document.getElementById('avisoVencimiento');
                    if (aviso) {
                        aviso.textContent = result.vencio_este_mes
                            ? `‚ö†Ô∏è Venci√≥ el ${result.dia_vencimiento} ‚Äî hay morosos`
                            : `üìÖ Vence el ${result.dia_vencimiento} ‚Äî sin morosos a√∫n`;
                        aviso.className = `text-xs px-3 py-1 rounded-full font-medium ${result.vencio_este_mes ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`;
                    }
                }
            } catch (error) {
                document.getElementById('usersList').innerHTML = '<div class="text-center text-red-500 py-12">Error cargando usuarios</div>';
            }
        }

        async function loadDailyStats() {
            try {
                const response = await fetch('/api/gmail/get_rl6_daily_stats.php');
                const result = await response.json();
                if (result.success) {
                    document.getElementById('statPagaronHoy').textContent = result.pagos_hoy.usuarios_pagaron;
                    document.getElementById('statTotalPagado').textContent = '$' + Math.round(result.pagos_hoy.total_pagado).toLocaleString('es-CL');
                    document.getElementById('statUsuariosPagaronTotal').textContent = result.pagos_historico.usuarios_pagaron_total;
                    document.getElementById('statMontoPagadoTotal').textContent = '$' + Math.round(result.pagos_historico.monto_pagado_total).toLocaleString('es-CL');
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        function renderUsers(userList) {
            const container = document.getElementById('usersList');
            
            if (userList.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-12">No hay usuarios con cr√©dito RL6</div>';
                return;
            }
            
            // Morosos primero
            userList.sort((a, b) => (b.es_moroso ? 1 : 0) - (a.es_moroso ? 1 : 0));
            
            const totalClientes = userList.length;
            const totalCredito = userList.reduce((sum, u) => sum + u.credito_total, 0);
            const morosos = userList.filter(u => u.es_moroso);
            const totalCobranza = morosos.reduce((sum, u) => sum + u.credito_usado, 0);
            const totalMorosos = morosos.length;
            
            document.getElementById('statClientes').textContent = totalClientes;
            document.getElementById('statCreditoTotal').textContent = '$' + Math.round(totalCredito).toLocaleString('es-CL');
            document.getElementById('statCobranza').textContent = '$' + Math.round(totalCobranza).toLocaleString('es-CL');
            document.getElementById('statMorosos').textContent = totalMorosos;

            // Render morosos tab
            const morososContainer = document.getElementById('morososList');
            const badge = document.getElementById('morososBadge');
            if (totalMorosos > 0) {
                badge.textContent = totalMorosos;
                badge.classList.remove('hidden');
                morososContainer.innerHTML = morosos.map(renderMorososCard).join('');
            } else {
                badge.classList.add('hidden');
                morososContainer.innerHTML = '<div class="text-center text-gray-400 py-12">‚úÖ Sin morosos este mes</div>';
            }
            
            container.innerHTML = userList.map(renderUserCard).join('');
            document.getElementById('sendMassiveCount').textContent = userList.length;
        }

        let activeFilter = 'todos';

        function renderUserCard(user) {
            return `
                <div class="bg-white border ${user.es_moroso ? 'border-red-300 bg-red-50' : ''} rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <h4 class="font-semibold text-gray-900 truncate">${user.nombre}</h4>
                                ${user.es_moroso ? '<span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-0.5 rounded-full">üî¥ MOROSO</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600 truncate">${user.email}</p>
                            <p class="text-xs text-gray-500 mt-1">${user.grado_militar} - ${user.unidad_trabajo}</p>
                            ${user.fecha_ultimo_pago ? `<span class="inline-block mt-1 px-2 py-0.5 bg-green-100 text-green-800 text-xs font-bold rounded-full">‚úÖ Pag√≥: ${user.fecha_ultimo_pago}</span>` : '<span class="inline-block mt-1 px-2 py-0.5 bg-red-100 text-red-700 text-xs font-bold rounded-full">‚ö†Ô∏è Sin pagos</span>'}
                            <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
                                <div class="bg-gray-50 rounded p-2">
                                    <p class="text-gray-500 mb-1">Cr√©dito</p>
                                    <p class="font-semibold text-gray-900">$${user.credito_total.toLocaleString('es-CL')}</p>
                                </div>
                                <div class="${user.es_moroso ? 'bg-red-100' : 'bg-orange-50'} rounded p-2">
                                    <p class="${user.es_moroso ? 'text-red-600' : 'text-orange-600'} mb-1">Debe</p>
                                    <p class="font-semibold ${user.es_moroso ? 'text-red-700' : 'text-orange-700'}">$${user.credito_usado.toLocaleString('es-CL')}</p>
                                </div>
                                <div class="bg-green-50 rounded p-2">
                                    <p class="text-green-600 mb-1">Saldo</p>
                                    <p class="font-semibold text-green-700">$${user.credito_disponible.toLocaleString('es-CL')}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex sm:flex-col gap-2">
                            <button data-action="preview" data-user-id="${user.id}" 
                                class="flex-1 sm:flex-none bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <strong>Preview</strong>
                            </button>
                            <button data-action="send" data-user-id="${user.id}" 
                                class="flex-1 sm:flex-none ${user.es_moroso ? 'bg-red-500 hover:bg-red-600' : 'bg-orange-500 hover:bg-orange-600'} text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <strong>${user.es_moroso ? '‚ö†Ô∏è Cobrar' : 'Notificar'}</strong>
                            </button>
                            ${user.credito_usado > 0 ? `
                            <button data-action="payManual" data-user-id="${user.id}" data-user-name="${user.nombre}" data-amount="${user.credito_usado}"
                                class="flex-1 sm:flex-none bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <strong>Prepagar</strong>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        document.addEventListener('click', (e) => {
            const filterBtn = e.target.closest('button[data-filter]');
            if (!filterBtn) return;
            activeFilter = filterBtn.getAttribute('data-filter');
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.className = 'filter-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600';
            });
            filterBtn.className = 'filter-btn px-3 py-1.5 rounded-full text-xs font-medium bg-gray-800 text-white';
            const filtered = activeFilter === 'morosos' ? users.filter(u => u.es_moroso)
                           : activeFilter === 'al_dia' ? users.filter(u => !u.es_moroso)
                           : users;
            document.getElementById('usersList').innerHTML = filtered.map(renderUserCard).join('');
            document.getElementById('sendMassiveCount').textContent = filtered.length;
        });


        function previewEmail(userId) {
            currentUserId = userId;
            document.getElementById('previewFrame').src = `/api/gmail/preview_email_dynamic.php?user_id=${userId}`;
            document.getElementById('previewModal').classList.remove('hidden');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.add('hidden');
            currentUserId = null;
        }

        function openPaymentModal(btn) {
            const userId = parseInt(btn.getAttribute('data-user-id'));
            const userName = btn.getAttribute('data-user-name');
            const amount = parseFloat(btn.getAttribute('data-amount'));
            
            currentPaymentData = { userId, userName, amount };
            
            document.getElementById('payUserName').textContent = userName;
            document.getElementById('payAmount').textContent = '$' + Math.round(amount).toLocaleString('es-CL');
            document.getElementById('payMethod').value = 'transfer';
            document.getElementById('payNotes').value = '';
            document.getElementById('processSteps').classList.add('hidden');
            
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            currentPaymentData = null;
        }

        async function processManualPayment() {
            if (!currentPaymentData) return;
            
            const method = document.getElementById('payMethod').value;
            const notes = document.getElementById('payNotes').value;
            const confirmBtn = document.querySelector('button[data-action="confirmPayment"]');
            const cancelBtn = document.querySelector('button[data-action="closePayment"]');
            
            confirmBtn.disabled = true;
            cancelBtn.disabled = true;
            confirmBtn.textContent = '‚è≥ Procesando...';
            
            document.getElementById('processSteps').classList.remove('hidden');
            
            try {
                // Step 1: Registrar transacci√≥n
                updateStep('step1', 'loading');
                const response = await fetch('/api/rl6/process_manual_payment.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentPaymentData.userId,
                        amount: currentPaymentData.amount,
                        method: method,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    updateStep('step1', 'error');
                    throw new Error(result.error || 'Error al procesar pago');
                }
                
                updateStep('step1', 'success');
                await new Promise(r => setTimeout(r, 300));
                updateStep('step2', 'success');
                await new Promise(r => setTimeout(r, 300));
                updateStep('step3', 'success');
                
                setTimeout(() => {
                    closePaymentModal();
                    showStatus('‚úÖ Pago procesado exitosamente. Email enviado.', 'success');
                    loadUsers();
                }, 1500);
                
            } catch (error) {
                confirmBtn.disabled = false;
                cancelBtn.disabled = false;
                confirmBtn.textContent = 'üí∞ Confirmar Pago';
                showStatus('‚ùå Error: ' + error.message, 'error');
            }
        }

        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            const circle = step.querySelector('div');
            const text = step.querySelector('span');
            
            if (status === 'loading') {
                circle.className = 'w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center animate-pulse';
                circle.innerHTML = '<div class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
                text.className = 'text-sm text-blue-600 font-medium';
            } else if (status === 'success') {
                circle.className = 'w-6 h-6 rounded-full bg-green-500 flex items-center justify-center';
                circle.textContent = '‚úì';
                text.className = 'text-sm text-green-600 font-medium';
            } else if (status === 'error') {
                circle.className = 'w-6 h-6 rounded-full bg-red-500 flex items-center justify-center';
                circle.textContent = '‚úó';
                text.className = 'text-sm text-red-600 font-medium';
            }
        }

        async function sendFromPreview() {
            if (currentUserId) {
                await sendEmail(currentUserId);
                closePreview();
            }
        }

        async function sendEmail(userId) {
            showStatus('Enviando email...', 'info');
            try {
                const response = await fetch(`/api/gmail/send_dynamic_email.php?user_id=${userId}`);
                const result = await response.json();
                if (result.success) {
                    const tipos = { recordatorio: 'üìÖ Recordatorio', moroso: '‚ö†Ô∏è Mora', sin_deuda: '‚úÖ Al d√≠a' };
                    showStatus(`‚úÖ Email enviado a ${result.to} (${tipos[result.tipo] || result.tipo})`, 'success');
                } else {
                    showStatus(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Error de conexi√≥n', 'error');
            }
        }

        async function sendMassiveMorosos() {
            const morosos = users.filter(u => u.es_moroso);
            if (morosos.length === 0) return showStatus('No hay morosos', 'info');
            if (!confirm(`¬øEnviar cobro a ${morosos.length} morosos?`)) return;

            const btn = document.querySelector('button[data-action="sendMassiveMorosos"]');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Enviando...';

            let sent = 0, failed = 0;
            for (const user of morosos) {
                try {
                    const res = await fetch(`/api/gmail/send_dynamic_email.php?user_id=${user.id}`);
                    const r = await res.json();
                    r.success ? sent++ : failed++;
                } catch { failed++; }
                await new Promise(r => setTimeout(r, 500));
            }

            btn.disabled = false;
            btn.innerHTML = '‚ö†Ô∏è Cobrar a Todos';
            showStatus(`‚úÖ Completado: ${sent} enviados, ${failed} fallidos`, sent === morosos.length ? 'success' : 'error');
        }

        async function sendMassive() {
            const filtered = activeFilter === 'morosos' ? users.filter(u => u.es_moroso)
                           : activeFilter === 'al_dia' ? users.filter(u => !u.es_moroso)
                           : users;
            if (!confirm(`¬øEnviar estado de cuenta a ${filtered.length} usuarios?`)) return;
            
            const btn = document.querySelector('button[data-action="sendMassive"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Enviando...';
            
            showStatus(`Enviando ${filtered.length} emails...`, 'info');
            
            let sent = 0, failed = 0;
            
            for (const user of filtered) {
                try {
                    const response = await fetch(`/api/gmail/send_dynamic_email.php?user_id=${user.id}`);
                    const result = await response.json();
                    result.success ? sent++ : failed++;
                    showStatus(`Enviando... ${sent + failed}/${users.length} (${sent} ‚úì, ${failed} ‚úó)`, 'info');
                } catch (error) {
                    failed++;
                }
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            btn.disabled = false;
            btn.innerHTML = originalText;
            showStatus(`‚úÖ Completado: ${sent} enviados, ${failed} fallidos`, sent === users.length ? 'success' : 'error');
        }

        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('to', document.getElementById('emailTo').value);
            formData.append('subject', document.getElementById('emailSubject').value);
            formData.append('body', document.getElementById('emailBody').value);
            
            showStatus('Enviando email...', 'info');
            try {
                const response = await fetch('/api/gmail/send_email.php', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    showStatus('‚úÖ Email enviado', 'success');
                    e.target.reset();
                } else {
                    showStatus(`‚ùå Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus('‚ùå Error de conexi√≥n', 'error');
            }
        });

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            const colors = {
                success: 'bg-green-50 border-l-4 border-green-500 text-green-700',
                error: 'bg-red-50 border-l-4 border-red-500 text-red-700',
                info: 'bg-blue-50 border-l-4 border-blue-500 text-blue-700'
            };
            statusDiv.className = `p-4 rounded-lg ${colors[type]}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            if (type !== 'info') setTimeout(() => statusDiv.classList.add('hidden'), 5000);
        }
        // ===== TAB PERSONAL =====
        let personalData = [];

        async function loadPersonalTab() {
            const mesInput = document.getElementById('personalMes');
            if (!mesInput.value) {
                const now = new Date();
                mesInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            }
            try {
                const [pRes, pnRes] = await Promise.all([
                    fetch('/api/personal/get_personal.php'),
                    fetch(`/api/personal/get_pagos_nomina.php?mes=${mesInput.value}`)
                ]);
                const [p, pn] = await Promise.all([pRes.json(), pnRes.json()]);
                if (p.success) {
                    personalData = p.data;
                    const sel = document.getElementById('personalSelector');
                    sel.innerHTML = '<option value="">Seleccionar...</option>';
                    p.data.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = `${c.nombre} (${c.rol})`;
                        sel.appendChild(opt);
                    });
                }
                if (pn.success) renderPersonalList(pn.data, pn.presupuesto);
            } catch(e) { console.error(e); }
        }

        function renderPersonalList(pagos, presupuesto) {
            const container = document.getElementById('personalList');
            if (!pagos.length) { container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Sin pagos registrados para este mes</p>'; return; }
            const total = pagos.reduce((s,p) => s + parseFloat(p.monto), 0);
            container.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-3 mb-3 flex justify-between items-center">
                    <span class="text-sm font-semibold text-gray-700">Total n√≥mina</span>
                    <span class="font-bold text-gray-900">$${total.toLocaleString('es-CL')} / $${presupuesto.toLocaleString('es-CL')}</span>
                </div>
                ${pagos.map(p => `
                <div class="flex items-center justify-between p-3 bg-white border rounded-lg">
                    <div>
                        <span class="font-semibold text-sm text-gray-900">${p.nombre}</span>
                        <span class="ml-2 text-xs px-2 py-0.5 rounded-full ${p.es_externo ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'}">${p.es_externo ? 'Externo' : 'Titular'}</span>
                        ${p.notas ? `<p class="text-xs text-gray-400 mt-0.5">${p.notas}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-green-600">$${parseFloat(p.monto).toLocaleString('es-CL')}</span>
                        <button onclick="sendPersonalEmailById(${p.personal_id || 0}, '${p.nombre}')" class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-lg transition-colors">üìß</button>
                    </div>
                </div>`).join('')}
            `;
        }

        function previewPersonalEmail() {
            const personalId = document.getElementById('personalSelector').value;
            const mes = document.getElementById('personalMes').value;
            if (!personalId || !mes) return showStatus('Selecciona mes y colaborador', 'error');
            const container = document.getElementById('personalPreviewContainer');
            document.getElementById('personalPreviewFrame').src = `/api/personal/preview_liquidacion_email.php?personal_id=${personalId}&mes=${mes}`;
            container.classList.remove('hidden');
        }

        async function sendPersonalEmail() {
            const personalId = document.getElementById('personalSelector').value;
            const mes = document.getElementById('personalMes').value;
            if (!personalId || !mes) return showStatus('Selecciona mes y colaborador', 'error');
            await sendPersonalEmailById(parseInt(personalId), null, mes);
        }

        async function sendPersonalEmailById(personalId, nombre, mes) {
            if (!mes) mes = document.getElementById('personalMes').value;
            if (!mes) { showStatus('Selecciona el mes', 'error'); return; }
            const btn = document.getElementById('btnSendPersonal');
            if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Enviando...'; }
            try {
                const res = await fetch('/api/personal/send_liquidacion_email.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ personal_id: personalId, mes })
                });
                const r = await res.json();
                showStatus(r.success ? `‚úÖ Email enviado a ${r.email || nombre}` : `‚ùå ${r.error}`, r.success ? 'success' : 'error');
            } catch { showStatus('‚ùå Error de conexi√≥n', 'error'); }
            if (btn) { btn.disabled = false; btn.textContent = 'üìß Enviar'; }
        }

        document.getElementById('personalMes')?.addEventListener('change', loadPersonalTab);

        window.previewPersonalEmail = previewPersonalEmail;
        window.sendPersonalEmail = sendPersonalEmail;
        window.sendPersonalEmailById = sendPersonalEmailById;

        // Cargar tab personal cuando se activa
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-orange-500', 'text-orange-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`tab-${tab}`).classList.add('border-orange-500', 'text-orange-600');
            document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            if (tab === 'personal') loadPersonalTab();
        }

    </script>
</body>
</html>
