<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - La Ruta 11</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #f8fafc;
      min-height: 100vh;
    }
    .header { 
      background: white; 
      padding: 1.5rem 2rem; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .back-btn { 
      background: #667eea; 
      color: white; 
      border: none; 
      padding: 0.75rem 1.5rem; 
      border-radius: 8px; 
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .back-btn:hover { background: #5a67d8; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .metric-card { 
      background: white; 
      padding: 2rem; 
      border-radius: 12px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      text-align: center;
    }
    .metric-icon { margin-bottom: 1rem; }
    h1 { display: flex; align-items: center; gap: 12px; }
    .header-icon { flex-shrink: 0; }
    .metric-value { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
    .metric-label { color: #718096; font-size: 0.9rem; }
    .green { color: #38a169; }
    .blue { color: #3182ce; }
    .purple { color: #805ad5; }
    .orange { color: #dd6b20; }
    .metrics { margin-bottom: 2rem; }
    .metric-card { position: relative; }
    .metric-card:hover { transform: translateY(-2px); transition: transform 0.2s; }
  </style>
</head>
<body>
  <div class="header">
    <h1><svg class="header-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v5h5"/><path d="M6 17l4-4 4 4 6-6"/><path d="M18 7h3v5"/></svg> Dashboard</h1>
    <a href="/admin" class="back-btn">â† Volver</a>
  </div>
  
  <div class="container">
    <!-- Resumen General -->
    <div class="metrics">
      <div class="metric-card">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ’°</div>
        <div class="metric-value green" id="sales">$0</div>
        <div class="metric-label">Ventas Hoy</div>
      </div>
      
      <div class="metric-card">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“¦</div>
        <div class="metric-value" style="color: #dc2626;" id="costs">$0</div>
        <div class="metric-label">Costos Hoy</div>
      </div>
      
      <div class="metric-card">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“ˆ</div>
        <div class="metric-value blue" id="profit">$0</div>
        <div class="metric-label">Utilidad Hoy</div>
      </div>
      
      <div class="metric-card">
        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ§¾</div>
        <div class="metric-value purple" id="orders">0</div>
        <div class="metric-label">Ã“rdenes Hoy</div>
      </div>
    </div>
    
    <!-- Desglose por MÃ©todo de Pago -->
    <div style="margin-bottom: 2rem;">
      <h2 style="font-size: 1.5rem; font-weight: bold; color: #374151; margin-bottom: 1.5rem;">ğŸ’³ Desglose por MÃ©todo de Pago (Hoy)</h2>
      <div class="metrics" id="payment-methods-grid">
        <!-- Se llenarÃ¡ dinÃ¡micamente -->
      </div>
    </div>
    
    <!-- MÃ©tricas de comportamiento -->
    <div class="metrics">
      <div class="metric-card">
        <svg class="metric-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
        <div class="metric-value" style="color: #f59e0b;" id="interactions">0</div>
        <div class="metric-label">Interacciones</div>
      </div>
      
      <div class="metric-card">
        <svg class="metric-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        <div class="metric-value" style="color: #10b981;" id="avg-time">0s</div>
        <div class="metric-label">Tiempo Promedio</div>
      </div>
      
      <div class="metric-card">
        <svg class="metric-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        <div class="metric-value" style="color: #8b5cf6;" id="top-product">-</div>
        <div class="metric-label">Producto Top</div>
      </div>
      
      <div class="metric-card">
        <svg class="metric-icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v5h5"/><path d="M6 17l4-4 4 4 6-6"/><path d="M18 7h3v5"/></svg>
        <div class="metric-value" style="color: #8b5cf6; font-size: 1.5rem;">ğŸ“Š</div>
        <div class="metric-label">Analytics</div>
        <a href="/admin/analytics" class="back-btn" style="margin-top: 1rem; font-size: 0.8rem; padding: 0.5rem 1rem;">Ver Detalles</a>
      </div>
    </div>
    
    <!-- SecciÃ³n Robots -->
    <div style="margin-top: 3rem;">
      <h2 style="font-size: 1.5rem; font-weight: bold; color: #374151; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
        ğŸ¤– Robots de Testing
      </h2>
      <div class="metrics">
        <div class="metric-card" style="text-align: left;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="font-size: 2rem;">ğŸ¤–</div>
            <div>
              <h3 style="font-size: 1.1rem; font-weight: bold; color: #374151; margin-bottom: 0.25rem;">Robot Test Tracking</h3>
              <p style="color: #6b7280; font-size: 0.9rem;">Simula usuario real y verifica que el tracking funcione</p>
            </div>
          </div>
          <div style="display: flex; gap: 0.75rem;">
            <a href="/api/robot_test_tracking.php" target="_blank" class="back-btn" style="margin: 0; font-size: 0.8rem; padding: 0.5rem 1rem; background: #10b981;">ğŸš€ Ejecutar Robot</a>
            <button onclick="window.open('/api/robot_test_tracking.php', '_blank')" class="back-btn" style="margin: 0; font-size: 0.8rem; padding: 0.5rem 1rem; background: #6b7280;">ğŸ“Š Ver Estado</button>
          </div>
        </div>
        
        <div class="metric-card" style="text-align: left;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="font-size: 2rem;">ğŸ“Š</div>
            <div>
              <h3 style="font-size: 1.1rem; font-weight: bold; color: #374151; margin-bottom: 0.25rem;">Test APIs</h3>
              <p style="color: #6b7280; font-size: 0.9rem;">Prueba individual de cada API de tracking</p>
            </div>
          </div>
          <div style="display: flex; gap: 0.75rem;">
            <a href="/api/test_analytics_system.php" target="_blank" class="back-btn" style="margin: 0; font-size: 0.8rem; padding: 0.5rem 1rem; background: #3b82f6;">ğŸ§ª Test APIs</a>
            <a href="/api/check_tracking_data.php" target="_blank" class="back-btn" style="margin: 0; font-size: 0.8rem; padding: 0.5rem 1rem; background: #8b5cf6;">ğŸ“‹ Ver Datos</a>
          </div>
        </div>
        
        <div class="metric-card" style="text-align: left;">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="font-size: 2rem;">âš™ï¸</div>
            <div>
              <h3 style="font-size: 1.1rem; font-weight: bold; color: #374151; margin-bottom: 0.25rem;">ConfiguraciÃ³n</h3>
              <p style="color: #6b7280; font-size: 0.9rem;">Verificar tablas y estructura de base de datos</p>
            </div>
          </div>
          <div style="display: flex; gap: 0.75rem;">
            <a href="/api/check_visits_table.php" target="_blank" class="back-btn" style="margin: 0; font-size: 0.8rem; padding: 0.5rem 1rem; background: #f59e0b;">ğŸ—„ï¸ Ver Tablas</a>
            <a href="/api/update_visits_table.php" target="_blank" class="back-btn" style="margin: 0; font-size: 0.8rem; padding: 0.5rem 1rem; background: #ef4444;">ğŸ”§ Actualizar</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Verificar auth
    fetch('/api/check_admin_auth.php')
      .then(r => r.json())
      .then(data => {
        if (!data.authenticated) window.location.href = '/admin/login';
      });
    
    // Cargar datos de TUU
    async function loadTUUData() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`/api/tuu/get_from_mysql.php?start_date=${today}&end_date=${today}&t=${Date.now()}`);
        const data = await response.json();
        
        if (data.success && data.data) {
          const transactions = data.data.all_transactions || [];
          let totalSales = 0, totalCost = 0;
          const paymentMethods = {
            'card': { icon: 'ğŸ’³', label: 'Tarjetas', sales: 0, cost: 0, orders: 0 },
            'transfer': { icon: 'ğŸ¦', label: 'Transfer', sales: 0, cost: 0, orders: 0 },
            'cash': { icon: 'ğŸ’µ', label: 'Efectivo', sales: 0, cost: 0, orders: 0 },
            'webpay': { icon: 'ğŸ’³', label: 'Webpay', sales: 0, cost: 0, orders: 0 },
            'pedidosya': { icon: 'ğŸ›µ', label: 'PedidosYA', sales: 0, cost: 0, orders: 0 }
          };
          let totalDeliveryFee = 0;
          
          transactions.forEach(t => {
            const amount = parseFloat(t.amount || 0);
            const cost = amount * 0.35;
            const method = t.payment_method || 'cash';
            totalSales += amount;
            totalCost += cost;
            totalDeliveryFee += parseFloat(t.delivery_fee || 0);
            if (paymentMethods[method]) {
              paymentMethods[method].sales += amount;
              paymentMethods[method].cost += cost;
              paymentMethods[method].orders += 1;
            }
          });
          
          const salesEl = document.getElementById('sales');
          const costsEl = document.getElementById('costs');
          const profitEl = document.getElementById('profit');
          const ordersEl = document.getElementById('orders');
          
          if (salesEl) salesEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(totalSales);
          if (costsEl) costsEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(totalCost);
          if (profitEl) profitEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(totalSales - totalCost);
          if (ordersEl) ordersEl.textContent = transactions.length.toString();
          
          const grid = document.getElementById('payment-methods-grid');
          if (grid) {
            grid.innerHTML = Object.entries(paymentMethods).map(([k, d]) => {
              const profit = d.sales - d.cost;
              const profitPercent = d.sales > 0 ? ((profit / d.sales) * 100).toFixed(1) : 0;
              return `<div class="metric-card" style="border-left: 4px solid ${d.sales > 0 ? '#10b981' : '#e5e5e5'}; text-align: left;"><div style="font-size: 1.75rem; font-weight: 700; color: #059669; margin-bottom: 0.5rem;">${d.icon} $${new Intl.NumberFormat('es-CL').format(d.sales)}</div><div style="font-size: 0.9rem; color: #666; margin-bottom: 0.75rem; font-weight: 600;">${d.label}</div><div style="font-size: 0.8rem; color: #999; margin-bottom: 0.25rem;">ğŸ“¦ Costo: $${new Intl.NumberFormat('es-CL').format(d.cost)}</div><div style="font-size: 0.8rem; color: #0284c7; margin-bottom: 0.25rem;">ğŸ“ˆ Utilidad: $${new Intl.NumberFormat('es-CL').format(profit)} (${profitPercent}%)</div><div style="font-size: 0.8rem; color: #666;">${d.orders} pedidos</div></div>`;
            }).join('');
            if (totalDeliveryFee > 0) {
              grid.innerHTML += `<div class="metric-card" style="border-left: 4px solid #f59e0b; text-align: left;"><div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b; margin-bottom: 0.5rem;">ğŸï¸ $${new Intl.NumberFormat('es-CL').format(totalDeliveryFee)}</div><div style="font-size: 0.9rem; color: #666; font-weight: 600;">Delivery (Rider)</div></div>`;
            }
          }
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    loadTUUData();
    setInterval(loadTUUData, 30000);
    
    // Cargar mÃ©tricas de comportamiento
    fetch('/api/app/get_user_behavior.php')
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // Total interacciones
          const totalInteractions = data.data.interactions_today.reduce((sum, item) => sum + parseInt(item.count), 0);
          const interactionsEl = document.getElementById('interactions');
          if (interactionsEl) interactionsEl.textContent = totalInteractions;
          
          // Tiempo promedio
          const avgTime = data.data.engagement?.avg_time ? Math.round(data.data.engagement.avg_time) : 0;
          const avgTimeEl = document.getElementById('avg-time');
          if (avgTimeEl) avgTimeEl.textContent = avgTime + 's';
          
          // Producto mÃ¡s popular
          const topProduct = data.data.top_products[0];
          const topProductEl = document.getElementById('top-product');
          if (topProduct && topProductEl) {
            const productName = topProduct.product_name.length > 15 
              ? topProduct.product_name.substring(0, 15) + '...' 
              : topProduct.product_name;
            topProductEl.textContent = productName;
          }
        }
      })
      .catch(console.error);
    
    // Cargar mÃ©tricas de visitas
    fetch('/api/app/get_analytics.php')
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          const pendingEl = document.getElementById('pending');
          if (pendingEl) pendingEl.textContent = data.data.visitors.today;
        }
      })
      .catch(console.error);
  </script>
</body>
</html>