---
---

<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estadísticas Concurso - Admin La Ruta 11</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; font-weight: 700; color: #ea580c; }
        .stat-label { color: #64748b; font-size: 0.9rem; margin-top: 5px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .source-list { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
        .source-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
        .source-item:last-child { border-bottom: none; }
        .source-code { font-weight: 600; color: #1e293b; }
        .source-visits { color: #ea580c; font-weight: 600; }
        .btn { background: #ea580c; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn:hover { background: #c2410c; }
        .links-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .link-item { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; position: relative; }
        .link-url { font-family: monospace; color: #0f172a; word-break: break-all; }
        .link-desc { color: #64748b; font-size: 0.9rem; margin-top: 5px; }
        .copy-btn { position: absolute; top: 15px; right: 15px; background: #ea580c; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 12px; }
        .copy-btn:hover { background: #c2410c; }
        .copy-btn.copied { background: #22c55e; }
        .contestant-row { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .contestant-info { flex: 1; }
        .contestant-actions { display: flex; gap: 8px; }
        .btn-sm { padding: 8px 12px; font-size: 0.875rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-edit:hover { background: #2563eb; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 600; color: #374151; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .form-input:focus { outline: none; border-color: #ea580c; box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1); }
        .form-actions { display: flex; gap: 12px; margin-top: 24px; }
        .btn-primary { background: #ea580c; color: white; flex: 1; }
        .btn-primary:hover { background: #c2410c; }
        .btn-secondary { background: #6b7280; color: white; flex: 1; }
        .btn-secondary:hover { background: #4b5563; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="color: #1e293b; font-size: 1.8rem; font-weight: 700;">
                <i data-lucide="bar-chart-3" style="width: 24px; height: 24px; display: inline; margin-right: 10px;"></i>
                Estadísticas Concurso Inauguración
            </h1>
            <p style="color: #64748b; margin-top: 10px;">Monitoreo de visitas y conversiones</p>
        </div>

        <!-- KPIs Principales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalVisits">-</div>
                <div class="stat-label">Total Visitas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayVisits">-</div>
                <div class="stat-label">Visitas Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalParticipants">-</div>
                <div class="stat-label">Participantes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="conversionRate">-</div>
                <div class="stat-label">Tasa Conversión</div>
            </div>
        </div>

        <!-- Links de Tracking -->
        <div class="links-section">
            <h3 style="color: #1e293b; font-weight: 600; margin-bottom: 15px;">
                <i data-lucide="link" style="width: 20px; height: 20px; display: inline; margin-right: 8px;"></i>
                Links de Seguimiento
            </h3>
            <div class="link-item">
                <div class="link-url">https://app.laruta11.cl/concurso/?source=ARICABKN</div>
                <div class="link-desc">Para campañas de Arica es Bacán</div>
                <button class="copy-btn" onclick="copyLink('https://app.laruta11.cl/concurso/?source=ARICABKN', this)">
                    <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                    Copiar
                </button>
            </div>
            <div class="link-item">
                <div class="link-url">https://app.laruta11.cl/concurso/?source=RUTA11</div>
                <div class="link-desc">Para campañas oficiales de La Ruta 11</div>
                <button class="copy-btn" onclick="copyLink('https://app.laruta11.cl/concurso/?source=RUTA11', this)">
                    <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                    Copiar
                </button>
            </div>
        </div>

        <!-- Gráficos en Grid -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 style="color: #1e293b; font-weight: 600; margin-bottom: 20px;">
                    <i data-lucide="trending-up" style="width: 20px; height: 20px; display: inline; margin-right: 8px;"></i>
                    Visitas por Día (Últimos 7 días)
                </h3>
                <canvas id="dailyChart" width="400" height="200"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 style="color: #1e293b; font-weight: 600; margin-bottom: 20px;">
                    <i data-lucide="pie-chart" style="width: 20px; height: 20px; display: inline; margin-right: 8px;"></i>
                    Visitas por Fuente
                </h3>
                <canvas id="sourcesChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Gestión de Concursantes -->
        <div class="source-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #1e293b; font-weight: 600;">
                    <i data-lucide="users" style="width: 20px; height: 20px; display: inline; margin-right: 8px;"></i>
                    Gestión de Concursantes
                </h3>
                <button id="add-contestant" class="btn">
                    <i data-lucide="plus" style="width: 16px; height: 16px; display: inline; margin-right: 8px;"></i>
                    Agregar Manual
                </button>
            </div>
            <div id="contestants-list" style="max-height: 400px; overflow-y: auto;">Cargando...</div>
        </div>

        <!-- Tabla de Estadísticas por Fuente -->
        <div class="source-list">
            <h3 style="color: #1e293b; font-weight: 600; margin-bottom: 20px;">
                <i data-lucide="bar-chart" style="width: 20px; height: 20px; display: inline; margin-right: 8px;"></i>
                Detalles por Fuente
            </h3>
            <div id="sourceStats">Cargando...</div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="refreshStats()">
                <i data-lucide="refresh-cw" style="width: 16px; height: 16px; display: inline; margin-right: 8px;"></i>
                Actualizar Datos
            </button>
        </div>
    </div>

    <!-- Modal Agregar/Editar Concursante -->
    <div id="contestant-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color: #1e293b; font-weight: 700; margin-bottom: 20px;">Agregar Concursante</h3>
            <form id="contestant-form">
                <input type="hidden" id="contestant-id">
                <div class="form-group">
                    <label class="form-label">Nombre Completo *</label>
                    <input type="text" id="modal-nombre" required class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">RUT *</label>
                    <input type="text" id="modal-rut" required class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" id="modal-email" required class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Teléfono *</label>
                    <input type="tel" id="modal-telefono" required class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Peso (kg) *</label>
                    <input type="number" id="modal-peso" required class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Estado de Pago</label>
                    <select id="modal-payment-status" class="form-input">
                        <option value="unpaid">No Pagado</option>
                        <option value="paid">Pagado</option>
                        <option value="failed">Fallido</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Imagen del Concursante</label>
                    <input type="file" id="modal-image" accept="image/*" class="form-input">
                    <div id="image-preview" style="margin-top: 10px; display: none;">
                        <img id="preview-img" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #d1d5db;">
                        <div id="upload-status" style="margin-top: 8px; font-size: 12px; color: #6b7280;"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save" style="width: 16px; height: 16px; display: inline; margin-right: 8px;"></i>
                        Guardar
                    </button>
                    <button type="button" id="cancel-modal" class="btn btn-secondary">
                        <i data-lucide="x" style="width: 16px; height: 16px; display: inline; margin-right: 8px;"></i>
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // @ts-ignore
        const Chart = window.Chart;
        // @ts-ignore
        const lucide = window.lucide;
        
        let dailyChart;
        let sourcesChart;

        async function loadStats() {
            try {
                const response = await fetch('/api/get_concurso_stats.php');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    // Actualizar KPIs
                    const totalVisitsEl = document.getElementById('totalVisits');
                    const todayVisitsEl = document.getElementById('todayVisits');
                    const totalParticipantsEl = document.getElementById('totalParticipants');
                    const conversionRateEl = document.getElementById('conversionRate');
                    
                    if (totalVisitsEl) totalVisitsEl.textContent = stats.total_visits || '0';
                    if (todayVisitsEl) todayVisitsEl.textContent = stats.today_visits || '0';
                    if (totalParticipantsEl) totalParticipantsEl.textContent = stats.participants || '0';
                    if (conversionRateEl) conversionRateEl.textContent = (stats.conversion_rate || 0) + '%';
                    
                    // Actualizar estadísticas por fuente (tabla)
                    const sourceContainer = document.getElementById('sourceStats');
                    if (sourceContainer) {
                        if (data.sources && data.sources.length > 0) {
                            sourceContainer.innerHTML = data.sources.map(source => `
                                <div class="source-item">
                                    <span class="source-code">${source.source || 'DIRECT'}</span>
                                    <span class="source-visits">${source.visits || 0} visitas (${source.conversion_rate || 0}% conversión)</span>
                                </div>
                            `).join('');
                        } else {
                            sourceContainer.innerHTML = '<p style="color: #64748b;">No hay datos de fuentes aún</p>';
                        }
                    }
                    
                    // Crear gráficos
                    createDailyChart(data.daily_visits || []);
                    createSourcesChart(data.sources || []);
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        function createDailyChart(dailyData) {
            const canvasEl = document.getElementById('dailyChart');
            if (!canvasEl) return;
            
            const ctx = (canvasEl as HTMLCanvasElement).getContext('2d');
            if (!ctx) return;
            
            if (dailyChart) {
                dailyChart.destroy();
            }
            
            const labels = dailyData.map(d => new Date(d.date).toLocaleDateString('es-CL'));
            const visits = dailyData.map(d => d.visits || 0);
            
            // @ts-ignore
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.reverse(),
                    datasets: [{
                        label: 'Visitas',
                        data: visits.reverse(),
                        borderColor: '#ea580c',
                        backgroundColor: 'rgba(234, 88, 12, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        function createSourcesChart(sourcesData) {
            const canvasEl = document.getElementById('sourcesChart');
            if (!canvasEl) return;
            
            const ctx = (canvasEl as HTMLCanvasElement).getContext('2d');
            if (!ctx) return;
            
            if (sourcesChart) {
                sourcesChart.destroy();
            }
            
            const labels = sourcesData.map(s => s.source || 'DIRECT');
            const visits = sourcesData.map(s => s.visits || 0);
            
            // @ts-ignore
            sourcesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: visits,
                        backgroundColor: ['#ea580c', '#64748b', '#22c55e', '#3b82f6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function refreshStats() {
            loadStats();
        }

        function copyLink(url, button) {
            navigator.clipboard.writeText(url).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i data-lucide="check" style="width: 14px; height: 14px;"></i> Copiado';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                    if (typeof lucide !== 'undefined') {
                        // @ts-ignore
                        lucide.createIcons();
                    }
                }, 2000);
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const originalText = button.innerHTML;
                button.innerHTML = '<i data-lucide="check" style="width: 14px; height: 14px;"></i> Copiado';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                    if (typeof lucide !== 'undefined') {
                        // @ts-ignore
                        lucide.createIcons();
                    }
                }, 2000);
            });
        }

        // Gestión de concursantes
        let contestants = [];
        let uploadedImageUrl = null;
        
        // Manejar preview y subida de imagen
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('modal-image') as HTMLInputElement;
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img') as HTMLImageElement;
            const uploadStatus = document.getElementById('upload-status');
            
            if (imageInput) {
                imageInput.addEventListener('change', async function(e) {
                    const target = e.target as HTMLInputElement;
                    const file = target.files?.[0];
                    if (!file) {
                        if (imagePreview) imagePreview.style.display = 'none';
                        uploadedImageUrl = null;
                        return;
                    }
                    
                    // Mostrar preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (previewImg && e.target?.result) {
                            previewImg.src = e.target.result as string;
                        }
                        if (imagePreview) imagePreview.style.display = 'block';
                        if (uploadStatus) {
                            uploadStatus.textContent = 'Preparando subida...';
                            uploadStatus.style.color = '#f59e0b';
                        }
                    };
                    reader.readAsDataURL(file);
                    
                    // Subir a AWS
                    await uploadImageToAWS(file);
                });
            }
        });
        
        async function uploadImageToAWS(file: File) {
            const uploadStatus = document.getElementById('upload-status');
            
            try {
                if (uploadStatus) {
                    uploadStatus.textContent = 'Subiendo imagen...';
                    uploadStatus.style.color = '#f59e0b';
                }
                
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch('/api/upload_image.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadedImageUrl = result.url;
                    if (uploadStatus) {
                        uploadStatus.textContent = `✅ Imagen subida exitosamente${result.compression_info ? ' (' + result.compression_info.replace('Subida exitosa a AWS S3: ' + result.url, '').trim() + ')' : ''}`;
                        uploadStatus.style.color = '#22c55e';
                    }
                } else {
                    uploadedImageUrl = null;
                    if (uploadStatus) {
                        uploadStatus.textContent = '❌ Error: ' + result.error;
                        uploadStatus.style.color = '#ef4444';
                    }
                }
            } catch (error) {
                uploadedImageUrl = null;
                if (uploadStatus) {
                    uploadStatus.textContent = '❌ Error de conexión';
                    uploadStatus.style.color = '#ef4444';
                }
                console.error('Error subiendo imagen:', error);
            }
        }
        
        async function loadContestants() {
            try {
                const response = await fetch('/api/get_participantes_concurso.php');
                const data = await response.json();
                if (data.participantes) {
                    contestants = data.participantes;
                    drawContestants();
                }
            } catch (error) {
                console.error('Error cargando concursantes:', error);
            }
        }
        
        function drawContestants() {
            const container = document.getElementById('contestants-list');
            if (!container) return;
            
            if (contestants.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No hay concursantes registrados</p>';
                return;
            }
            
            container.innerHTML = contestants.map((c: any) => {
                const statusColor = c.payment_status === 'paid' ? '#22c55e' : 
                                  c.payment_status === 'failed' ? '#ef4444' : '#f59e0b';
                const statusText = c.payment_status === 'paid' ? '✅ Pagado' : 
                                 c.payment_status === 'failed' ? '❌ Fallido' : '⏳ Pendiente';
                
                return `
                    <div class="contestant-row">
                        <div class="contestant-info">
                            <div style="font-weight: 600; color: #1e293b;">${c.nombre}</div>
                            <div style="font-size: 0.875rem; color: #64748b; margin-top: 4px;">
                                ${c.rut} | ${c.email} | ${c.peso}kg
                            </div>
                            <div style="font-size: 0.875rem; color: ${statusColor}; margin-top: 4px; font-weight: 500;">
                                ${statusText}
                            </div>
                        </div>
                        <div class="contestant-actions">
                            <button onclick="editContestant(${c.id})" class="btn-sm btn-edit">
                                <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button onclick="deleteContestant(${c.id})" class="btn-sm btn-delete">
                                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (typeof lucide !== 'undefined') {
                // @ts-ignore
                lucide.createIcons();
            }
        }
        
        // Modal functions
        const addBtn = document.getElementById('add-contestant');
        if (addBtn) {
            addBtn.onclick = function() {
                const title = document.getElementById('modal-title');
                const form = document.getElementById('contestant-form') as HTMLFormElement;
                const idInput = document.getElementById('contestant-id') as HTMLInputElement;
                const preview = document.getElementById('image-preview');
                const imageInput = document.getElementById('modal-image') as HTMLInputElement;
                const modal = document.getElementById('contestant-modal');
                
                if (title) title.textContent = 'Agregar Concursante';
                if (form) form.reset();
                if (idInput) idInput.value = '';
                
                // Limpiar imagen
                uploadedImageUrl = null;
                if (preview) preview.style.display = 'none';
                if (imageInput) imageInput.value = '';
                
                if (modal) modal.style.display = 'flex';
            };
        }
        
        const cancelBtn = document.getElementById('cancel-modal');
        if (cancelBtn) {
            cancelBtn.onclick = function() {
                const modal = document.getElementById('contestant-modal');
                if (modal) modal.style.display = 'none';
            };
        }
        
        (window as any).editContestant = function(id: number) {
            const contestant: any = contestants.find((c: any) => c.id == id);
            if (!contestant) return;
            
            const title = document.getElementById('modal-title');
            const idInput = document.getElementById('contestant-id') as HTMLInputElement;
            const nombreInput = document.getElementById('modal-nombre') as HTMLInputElement;
            const rutInput = document.getElementById('modal-rut') as HTMLInputElement;
            const emailInput = document.getElementById('modal-email') as HTMLInputElement;
            const telefonoInput = document.getElementById('modal-telefono') as HTMLInputElement;
            const pesoInput = document.getElementById('modal-peso') as HTMLInputElement;
            const statusSelect = document.getElementById('modal-payment-status') as HTMLSelectElement;
            const modal = document.getElementById('contestant-modal');
            
            if (title) title.textContent = 'Editar Concursante';
            if (idInput) idInput.value = contestant.id;
            if (nombreInput) nombreInput.value = contestant.nombre;
            if (rutInput) rutInput.value = contestant.rut;
            if (emailInput) emailInput.value = contestant.email;
            if (telefonoInput) telefonoInput.value = contestant.telefono;
            if (pesoInput) pesoInput.value = contestant.peso;
            if (statusSelect) statusSelect.value = contestant.payment_status;
            if (modal) modal.style.display = 'flex';
        };
        
        (window as any).deleteContestant = async function(id: number) {
            if (!confirm('¿Eliminar este concursante?')) return;
            
            try {
                const response = await fetch('/api/delete_concursante.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: id})
                });
                const result = await response.json();
                
                if (result.success) {
                    loadContestants();
                    loadStats(); // Actualizar estadísticas
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error eliminando concursante:', error);
                alert('Error de conexión');
            }
        };
        
        const form = document.getElementById('contestant-form');
        if (form) {
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const idInput = document.getElementById('contestant-id') as HTMLInputElement;
                const nombreInput = document.getElementById('modal-nombre') as HTMLInputElement;
                const rutInput = document.getElementById('modal-rut') as HTMLInputElement;
                const emailInput = document.getElementById('modal-email') as HTMLInputElement;
                const telefonoInput = document.getElementById('modal-telefono') as HTMLInputElement;
                const pesoInput = document.getElementById('modal-peso') as HTMLInputElement;
                const statusSelect = document.getElementById('modal-payment-status') as HTMLSelectElement;
                
                const formData = {
                    id: idInput?.value || '',
                    nombre: nombreInput?.value || '',
                    rut: rutInput?.value || '',
                    email: emailInput?.value || '',
                    telefono: telefonoInput?.value || '',
                    peso: parseInt(pesoInput?.value || '0'),
                    payment_status: statusSelect?.value || 'unpaid',
                    mayor_18: 1,
                    image_url: uploadedImageUrl
                };
                
                const url = formData.id ? '/api/update_concursante.php' : '/api/add_concursante_manual.php';
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(formData)
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        const modal = document.getElementById('contestant-modal');
                        if (modal) modal.style.display = 'none';
                        loadContestants();
                        loadStats(); // Actualizar estadísticas
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error guardando concursante:', error);
                    alert('Error de conexión');
                }
            };
        }

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadContestants();
            
            if (typeof lucide !== 'undefined') {
                // @ts-ignore
                lucide.createIcons();
            }
            
            setInterval(() => {
                loadStats();
                loadContestants();
            }, 30000);
        });
    </script>
</body>
</html>