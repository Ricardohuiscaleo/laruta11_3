<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - La Ruta 11</title>
  <link rel="icon" type="image/png" href="https://laruta11-images.s3.amazonaws.com/menu/logo.png" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #fafafa; color: #0a0a0a; line-height: 1.6; }
    
    .app { display: flex; height: 100vh; position: relative; }
    
    /* Mobile-first sidebar */
    .sidebar { 
      width: 280px; 
      background: #ffffff; 
      border-right: 1px solid #e5e5e5; 
      display: flex; 
      flex-direction: column;
      position: fixed;
      left: -280px;
      top: 0;
      height: 100vh;
      z-index: 1000;
      transition: left 0.3s ease;
    }
    .sidebar.open { left: 0; }
    .sidebar-overlay { 
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    .sidebar-overlay.show { display: block; }
    
    .sidebar-header { padding: 16px 24px; border-bottom: 1px solid #e5e5e5; }
    .logo { font-size: 16px; font-weight: 700; color: #0a0a0a; display: flex; align-items: center; gap: 8px; }
    .nav { flex: 1; padding: 8px 0; overflow-y: auto; }
    .nav-item { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      padding: 12px 24px; 
      color: #666; 
      text-decoration: none; 
      transition: all 0.2s; 
      border: none; 
      background: none; 
      width: 100%; 
      cursor: pointer; 
      font-size: 14px;
      min-height: 44px;
    }
    .nav-item:hover { background: #f5f5f5; color: #0a0a0a; }
    .nav-item.active { background: #0a0a0a; color: #ffffff; }
    .nav-icon { width: 20px; height: 20px; flex-shrink: 0; }
    
    .main { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      overflow: hidden;
      margin-left: 0;
      width: 100%;
    }
    .header { 
      background: #ffffff; 
      border-bottom: 1px solid #e5e5e5; 
      padding: 0 16px; 
      height: 64px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .mobile-menu-btn {
      display: block;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      margin-right: 12px;
    }
    .page-title { font-size: 18px; font-weight: 600; color: #0a0a0a; }
    .user-info { display: flex; align-items: center; gap: 8px; color: #666; font-size: 14px; }
    
    .content { flex: 1; overflow: auto; padding: 16px; }
    #dashboard-view .content { padding: 4px; }
    .view { display: none; }
    .view.active { display: block; }
    
    .card { background: #ffffff; border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden; }
    .card-header { padding: 24px; border-bottom: 1px solid #e5e5e5; }
    .card-title { font-size: 16px; font-weight: 600; color: #0a0a0a; }
    .card-content { padding: 24px; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: #0f766e; border: none; border-radius: 8px; padding: 16px; overflow: hidden; }
    .stat-value { font-size: clamp(1.2rem, 3vw, 1.5rem); font-weight: 700; color: #ffffff; margin-bottom: 4px; word-break: break-word; }
    .stat-label { font-size: 14px; color: rgba(255,255,255,0.8); }
    
    .btn { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: #0a0a0a; color: #ffffff; }
    .btn-primary:hover { background: #333; }
    .btn-secondary { background: #f5f5f5; color: #0a0a0a; }
    .btn-secondary:hover { background: #e5e5e5; }
    .btn-danger { background: #ef4444; color: #ffffff; }
    .btn-danger:hover { background: #dc2626; }
    
    .table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table th { text-align: left; padding: 12px; font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #e5e5e5; }
    .table td { padding: 12px; border-bottom: 1px solid #f5f5f5; }
    .table tr:hover { background: #fafafa; }
    
    .input { width: 100%; padding: 12px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 14px; transition: border-color 0.2s; }
    .input:focus { outline: none; border-color: #0a0a0a; }
    
    .toolbar { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
    .search { position: relative; }
    .search input { padding-left: 40px; width: 300px; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #666; }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Desktop styles */
    @media (min-width: 768px) {
      .sidebar {
        position: static;
        left: 0;
      }
      .sidebar-overlay { display: none !important; }
      .mobile-menu-btn { display: none; }
      .header { padding: 0 32px; }
      .content { padding: 32px; }
      #dashboard-view { padding: 4px; }
      .stats-grid { gap: 24px; margin-bottom: 32px; }
      .stat-card { padding: 24px; }
      .stat-value { font-size: 32px; }
      .page-title { font-size: 20px; }
      .user-info { gap: 12px; }
    }
    
    /* Tablet adjustments */
    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    }
    
    /* TUU Reports responsive */
    .tuu-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .tuu-select, .tuu-search {
      padding: 8px;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-size: 14px;
    }
    .tuu-search { min-width: 200px; }
    .tuu-pagination-header {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .tuu-info { font-size: 14px; color: #666; }
    .tuu-pagination-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .tuu-page-info { font-size: 14px; color: #666; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    
    /* Mobile optimizations */
    @media (max-width: 640px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .stat-card { padding: 12px; }
      .stat-value { font-size: 20px; }
      .stat-label { font-size: 12px; }
      .table { font-size: 12px; }
      .table th, .table td { padding: 8px 4px; }
      .btn { padding: 6px 12px; font-size: 12px; }
      .card-content { padding: 16px; }
      .toolbar { flex-direction: column; gap: 12px; align-items: stretch; }
      .search input { width: 100%; }
      
      /* TUU mobile specific */
      .tuu-filters { flex-direction: column; align-items: stretch; }
      .tuu-select, .tuu-search { width: 100%; }
      .tuu-pagination-header { flex-direction: column; align-items: stretch; text-align: center; }
      .tuu-pagination-controls { justify-content: center; }
      .btn-sm { padding: 8px 16px; }
      .tuu-page-info { margin: 0 8px; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script is:inline src="/smart-analysis-loader.js?v=10"></script>
  <script is:inline src="/product-edit-modal-loader.js?v=12"></script>
</head>
<body>
  <!-- Root para el modal de edici√≥n -->
  <div id="product-edit-modal-root"></div>
  <div class="app">
    <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <img src="https://laruta11-images.s3.amazonaws.com/menu/logo.png" width="24" height="24" alt="La Ruta 11" style="border-radius: 4px;">
          La Ruta 11
        </div>
      </div>
      <nav class="nav">
        <button class="nav-item active" onclick="showView('dashboard')" id="nav-dashboard">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
          Dashboard
        </button>
        <button class="nav-item" onclick="showView('sales-analytics')" id="nav-sales-analytics">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
          Control Ventas
        </button>
        <button class="nav-item" onclick="showView('purchase-plan')" id="nav-purchase-plan">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 2v4m6-4v4M4 8h16M3 10h18a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-9a1 1 0 0 1 1-1z"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/></svg>
          Plan de Compras
        </button>
        <button class="nav-item" onclick="showView('payments')" id="nav-payments">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><path d="M2 10h20"/></svg>
          Pagos
        </button>
        <button class="nav-item" onclick="showView('products')" id="nav-products">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
          Productos
        </button>
        <button class="nav-item" onclick="showView('ingredients')" id="nav-ingredients">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
          Ingredientes
        </button>
        <button class="nav-item" onclick="window.location.href='/admin/mermas'" id="nav-mermas">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
          Mermas
        </button>
        <button class="nav-item" onclick="showView('users')" id="nav-users">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-4-4h-1.3"/><circle cx="17" cy="7" r="4"/></svg>
          Usuarios
        </button>
        <button class="nav-item" onclick="showView('militares-rl6')" id="nav-militares-rl6">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
          Militares RL6
        </button>
        <button class="nav-item" onclick="showView('test')" id="nav-test">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          Test APIs
        </button>
        <button class="nav-item" onclick="window.location.href='/admin/food-trucks'" id="nav-trucks">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h2a1 1 0 0 1 1 1v2h-3V8zM4 17h1.5a2.5 2.5 0 0 0 5 0h3a2.5 2.5 0 0 0 5 0H20v-6H4v6zm14.5 1.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm-12 0a1 1 0 1 1 0-2 1 1 0 0 1 0 2zM4 8V6a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2h-2V7H6v1H4z"/></svg>
          Food Trucks
        </button>
        <button class="nav-item" onclick="showView('technical-report')" id="nav-technical-report">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
          Informe T√©cnico
        </button>
        <button class="nav-item" onclick="showView('robots')" id="nav-robots">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="10" x="3" y="11" rx="2"/><circle cx="12" cy="5" r="2"/><path d="m12 7 0 4"/><line x1="8" x2="8" y1="16" y2="16"/><line x1="16" x2="16" y1="16" y2="16"/></svg>
          Robots
        </button>
        <button class="nav-item" onclick="showView('calidad')" id="nav-calidad">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"/><path d="M21 12c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1H3c-.552 0-1 .448-1-1H3c-.552 0-1 .448-1 1v6c0 .552.448 1 1 1h18z"/><path d="M3 12v6c0 .552.448 1 1 1h16c.552 0 1-.448 1-1v-6"/></svg>
          Control Calidad
        </button>
        <button class="nav-item" onclick="window.location.href='/admin/keys'" id="nav-keys">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4"/><path d="m21 2-9.6 9.6"/><circle cx="7.5" cy="15.5" r="5.5"/></svg>
          Keys
        </button>
        <button class="nav-item" onclick="showView('concurso')" id="nav-concurso">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-1.414-.586H13l-2.5-2.5L9 8v6l3 3 2.5-2.5H18.5a2 2 0 0 0 1.414-.586L21 15Z"/></svg>
          Concurso Stats
        </button>
        <button class="nav-item" onclick="showView('concurso-admin')" id="nav-concurso-admin">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/><circle cx="12" cy="12" r="3"/></svg>
          Concurso Admin
        </button>
        <button class="nav-item" onclick="showView('combos')" id="nav-combos">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3z"/><path d="M9 9h6v6H9z"/><path d="M3 9h18"/><path d="M9 3v18"/></svg>
          Gesti√≥n Combos
        </button>
        <button class="nav-item" onclick="showView('reportes')" id="nav-reportes">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18V3z"/><path d="M9 9h2v6H9z"/><path d="M13 13h2v2h-2z"/><path d="M17 7h2v8h-2z"/></svg>
          Reportes
        </button>
        <button class="nav-item" onclick="window.location.href='/admin/reportes'" id="nav-reportes">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18V3z"/><path d="M9 9h2v6H9z"/><path d="M13 13h2v2h-2z"/><path d="M17 7h2v8h-2z"/></svg>
          Reportes
        </button>
      </nav>
    </aside>
    
    <main class="main">
      <header class="header">
        <div style="display: flex; align-items: center;">
          <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
          <h1 class="page-title" id="page-title">Dashboard</h1>
        </div>
        <div class="user-info">
          <div id="header-actions" style="display: flex; align-items: center; gap: 12px;">
            <div id="month-year-display" style="display: none; font-size: 14px; font-weight: 600; color: #0a0a0a; padding: 6px 12px; background: #f3f4f6; border-radius: 6px;"></div>
            <button class="btn btn-secondary" onclick="loadPreviousMonth()" id="prev-month-btn" style="display: none; font-size: 12px;">‚è™ Mes Anterior</button>
            <button class="btn btn-primary" onclick="loadCurrentMonth()" id="current-month-btn" style="display: none; font-size: 12px;">üìÖ Mes Actual</button>
          </div>
          <span id="username">Admin</span>
          <button onclick="logout()" class="btn btn-secondary">Salir</button>
        </div>
      </header>
      
      <div class="content">
        <div class="view active" id="dashboard-view">
          
          <!-- GRID UNIFORME 3x2: Todas las tarjetas del mismo tama√±o -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
          <style>
            @media (max-width: 1024px) {
              div[style*='grid-template-columns: repeat(3, 1fr)'] {
                grid-template-columns: repeat(2, 1fr) !important;
              }
            }
            @media (max-width: 640px) {
              div[style*='grid-template-columns: repeat(3, 1fr)'] {
                grid-template-columns: 1fr !important;
              }
            }
          </style>
            
            <!-- Tarjeta Ventas -->
            <div style="background: #0a0a0a; border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;">
                    <i data-lucide="trending-up" style="width: 24px; height: 24px;"></i>
                  </div>
                  <div>
                    <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">Ventas</div>
                    <div style="font-size: 11px; opacity: 0.7;">Mes actual</div>
                  </div>
                </div>
                <div id="dash-vs-badge" style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px;">
                  <span style="font-size: 10px; font-weight: 700;" id="dash-vs-last-month">+0%</span>
                </div>
              </div>
              <div style="font-size: 28px; font-weight: 700; margin-bottom: 12px;" id="dash-main-sales">$0</div>
              <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px; opacity: 0.9;">
                <div><span style="opacity: 0.7;">Pedidos:</span> <strong id="dash-main-orders">0</strong></div>
                <div><span style="opacity: 0.7;">Ticket:</span> <strong id="dash-main-ticket">$0</strong></div>
                <div><span style="opacity: 0.7;">Top Ingresos:</span> <strong id="dash-main-top-product">-</strong></div>
                <div style="font-size: 11px;"><span style="opacity: 0.6;" id="dash-main-top-money">$0</span> <span style="opacity: 0.5;" id="dash-main-top-percent">(0%)</span></div>
              </div>
            </div>
                
                <!-- Tarjeta Compras -->
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                      <i data-lucide="shopping-cart" style="width: 24px; height: 24px;"></i>
                    </div>
                    <div>
                      <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">Compras</div>
                      <div style="font-size: 11px; opacity: 0.7;">Inversi√≥n Inventario</div>
                    </div>
                  </div>
                  <div style="font-size: 28px; font-weight: 700; margin-bottom: 12px;" id="op-compras-total">$0</div>
                  <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px; opacity: 0.9;">
                    <div><span style="opacity: 0.7;">N√∫mero de compras:</span> <strong id="op-compras-numero">0</strong></div>
                    <div><span style="opacity: 0.7;">Items cr√≠ticos:</span> <strong id="op-compras-criticos">0</strong></div>
                    <div><span style="opacity: 0.7;">Top proveedor:</span> <strong id="op-compras-proveedor">-</strong></div>
                  </div>
                </div>
                
                <!-- Tarjeta Margen Operativo -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                      <i data-lucide="dollar-sign" style="width: 24px; height: 24px;"></i>
                    </div>
                    <div>
                      <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">Margen Bruto</div>
                      <div style="font-size: 11px; opacity: 0.7;">Ventas - CMV</div>
                    </div>
                  </div>
                  <div style="font-size: 28px; font-weight: 700; margin-bottom: 12px;" id="op-margen-total">$0</div>
                  <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px; opacity: 0.9;">
                    <div><span style="opacity: 0.7;">Ventas:</span> <strong id="op-margen-ventas">$0</strong></div>
                    <div><span style="opacity: 0.7;">Compras:</span> <strong id="op-margen-costos">$0</strong></div>
                    <div><span style="opacity: 0.7;">Margen %:</span> <strong id="op-margen-porcentaje">0%</strong></div>
                  </div>
                </div>
                
                <!-- Tarjeta Inventarios -->
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                      <i data-lucide="package" style="width: 24px; height: 24px;"></i>
                    </div>
                    <div>
                      <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">Inventarios</div>
                      <div style="font-size: 11px; opacity: 0.7;">Estado actual</div>
                    </div>
                  </div>
                  <div style="font-size: 28px; font-weight: 700; margin-bottom: 12px;" id="op-inventario-valor">$0</div>
                  <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px; opacity: 0.9;">
                    <div><span style="opacity: 0.7;">Items activos:</span> <strong id="op-inventario-items">0</strong></div>
                    <div><span style="opacity: 0.7;">M√°s Estancado:</span> <strong id="op-inventario-top">-</strong></div>
                    <div style="font-size: 11px;"><span style="opacity: 0.6;" id="op-inventario-top-valor">$0</span> <span style="opacity: 0.5;" id="op-inventario-top-percent">(0%)</span></div>
                    <div style="display: flex; align-items: center; gap: 6px; position: relative;">
                      <span style="opacity: 0.7;">Rotaci√≥n mes:</span>
                      <span id="op-inventario-rotacion-badge" style="padding: 2px 8px; background: #fbbf24; color: #0a0a0a; border-radius: 4px; font-weight: 600; font-size: 11px;">0x</span>
                      <div style="position: relative; display: inline-flex;">
                        <i data-lucide="info" style="width: 14px; height: 14px; color: #666; cursor: help;"></i>
                        <div id="op-inventario-rotacion-tooltip" style="display: none; position: absolute; left: 20px; top: -40px; background: #1f2937; color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; white-space: nowrap; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                          Rotaci√≥n: Cu√°ntas veces renov√≥ el inventario.<br>
                          <strong style="color: #10b981;">‚â• 1.0x:</strong> Saludable | <strong style="color: #fbbf24;">0.5-1.0x:</strong> Cr√≠tico | <strong style="color: #ef4444;">&lt; 0.5x:</strong> Muy bajo
                          <div style="position: absolute; left: -4px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 4px solid transparent; border-bottom: 4px solid transparent; border-right: 4px solid #1f2937;"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Tarjeta Plan de Compras -->
                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                      <i data-lucide="clipboard-list" style="width: 24px; height: 24px;"></i>
                    </div>
                    <div>
                      <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">Plan de Compras</div>
                      <div style="font-size: 11px; opacity: 0.7;">Pr√≥xima reposici√≥n</div>
                    </div>
                  </div>
                  <div style="font-size: 28px; font-weight: 700; margin-bottom: 12px;" id="op-plan-items">0</div>
                  <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px; opacity: 0.9;">
                    <div><span style="opacity: 0.7;">Costo estimado:</span> <strong id="op-plan-costo">$0</strong></div>
                    <div><span style="opacity: 0.7;">Items urgentes:</span> <strong id="op-plan-urgentes">0</strong></div>
                    <div><span style="opacity: 0.7;">D√≠as restantes:</span> <strong id="op-plan-dias">-</strong></div>
                  </div>
                </div>
                
                <!-- Tarjeta Punto de Equilibrio Consolidada -->
                <div id="dash-breakeven-card-main" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                      <i data-lucide="target" style="width: 24px; height: 24px;"></i>
                    </div>
                    <div>
                      <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">Punto de Equilibrio</div>
                      <div style="font-size: 11px; opacity: 0.7;">Falta vender para cubrir sueldos</div>
                    </div>
                  </div>
                  <div style="font-size: 28px; font-weight: 700; margin-bottom: 12px;" id="dash-breakeven-amount-main">$0</div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; font-size: 12px; opacity: 0.9;">
                    <div><span style="opacity: 0.7;">üë• Sueldos:</span> <strong>$1,59M</strong></div>
                    <div><span style="opacity: 0.7;">üìä Margen:</span> <strong id="dash-breakeven-margin">0%</strong></div>
                    <div><span style="opacity: 0.7;">Progreso:</span> <strong id="dash-breakeven-percent-main">0%</strong></div>
                    <div><span style="opacity: 0.7;">üíµ Liquidez:</span> <strong id="dash-cashflow-status-short">-</strong></div>
                  </div>
                  <div style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 10px; padding-top: 8px; font-size: 10px; opacity: 0.7;" id="dash-cashflow-formula">-</div>
                  <div style="margin-top: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; height: 8px; overflow: hidden;">
                    <div id="dash-breakeven-progress-bar" style="background: rgba(255,255,255,0.9); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                  </div>
                </div>
                
          </div>
          
          <!-- Mini KPIs: 6 tarjetas con porcentajes en 1 fila -->
          <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 24px;">
          <style>
            @media (max-width: 1024px) {
              div[style*='grid-template-columns: repeat(6, 1fr)'] {
                grid-template-columns: repeat(3, 1fr) !important;
              }
            }
            @media (max-width: 640px) {
              div[style*='grid-template-columns: repeat(6, 1fr)'] {
                grid-template-columns: repeat(2, 1fr) !important;
              }
            }
          </style>
            
            <div class="stat-card" id="kpi-ticket-card" style="padding: 12px;">
              <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700; margin-bottom: 4px; color: #ffffff;" id="dash-ticket-percent">0%</div>
              <div style="font-size: clamp(0.65rem, 1.5vw, 0.75rem); font-weight: 600; color: #000000;">Ticket Promedio</div>
              <div style="font-size: clamp(0.6rem, 1.3vw, 0.65rem); margin-top: 2px; color: #000000;" id="dash-ticket-detail">$0 / $8.500</div>
            </div>
            
            <div class="stat-card" id="kpi-daily-card" style="padding: 12px;">
              <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700; margin-bottom: 8px; color: #ffffff;" id="dash-daily-percent">0%</div>
              <div style="font-size: clamp(0.65rem, 1.5vw, 0.75rem); font-weight: 600; color: #000000;">Meta Diaria</div>
              <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 6px;">
                <div style="display: inline-block; padding: 3px 8px; background: rgba(0,0,0,0.15); border-radius: 4px; font-size: clamp(0.55rem, 1.2vw, 0.65rem); font-weight: 600; color: #000000;" id="dash-daily-detail">Diaria: $0 / $0</div>
                <div style="display: inline-block; padding: 3px 8px; background: rgba(0,0,0,0.15); border-radius: 4px; font-size: clamp(0.55rem, 1.2vw, 0.65rem); font-weight: 600; color: #000000;" id="dash-daily-acum">Acum: $0 / $0</div>
              </div>
            </div>
            
            <div class="stat-card" id="kpi-monthly-card" style="padding: 12px;">
              <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700; margin-bottom: 8px; color: #ffffff;" id="dash-monthly-progress">0%</div>
              <div style="font-size: clamp(0.65rem, 1.5vw, 0.75rem); font-weight: 600; color: #000000;">Meta Mensual</div>
              <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 6px;">
                <div style="display: inline-block; padding: 3px 8px; background: rgba(0,0,0,0.15); border-radius: 4px; font-size: clamp(0.55rem, 1.2vw, 0.65rem); font-weight: 600; color: #000000;" id="dash-monthly-detail">$0 de $0</div>
                <div style="display: inline-block; padding: 3px 8px; background: rgba(0,0,0,0.15); border-radius: 4px; font-size: clamp(0.55rem, 1.2vw, 0.65rem); font-weight: 600; color: #000000;" id="dash-monthly-extra"></div>
              </div>
            </div>
            
            <div class="stat-card" id="kpi-growth-card" style="padding: 12px;">
              <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700; margin-bottom: 4px; color: #ffffff;" id="dash-growth-percent">0%</div>
              <div style="font-size: clamp(0.65rem, 1.5vw, 0.75rem); font-weight: 600; color: #000000;">Crecimiento</div>
              <div style="font-size: clamp(0.6rem, 1.3vw, 0.65rem); margin-top: 2px; color: #000000;" id="dash-growth-detail">vs mes anterior</div>
            </div>
            
            <div class="stat-card" id="kpi-margin-card" style="padding: 12px;">
              <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700; margin-bottom: 4px; color: #ffffff;" id="dash-margin-percent">0%</div>
              <div style="font-size: clamp(0.65rem, 1.5vw, 0.75rem); font-weight: 600; color: #000000;">Margen Operativo</div>
              <div style="font-size: clamp(0.6rem, 1.3vw, 0.65rem); margin-top: 2px; color: #000000;" id="dash-margin-detail">$0 margen</div>
            </div>
            
            <div class="stat-card" id="kpi-rotation-card" style="padding: 12px;">
              <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700; margin-bottom: 4px; color: #ffffff;" id="dash-effectiveness">0%</div>
              <div style="font-size: clamp(0.65rem, 1.5vw, 0.75rem); font-weight: 600; color: #000000;">Rotaci√≥n Inventario</div>
              <div style="font-size: clamp(0.6rem, 1.3vw, 0.65rem); margin-top: 2px; color: #000000;" id="dash-effectiveness-detail">0.00x / 1.0x</div>
            </div>
          </div>
          
          <!-- Tarjeta de An√°lisis Inteligente (React) -->
          <div id="smart-analysis-root"></div>
          
          <!-- Desglose por M√©todo de Pago -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <h3 class="card-title"><i data-lucide="credit-card" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>Desglose por M√©todo de Pago</h3>
                <div id="month-notice" style="font-size: 12px; color: #666; background: #fef3c7; padding: 6px 12px; border-radius: 6px; border: 1px solid #fbbf24;"></div>
              </div>
            </div>
            <div class="card-content">
              <canvas id="paymentMethodsChart" width="400" height="250"></canvas>
            </div>
          </div>
          
          <div class="card" style="margin-top: 32px;">
            <div class="card-header">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <h3 class="card-title"><i data-lucide="trending-up" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>Proyecci√≥n de Ventas Mes Actual</h3>
              </div>
            </div>
            <div class="card-content">
              <canvas id="projectionChart" width="400" height="200"></canvas>
            </div>
          </div>
          
          <!-- Gr√°ficos en 2 columnas en PC -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
            <style>
              @media (max-width: 1024px) {
                div[style*='grid-template-columns: 1fr 1fr'] {
                  grid-template-columns: 1fr !important;
                }
              }
            </style>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i data-lucide="bar-chart-2" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>Comparativa Mensual</h3>
              </div>
              <div class="card-content">
                <canvas id="monthComparisonChart" width="400" height="200"></canvas>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                  <h3 class="card-title"><i data-lucide="calendar" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>Ventas por Per√≠odo</h3>
                  <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="view2-7d" onclick="changeSalesView2('7d')" style="background: #0a0a0a; color: white; font-size: 11px; padding: 6px 10px;">7D</button>
                    <button class="btn btn-secondary" id="view2-15d" onclick="changeSalesView2('15d')" style="font-size: 11px; padding: 6px 10px;">15D</button>
                    <button class="btn btn-secondary" id="view2-30d" onclick="changeSalesView2('30d')" style="font-size: 11px; padding: 6px 10px;">30D</button>
                    <button class="btn btn-secondary" id="view2-60d" onclick="changeSalesView2('60d')" style="font-size: 11px; padding: 6px 10px;">60D</button>
                    <button class="btn btn-secondary" id="view2-90d" onclick="changeSalesView2('90d')" style="font-size: 11px; padding: 6px 10px;">90D</button>
                  </div>
                </div>
              </div>
              <div class="card-content">
                <canvas id="salesChart2" width="400" height="200"></canvas>
              </div>
            </div>
          </div>
          
          <!-- Nuevo gr√°fico: Ventas por Direcci√≥n -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title"><i data-lucide="map-pin" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>Ventas por Direcci√≥n (Top 10)</h3>
            </div>
            <div class="card-content">
              <canvas id="salesByAddressChart" width="400" height="300"></canvas>
            </div>
          </div>
        </div>
        
        <div class="view" id="products-view">
          <div class="card">
            <div class="card-header">
              <div class="toolbar">
                <button class="btn btn-primary" onclick="addProduct()">+ Nuevo Producto</button>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button class="btn btn-secondary" id="filter-all" onclick="filterProductsByStatus('all')" style="background: #0a0a0a; color: white;">Todos</button>
                  <button class="btn btn-secondary" id="filter-active" onclick="filterProductsByStatus('active')">Activos</button>
                  <button class="btn btn-secondary" id="filter-inactive" onclick="filterProductsByStatus('inactive')">Inactivos</button>
                  <button class="btn btn-secondary" id="filter-nocost" onclick="filterProductsByStatus('nocost')" style="background: #dc2626; color: white;">‚ö†Ô∏è Sin Costo</button>
                </div>
                <div class="search">
                  <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                  <input type="text" class="input" placeholder="Buscar productos..." onkeyup="filterProducts(this.value)">
                </div>
              </div>
              <div id="bulk-actions" style="display: none; margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e5e5e5;">
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                  <span id="selected-count" style="font-size: 14px; color: #666;">0 productos seleccionados</span>
                  <button class="btn btn-secondary" onclick="bulkAdjustPrice()">üí∞ Ajustar Precio</button>
                  <button class="btn btn-secondary" onclick="bulkEdit()">‚úèÔ∏è Editar</button>
                  <button class="btn btn-secondary" onclick="bulkActivate()">‚úÖ Activar</button>
                  <button class="btn btn-secondary" onclick="bulkDeactivate()">‚ùå Desactivar</button>
                  <button class="btn btn-danger" onclick="bulkDelete()">üóëÔ∏è Eliminar</button>
                  <button class="btn btn-secondary" onclick="clearSelection()">Limpiar</button>
                </div>
              </div>
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="table" id="productsTable">
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="select-all" onchange="toggleSelectAll(this.checked)"></th>
                      <th>Imagen</th>
                      <th>Producto</th>
                      <th>Categor√≠a</th>
                      <th>Precio/Costo</th>
                      <th>Stock</th>
                      <th>Tiempo Prep</th>
                      <th>Popularidad</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="10" style="text-align: center; padding: 40px; color: #666;">Cargando productos...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="view" id="users-view">
          <div class="card">
            <div class="card-header">
              <div class="toolbar">
                <h2 class="card-title">Gesti√≥n de Usuarios</h2>
                <div class="search">
                  <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                  <input type="text" class="input" placeholder="Buscar usuarios..." onkeyup="filterUsers(this.value)">
                </div>
              </div>
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="table" id="usersTable">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Usuario</th>
                      <th>Email</th>
                      <th>Tel√©fono</th>
                      <th>Registro</th>
                      <th>Pedidos</th>
                      <th>Total Gastado</th>
                      <th>Recompensas</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="9" style="text-align: center; padding: 40px; color: #666;">Cargando usuarios...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="view" id="militares-rl6-view">
          <div class="card">
            <div class="card-header">
              <div class="toolbar">
                <h2 class="card-title">üéØ Militares RL6 - Aprobaci√≥n de Cr√©dito</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <button class="btn btn-primary" id="filter-rl6-pending" onclick="filterMilitaresRL6('pending')" style="background: #0a0a0a; color: white;">Pendientes</button>
                  <button class="btn btn-secondary" id="filter-rl6-approved" onclick="filterMilitaresRL6('approved')">Aprobados</button>
                  <button class="btn btn-secondary" id="filter-rl6-all" onclick="filterMilitaresRL6('all')">Todos</button>
                </div>
              </div>
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="table" id="militaresRL6Table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nombre</th>
                      <th>RUT</th>
                      <th>Rango</th>
                      <th>Unidad</th>
                      <th>Registro</th>
                      <th>Cr√©dito</th>
                      <th>Estado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="9" style="text-align: center; padding: 40px; color: #666;">Cargando militares...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="view" id="orders-view">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Gesti√≥n de Pedidos</h2>
            </div>
            <div class="card-content">
              <p style="color: #666;">Sistema de pedidos en desarrollo</p>
            </div>
          </div>
        </div>
        
        <div class="view" id="payments-view">
          <iframe src="/admin/pagos-tuu" style="width: 100%; height: calc(100vh - 120px); border: none; border-radius: 8px;"></iframe>
        </div>
        
        <div class="view" id="test-view">
          <iframe src="/admin/test" style="width: 100%; height: calc(100vh - 120px); border: none; border-radius: 8px;"></iframe>
        </div>
        
        <div class="view" id="technical-report-view">
          <div id="technical-report-container"></div>
        </div>
        
        <div class="view" id="calidad-view">
          <iframe src="/admin/calidad" style="width: 100%; height: calc(100vh - 120px); border: none; border-radius: 8px;"></iframe>
        </div>
        
        <div class="view" id="concurso-admin-view">
          <div class="card">
            <div class="card-header">
              <div class="toolbar">
                <h2 class="card-title">Gesti√≥n de Concursantes</h2>
                <button class="btn btn-primary" onclick="addConcursante()">+ Agregar Concursante</button>
              </div>
            </div>
            <div class="card-content">
              <div id="concursantes-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                <div style="text-align: center; padding: 40px; color: #666;">Cargando concursantes...</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="view" id="concurso-view">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <div style="font-size: 2rem; margin-bottom: 8px;">üëÅÔ∏è</div>
              <div class="stat-value" id="concurso-total-visits">0</div>
              <div class="stat-label">Total Visitas</div>
            </div>
            <div class="stat-card">
              <div style="font-size: 2rem; margin-bottom: 8px;">üìÖ</div>
              <div class="stat-value" id="concurso-today-visits">0</div>
              <div class="stat-label">Visitas Hoy</div>
            </div>
            <div class="stat-card">
              <div style="font-size: 2rem; margin-bottom: 8px;">üéØ</div>
              <div class="stat-value" id="concurso-participants">0</div>
              <div class="stat-label">Participantes</div>
            </div>
            <div class="stat-card">
              <div style="font-size: 2rem; margin-bottom: 8px;">üìà</div>
              <div class="stat-value" id="concurso-conversion">0%</div>
              <div class="stat-label">Conversi√≥n</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Visitas por D√≠a (√öltimos 7 d√≠as)</h3>
              </div>
              <div class="card-content">
                <canvas id="concursoVisitsChart" width="400" height="200"></canvas>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Visitas por Fuente</h3>
              </div>
              <div class="card-content">
                <canvas id="concursoSourcesChart" width="400" height="200"></canvas>
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title">üîó Links de Seguimiento</h3>
            </div>
            <div class="card-content">
              <div style="display: grid; gap: 16px;">
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; position: relative;">
                  <div style="font-family: monospace; font-size: 14px; color: #1e293b; word-break: break-all; margin-bottom: 8px;">https://app.laruta11.cl/concurso/?source=ARICABKN</div>
                  <div style="color: #64748b; font-size: 12px;">Para campa√±as de Arica es Bac√°n</div>
                  <button onclick="copyConcursoLink('https://app.laruta11.cl/concurso/?source=ARICABKN', this)" style="position: absolute; top: 16px; right: 16px; background: #0a0a0a; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                    üìã Copiar
                  </button>
                </div>
                <div style="background: #f8fafc; padding: 16px; border-radius: 8px; position: relative;">
                  <div style="font-family: monospace; font-size: 14px; color: #1e293b; word-break: break-all; margin-bottom: 8px;">https://app.laruta11.cl/concurso/?source=RUTA11</div>
                  <div style="color: #64748b; font-size: 12px;">Para campa√±as oficiales de La Ruta 11</div>
                  <button onclick="copyConcursoLink('https://app.laruta11.cl/concurso/?source=RUTA11', this)" style="position: absolute; top: 16px; right: 16px; background: #0a0a0a; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                    üìã Copiar
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Detalles por Fuente</h3>
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="table" id="concursoSourcesTable">
                  <thead>
                    <tr>
                      <th>Fuente</th>
                      <th>Total Visitas</th>
                      <th>Visitas Hoy</th>
                      <th>Participantes</th>
                      <th>Conversi√≥n</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="5" style="text-align: center; padding: 40px; color: #666;">Cargando datos...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="view" id="ingredients-view">
          <iframe src="/admin/ingredients" style="width: 100%; height: calc(100vh - 120px); border: none; border-radius: 8px;"></iframe>
        </div>
        
        <div class="view" id="combos-view">
          <div class="card">
            <div class="card-header">
              <div class="toolbar">
                <h2 class="card-title">Gesti√≥n de Combos</h2>
                <button class="btn btn-primary" onclick="addCombo()">+ Nuevo Combo</button>
              </div>
            </div>
            <div class="card-content">
              <div id="combos-grid" style="display: grid; gap: 16px;">
                <div style="text-align: center; padding: 40px; color: #666;">Cargando combos...</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="view" id="reportes-view">
          <iframe src="/admin/reportes" style="width: 100%; height: calc(100vh - 120px); border: none; border-radius: 8px;"></iframe>
        </div>
        
        <div class="view" id="sales-analytics-view">
          <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
            <button class="btn btn-primary" id="period-day" onclick="changePeriod('day')" style="background: #0a0a0a;"><i data-lucide="clock" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>Turno Actual</button>
            <button class="btn btn-secondary" id="period-week" onclick="changePeriod('week')">√öltima Semana</button>
            <button class="btn btn-secondary" id="period-month" onclick="changePeriod('month')">Este Mes</button>
            <button class="btn btn-secondary" id="period-all" onclick="changePeriod('all')">Total Ventas</button>
          </div>
          
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <i data-lucide="shopping-cart" style="width: 32px; height: 32px; margin-bottom: 8px; color: #3b82f6;"></i>
              <div class="stat-value" id="summary-total-orders">0</div>
              <div class="stat-label">Total Pedidos</div>
            </div>
            <div class="stat-card">
              <i data-lucide="dollar-sign" style="width: 32px; height: 32px; margin-bottom: 8px; color: #059669;"></i>
              <div class="stat-value" id="summary-total-revenue">$0</div>
              <div class="stat-label" style="display: flex; flex-direction: column; gap: 2px;">
                <span>Total Venta (sin delivery)</span>
                <span id="summary-delivery-discount" style="font-size: 10px; color: #f59e0b; font-weight: 500;"></span>
              </div>
            </div>
            <div class="stat-card">
              <i data-lucide="trending-up" style="width: 32px; height: 32px; margin-bottom: 8px; color: #10b981;"></i>
              <div class="stat-value" id="summary-total-profit">$0</div>
              <div class="stat-label" id="summary-margin-label">Utilidad (0%)</div>
            </div>
            <div class="stat-card">
              <i data-lucide="receipt" style="width: 32px; height: 32px; margin-bottom: 8px; color: #f59e0b;"></i>
              <div class="stat-value" id="summary-avg-ticket">$0</div>
              <div class="stat-label">Ticket Promedio</div>
            </div>
          </div>
          
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <i data-lucide="package" style="width: 32px; height: 32px; margin-bottom: 8px; color: #0a0a0a;"></i>
              <div class="stat-value" id="total-products-sold">0</div>
              <div class="stat-label">Productos Vendidos</div>
            </div>
            <div class="stat-card">
              <i data-lucide="trophy" style="width: 32px; height: 32px; margin-bottom: 8px; color: #0a0a0a;"></i>
              <div class="stat-value" id="top-product-name" style="font-size: clamp(1.2rem, 3vw, 1.8rem);">-</div>
              <div class="stat-label" id="top-product-quantity" style="font-size: 11px; color: #666; margin-top: 4px;"></div>
              <div class="stat-label">Producto M√°s Vendido</div>
            </div>
            <div class="stat-card">
              <i data-lucide="calendar" style="width: 32px; height: 32px; margin-bottom: 8px; color: #0a0a0a;"></i>
              <div class="stat-value" id="avg-per-day">0</div>
              <div class="stat-label">Promedio por D√≠a</div>
            </div>
            <div class="stat-card">
              <i data-lucide="trending-up" style="width: 32px; height: 32px; margin-bottom: 8px; color: #0a0a0a;"></i>
              <div class="stat-value" id="avg-per-week">0</div>
              <div class="stat-label">Promedio por Semana</div>
            </div>
          </div>
          

          
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title">üìä Top 10 Productos M√°s Vendidos</h3>
            </div>
            <div class="card-content">
              <canvas id="topProductsChart" width="400" height="200"></canvas>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üìã Detalle de Productos Vendidos</h3>
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="table" id="productsAnalyticsTable">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th>Cantidad Total</th>
                      <th>Promedio/D√≠a</th>
                      <th>Promedio/Semana</th>
                      <th>Promedio/Mes</th>
                      <th>Pedidos</th>
                      <th>Ingresos</th>
                      <th>Margen %</th>
                      <th>Utilidad</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="7" style="text-align: center; padding: 40px; color: #666;">Cargando datos...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="view" id="purchase-plan-view">
          <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center;">
            <button class="btn btn-primary" id="plan-2days" onclick="changePlanDays(2)" style="background: #0a0a0a;">2 D√≠as</button>
            <button class="btn btn-secondary" id="plan-4days" onclick="changePlanDays(4)">4 D√≠as</button>
            <button class="btn btn-secondary" id="plan-7days" onclick="changePlanDays(7)">7 D√≠as</button>
            <button class="btn btn-secondary" id="plan-15days" onclick="changePlanDays(15)">15 D√≠as</button>
            <button class="btn btn-secondary" id="plan-30days" onclick="changePlanDays(30)">30 D√≠as</button>
            <div style="flex: 1;"></div>
            <button class="btn" id="next-purchase-btn" onclick="openPurchaseModal()" style="background: #10b981; color: white; position: relative; padding-right: 50px;">
              üìÖ Pr√≥xima Compra
              <span id="days-until-purchase" style="position: absolute; top: -8px; right: -8px; background: #dc2626; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">0</span>
            </button>
          </div>
          
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <i data-lucide="package" style="width: 32px; height: 32px; margin-bottom: 8px; color: #0a0a0a;"></i>
              <div class="stat-value" id="plan-total-ingredients">0</div>
              <div class="stat-label">Ingredientes a Comprar</div>
            </div>
            <div class="stat-card">
              <i data-lucide="dollar-sign" style="width: 32px; height: 32px; margin-bottom: 8px; color: #059669;"></i>
              <div class="stat-value" id="plan-total-cost">$0</div>
              <div class="stat-label">Costo Total Estimado</div>
            </div>
            <div class="stat-card">
              <i data-lucide="bar-chart-3" style="width: 32px; height: 32px; margin-bottom: 8px; color: #3b82f6;"></i>
              <div class="stat-value" id="plan-total-products">0</div>
              <div class="stat-label">Productos en Forecast</div>
            </div>
            <div class="stat-card">
              <i data-lucide="calendar-days" style="width: 32px; height: 32px; margin-bottom: 8px; color: #f59e0b;"></i>
              <div class="stat-value" id="plan-days">2</div>
              <div class="stat-label">D√≠as de Abastecimiento</div>
            </div>
          </div>
          
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title"><i data-lucide="shopping-cart" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>Lista de Compras Prioritaria</h3>
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="table" id="purchaseListTable">
                  <thead>
                    <tr>
                      <th><i data-lucide="package" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>Ingrediente</th>
                      <th><i data-lucide="archive" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>Stock Actual</th>
                      <th><i data-lucide="trending-up" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>Necesario</th>
                      <th><i data-lucide="shopping-cart" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>A Comprar</th>
                      <th><i data-lucide="dollar-sign" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>Costo Unit.</th>
                      <th><i data-lucide="credit-card" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;"></i>Costo Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="7" style="text-align: center; padding: 40px; color: #666;">Cargando plan de compras...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üìà Forecast de Productos</h3>
            </div>
            <div class="card-content">
              <div class="table-container">
                <table class="table" id="forecastTable">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th>Promedio Diario</th>
                      <th>Forecast <span id="forecast-days">4</span> D√≠as</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="3" style="text-align: center; padding: 40px; color: #666;">Cargando forecast...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="view" id="robots-view">
          <div class="stats-grid" style="margin-bottom: 24px;">
            <div class="stat-card">
              <div style="font-size: 2rem; margin-bottom: 8px;">ü§ñ</div>
              <div class="stat-value" id="robot-status">Inactivo</div>
              <div class="stat-label">Estado del Robot</div>
            </div>
            <div class="stat-card">
              <div style="font-size: 2rem; margin-bottom: 8px;">üìä</div>
              <div class="stat-value" id="robot-tests">0</div>
              <div class="stat-label">Tests Ejecutados</div>
            </div>
            <div class="stat-card">
              <div style="font-size: 2rem; margin-bottom: 8px;">‚úÖ</div>
              <div class="stat-value" id="robot-success">0%</div>
              <div class="stat-label">Tasa de √âxito</div>
            </div>
            <div class="stat-card">
              <div style="font-size: 2rem; margin-bottom: 8px;">‚è±Ô∏è</div>
              <div class="stat-value" id="robot-last">-</div>
              <div class="stat-label">√öltimo Test</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ü§ñ Robot Test Tracking</h3>
              </div>
              <div class="card-content">
                <p style="margin-bottom: 16px; color: #666;">Simula un usuario real navegando por la app y verifica que el sistema de tracking funcione correctamente.</p>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                  <button class="btn btn-primary" onclick="window.open('/api/robot_test_tracking.php', '_blank')">üöÄ Ejecutar Robot</button>
                  <button class="btn btn-secondary" onclick="checkRobotStatus()">üìä Ver Estado</button>
                </div>
                <div style="font-size: 12px; color: #666;">
                  <p><strong>Funciones:</strong></p>
                  <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>Simula visitas reales</li>
                    <li>Hace clicks en productos</li>
                    <li>Agrega items al carrito</li>
                    <li>Verifica tracking completo</li>
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">üß™ Test APIs Individual</h3>
              </div>
              <div class="card-content">
                <p style="margin-bottom: 16px; color: #666;">Prueba cada API de tracking por separado para identificar problemas espec√≠ficos.</p>
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                  <button class="btn btn-primary" onclick="window.open('/api/test_analytics_system.php', '_blank')">üß™ Test APIs</button>
                  <button class="btn btn-secondary" onclick="window.open('/api/check_tracking_data.php', '_blank')">üìã Ver Datos</button>
                </div>
                <div style="font-size: 12px; color: #666;">
                  <p><strong>APIs Disponibles:</strong></p>
                  <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>Track Visit</li>
                    <li>Track Interaction</li>
                    <li>Track Journey</li>
                    <li>Product Analytics</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">‚öôÔ∏è Configuraci√≥n y Mantenimiento</h3>
            </div>
            <div class="card-content">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div>
                  <h4 style="margin-bottom: 8px;">Base de Datos</h4>
                  <button class="btn btn-secondary" onclick="window.open('/api/check_visits_table.php', '_blank')" style="width: 100%; margin-bottom: 8px;">üóÉÔ∏è Verificar Tablas</button>
                  <button class="btn btn-secondary" onclick="window.open('/api/update_visits_table.php', '_blank')" style="width: 100%;">üîß Actualizar Estructura</button>
                </div>
                <div>
                  <h4 style="margin-bottom: 8px;">Analytics</h4>
                  <button class="btn btn-secondary" onclick="window.open('/api/app/get_user_behavior.php', '_blank')" style="width: 100%; margin-bottom: 8px;">üìä Datos Comportamiento</button>
                  <button class="btn btn-secondary" onclick="window.open('/admin/analytics', '_blank')" style="width: 100%;">üìà Dashboard Analytics</button>
                </div>
                <div>
                  <h4 style="margin-bottom: 8px;">Limpieza</h4>
                  <button class="btn btn-danger" onclick="cleanRobotData()" style="width: 100%; margin-bottom: 8px;">üßπ Limpiar Datos Robot</button>
                  <button class="btn btn-secondary" onclick="window.open('/api/simulate_visit.php', '_blank')" style="width: 100%;">üéØ Simular Visita</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    // @ts-nocheck
    // Variables globales
    let currentViewMonth = null; // null = mes actual, {month, year} = mes espec√≠fico
    let dashboardAutoRefreshInterval = null;
    
    // Declarar funciones globalmente
    window.isAppOrder = function(id) {
      return id && id.toString().startsWith('R11-');
    };
    
    window.showView = function(viewName) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
      
      const navEl = document.getElementById(`nav-${viewName}`);
      const viewEl = document.getElementById(`${viewName}-view`);
      const titleEl = document.getElementById('page-title');
      const monthYearDisplay = document.getElementById('month-year-display');
      const prevMonthBtn = document.getElementById('prev-month-btn');
      const currentMonthBtn = document.getElementById('current-month-btn');
      
      if (navEl) navEl.classList.add('active');
      if (viewEl) viewEl.classList.add('active');
      
      const titles = { dashboard: 'Dashboard', products: 'Productos', users: 'Usuarios', 'militares-rl6': 'Militares RL6', orders: 'Pedidos', payments: 'Pagos TUU', test: 'Test APIs', 'technical-report': 'Informe T√©cnico', robots: 'ü§ñ Robots', calidad: 'Control de Calidad', concurso: 'üèÜ Concurso Stats', 'concurso-admin': 'üéÆ Concurso Admin', combos: 'Gesti√≥n de Combos', ingredients: 'Ingredientes', 'sales-analytics': 'Control Ventas', 'purchase-plan': 'Plan de Compras' };
      if (titleEl) titleEl.textContent = titles[viewName];
      
      // Show/hide header actions based on view
      if (monthYearDisplay && prevMonthBtn && currentMonthBtn) {
        if (viewName === 'dashboard') {
          const today = new Date();
          const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
          monthYearDisplay.textContent = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
          monthYearDisplay.style.display = 'block';
          prevMonthBtn.style.display = 'inline-flex';
          currentMonthBtn.style.display = 'none';
        } else {
          monthYearDisplay.style.display = 'none';
          prevMonthBtn.style.display = 'none';
          currentMonthBtn.style.display = 'none';
        }
      }
      
      if (viewName === 'dashboard') {
        if (currentViewMonth) {
          // Cargar mes espec√≠fico
          loadDashboardForMonth(currentViewMonth.month, currentViewMonth.year);
        } else {
          // Cargar mes actual
          loadDashboardMetrics();
          if (window.loadDashboardTUU) window.loadDashboardTUU();
          if (window.loadOperationalCards) window.loadOperationalCards();
          setTimeout(() => {
            createProjectionChart();
            createMonthComparisonChart();
            loadSalesChart2();
            loadSalesByAddressChart();
          }, 500);
        }
      }
      if (viewName === 'products') loadProducts();
      if (viewName === 'users') loadUsers();
      if (viewName === 'militares-rl6') loadMilitaresRL6();
      // payments view now uses iframe
      if (viewName === 'test') loadTestAPIs();
      if (viewName === 'technical-report') loadTechnicalReport();
      if (viewName === 'robots') loadRobotsView();
      if (viewName === 'concurso') loadConcursoStats();
      if (viewName === 'concurso-admin') loadConcursantes();
      if (viewName === 'combos') loadCombos();
      if (viewName === 'sales-analytics') loadSalesAnalytics();
      if (viewName === 'purchase-plan') loadPurchasePlan();
      if (viewName === 'reportes') loadReportes();
    };
    window.loadDashboardMetrics = loadDashboardMetrics;
    
    window.generateSmartAnalysis = function(metrics) {
      const analysisEl = document.getElementById('smart-analysis');
      if (!analysisEl) return;
      
      let analysis = '';
      let emoji = 'ü§î';
      
      // Escenario 1: Todo va excelente
      if (metrics.monthlyProgress >= 100 && metrics.dailyPercent >= 100 && metrics.ticketPercent >= 100) {
        emoji = 'üöÄ';
        analysis = `<strong>${emoji} ¬°Modo Cohete Activado!</strong><br>Est√°s en fuego üî• - Meta mensual cumplida, ventas diarias superando expectativas y ticket promedio por las nubes. Si sigues as√≠, podr√≠as considerar abrir una segunda sucursal... o simplemente disfrutar el √©xito üçæ`;
      }
      // Escenario 2: Meta mensual en riesgo pero buen ticket
      else if (metrics.monthlyProgress < 70 && metrics.ticketPercent > 100) {
        emoji = 'ü§®';
        analysis = `<strong>${emoji} Situaci√≥n Curiosa</strong><br>Tus clientes gastan bien ($${Math.round(metrics.ticketPercent)}% sobre objetivo üí∞), pero... ¬ød√≥nde est√°n todos? üëÄ Necesitas <strong>$${new Intl.NumberFormat('es-CL').format(Math.round(metrics.dailyNeeded))}/d√≠a</strong> los pr√≥ximos ${metrics.daysRemaining} d√≠as. Hora de activar el marketing üì£`;
      }
      // Escenario 3: Buen ritmo diario pero meta mensual atrasada
      else if (metrics.dailyPercent >= 90 && metrics.monthlyProgress < 70) {
        emoji = '‚è±Ô∏è';
        analysis = `<strong>${emoji} Carrera Contra el Tiempo</strong><br>Ritmo diario decente (${metrics.dailyPercent}%), pero el mes te qued√≥ corto. Faltan <strong>$${new Intl.NumberFormat('es-CL').format(Math.round(metrics.salesRemaining))}</strong> en ${metrics.daysRemaining} d√≠as. Necesitas acelerar a <strong>$${new Intl.NumberFormat('es-CL').format(Math.round(metrics.dailyNeeded))}/d√≠a</strong> üèÉ`;
      }
      // Escenario 4: Margen excelente pero ventas bajas
      else if (metrics.marginPercent > 50 && metrics.monthlyProgress < 70) {
        emoji = 'üßê';
        analysis = `<strong>${emoji} El Dilema del Margen</strong><br>Margen brutal del ${metrics.marginPercent.toFixed(1)}% üí™, pero las ventas no acompa√±an (${metrics.monthlyProgress}% de meta). ¬øPrecios muy altos? ¬øPoca demanda? Considera promociones estrat√©gicas para mover volumen üì¶`;
      }
      // Escenario 5: Rotaci√≥n de inventario baja
      else if (metrics.rotacionPercent < 50) {
        emoji = 'üêå';
        analysis = `<strong>${emoji} Inventario Dormido</strong><br>Rotaci√≥n del ${metrics.rotacionPercent}% es preocupante. Tienes productos durmi√©ndose en el almac√©n üò¥ Revisa qu√© no se vende y considera: descuentos, combos o... donaciones (para el karma ‚ú®)`;
      }
      // Escenario 6: Todo mal
      else if (metrics.monthlyProgress < 60 && metrics.dailyPercent < 80 && metrics.ticketPercent < 90) {
        emoji = 'üõë';
        analysis = `<strong>${emoji} C√≥digo Rojo</strong><br>Houston, tenemos un problema. Meta mensual al ${metrics.monthlyProgress}%, ventas diarias flojas y ticket bajo objetivo. Necesitas <strong>$${new Intl.NumberFormat('es-CL').format(Math.round(metrics.dailyNeeded))}/d√≠a</strong> urgente. Recomendaci√≥n: reuni√≥n de emergencia ‚òï + plan de acci√≥n üìù`;
      }
      // Escenario 7: Casi llegando a la meta
      else if (metrics.monthlyProgress >= 80 && metrics.monthlyProgress < 100) {
        emoji = 'üéØ';
        analysis = `<strong>${emoji} ¬°Casi Ah√≠!</strong><br>Est√°s al ${metrics.monthlyProgress}% de la meta. Solo faltan <strong>$${new Intl.NumberFormat('es-CL').format(Math.round(metrics.salesRemaining))}</strong> en ${metrics.daysRemaining} d√≠as. Eso es <strong>$${new Intl.NumberFormat('es-CL').format(Math.round(metrics.dailyNeeded))}/d√≠a</strong>. ¬°Un √∫ltimo empuj√≥n y lo logras! üí™`;
      }
      // Escenario 8: Ticket bajo pero buen volumen
      else if (metrics.ticketPercent < 80 && metrics.monthlyProgress >= 70) {
        emoji = 'üí∏';
        analysis = `<strong>${emoji} Volumen vs Valor</strong><br>Vendes bien pero el ticket promedio est√° bajo (${metrics.ticketPercent}%). Estrategia: upselling üçî‚ûïüçü, combos atractivos o sugerir extras. Cada $500 extra por pedido suma mucho al mes üìà`;
      }
      // Escenario default: Situaci√≥n normal
      else {
        emoji = 'üìà';
        analysis = `<strong>${emoji} Operaci√≥n Normal</strong><br>Meta mensual al ${metrics.monthlyProgress}%, ritmo diario ${metrics.dailyPercent}%. Necesitas mantener <strong>$${new Intl.NumberFormat('es-CL').format(Math.round(metrics.dailyNeeded))}/d√≠a</strong> para cerrar el mes. Margen del ${metrics.marginPercent.toFixed(1)}% es saludable. Sigue as√≠ üëç`;
      }
      
      analysisEl.innerHTML = analysis;
    };
    
    window.loadDashboardTUU = async function() {
      try {
        const MONTHLY_SALARIES = 1590000;
        
        // üî• INYECCI√ìN HARDCODEADA OCTUBRE 2025 - SOLO TPV FALTANTE
        const OCTOBER_2025_TPV_INJECTION = {
          sales: 695433,  // TPV faltante de TUU (SIN delivery)
          delivery: 0,     // TPV es terminal f√≠sico, NO tiene delivery
          orders: 1
          // cost se calcular√° din√°micamente seg√∫n costPercentage real
        };
        
        const today = new Date();
        const startOfMonth = new Date(today);
        startOfMonth.setDate(1);
        const startDate = startOfMonth.toISOString().split('T')[0];
        const endDate = today.toISOString().split('T')[0];
        
        // Detectar si estamos en Octubre 2025
        const isOctober2025 = today.getFullYear() === 2025 && today.getMonth() === 9;
        
        // Usar get_sales_analytics.php?period=month (igual que Control Ventas)
        const response = await fetch(`/api/get_sales_analytics.php?period=month&t=${Date.now()}`);
        const data = await response.json();
        if (data.success && data.data) {
          const totalSales = data.data.summary_kpis.total_revenue || 0;
          const totalOrders = data.data.summary_kpis.total_orders || 0;
          const avgTicket = data.data.summary_kpis.avg_ticket || 0;
          const totalDeliveryFee = data.data.summary_kpis.total_delivery || 0;
          const paymentSummary = data.data.payment_summary || [];
          
          // Valores ya calculados correctamente por get_smart_projection.php
          

          
          // Guardar globalmente para c√°lculo de margen operativo
          window.dashTotalSales = totalSales;
          
          // Actualizar top producto en tarjeta Ventas
          const topProductEl = document.getElementById('dash-main-top-product');
          const topPercentEl = document.getElementById('dash-main-top-percent');
          const topMoneyEl = document.getElementById('dash-main-top-money');
          
          if (topProductEl && window.dashTopProductName) {
            topProductEl.textContent = window.dashTopProductName;
          }
          
          // Calcular porcentaje y dinero del top producto usando datos ya cargados
          if (topPercentEl && topMoneyEl && window.dashTotalSales && window.dashTopProductIngresos) {
            const percent = ((window.dashTopProductIngresos / window.dashTotalSales) * 100).toFixed(1);
            topMoneyEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(window.dashTopProductIngresos));
            topPercentEl.textContent = '(' + percent + '%)';
          }
          
          // CARD PRINCIPAL
          const mainSalesEl = document.getElementById('dash-main-sales');
          const mainDeliveryEl = document.getElementById('dash-main-delivery');
          const mainOrdersEl = document.getElementById('dash-main-orders');
          const mainTicketEl = document.getElementById('dash-main-ticket');
          
          if (mainSalesEl) mainSalesEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(totalSales));
          if (mainOrdersEl) mainOrdersEl.textContent = totalOrders;
          if (mainTicketEl) mainTicketEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(avgTicket));
          
          // Calcular vs mes anterior
          fetch(`/api/get_month_comparison.php?t=${Date.now()}`)
            .then(r => r.json())
            .then(compData => {
              if (compData.success) {
                const prevMonthTotal = compData.data.previousMonth.salesByWeekday.reduce((a,b) => a+b, 0);
                
                // Calcular ventas por semana del mes anterior
                const prevMonthWeeks = [];
                const salesByDay = compData.data.previousMonth.salesByWeekday || [];
                for (let week = 0; week < 4; week++) {
                  const weekSales = salesByDay.slice(week * 7, (week + 1) * 7).reduce((a, b) => a + b, 0);
                  if (weekSales > 0) {
                    prevMonthWeeks.push({ week: week + 1, sales: weekSales });
                  }
                }
                
                // Cargar datos completos del mes anterior (√≥rdenes, ticket, margen)
                fetch('/api/get_previous_month_summary.php?t=' + Date.now())
                  .then(r => r.json())
                  .then(prevData => {
                    if (prevData.success && window.dashboardMetrics) {
                      window.dashboardMetrics.previousMonthSales = prevMonthTotal;
                      window.dashboardMetrics.previousMonthWeeks = prevMonthWeeks;
                      window.dashboardMetrics.previousMonthOrders = prevData.data.total_orders;
                      window.dashboardMetrics.previousMonthTicket = prevData.data.avg_ticket;
                      window.dashboardMetrics.previousMonthMargin = prevData.data.margin_percent;
                      console.log('üìä Datos completos mes anterior:', window.dashboardMetrics);
                      
                      if (window.renderSmartAnalysis) {
                        window.renderSmartAnalysis(window.dashboardMetrics);
                      }
                    }
                  })
                  .catch(err => console.error('Error cargando resumen mes anterior:', err));
                
                // Si es inicio de mes (primeros 3 d√≠as) y ventas son muy bajas, mostrar 0% en lugar de -100%
                const daysPassed = new Date().getDate();
                let vsLastMonth;
                if (daysPassed <= 3 && totalSales < (prevMonthTotal * 0.1)) {
                  vsLastMonth = '0.0'; // Inicio de mes, a√∫n no hay datos suficientes
                } else {
                  vsLastMonth = prevMonthTotal > 0 ? (((totalSales - prevMonthTotal) / prevMonthTotal) * 100).toFixed(1) : 0;
                }
                
                // Actualizar badge en tarjeta principal
                const vsEl = document.getElementById('dash-vs-last-month');
                if (vsEl) {
                  vsEl.textContent = (vsLastMonth >= 0 ? '+' : '') + vsLastMonth + '%';
                  vsEl.style.color = vsLastMonth >= 0 ? '#10b981' : '#dc2626';
                }
                
                // Actualizar mini KPI de Crecimiento
                const growthPercentEl = document.getElementById('dash-growth-percent');
                const growthDetailEl = document.getElementById('dash-growth-detail');
                const growthCard = document.getElementById('kpi-growth-card');
                if (growthPercentEl) {
                  growthPercentEl.textContent = (vsLastMonth >= 0 ? '+' : '') + vsLastMonth + '%';
                  growthPercentEl.style.color = '#ffffff';
                  const growthBg = parseFloat(vsLastMonth) >= 10 ? '#10b981' : parseFloat(vsLastMonth) >= 0 ? '#f59e0b' : '#ef4444';
                  if (growthCard) growthCard.style.background = growthBg;
                }
                if (growthDetailEl) {
                  growthDetailEl.textContent = 'vs mes anterior';
                }
              }
            })
            .catch(() => {});
          
          const monthNotice = document.getElementById('month-notice');
          if (monthNotice) {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const currentMonth = monthNames[today.getMonth()];
            let noticeHTML = `üìÖ ${currentMonth} ${today.getFullYear()}`;
            if (totalDeliveryFee > 0) {
              noticeHTML += ` | üèçÔ∏è Delivery: $${new Intl.NumberFormat('es-CL').format(totalDeliveryFee)}`;
            }
            monthNotice.innerHTML = noticeHTML;
            monthNotice.style.display = 'block';
          }
          // Mapear paymentSummary a estructura de paymentMethods
          const paymentMethodsMap = {
            'webpay': {icon:'credit-card',label:'Webpay'},
            'transfer': {icon:'building-2',label:'Transferencia'},
            'card': {icon:'credit-card',label:'Tarjeta'},
            'cash': {icon:'banknote',label:'Efectivo'},
            'pedidosya': {icon:'bike',label:'PedidosYA'}
          };
          
          const paymentMethods = {};
          paymentSummary.forEach(pm => {
            const method = pm.method;
            if (paymentMethodsMap[method]) {
              paymentMethods[method] = {
                ...paymentMethodsMap[method],
                sales: pm.total_sales || 0,
                cost: pm.total_cost || 0,
                orders: pm.order_count || 0,
                delivery: 0 // Ya est√° restado en total_sales
              };
            }
          });
          
          // Asegurar que todos los m√©todos existan
          Object.keys(paymentMethodsMap).forEach(method => {
            if (!paymentMethods[method]) {
              paymentMethods[method] = {
                ...paymentMethodsMap[method],
                sales: 0,
                cost: 0,
                orders: 0,
                delivery: 0
              };
            }
          });
          // Obtener compras del mes desde la API
          fetch(`/api/get_dashboard_cards.php?t=${Date.now()}`)
            .then(r => r.json())
            .then(cardsData => {
              const totalCompras = cardsData.success && cardsData.data.compras ? cardsData.data.compras.total_mes : 0;
              
              // Esperar a que se calcule el margen bruto real
              setTimeout(() => {
                const marginPercent = window.dashMargenBruto || 0.441; // Usar margen calculado o default
                
                // PUNTO DE EQUILIBRIO REAL (Rentabilidad)
                // Punto de equilibrio = Sueldos / Margen Bruto %
                const breakevenSales = marginPercent > 0 ? MONTHLY_SALARIES / marginPercent : 0;
                const additionalSalesNeeded = Math.max(0, breakevenSales - totalSales);
                const percentOfBreakeven = breakevenSales > 0 ? (totalSales / breakevenSales) * 100 : 0;
                
                // FLUJO DE CAJA (Liquidez)
                const totalIngresos = totalSales;
                const totalEgresos = totalCompras + MONTHLY_SALARIES;
                const cashFlow = totalIngresos - totalEgresos;
                
                const breakevenCardMain = document.getElementById('dash-breakeven-card-main');
                const breakevenAmountMain = document.getElementById('dash-breakeven-amount-main');
                const breakevenPercentMain = document.getElementById('dash-breakeven-percent-main');
                const breakevenMargin = document.getElementById('dash-breakeven-margin');
                const breakevenProgressBar = document.getElementById('dash-breakeven-progress-bar');
                const cashflowStatus = document.getElementById('dash-cashflow-status');
                
                if (breakevenCardMain) {
                  breakevenCardMain.style.background = additionalSalesNeeded > 0 ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                }
                if (breakevenAmountMain) {
                  breakevenAmountMain.textContent = additionalSalesNeeded > 0 ? '$' + new Intl.NumberFormat('es-CL').format(Math.round(additionalSalesNeeded)) : '‚úÖ $0';
                }
                if (breakevenPercentMain) {
                  breakevenPercentMain.textContent = percentOfBreakeven.toFixed(1) + '%';
                }
                if (breakevenMargin) {
                  breakevenMargin.textContent = (marginPercent * 100).toFixed(1) + '%';
                }
                if (breakevenProgressBar) {
                  breakevenProgressBar.style.width = Math.min(100, percentOfBreakeven).toFixed(1) + '%';
                }
                // Actualizar flujo de caja compacto
                const cashflowStatusShort = document.getElementById('dash-cashflow-status-short');
                const cashflowFormula = document.getElementById('dash-cashflow-formula');
                
                if (cashflowStatusShort) {
                  const cashFlowAbsM = Math.abs(cashFlow / 1000000).toFixed(2).replace('.', ',');
                  const cashFlowText = (cashFlow >= 0 ? '+$' : '-$') + cashFlowAbsM + 'M';
                  const cashFlowEmoji = cashFlow >= 0 ? ' ‚úÖ' : ' üö®';
                  cashflowStatusShort.innerHTML = cashFlowText + cashFlowEmoji;
                }
                
                if (cashflowFormula) {
                  const salesM = (totalSales / 1000000).toFixed(2).replace('.', ',');
                  const comprasM = (totalCompras / 1000000).toFixed(2).replace('.', ',');
                  const resultM = Math.abs(cashFlow / 1000000).toFixed(2).replace('.', ',');
                  const sign = cashFlow >= 0 ? '+' : '-';
                  cashflowFormula.textContent = `$${salesM}M - $${comprasM}M - $1,59M = ${sign}$${resultM}M`;
                }
              }, 500); // Esperar a que se calcule el margen
              
              // Calcular punto de equilibrio real y meta mensual
              const grossProfit = data.data.summary_kpis.total_profit || 0;
              const marginPercentForGoal = totalSales > 0 ? (grossProfit / totalSales) : 0.441; // Default 44.1%
              const breakevenSalesGoal = marginPercentForGoal > 0 ? MONTHLY_SALARIES / marginPercentForGoal : 0;
              const breakEvenWith10Percent = breakevenSalesGoal * 1.05; // Meta = Equilibrio + 5%
              const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
              const daysPassed = today.getDate();
              const dailyGoal = breakEvenWith10Percent / daysInMonth;
              const dailyAverage = totalSales / daysPassed;
              const expectedToDate = dailyGoal * daysPassed;
              const deviation = totalSales - expectedToDate;
              const deviationPercent = ((deviation / expectedToDate) * 100).toFixed(1);
              // Calcular porcentaje de cumplimiento vs meta esperada
              const percentageOfExpected = ((totalSales / expectedToDate) * 100).toFixed(1);
              
              const salesEl = document.getElementById('dash-sales');
              const costsEl = document.getElementById('dash-costs');
              const costsPercentEl = document.getElementById('dash-costs-percent');
              const profitEl = document.getElementById('dash-profit');
              const profitPercentEl = document.getElementById('dash-profit-percent');
              const ordersEl = document.getElementById('dash-orders');
              const salesPercentageEl = document.getElementById('dash-sales-percentage');
              
              // Ventas: % arriba, desglose abajo con colores sem√°foro
              const salesPercentage = parseFloat(percentageOfExpected);
              const salesColor = salesPercentage >= 100 ? '#10b981' : salesPercentage >= 80 ? '#f59e0b' : '#dc2626';
              const salesCardEl = document.getElementById('dash-sales-card');
              const salesLabelEl = document.getElementById('dash-sales-label');
              
              // Calcular % vs meta mensual total
              const percentOfMonthlyGoal = ((totalSales / breakEvenWith10Percent) * 100).toFixed(1);
              
              if (salesEl) {
                salesEl.textContent = percentageOfExpected + '%';
                salesEl.style.color = salesColor;
              }
              if (salesLabelEl) {
                salesLabelEl.textContent = `Ventas (${percentOfMonthlyGoal}% meta mes)`;
              }
              if (salesPercentageEl) {
                salesPercentageEl.innerHTML = `<span style="color: #666;">$${new Intl.NumberFormat('es-CL').format(Math.round(totalSales))}</span><br><span style="color: #999; font-size: 0.9em;">Esperado hoy: $${new Intl.NumberFormat('es-CL').format(Math.round(expectedToDate))} (${daysPassed}d)</span>`;
              }
              if (salesCardEl) {
                salesCardEl.style.borderLeftColor = salesColor;
              }
              
              // Resumen compacto
              const profitCard = document.getElementById('dash-profit-card');
              const profitLabel = document.getElementById('dash-profit-label');
              const dailyAvgEl = document.getElementById('dash-daily-avg');
              const dailyMetaEl = document.getElementById('dash-daily-meta');
              
              // Actualizar tarjeta de Punto de Equilibrio
              const breakevenCard = document.getElementById('dash-breakeven-card');
              const breakevenAmount = document.getElementById('dash-breakeven-amount');
              const breakevenPercent = document.getElementById('dash-breakeven-percent');
              
              if (breakevenAmount) {
                breakevenAmount.textContent = additionalSalesNeeded > 0 ? '‚ö†Ô∏è $' + new Intl.NumberFormat('es-CL').format(Math.round(additionalSalesNeeded)) : '‚úÖ $0';
                breakevenAmount.style.color = additionalSalesNeeded > 0 ? '#dc2626' : '#10b981';
              }
              if (breakevenPercent) {
                breakevenPercent.textContent = percentOfBreakeven.toFixed(1) + '% del equilibrio alcanzado';
              }
              if (breakevenCard) {
                breakevenCard.style.borderLeftColor = percentOfBreakeven >= 100 ? '#10b981' : percentOfBreakeven >= 80 ? '#f59e0b' : '#dc2626';
              }
              
              // Actualizar 6 mini KPIs con porcentajes
              const dailyPercent = dailyGoal > 0 ? ((dailyAverage / dailyGoal) * 100).toFixed(1) : 0;
              const comprasPercent = totalSales > 0 ? ((totalCompras / totalSales) * 100).toFixed(1) : 0;
              // Margen Operativo se actualiza desde loadOperationalCards() con datos de API
              const monthlyProgress = breakEvenWith10Percent > 0 ? ((totalSales / breakEvenWith10Percent) * 100).toFixed(1) : 0;
              const effectiveness = expectedToDate > 0 ? ((totalSales / expectedToDate) * 100).toFixed(1) : 0;
              const ticketObjective = 8500;
              const ticketPercent = ticketObjective > 0 ? ((avgTicket / ticketObjective) * 100).toFixed(1) : 0;
              
              // KPI 1: Meta Diaria
              const dailyPercentEl = document.getElementById('dash-daily-percent');
              const dailyDetailEl = document.getElementById('dash-daily-detail');
              const dailyAcumEl = document.getElementById('dash-daily-acum');
              const dailyCard = document.getElementById('kpi-daily-card');
              if (dailyPercentEl) {
                const dailyVal = parseFloat(dailyPercent);
                const dailyBg = dailyVal >= 100 ? '#10b981' : dailyVal >= 80 ? '#f59e0b' : '#ef4444';
                const dailyText = '#ffffff';
                dailyPercentEl.textContent = dailyPercent + '%';
                dailyPercentEl.style.color = dailyText;
                if (dailyCard) dailyCard.style.background = dailyBg;
              }
              if (dailyDetailEl) dailyDetailEl.textContent = 'Diaria: $' + new Intl.NumberFormat('es-CL').format(Math.round(dailyAverage)) + ' / $' + new Intl.NumberFormat('es-CL').format(Math.round(dailyGoal));
              if (dailyAcumEl) dailyAcumEl.textContent = 'Acum: $' + new Intl.NumberFormat('es-CL').format(Math.round(totalSales)) + ' / $' + new Intl.NumberFormat('es-CL').format(Math.round(expectedToDate));
              
              // KPI 2: Meta Mensual
              const monthlyProgressEl = document.getElementById('dash-monthly-progress');
              const monthlyDetailEl = document.getElementById('dash-monthly-detail');
              const monthlyExtraEl = document.getElementById('dash-monthly-extra');
              
              const daysRemaining = daysInMonth - daysPassed;
              const salesRemaining = breakEvenWith10Percent - totalSales;
              const dailyNeeded = daysRemaining > 0 ? salesRemaining / daysRemaining : 0;
              
              const monthlyCard = document.getElementById('kpi-monthly-card');
              if (monthlyProgressEl) {
                const monthlyVal = parseFloat(monthlyProgress);
                const monthlyBg = monthlyVal >= 100 ? '#10b981' : monthlyVal >= 80 ? '#f59e0b' : '#ef4444';
                const monthlyText = '#ffffff';
                monthlyProgressEl.textContent = monthlyProgress + '%';
                monthlyProgressEl.style.color = monthlyText;
                if (monthlyCard) monthlyCard.style.background = monthlyBg;
              }
              if (monthlyDetailEl) {
                monthlyDetailEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(totalSales)) + ' de $' + new Intl.NumberFormat('es-CL').format(Math.round(breakEvenWith10Percent)) + ' (' + daysPassed + 'd/' + daysRemaining + 'd)';
              }
              if (monthlyExtraEl) {
                if (salesRemaining > 0) {
                  monthlyExtraEl.textContent = 'Faltan $' + new Intl.NumberFormat('es-CL').format(Math.round(salesRemaining)) + ' | Ritmo: $' + new Intl.NumberFormat('es-CL').format(Math.round(dailyNeeded)) + '/d';
                } else {
                  monthlyExtraEl.textContent = '‚úÖ Meta alcanzada';
                }
              }
              
              // KPI 3: Rotaci√≥n de Inventario (objetivo vs actual)
              const effectivenessEl = document.getElementById('dash-effectiveness');
              const effectivenessDetailEl = document.getElementById('dash-effectiveness-detail');
              
              // Obtener rotaci√≥n desde tarjeta de inventarios (ya calculada)
              const rotacion = window.dashInventoryRotation || 0;
              const rotacionObjetivo = 1.0; // Objetivo: 1.0x por mes (renueva cada 30 d√≠as) - est√°ndar restaurantes
              const rotacionPercent = rotacionObjetivo > 0 ? ((rotacion / rotacionObjetivo) * 100).toFixed(1) : 0;
              
              const rotationCard = document.getElementById('kpi-rotation-card');
              if (effectivenessEl) {
                const rotacionVal = parseFloat(rotacionPercent);
                // Verde: ‚â•95% (0.95x+), Amarillo: 70-94% (0.7-0.95x), Rojo: <70% (<0.7x)
                const rotacionBg = rotacionVal >= 95 ? '#10b981' : rotacionVal >= 70 ? '#f59e0b' : '#ef4444';
                const rotacionText = '#ffffff';
                effectivenessEl.textContent = rotacionPercent + '%';
                effectivenessEl.style.color = rotacionText;
                if (rotationCard) rotationCard.style.background = rotacionBg;
              }
              if (effectivenessDetailEl) {
                effectivenessDetailEl.textContent = rotacion.toFixed(2) + 'x / ' + rotacionObjetivo.toFixed(1) + 'x';
              }
              
              // KPI 4: Margen Operativo
              const marginPercentEl = document.getElementById('dash-margin-percent');
              const marginCard = document.getElementById('kpi-margin-card');
              if (marginPercentEl) {
                const marginValue = parseFloat(marginPercentEl.textContent) || 0;
                const marginBg = marginValue >= 50 ? '#10b981' : marginValue >= 30 ? '#f59e0b' : '#ef4444';
                const marginText = '#ffffff';
                marginPercentEl.style.color = marginText;
                if (marginCard) marginCard.style.background = marginBg;
              }
              
              // KPI 5: Ticket Promedio
              const ticketPercentEl = document.getElementById('dash-ticket-percent');
              const ticketDetailEl = document.getElementById('dash-ticket-detail');
              const ticketCard = document.getElementById('kpi-ticket-card');
              if (ticketPercentEl) {
                const ticketVal = parseFloat(ticketPercent);
                const ticketBg = ticketVal >= 100 ? '#10b981' : ticketVal >= 80 ? '#f59e0b' : '#ef4444';
                const ticketText = '#ffffff';
                ticketPercentEl.textContent = ticketPercent + '%';
                ticketPercentEl.style.color = ticketText;
                if (ticketCard) ticketCard.style.background = ticketBg;
              }
              if (ticketDetailEl) ticketDetailEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(avgTicket)) + ' / $8.500';
              
              // Guardar m√©tricas globalmente para el componente React
              window.dashboardMetrics = {
                ticketPercent: parseFloat(ticketPercent),
                dailyPercent: parseFloat(dailyPercent),
                monthlyProgress: parseFloat(monthlyProgress),
                growthPercent: 0, // Se actualizar√° despu√©s
                marginPercent: window.dashMargenBruto ? (window.dashMargenBruto * 100) : 0,
                rotacionPercent: parseFloat(rotacionPercent),
                totalSales: totalSales,
                salesRemaining: salesRemaining,
                dailyNeeded: dailyNeeded,
                daysRemaining: daysRemaining,
                daysPassed: new Date().getDate(),
                previousMonthSales: 0,
                previousMonthWeeks: [],
                previousMonthOrders: 0,
                previousMonthTicket: 0,
                previousMonthMargin: 0
              };
              
              // NO renderizar a√∫n, esperar a que se carguen datos del mes anterior
              
              // KPI 6: Crecimiento vs mes anterior
              const growthPercentEl = document.getElementById('dash-growth-percent');
              const growthDetailEl = document.getElementById('dash-growth-detail');
              const growthCard = document.getElementById('kpi-growth-card');
              if (growthPercentEl) {
                const growthValue = parseFloat(growthPercentEl.textContent) || 0;
                const growthBg = growthValue >= 10 ? '#10b981' : growthValue >= 0 ? '#f59e0b' : '#ef4444';
                growthPercentEl.style.color = '#ffffff';
                if (growthCard) growthCard.style.background = growthBg;
              }
              // Se actualiza desde loadDashboardTUU con datos de comparaci√≥n mensual

              // Crear gr√°fico de m√©todos de pago
              createPaymentMethodsChart(paymentMethods, totalDeliveryFee);
            })
            .catch(() => {});
        }
      } catch (error) { console.error('Error:', error); }
      setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 100);
    };
    // Iniciar auto-refresh solo para mes actual (ya declarado arriba)
    if (!dashboardAutoRefreshInterval) {
      dashboardAutoRefreshInterval = setInterval(() => { 
        if (window.loadDashboardTUU && !currentViewMonth) window.loadDashboardTUU(); 
      }, 30000);
    }
    
    function loadDashboardMetrics() {
      console.log('üîÑ Cargando m√©tricas del dashboard...');
      fetch('/api/get_dashboard_analytics.php')
        .then(r => {
          console.log('üì° Respuesta HTTP:', r.status, r.statusText);
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          console.log('üìä Datos recibidos:', data);
          if (data && data.success && data.data) {
            const metrics = data.data.metrics;
            console.log('üìà M√©tricas:', metrics);
            
            // Ya no se usan estos elementos, se cargan con loadDashboardTUU()
            
            // Cargar usuarios registrados
            loadUsersCount();
            
            // Cargar datos de ventas
            loadSalesData();
            
            // Cargar calidad promedio
            loadQualityScore();
            
            console.log('‚úÖ M√©tricas actualizadas en el DOM');
            
            // Crear gr√°ficos con datos reales
            createAnalyticsCharts(data.data);
          } else {
            console.error('‚ùå Estructura de datos inv√°lida:', data);
          }
        })
        .catch(error => {
          console.error('‚ùå Error cargando m√©tricas:', error);
        });
    };
    
    // Cargar tarjetas operativas
    window.loadOperationalCards = function() {
      console.log('üîÑ Cargando tarjetas operativas...');
      fetch(`/api/get_dashboard_cards.php?t=${Date.now()}`)
        .then(r => {
          console.log('üì° Respuesta tarjetas:', r.status);
          return r.json();
        })
        .then(data => {
          console.log('üìä Datos tarjetas:', data);
          if (!data.success) {
            console.error('‚ùå Error en respuesta:', data);
            return;
          }
          
          const cards = data.data;
          

          
          // Tarjeta Margen Bruto (Ventas - CMV) - Usar costo real de ventas
          // Obtener totalSales de loadDashboardTUU (se guarda globalmente)
          const ventasReales = window.dashTotalSales || 0;
          
          // CMV = Costo de Mercader√≠a Vendida (desde get_sales_analytics.php)
          fetch(`/api/get_sales_analytics.php?period=month&t=${Date.now()}`)
            .then(r => r.json())
            .then(analyticsData => {
              if (analyticsData.success && analyticsData.data) {
                const cmv = analyticsData.data.summary_kpis.total_cost || 0; // Costo real de lo vendido
                const margenBruto = ventasReales - cmv;
                const porcentajeMargen = ventasReales > 0 ? ((margenBruto / ventasReales) * 100).toFixed(1) : 0;
                
                document.getElementById('op-margen-total').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(margenBruto));
                document.getElementById('op-margen-ventas').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(ventasReales));
                document.getElementById('op-margen-costos').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(cmv));
                document.getElementById('op-margen-porcentaje').textContent = porcentajeMargen + '%';
                
                // Guardar margen globalmente para otros c√°lculos
                window.dashMargenBruto = parseFloat(porcentajeMargen) / 100;
                
                // Actualizar mini KPI de Margen Operativo
                const marginPercentEl = document.getElementById('dash-margin-percent');
                const marginDetailEl = document.getElementById('dash-margin-detail');
                if (marginPercentEl) {
                  marginPercentEl.textContent = porcentajeMargen + '%';
                  const marginColor = parseFloat(porcentajeMargen) >= 50 ? '#22c55e' : parseFloat(porcentajeMargen) >= 30 ? '#fbbf24' : '#fb7185';
                  marginPercentEl.style.color = marginColor;
                }
                if (marginDetailEl) marginDetailEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(margenBruto)) + ' margen';
              }
            })
            .catch(() => {});
          
          // Tarjeta Compras
          if (cards.compras) {
            document.getElementById('op-compras-total').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(cards.compras.total_mes));
            document.getElementById('op-compras-numero').textContent = cards.compras.numero_compras;
            document.getElementById('op-compras-criticos').textContent = cards.compras.items_criticos;
            document.getElementById('op-compras-proveedor').textContent = cards.compras.top_proveedor || '-';
          }
          
          // Tarjeta Inventarios
          if (cards.inventarios) {
            const valorTotal = cards.inventarios.valor_total || 0;
            const topValor = cards.inventarios.top_inventario_valor || 0;
            const topPercent = valorTotal > 0 ? ((topValor / valorTotal) * 100).toFixed(1) : 0;
            const rotacion = cards.inventarios.rotacion || 0;
            
            document.getElementById('op-inventario-valor').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(valorTotal));
            document.getElementById('op-inventario-items').textContent = cards.inventarios.items_activos;
            document.getElementById('op-inventario-top').textContent = cards.inventarios.top_inventario || '-';
            document.getElementById('op-inventario-top-valor').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(topValor));
            document.getElementById('op-inventario-top-percent').textContent = '(' + topPercent + '%)';
            
            const rotacionBadge = document.getElementById('op-inventario-rotacion-badge');
            rotacionBadge.textContent = rotacion.toFixed(2) + 'x';
            
            // Guardar rotaci√≥n globalmente para KPI de Meta
            window.dashInventoryRotation = rotacion;
            
            // Cambiar color seg√∫n rotaci√≥n
            if (rotacion >= 1.0) {
              // Verde: Rotaci√≥n saludable
              rotacionBadge.style.background = '#10b981';
              rotacionBadge.style.color = 'white';
            } else if (rotacion >= 0.5) {
              // Amarillo: Rotaci√≥n cr√≠tica (0.5-1.0x)
              rotacionBadge.style.background = '#fbbf24';
              rotacionBadge.style.color = '#0a0a0a';
            } else {
              // Rojo: Rotaci√≥n muy baja (<0.5x)
              rotacionBadge.style.background = '#ef4444';
              rotacionBadge.style.color = 'white';
            }
            
            // Tooltip hover - ejecutar despu√©s de que Lucide inicialice
            setTimeout(() => {
              const tooltipContainer = document.querySelector('#op-inventario-rotacion-badge').parentElement;
              const infoIcon = tooltipContainer?.querySelector('svg');
              const tooltip = document.getElementById('op-inventario-rotacion-tooltip');
              
              if (infoIcon && tooltip) {
                infoIcon.style.cursor = 'help';
                infoIcon.addEventListener('mouseenter', () => tooltip.style.display = 'block');
                infoIcon.addEventListener('mouseleave', () => tooltip.style.display = 'none');
              }
            }, 200);
            
            // Guardar para usar en loadDashboardTUU (tarjeta de Ventas)
            window.dashTopProductId = cards.inventarios.mas_vendido_id;
            window.dashTopProductName = cards.inventarios.mas_vendido || '-';
            window.dashTopProductIngresos = cards.inventarios.mas_vendido_ingresos || 0;
          }
          
          // Tarjeta Plan de Compras
          if (cards.plan_compras) {
            document.getElementById('op-plan-items').textContent = cards.plan_compras.items_reposicion + ' items';
            document.getElementById('op-plan-costo').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(cards.plan_compras.costo_estimado));
            document.getElementById('op-plan-urgentes').textContent = cards.plan_compras.items_urgentes;
            document.getElementById('op-plan-dias').textContent = cards.plan_compras.dias_stock || '-';
          }
          console.log('‚úÖ Tarjetas operativas actualizadas');
        })
        .catch(error => console.error('‚ùå Error cargando tarjetas operativas:', error));
    };
    
    window.loadUsers = function() {
      fetch('/api/users/get_users.php')
      .then(r => r.json())
      .then(usersResponse => {
        const tbody = document.querySelector('#usersTable tbody');
        if (!tbody) return;
        
        const users = usersResponse.success ? usersResponse.data : [];
        
        if (Array.isArray(users) && users.length > 0) {
          tbody.innerHTML = users.map(user => {
            const totalSpent = Math.round(user.total_spent || 0);
            const deliveryCount = user.delivery_count || 0;
            const pickupCount = user.pickup_count || 0;
            const rewardsUsed = user.rewards_used || 0;
            const totalStamps = user.total_stamps_earned || 0;
            const stampsConsumed = user.stamps_consumed || 0;
            const availableStamps = totalStamps - stampsConsumed;
            const lastOrder = user.last_order_date ? new Date(user.last_order_date).toLocaleDateString('es-CL', {day: 'numeric', month: 'short'}) : '-';
            
            let rewardStatus = '';
            if (availableStamps >= 6) {
              rewardStatus = '<div style="font-size: 10px; color: #10b981; font-weight: 600;">‚úÖ $10k descuento</div>';
            } else if (availableStamps >= 4) {
              rewardStatus = '<div style="font-size: 10px; color: #10b981; font-weight: 600;">‚úÖ Papas + Bebida</div>';
            } else if (availableStamps >= 2) {
              rewardStatus = '<div style="font-size: 10px; color: #10b981; font-weight: 600;">‚úÖ Delivery gratis</div>';
            }
            
            return `
              <tr>
                <td>${user.id}</td>
                <td>
                  <div style="font-weight: 600;">${user.name || 'Sin nombre'}</div>
                  <div style="font-size: 11px; color: #666;">${user.email}</div>
                  ${user.city ? `<div style="font-size: 10px; color: #999;">üìç ${user.city}</div>` : ''}
                </td>
                <td>${user.email}</td>
                <td>${user.phone || '-'}</td>
                <td>
                  <div style="font-size: 12px;">${new Date(user.registration_date).toLocaleDateString('es-CL', {day: 'numeric', month: 'short', year: 'numeric'})}</div>
                  ${user.last_order_date ? `<div style="font-size: 10px; color: #666;">√öltimo: ${lastOrder}</div>` : ''}
                </td>
                <td>
                  <div style="font-weight: 600; color: #3b82f6;">${user.total_orders || 0}</div>
                  ${deliveryCount > 0 || pickupCount > 0 ? `<div style="font-size: 10px; color: #666;">üöö${deliveryCount} üè™${pickupCount}</div>` : ''}
                  ${rewardsUsed > 0 ? `<div style="font-size: 10px; color: #f59e0b;">üéÅ${rewardsUsed} canjeadas</div>` : ''}
                </td>
                <td>
                  <div style="font-weight: 600; color: #059669;">$${totalSpent.toLocaleString('es-CL')}</div>
                  ${user.total_orders > 0 ? `<div style="font-size: 10px; color: #666;">~$${Math.round(totalSpent / user.total_orders).toLocaleString('es-CL')}/pedido</div>` : ''}
                </td>
                <td>
                  <div style="font-weight: 600; color: #3b82f6; font-size: 16px;">${availableStamps}</div>
                  <div style="font-size: 10px; color: #666;">sellos disponibles</div>
                  ${rewardStatus}
                  ${rewardsUsed > 0 ? `<div style="font-size: 9px; color: #999; margin-top: 2px;">${stampsConsumed} usados</div>` : ''}
                </td>
                <td>
                  <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; background: ${user.is_active == 1 ? '#dcfce7' : '#fef2f2'}; color: ${user.is_active == 1 ? '#166534' : '#dc2626'};">
                    ${user.is_active == 1 ? 'Activo' : 'Inactivo'}
                  </span>
                </td>
                <td>
                  <button class="btn btn-secondary" onclick="viewUserDetails(${user.id})">Ver Detalles</button>
                </td>
              </tr>
            `;
          }).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">No hay usuarios registrados</td></tr>';
        }
      })
      .catch(error => {
        console.error('Error loading users:', error);
        const tbody = document.querySelector('#usersTable tbody');
        if (tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #ef4444;">Error al cargar usuarios</td></tr>';
      });
    };
    
    window.viewUserDetails = function(userId, userTransactions = []) {
      // Si no se pasan transacciones, usar array vac√≠o
      const transactions = Array.isArray(userTransactions) ? userTransactions : [];
      
      // Obtener detalles del usuario
      fetch(`/api/users/get_users.php`)
        .then(r => r.json())
        .then(response => {
          const users = response.success ? response.data : (Array.isArray(response) ? response : []);
          const user = users.find(u => u.id == userId);
          
          if (!user) {
            alert('Usuario no encontrado');
            return;
          }
          
          const modal = document.createElement('div');
          modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
          
          const totalSpent = transactions.reduce((sum, t) => {
            const amount = parseFloat(t.amount || t.totalAmount || t.tuu_amount || 0);
            return sum + (isNaN(amount) ? 0 : amount);
          }, 0);
          
          modal.innerHTML = `
            <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2>Detalles del Usuario</h2>
                <button onclick="closeUserModal(this)" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div>
                  <h3 style="margin-bottom: 12px;">Informaci√≥n Personal</h3>
                  <p><strong>Nombre:</strong> ${user.name || user.first_name || 'No registrado'} ${user.last_name || ''}</p>
                  <p><strong>Email:</strong> ${user.email}</p>
                  <p><strong>Tel√©fono:</strong> ${user.phone || 'No registrado'}</p>
                  <p><strong>Registro:</strong> ${new Date(user.registration_date || user.created_at).toLocaleString('es-CL')}</p>
                </div>
                <div>
                  <h3 style="margin-bottom: 12px;">Estad√≠sticas</h3>
                  <p><strong>Total Pedidos:</strong> ${transactions.length}</p>
                  <p><strong>Total Gastado:</strong> $${totalSpent.toLocaleString('es-CL')}</p>
                  <p><strong>Promedio por Pedido:</strong> $${transactions.length > 0 ? Math.round(totalSpent / transactions.length).toLocaleString('es-CL') : 0}</p>
                  <p><strong>Estado:</strong> ${user.is_active == 1 ? 'Activo' : 'Inactivo'}</p>
                </div>
              </div>
              
              <h3 style="margin-bottom: 12px;">Historial de Pedidos</h3>
              <div style="max-height: 300px; overflow-y: auto;">
                ${transactions.length > 0 ? `
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: #f9fafb;">
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Fecha</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">ID</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Productos</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Monto</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Tipo</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${transactions.map(t => {
                        const displayDate = t.created_at || t.date || t.tuu_timestamp;
                        const displayId = t.order_reference || t.saleId || t.id;
                        const displayAmount = t.amount || t.totalAmount || t.tuu_amount || 0;
                        const isOnline = t.payment_source === 'online';
                        const isApp = displayId && displayId.toString().startsWith('R11-');
                        const paymentType = isOnline ? (isApp ? 'üì≤ APP' : 'üíª Online') : 'üè™ POS';
                        
                        const productDetails = t.detailed_items || t.product_name || 'Pedido gen√©rico';
                        
                        return `
                          <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${new Date(displayDate).toLocaleDateString('es-CL')}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${displayId}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px;">
                              <div style="color: #059669;">${productDetails}</div>
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">$${parseFloat(displayAmount).toLocaleString('es-CL')}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
                              <span style="padding: 2px 6px; border-radius: 4px; font-size: 10px; background: ${isOnline ? (isAppOrder ? '#dcfce7' : '#dbeafe') : '#fef3c7'}; color: ${isOnline ? (isAppOrder ? '#166534' : '#1e40af') : '#92400e'};">
                                ${paymentType}
                              </span>
                            </td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                ` : '<p style="color: #666; text-align: center; padding: 20px;">No hay pedidos registrados</p>'}
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
        })
        .catch(() => {
          alert('Error cargando detalles del usuario');
        });
    };
    
    // Funci√≥n legacy para compatibilidad
    window.viewUserDetail = function(userId) {
      viewUserDetails(userId); // Usar la nueva funci√≥n
      return;
      
      fetch(`/api/get_user_details.php?id=${userId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            const user = data.user;
            const orders = data.orders || [];
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            modal.innerHTML = `
              <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 24px;">
                  <h2>Detalles del Usuario</h2>
                  <button onclick="document.body.removeChild(this.closest('div').parentElement)" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                  <div>
                    <h3 style="margin-bottom: 12px;">Informaci√≥n Personal</h3>
                    <p><strong>Nombre:</strong> ${user.name || 'No registrado'}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Tel√©fono:</strong> ${user.phone || 'No registrado'}</p>
                    <p><strong>Registro:</strong> ${new Date(user.created_at).toLocaleString('es-CL')}</p>
                  </div>
                  <div>
                    <h3 style="margin-bottom: 12px;">Estad√≠sticas</h3>
                    <p><strong>Total Pedidos:</strong> ${user.total_orders || 0}</p>
                    <p><strong>Total Gastado:</strong> $${(user.total_spent || 0).toLocaleString('es-CL')}</p>
                    <p><strong>Promedio por Pedido:</strong> $${user.total_orders > 0 ? Math.round((user.total_spent || 0) / user.total_orders).toLocaleString('es-CL') : 0}</p>
                    <p><strong>Estado:</strong> ${user.is_active == 1 ? 'Activo' : 'Inactivo'}</p>
                  </div>
                </div>
                
                <h3 style="margin-bottom: 12px;">Historial de Pedidos</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                  ${orders.length > 0 ? `
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead>
                        <tr style="background: #f9fafb;">
                          <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Fecha</th>
                          <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Total</th>
                          <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Estado</th>
                          <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Productos</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${orders.map(order => `
                          <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${new Date(order.created_at).toLocaleDateString('es-CL')}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">$${order.total.toLocaleString('es-CL')}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
                              <span style="padding: 2px 6px; border-radius: 4px; font-size: 10px; background: #dcfce7; color: #166534;">${order.status}</span>
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px;">${order.items_count} productos</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  ` : '<p style="color: #666; text-align: center; padding: 20px;">No hay pedidos registrados</p>'}
                </div>
              </div>
            `;
            
            document.body.appendChild(modal);
          } else {
            alert('Error cargando detalles del usuario');
          }
        })
        .catch(() => {
          alert('Error cargando detalles del usuario');
        });
    };
    
    window.filterUsers = function(searchTerm) {
      const rows = document.querySelectorAll('#usersTable tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
      });
    };
    
    let allProducts = [];
    let currentStatusFilter = 'all';
    
    window.loadProducts = function() {
      fetch('/api/get_productos.php?include_inactive=1')
        .then(r => r.json())
        .then(data => {
          allProducts = Array.isArray(data) ? data : [];
          renderProducts();
        })
        .catch(() => {
          const tbody = document.querySelector('#productsTable tbody');
          if (tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #ef4444;">Error al cargar</td></tr>';
        });
    };
    
    window.renderProducts = function() {
      const tbody = document.querySelector('#productsTable tbody');
      if (!tbody) return;
      
      let filteredProducts = allProducts;
      
      // Filtrar por estado
      if (currentStatusFilter === 'active') {
        filteredProducts = allProducts.filter(p => p.is_active == 1);
      } else if (currentStatusFilter === 'inactive') {
        filteredProducts = allProducts.filter(p => p.is_active == 0);
      } else if (currentStatusFilter === 'nocost') {
        filteredProducts = allProducts.filter(p => p.is_active == 1 && (p.cost_price == 0 || p.cost_price == null));
      }
      
      if (filteredProducts.length > 0) {
        const categoryNames = {1: 'La Ruta 11', 2: 'Sandwiches', 3: 'Hamburguesas', 4: 'Completos', 5: 'Snacks', 6: 'Personalizar', 7: 'Extras', 8: 'Combos'};
        tbody.innerHTML = filteredProducts.map(product => `
          <tr data-status="${product.is_active == 1 ? 'active' : 'inactive'}">
            <td><input type="checkbox" class="product-checkbox" value="${product.id}" onchange="updateSelection()"></td>
            <td>
              <img src="${product.image_url || 'https://laruta11-images.s3.amazonaws.com/default-product.jpg'}" 
                   style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;" 
                   alt="${product.name}" onerror="this.src='https://via.placeholder.com/50x50?text=IMG'">
            </td>
            <td>
              <div style="font-weight: 600;">${product.name}</div>
              <div style="font-size: 12px; color: #666;">${product.sku || 'Sin SKU'}</div>
              <div style="font-size: 11px; color: #999; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${product.description || ''}</div>
              ${product.calories ? `<div style="font-size: 10px; color: #f59e0b;">üî• ${product.calories} cal</div>` : ''}
            </td>
            <td>
              <span style="padding: 2px 6px; background: #f3f4f6; border-radius: 4px; font-size: 11px;">${categoryNames[product.category_id] || 'Sin categor√≠a'}</span>
            </td>
            <td>
              <div style="font-weight: 600;">$${new Intl.NumberFormat('es-CL').format(product.price)}</div>
              <div style="font-size: 11px; color: #666;">Costo: $${new Intl.NumberFormat('es-CL').format(product.cost_price || 0)}</div>
              ${product.cost_price > 0 ? `<div style="font-size: 10px; color: #059669;">Margen: ${Math.round(((product.price - product.cost_price) / product.price) * 100)}%</div>` : ''}
            </td>
            <td>
              <div style="color: ${product.stock_quantity <= (product.min_stock_level || 5) ? '#ef4444' : '#22c55e'}; font-weight: 600;">${product.stock_quantity || 0} uds</div>
              <div style="font-size: 10px; color: #666;">M√≠n: ${product.min_stock_level || 5}</div>
            </td>
            <td>
              <div style="font-size: 12px;">‚è±Ô∏è ${product.preparation_time || 10} min</div>
              ${product.grams ? `<div style="font-size: 10px; color: #666;">‚öñÔ∏è ${product.grams}g</div>` : ''}
            </td>
            <td>
              <div style="font-size: 11px;">üëÅÔ∏è ${product.views || 0}</div>
              <div style="font-size: 11px;">‚ù§Ô∏è ${product.likes || 0}</div>
            </td>
            <td>
              <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; background: ${product.is_active == 1 ? '#dcfce7' : '#fef2f2'}; color: ${product.is_active == 1 ? '#166534' : '#dc2626'};">
                ${product.is_active == 1 ? 'Activo' : 'Inactivo'}
              </span>
            </td>
            <td>
              <button class="btn btn-secondary" onclick="openProductEditModal(${product.id})" title="Editar producto">üìù Editar</button>
              <a href="/admin/edit-product?id=${product.id}" class="btn btn-secondary" style="font-size: 11px; padding: 4px 8px;" title="Edici√≥n avanzada" target="_blank">üîß</a>
              <button class="btn btn-danger" onclick="deleteProduct(${product.id})">Eliminar</button>
            </td>
          </tr>
        `).join('');
      } else {
        const message = currentStatusFilter === 'active' ? 'No hay productos activos' : 
                       currentStatusFilter === 'inactive' ? 'No hay productos inactivos' : 
                       currentStatusFilter === 'nocost' ? '‚úÖ Todos los productos activos tienen costo asignado' :
                       'No hay productos';
        tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">${message}</td></tr>`;
      }
    };
    
    window.filterProductsByStatus = function(status) {
      currentStatusFilter = status;
      
      // Actualizar botones activos
      document.querySelectorAll('[id^="filter-"]').forEach(btn => {
        btn.style.background = '#f5f5f5';
        btn.style.color = '#0a0a0a';
      });
      
      const activeBtn = document.getElementById(`filter-${status}`);
      if (activeBtn) {
        activeBtn.style.background = '#0a0a0a';
        activeBtn.style.color = 'white';
      }
      
      renderProducts();
    };
    
    window.addProduct = function() {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      
      modal.innerHTML = `
        <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <h2 style="margin-bottom: 24px;">Nuevo Producto</h2>
          <form id="addForm">
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Nombre *:</label>
              <input type="text" id="addName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Descripci√≥n:</label>
              <textarea id="addDescription" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 80px;"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Precio *:</label>
                <input type="number" id="addPrice" required step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Costo:</label>
                <input type="number" id="addCost" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Stock inicial:</label>
                <input type="number" id="addStock" value="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Stock M√≠nimo:</label>
                <input type="number" id="addMinStock" value="5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Categor√≠a:</label>
                <select id="addCategory" onchange="updateSubcategories()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                  <option value="1">La Ruta 11</option>
                  <option value="2">Sandwiches</option>
                  <option value="3">Hamburguesas</option>
                  <option value="4">Completos</option>
                  <option value="5">Snacks</option>
                  <option value="6">Personalizar</option>
                  <option value="8">Combos</option>
                </select>
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Subcategor√≠a:</label>
                <select id="addSubcategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                  <option value="tomahawks">Tomahawks</option>
                </select>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">SKU:</label>
                <input type="text" id="addSku" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ej: TOMA-001">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Tiempo Prep (min):</label>
                <input type="number" id="addPrepTime" value="10" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Peso (gramos):</label>
                <input type="number" id="addGrams" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Calor√≠as:</label>
                <input type="number" id="addCalories" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Estado:</label>
                <select id="addActive" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                  <option value="1">Activo</option>
                  <option value="0">Inactivo</option>
                </select>
              </div>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Al√©rgenos:</label>
              <textarea id="addAllergens" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 60px;" placeholder="Ej: Gluten, L√°cteos, Frutos secos"></textarea>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Imagen:</label>
              <input type="file" id="addImage" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
              <button type="button" onclick="document.body.removeChild(this.closest('.modal'))" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
              <button type="submit" style="padding: 8px 16px; background: #0a0a0a; color: white; border: none; border-radius: 4px; cursor: pointer;">Crear Producto</button>
            </div>
          </form>
        </div>
      `;
      
      modal.className = 'modal';
      document.body.appendChild(modal);
      
      document.getElementById('addForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('name', document.getElementById('addName').value || '');
        formData.append('description', document.getElementById('addDescription').value || '');
        formData.append('price', document.getElementById('addPrice').value || '0');
        formData.append('cost_price', document.getElementById('addCost').value || '0');
        formData.append('stock_quantity', document.getElementById('addStock').value || '0');
        formData.append('min_stock_level', document.getElementById('addMinStock').value || '5');
        formData.append('category_id', document.getElementById('addCategory').value || '1');
        formData.append('subcategory_id', document.getElementById('addSubcategory').value || '');
        formData.append('sku', document.getElementById('addSku').value || '');
        formData.append('preparation_time', document.getElementById('addPrepTime').value || '10');
        formData.append('grams', document.getElementById('addGrams').value || '0');
        formData.append('calories', document.getElementById('addCalories').value || '0');
        formData.append('is_active', document.getElementById('addActive').value || '1');
        formData.append('allergens', document.getElementById('addAllergens').value || '');
        
        const imageFile = document.getElementById('addImage').files[0];
        if (imageFile) {
          formData.append('image', imageFile);
        }
        
        fetch('/api/add_producto.php', {
          method: 'POST',
          body: formData
        })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            alert('Producto creado');
            document.body.removeChild(modal);
            window.loadProducts();
          } else {
            alert('Error: ' + result.error);
          }
        });
      });
    };
    

    

    
    window.viewUserDetail = function(userId) {
      fetch(`/api/users/get_user_detail.php?id=${userId}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            modal.innerHTML = `
              <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <h2 style="margin-bottom: 24px;">Detalle de Usuario</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                  <div>
                    <h3 style="margin-bottom: 12px;">Informaci√≥n Personal</h3>
                    <p><strong>Nombre:</strong> ${data.user.name}</p>
                    <p><strong>Email:</strong> ${data.user.email}</p>
                    <p><strong>Tel√©fono:</strong> ${data.user.phone || 'No registrado'}</p>
                    <p><strong>Registro:</strong> ${new Date(data.user.registration_date).toLocaleDateString('es-CL')}</p>
                    <p><strong>√öltimo acceso:</strong> ${data.user.last_login ? new Date(data.user.last_login).toLocaleDateString('es-CL') : 'Nunca'}</p>
                  </div>
                  <div>
                    <h3 style="margin-bottom: 12px;">Estad√≠sticas</h3>
                    <p><strong>Total pedidos:</strong> ${data.orders.length}</p>
                    <p><strong>Total gastado:</strong> $${new Intl.NumberFormat('es-CL').format(data.user.total_spent || 0)}</p>
                    <p><strong>Estado:</strong> ${data.user.is_active ? 'Activo' : 'Inactivo'}</p>
                  </div>
                </div>
                <h3 style="margin-bottom: 12px;">Historial de Pedidos</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                  ${data.orders.length > 0 ? data.orders.map(order => `
                    <div style="border: 1px solid #e5e5e5; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                          <strong>Pedido #${order.order_number || order.id}</strong>
                          <span style="margin-left: 12px; padding: 2px 6px; background: #f3f4f6; border-radius: 4px; font-size: 11px;">${order.status}</span>
                        </div>
                        <div style="text-align: right;">
                          <div style="font-weight: 600;">$${new Intl.NumberFormat('es-CL').format(order.total_amount)}</div>
                          <div style="font-size: 11px; color: #666;">${new Date(order.created_at).toLocaleDateString('es-CL')}</div>
                        </div>
                      </div>
                      <div style="margin-top: 8px; font-size: 12px; color: #666;">${order.items || 'Sin items'}</div>
                    </div>
                  `).join('') : '<p style="color: #666; text-align: center; padding: 20px;">No hay pedidos registrados</p>'}
                </div>
                <div style="display: flex; justify-content: flex-end; margin-top: 24px;">
                  <button onclick="document.body.removeChild(this.closest('div'))" style="padding: 8px 16px; background: #0a0a0a; color: white; border: none; border-radius: 4px; cursor: pointer;">Cerrar</button>
                </div>
              </div>
            `;
            
            document.body.appendChild(modal);
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error cargando detalles del usuario');
        });
    };
    
    window.filterUsers = function(searchTerm) {
      const rows = document.querySelectorAll('#usersTable tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
      });
    };
    
    window.deleteProduct = function(id) {
      if (confirm('¬øEliminar producto?')) {
        const formData = new FormData();
        formData.append('id', id);
        fetch('/api/delete_producto.php', { method: 'POST', body: formData })
          .then(r => r.json())
          .then(result => {
            alert(result.success ? 'Producto eliminado' : 'Error: ' + result.error);
            if (result.success) window.loadProducts();
          });
      }
    };
    
    window.filterProducts = function(searchTerm) {
      const tbody = document.querySelector('#productsTable tbody');
      if (!tbody) return;
      
      let filteredProducts = allProducts;
      
      // Filtrar por estado primero
      if (currentStatusFilter === 'active') {
        filteredProducts = allProducts.filter(p => p.is_active == 1);
      } else if (currentStatusFilter === 'inactive') {
        filteredProducts = allProducts.filter(p => p.is_active == 0);
      }
      
      // Luego filtrar por t√©rmino de b√∫squeda
      if (searchTerm.trim()) {
        filteredProducts = filteredProducts.filter(product => {
          const searchText = `${product.name} ${product.sku || ''} ${product.description || ''}`.toLowerCase();
          return searchText.includes(searchTerm.toLowerCase());
        });
      }
      
      // Renderizar productos filtrados
      if (filteredProducts.length > 0) {
        const categoryNames = {1: 'La Ruta 11', 2: 'Sandwiches', 3: 'Hamburguesas', 4: 'Completos', 5: 'Snacks', 6: 'Personalizar', 7: 'Extras', 8: 'Combos'};
        tbody.innerHTML = filteredProducts.map(product => `
          <tr data-status="${product.is_active == 1 ? 'active' : 'inactive'}">
            <td><input type="checkbox" class="product-checkbox" value="${product.id}" onchange="updateSelection()"></td>
            <td>
              <img src="${product.image_url || 'https://laruta11-images.s3.amazonaws.com/default-product.jpg'}" 
                   style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;" 
                   alt="${product.name}" onerror="this.src='https://via.placeholder.com/50x50?text=IMG'">
            </td>
            <td>
              <div style="font-weight: 600;">${product.name}</div>
              <div style="font-size: 12px; color: #666;">${product.sku || 'Sin SKU'}</div>
              <div style="font-size: 11px; color: #999; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${product.description || ''}</div>
              ${product.calories ? `<div style="font-size: 10px; color: #f59e0b;">üî• ${product.calories} cal</div>` : ''}
            </td>
            <td>
              <span style="padding: 2px 6px; background: #f3f4f6; border-radius: 4px; font-size: 11px;">${categoryNames[product.category_id] || 'Sin categor√≠a'}</span>
            </td>
            <td>
              <div style="font-weight: 600;">$${new Intl.NumberFormat('es-CL').format(product.price)}</div>
              <div style="font-size: 11px; color: #666;">Costo: $${new Intl.NumberFormat('es-CL').format(product.cost_price || 0)}</div>
              ${product.cost_price > 0 ? `<div style="font-size: 10px; color: #059669;">Margen: ${Math.round(((product.price - product.cost_price) / product.price) * 100)}%</div>` : ''}
            </td>
            <td>
              <div style="color: ${product.stock_quantity <= (product.min_stock_level || 5) ? '#ef4444' : '#22c55e'}; font-weight: 600;">${product.stock_quantity || 0} uds</div>
              <div style="font-size: 10px; color: #666;">M√≠n: ${product.min_stock_level || 5}</div>
            </td>
            <td>
              <div style="font-size: 12px;">‚è±Ô∏è ${product.preparation_time || 10} min</div>
              ${product.grams ? `<div style="font-size: 10px; color: #666;">‚öñÔ∏è ${product.grams}g</div>` : ''}
            </td>
            <td>
              <div style="font-size: 11px;">üëÅÔ∏è ${product.views || 0}</div>
              <div style="font-size: 11px;">‚ù§Ô∏è ${product.likes || 0}</div>
            </td>
            <td>
              <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; background: ${product.is_active == 1 ? '#dcfce7' : '#fef2f2'}; color: ${product.is_active == 1 ? '#166534' : '#dc2626'};">
                ${product.is_active == 1 ? 'Activo' : 'Inactivo'}
              </span>
            </td>
            <td>
              <a href="/admin/edit-product?id=${product.id}" class="btn btn-secondary" title="Editar producto e ingredientes">üìù Editar</a>
              <button class="btn btn-danger" onclick="deleteProduct(${product.id})">Eliminar</button>
            </td>
          </tr>
        `).join('');
      } else {
        const message = searchTerm.trim() ? 'No se encontraron productos' : 
                       currentStatusFilter === 'active' ? 'No hay productos activos' : 
                       currentStatusFilter === 'inactive' ? 'No hay productos inactivos' : 
                       'No hay productos';
        tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px; color: #666;">${message}</td></tr>`;
      }
    };
    
    window.logout = function() {
      fetch('/api/admin_logout.php').then(() => window.location.href = '/admin/login');
    };
    
    // ========== MILITARES RL6 FUNCTIONS ==========
    let currentRL6Filter = 'pending';
    
    window.loadMilitaresRL6 = function() {
      fetch(`/api/get_militares_rl6.php?status=${currentRL6Filter}&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          const tbody = document.querySelector('#militaresRL6Table tbody');
          if (!tbody) return;
          
          const militares = data.success ? data.data : [];
          
          if (militares.length > 0) {
            tbody.innerHTML = militares.map(militar => {
              const hasDocuments = militar.carnet_militar_url && militar.selfie_carnet_url;
              const creditoAprobado = militar.credito_aprobado == 1;
              
              return `
                <tr>
                  <td>${militar.id}</td>
                  <td>
                    <div style="font-weight: 600;">${militar.name || 'Sin nombre'}</div>
                    <div style="font-size: 11px; color: #666;">${militar.email}</div>
                  </td>
                  <td style="font-family: monospace; font-size: 12px;">${militar.rut_militar || '-'}</td>
                  <td><span style="padding: 2px 6px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 11px;">${militar.rango_militar || '-'}</span></td>
                  <td style="font-size: 12px;">${militar.unidad_militar || '-'}</td>
                  <td style="font-size: 12px;">${new Date(militar.registration_date).toLocaleDateString('es-CL')}</td>
                  <td>
                    ${creditoAprobado ? `
                      <div style="font-weight: 600; color: #059669;">$${new Intl.NumberFormat('es-CL').format(militar.limite_credito || 0)}</div>
                      <div style="font-size: 10px; color: #666;">Disponible: $${new Intl.NumberFormat('es-CL').format(militar.credito_disponible || 0)}</div>
                      <div style="font-size: 10px; color: #999;">Usado: $${new Intl.NumberFormat('es-CL').format(militar.credito_usado || 0)}</div>
                    ` : '<span style="color: #999;">Sin cr√©dito</span>'}
                  </td>
                  <td>
                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; background: ${creditoAprobado ? '#dcfce7' : '#fef2f2'}; color: ${creditoAprobado ? '#166534' : '#dc2626'};">
                      ${creditoAprobado ? '‚úÖ Aprobado' : '‚è≥ Pendiente'}
                    </span>
                    ${!hasDocuments ? '<div style="font-size: 10px; color: #f59e0b; margin-top: 4px;">‚ö†Ô∏è Sin documentos</div>' : ''}
                  </td>
                  <td>
                    <button class="btn btn-secondary" onclick="viewMilitarRL6(${militar.id})" style="font-size: 12px; padding: 6px 12px; margin: 2px;">üëÅÔ∏è Ver</button>
                    ${!creditoAprobado && hasDocuments ? `
                      <button class="btn btn-primary" onclick="approveMilitarRL6(${militar.id})" style="font-size: 12px; padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">‚úÖ Aprobar</button>
                      <button class="btn btn-danger" onclick="rejectMilitarRL6(${militar.id})" style="font-size: 12px; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">‚ùå Rechazar</button>
                    ` : ''}
                    ${creditoAprobado ? `
                      <button class="btn btn-danger" onclick="rejectMilitarRL6(${militar.id})" style="font-size: 12px; padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">üîÑ Revocar</button>
                    ` : ''}
                  </td>
                </tr>
              `;
            }).join('');
          } else {
            const message = currentRL6Filter === 'pending' ? 'No hay militares pendientes de aprobaci√≥n' : 
                           currentRL6Filter === 'approved' ? 'No hay militares aprobados' : 
                           'No hay militares registrados';
            tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">${message}</td></tr>`;
          }
        })
        .catch(error => {
          console.error('Error loading militares RL6:', error);
          const tbody = document.querySelector('#militaresRL6Table tbody');
          if (tbody) tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #ef4444;">Error al cargar militares</td></tr>';
        });
    };
    
    window.filterMilitaresRL6 = function(status) {
      currentRL6Filter = status;
      
      // Actualizar botones activos
      ['pending', 'approved', 'all'].forEach(s => {
        const btn = document.getElementById(`filter-rl6-${s}`);
        if (btn) {
          btn.style.background = s === status ? '#0a0a0a' : '#f5f5f5';
          btn.style.color = s === status ? 'white' : '#0a0a0a';
        }
      });
      
      loadMilitaresRL6();
    };
    
    window.viewMilitarRL6 = function(militarId) {
      fetch(`/api/get_militares_rl6.php?status=all&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          const militares = data.success ? data.data : [];
          const militar = militares.find(m => m.id == militarId);
          
          if (!militar) {
            alert('Militar no encontrado');
            return;
          }
          
          const modal = document.createElement('div');
          modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px;';
          
          const creditoAprobado = militar.credito_aprobado == 1;
          const hasDocuments = militar.carnet_militar_url && militar.selfie_carnet_url;
          
          modal.innerHTML = `
            <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2>üéØ Detalle Militar RL6</h2>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div>
                  <h3 style="margin-bottom: 12px; font-size: 16px;">üë§ Informaci√≥n Personal</h3>
                  <p><strong>Nombre:</strong> ${militar.name || 'No registrado'}</p>
                  <p><strong>Email:</strong> ${militar.email}</p>
                  <p><strong>Tel√©fono:</strong> ${militar.phone || 'No registrado'}</p>
                  <p><strong>Registro:</strong> ${new Date(militar.registration_date).toLocaleString('es-CL')}</p>
                </div>
                <div>
                  <h3 style="margin-bottom: 12px; font-size: 16px;">üéØ Informaci√≥n Militar</h3>
                  <p><strong>RUT:</strong> ${militar.rut_militar || 'No registrado'}</p>
                  <p><strong>Rango:</strong> ${militar.rango_militar || 'No registrado'}</p>
                  <p><strong>Unidad:</strong> ${militar.unidad_militar || 'No registrado'}</p>
                </div>
              </div>
              
              ${hasDocuments ? `
                <div style="margin-bottom: 24px;">
                  <h3 style="margin-bottom: 12px; font-size: 16px;">üì∏ Documentos</h3>
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div>
                      <p style="font-weight: 600; margin-bottom: 8px;">Carnet Frontal</p>
                      <img src="${militar.carnet_militar_url}" style="width: 100%; max-height: 300px; object-fit: contain; border: 2px solid #e5e5e5; border-radius: 8px; cursor: pointer;" onclick="window.open('${militar.carnet_militar_url}', '_blank')" alt="Carnet Frontal">
                    </div>
                    <div>
                      <p style="font-weight: 600; margin-bottom: 8px;">Carnet Trasero</p>
                      <img src="${militar.carnet_trasero_url}" style="width: 100%; max-height: 300px; object-fit: contain; border: 2px solid #e5e5e5; border-radius: 8px; cursor: pointer;" onclick="window.open('${militar.carnet_trasero_url}', '_blank')" alt="Carnet Trasero">
                    </div>
                    <div>
                      <p style="font-weight: 600; margin-bottom: 8px;">Selfie</p>
                      <img src="${militar.selfie_carnet_url}" style="width: 100%; max-height: 300px; object-fit: contain; border: 2px solid #e5e5e5; border-radius: 8px; cursor: pointer;" onclick="window.open('${militar.selfie_carnet_url}', '_blank')" alt="Selfie">
                    </div>
                  </div>
                </div>
              ` : '<div style="background: #fef2f2; border: 1px solid #fecaca; padding: 16px; border-radius: 8px; margin-bottom: 24px; color: #dc2626;">‚ö†Ô∏è El usuario a√∫n no ha subido los documentos requeridos</div>'}
              
              <div style="background: ${creditoAprobado ? '#dcfce7' : '#fef3c7'}; border: 1px solid ${creditoAprobado ? '#bbf7d0' : '#fde68a'}; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <h3 style="margin-bottom: 12px; font-size: 16px; color: ${creditoAprobado ? '#166534' : '#92400e'};">üí≥ Estado de Cr√©dito</h3>
                ${creditoAprobado ? `
                  <p><strong>L√≠mite de Cr√©dito:</strong> $${new Intl.NumberFormat('es-CL').format(militar.limite_credito || 0)}</p>
                  <p><strong>Cr√©dito Disponible:</strong> $${new Intl.NumberFormat('es-CL').format(militar.credito_disponible || 0)}</p>
                  <p><strong>Cr√©dito Usado:</strong> $${new Intl.NumberFormat('es-CL').format(militar.credito_usado || 0)}</p>
                  <p><strong>Fecha Aprobaci√≥n:</strong> ${militar.fecha_aprobacion_credito ? new Date(militar.fecha_aprobacion_credito).toLocaleString('es-CL') : '-'}</p>
                ` : '<p style="color: #92400e;">‚è≥ Cr√©dito pendiente de aprobaci√≥n</p>'}
              </div>
              
              ${!creditoAprobado && hasDocuments ? `
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                  <button onclick="this.closest('div[style*=fixed]').remove()" class="btn btn-secondary">Cerrar</button>
                  <button onclick="rejectMilitarRL6(${militar.id})" class="btn btn-danger">‚ùå Rechazar Cr√©dito</button>
                  <button onclick="approveMilitarRL6(${militar.id})" class="btn btn-primary" style="background: #10b981;">‚úÖ Aprobar Cr√©dito</button>
                </div>
              ` : `
                <div style="display: flex; justify-content: flex-end;">
                  <button onclick="this.closest('div[style*=fixed]').remove()" class="btn btn-primary">Cerrar</button>
                </div>
              `}
            </div>
          `;
          
          document.body.appendChild(modal);
        })
        .catch(() => {
          alert('Error cargando detalles del militar');
        });
    };
    
    window.approveMilitarRL6 = function(militarId) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001;';
      
      modal.innerHTML = `
        <div style="background: white; padding: 32px; border-radius: 12px; width: 90%; max-width: 500px;">
          <h2 style="margin-bottom: 24px;">‚úÖ Aprobar Cr√©dito Militar RL6</h2>
          <form id="approveRL6Form">
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">L√≠mite de Cr√©dito ($):</label>
              <input type="number" id="limiteCredito" required step="1000" value="50000" min="10000" max="500000" style="width: 100%; padding: 12px; border: 1px solid #e5e5e5; border-radius: 6px; font-size: 16px;">
              <div style="font-size: 12px; color: #666; margin-top: 4px;">Rango sugerido: $10.000 - $500.000</div>
            </div>
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
              <div style="font-size: 13px; color: #0369a1;">
                <strong>üìå Nota:</strong> El cr√©dito aprobado estar√° disponible inmediatamente para el militar en la APP.
              </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button type="button" onclick="this.closest('div[style*=fixed]').remove()" class="btn btn-secondary">Cancelar</button>
              <button type="submit" class="btn btn-primary" style="background: #10b981;">‚úÖ Aprobar</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('approveRL6Form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const limiteCredito = document.getElementById('limiteCredito').value;
        
        if (!limiteCredito || limiteCredito < 10000) {
          alert('El l√≠mite de cr√©dito debe ser al menos $10.000');
          return;
        }
        
        const formData = new FormData();
        formData.append('usuario_id', militarId);
        formData.append('action', 'approve');
        formData.append('limite_credito', limiteCredito);
        formData.append('admin_id', 1); // TODO: Obtener ID del admin logueado
        
        fetch('/api/approve_militar_rl6.php', {
          method: 'POST',
          body: formData
        })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            alert('‚úÖ Cr√©dito aprobado exitosamente');
            modal.remove();
            // Cerrar modal de detalle si est√° abierto
            const detailModal = document.querySelector('div[style*="z-index: 1000"]');
            if (detailModal) detailModal.remove();
            loadMilitaresRL6();
          } else {
            alert('‚ùå Error: ' + result.error);
          }
        })
        .catch(error => {
          alert('‚ùå Error: ' + error.message);
        });
      });
    };
    window.rejectMilitarRL6 = function(militarId) {
      if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de RECHAZAR esta solicitud de cr√©dito?\n\nEsta acci√≥n notificar√° al militar que su solicitud fue rechazada.')) {
        return;
      }
      
      const formData = new FormData();
      formData.append('usuario_id', militarId);
      formData.append('action', 'reject');
      formData.append('admin_id', 1);
      
      fetch('/api/approve_militar_rl6.php', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(result => {
        if (result.success) {
          alert('‚ùå Solicitud de cr√©dito rechazada');
          const detailModal = document.querySelector('div[style*="z-index: 1000"]');
          if (detailModal) detailModal.remove();
          loadMilitaresRL6();
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      })
      .catch(error => {
        alert('‚ùå Error: ' + error.message);
      });
    };
    // ========== END MILITARES RL6 FUNCTIONS ==========
    
    // TUU reports now handled in separate page
    
    window.viewTUUTransaction = function(transaction) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      
      const isOnline = transaction.payment_source === 'online';
      const displayDate = transaction.created_at || transaction.date || transaction.tuu_timestamp;
      const displayId = transaction.order_reference || transaction.saleId || transaction.id;
      const displayAmount = transaction.amount || transaction.totalAmount || transaction.tuu_amount || 0;
      const displayCustomer = transaction.customer_name || (isOnline ? 'Cliente Online' : 'Cliente POS');
      
      // Determinar tipo de pago
      const isApp = displayId && displayId.toString().startsWith('R11-');
      const paymentTypeText = isOnline ? (isApp ? 'Pedido desde APP' : 'Pago Web') : 'POS F√≠sico';
      
      modal.innerHTML = `
        <div style="background: white; padding: 16px; border-radius: 12px; width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; margin: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="font-size: 18px; margin: 0;">${window.innerWidth < 640 ? (isOnline ? 'APP' : 'POS') : `Detalle Transacci√≥n ${isOnline ? (isApp ? 'APP' : 'Online') : 'POS'}`}</h2>
            <button onclick="closeModal(this)" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 8px;">&times;</button>
          </div>
          
          <div style="display: grid; grid-template-columns: ${window.innerWidth < 640 ? '1fr' : '1fr 1fr'}; gap: 16px; margin-bottom: 16px;">
            <div>
              <h3 style="margin-bottom: 12px;">Informaci√≥n de Venta</h3>
              <p><strong>ID Venta:</strong> ${displayId}</p>
              <p><strong>Fecha:</strong> ${new Date(displayDate).toLocaleString('es-CL')}</p>
              <p><strong>Monto:</strong> $${new Intl.NumberFormat('es-CL').format(displayAmount)}</p>
              <p><strong>Estado:</strong> ${(transaction.status === 'completed' || !transaction.status) ? '‚úì Completado' : transaction.status}</p>
              <p><strong>Tipo:</strong> ${paymentTypeText}</p>
            </div>
            <div>
              <h3 style="margin-bottom: 12px;">${isOnline ? 'Datos del Cliente' : 'Detalles de Pago'}</h3>
              ${isOnline ? `
                <p><strong>Cliente:</strong> ${displayCustomer}</p>
                ${transaction.customer_phone ? `<p><strong>Tel√©fono:</strong> ${transaction.customer_phone}</p>` : ''}
                ${transaction.detailed_items ? `<p><strong>Productos:</strong> ${transaction.detailed_items}</p>` : 
                  (transaction.product_name && transaction.product_name !== 'Pedido La Ruta 11' ? `<p><strong>Producto:</strong> ${transaction.product_name}</p>` : '<p><strong>Producto:</strong> Pedido gen√©rico</p>')}
                ${transaction.items_count ? `<p><strong>Total Items:</strong> ${transaction.items_count}</p>` : ''}
              ` : `
                <p><strong>Tipo:</strong> ${transaction.transaction_type || 'Tarjeta'}</p>
                <p><strong>Procesador:</strong> TUU/Transbank</p>
                <p><strong>Cliente:</strong> ${displayCustomer}</p>
                <p><strong>Terminal:</strong> ${transaction.pos_serial_number || 'POS F√≠sico'}</p>
              `}
            </div>
          </div>
          
          ${isOnline && (transaction.tuu_transaction_id || transaction.tuu_message || transaction.tuu_account_id) ? `
            <div style="border-top: 1px solid #e5e5e5; padding-top: 24px;">
              <h3 style="margin-bottom: 12px;">Detalles TUU/Transbank</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                  ${transaction.tuu_transaction_id ? `<p><strong>ID Transacci√≥n TUU:</strong> ${transaction.tuu_transaction_id}</p>` : ''}
                  ${transaction.tuu_account_id ? `<p><strong>Cuenta TUU:</strong> ${transaction.tuu_account_id}</p>` : ''}
                  ${transaction.tuu_currency ? `<p><strong>Moneda:</strong> ${transaction.tuu_currency}</p>` : ''}
                </div>
                <div>
                  ${transaction.tuu_message ? `<p><strong>Mensaje:</strong> ${transaction.tuu_message}</p>` : ''}
                  ${transaction.tuu_timestamp ? `<p><strong>Timestamp TUU:</strong> ${new Date(transaction.tuu_timestamp * 1000).toLocaleString('es-CL')}</p>` : ''}
                  <p><strong>Procesador:</strong> TUU/Transbank</p>
                </div>
              </div>
            </div>
          ` : ''}
          
          ${!isOnline ? `
            <div style="border-top: 1px solid #e5e5e5; padding-top: 24px;">
              <h3 style="margin-bottom: 12px;">Detalles del Terminal POS</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                  ${transaction.serialNumber ? `<p><strong>N√∫mero de Serie:</strong> ${transaction.serialNumber}</p>` : ''}
                  ${transaction.sequenceNumber && transaction.sequenceNumber !== 'N/A' ? `<p><strong>N¬∫ Transacci√≥n:</strong> ${transaction.sequenceNumber}</p>` : ''}
                  ${transaction.locationId && transaction.locationId !== 'N/A' ? `<p><strong>ID Ubicaci√≥n:</strong> ${transaction.locationId}</p>` : ''}
                  ${transaction.address && transaction.address !== 'N/A' ? `<p><strong>Direcci√≥n:</strong> ${transaction.address}</p>` : ''}
                  ${transaction.channel ? `<p><strong>Tipo de Canal:</strong> ${transaction.channel}</p>` : ''}
                  ${transaction.commission && transaction.commission !== 'N/A' ? `<p><strong>Comisi√≥n:</strong> ${transaction.commission}</p>` : ''}
                </div>
                <div>
                  ${transaction.cardBrand && transaction.cardBrand !== 'N/A' ? `<p><strong>Marca Tarjeta:</strong> ${transaction.cardBrand}</p>` : ''}
                  ${transaction.cardBin && transaction.cardBin !== 'N/A' ? `<p><strong>BIN Tarjeta:</strong> ${transaction.cardBin}</p>` : ''}
                  ${transaction.cardLastFour && transaction.cardLastFour !== 'N/A' ? `<p><strong>N¬∫ Tarjeta:</strong> ****${transaction.cardLastFour}</p>` : ''}
                  ${transaction.cardOrigin && transaction.cardOrigin !== 'N/A' ? `<p><strong>Origen:</strong> ${transaction.cardOrigin}</p>` : ''}
                  ${transaction.cardIssuer && transaction.cardIssuer !== 'N/A' ? `<p><strong>Banco Emisor:</strong> ${transaction.cardIssuer}</p>` : ''}
                  ${transaction.activityCode ? `<p><strong>C√≥d. Actividad SII:</strong> ${transaction.activityCode}</p>` : ''}
                </div>
              </div>
              ${transaction.tipAmount > 0 || transaction.cashbackAmount > 0 ? `
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
                  <h4 style="margin-bottom: 8px;">Desglose de Montos</h4>
                  <p><strong>Venta:</strong> $${parseInt(transaction.saleAmount || transaction.totalAmount).toLocaleString('es-CL')}</p>
                  ${transaction.tipAmount > 0 ? `<p><strong>Propina:</strong> $${parseInt(transaction.tipAmount).toLocaleString('es-CL')}</p>` : ''}
                  ${transaction.cashbackAmount > 0 ? `<p><strong>Vuelto:</strong> $${parseInt(transaction.cashbackAmount).toLocaleString('es-CL')}</p>` : ''}
                </div>
              ` : ''}
              ${transaction.installmentCount > 0 ? `
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;">
                  <h4 style="margin-bottom: 8px;">Informaci√≥n de Cuotas</h4>
                  <p><strong>Tipo:</strong> ${transaction.installmentType}</p>
                  <p><strong>Cantidad:</strong> ${transaction.installmentCount} cuotas</p>
                </div>
              ` : ''}
            </div>
          ` : ''}
          
          <div style="margin-top: 24px; text-align: center; color: #666;">
            <p>${isOnline ? 'Pago procesado v√≠a TUU/Transbank Online con datos completos' : 'Transacci√≥n POS - Datos b√°sicos disponibles'}</p>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.remove();
      });
    };
    
    window.closeModal = function(button) {
      const modal = button.closest('div[style*="position: fixed"]');
      if (modal) modal.remove();
    };
    
    window.loadTestAPIs = function() {
      // El iframe ya carga autom√°ticamente
    };
    
    window.loadRobotsView = function() {
      checkRobotStatus();
    };
    
    window.checkRobotStatus = function() {
      fetch('/api/check_tracking_data.php')
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById('robot-tests').textContent = data.data.interactions_today || 0;
            document.getElementById('robot-success').textContent = data.data.visits_today > 0 ? '100%' : '0%';
            document.getElementById('robot-last').textContent = new Date().toLocaleTimeString('es-CL');
            document.getElementById('robot-status').textContent = data.data.visits_today > 0 ? 'Activo' : 'Inactivo';
          }
        })
        .catch(() => {
          document.getElementById('robot-status').textContent = 'Error';
        });
    };
    
    window.cleanRobotData = function() {
      if (confirm('¬øLimpiar todos los datos generados por robots de testing?')) {
        fetch('/api/cleanup_fake_data.php')
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              alert('‚úÖ Datos de robot limpiados exitosamente');
              checkRobotStatus();
            } else {
              alert('‚ùå Error: ' + data.error);
            }
          })
          .catch(error => {
            alert('‚ùå Error de conexi√≥n: ' + error.message);
          });
      }
    };
    
    window.loadTechnicalReport = function() {
      const container = document.getElementById('technical-report-container');
      if (!container) return;
      
      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0a0a0a; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 16px;">Cargando informe t√©cnico...</p></div>';
      
      fetch('/api/get_technical_report.php')
        .then(r => r.json())
        .then(data => {
          if (data.success && data.report) {
            const report = data.report;
            
            container.innerHTML = `
              <div style="padding: 24px;">
                <!-- M√©tricas principales -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                  <div class="stat-card">
                    <div class="stat-value">${report.summary.totalFiles.toLocaleString()}</div>
                    <div class="stat-label">Total Archivos</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">${report.summary.totalLines.toLocaleString()}</div>
                    <div class="stat-label">L√≠neas de C√≥digo</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">${report.categories['Backend PHP'].files}</div>
                    <div class="stat-label">APIs PHP</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">${report.categories.Frontend.files}</div>
                    <div class="stat-label">Frontend</div>
                  </div>
                </div>
                
                <!-- Stack tecnol√≥gico -->
                <div class="card" style="margin-bottom: 24px;">
                  <div class="card-header">
                    <h3 class="card-title">Stack Tecnol√≥gico</h3>
                  </div>
                  <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                      ${Object.entries(report.categories).filter(([_, data]) => data.files > 0).map(([category, data]) => `
                        <div style="padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                          <div style="font-weight: 600; margin-bottom: 4px;">${category}</div>
                          <div style="font-size: 14px; color: #666;">${data.files} archivos</div>
                          <div style="font-size: 12px; color: #999;">${data.lines.toLocaleString()} l√≠neas</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
                
                <!-- Archivos m√°s grandes -->
                <div class="card" style="margin-bottom: 24px;">
                  <div class="card-header">
                    <h3 class="card-title">Archivos M√°s Grandes</h3>
                  </div>
                  <div class="card-content">
                    <div style="max-height: 300px; overflow-y: auto;">
                      ${report.largestFiles.slice(0, 10).map((file, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                          <span style="font-family: monospace; font-size: 13px;">${index + 1}. ${file.path}</span>
                          <span style="font-size: 13px; color: #666;">${file.lines.toLocaleString()} l√≠neas</span>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
                
                <!-- Distribuci√≥n por directorios -->
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Distribuci√≥n por Directorios</h3>
                  </div>
                  <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                      ${Object.entries(report.directories).sort((a, b) => b[1].files - a[1].files).slice(0, 8).map(([dir, data]) => `
                        <div style="padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                          <div style="font-weight: 600; margin-bottom: 4px;">/${dir}</div>
                          <div style="font-size: 14px; color: #666;">${data.files} archivos</div>
                          <div style="font-size: 12px; color: #999;">${data.lines.toLocaleString()} l√≠neas</div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
                
                <!-- Estado del sistema -->
                <div style="margin-top: 24px; padding: 16px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
                  <h3 style="color: #166534; margin-bottom: 12px;">Estado del Sistema</h3>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div style="display: flex; align-items: center; color: #166534;">
                      <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; margin-right: 8px;"></div>
                      Aplicaci√≥n Operativa
                    </div>
                    <div style="display: flex; align-items: center; color: #166534;">
                      <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; margin-right: 8px;"></div>
                      API Funcionando
                    </div>
                    <div style="display: flex; align-items: center; color: #166534;">
                      <div style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; margin-right: 8px;"></div>
                      Base de Datos OK
                    </div>
                  </div>
                </div>
                
                <div style="margin-top: 16px; text-align: center; color: #666; font-size: 12px;">
                  √öltima actualizaci√≥n: ${new Date().toLocaleString('es-CL')}
                </div>
              </div>
            `;
          } else {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error cargando informe t√©cnico</div>';
          }
        })
        .catch(error => {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error de conexi√≥n: ' + error.message + '</div>';
        });
    };
    
    // Funci√≥n para actualizar subcategor√≠as en edici√≥n masiva
    window.updateBulkSubcategories = function() {
      const categorySelect = document.getElementById('bulkCategory');
      const subcategorySelect = document.getElementById('bulkSubcategory');
      const categoryId = categorySelect.value;
      
      console.log('üîÑ Cargando subcategor√≠as bulk para categor√≠a ID:', categoryId);
      subcategorySelect.innerHTML = '<option value="">No cambiar</option>';
      
      if (!categoryId) return;
      
      fetch(`/api/get_subcategories.php?category_id=${categoryId}`)
        .then(r => {
          console.log('üì° Respuesta HTTP bulk:', r.status, r.statusText);
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          console.log('üìä Datos bulk recibidos:', data);
          if (data.success && data.subcategories && data.subcategories.length > 0) {
            console.log('‚úÖ Subcategor√≠as bulk encontradas:', data.subcategories.length);
            data.subcategories.forEach(sub => {
              const option = document.createElement('option');
              option.value = sub.id;
              option.textContent = sub.name;
              subcategorySelect.appendChild(option);
              console.log('‚ûï Agregada subcategor√≠a bulk:', sub.name, '(ID:', sub.id + ')');
            });
          } else {
            console.log('‚ö†Ô∏è No hay subcategor√≠as bulk disponibles');
          }
        })
        .catch(error => {
          console.error('‚ùå Error cargando subcategor√≠as bulk:', error);
        });
    };
    
    // Funci√≥n para actualizar subcategor√≠as en nuevo producto
    window.updateSubcategories = function() {
      const categorySelect = document.getElementById('addCategory');
      const subcategorySelect = document.getElementById('addSubcategory');
      const categoryId = categorySelect.value;
      
      console.log('üîÑ Cargando subcategor√≠as para categor√≠a ID:', categoryId);
      subcategorySelect.innerHTML = '<option value="">Cargando...</option>';
      
      if (!categoryId) {
        subcategorySelect.innerHTML = '<option value="">Selecciona una categor√≠a</option>';
        return;
      }
      
      fetch(`/api/get_subcategories.php?category_id=${categoryId}`)
        .then(r => {
          console.log('üì° Respuesta HTTP:', r.status, r.statusText);
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          console.log('üìä Datos recibidos:', data);
          subcategorySelect.innerHTML = '<option value="">Seleccionar subcategor√≠a...</option>';
          
          if (data.success && data.subcategories && data.subcategories.length > 0) {
            console.log('‚úÖ Subcategor√≠as encontradas:', data.subcategories.length);
            data.subcategories.forEach(sub => {
              const option = document.createElement('option');
              option.value = sub.id;
              option.textContent = sub.name;
              subcategorySelect.appendChild(option);
              console.log('‚ûï Agregada subcategor√≠a:', sub.name, '(ID:', sub.id + ')');
            });
          } else {
            console.log('‚ö†Ô∏è No hay subcategor√≠as disponibles');
            subcategorySelect.innerHTML = '<option value="">Sin subcategor√≠as</option>';
          }
        })
        .catch(error => {
          console.error('‚ùå Error cargando subcategor√≠as:', error);
          subcategorySelect.innerHTML = '<option value="">Error cargando</option>';
        });
    };
    
    // Funciones de selecci√≥n m√∫ltiple
    window.toggleSelectAll = function(checked) {
      const checkboxes = document.querySelectorAll('.product-checkbox');
      checkboxes.forEach(cb => cb.checked = checked);
      updateSelection();
    };
    
    window.updateSelection = function() {
      const checkboxes = document.querySelectorAll('.product-checkbox');
      const checked = document.querySelectorAll('.product-checkbox:checked');
      const selectAll = document.getElementById('select-all');
      const bulkActions = document.getElementById('bulk-actions');
      const selectedCount = document.getElementById('selected-count');
      
      if (checked.length === 0) {
        selectAll.indeterminate = false;
        selectAll.checked = false;
      } else if (checked.length === checkboxes.length) {
        selectAll.indeterminate = false;
        selectAll.checked = true;
      } else {
        selectAll.indeterminate = true;
        selectAll.checked = false;
      }
      
      if (checked.length > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = `${checked.length} producto${checked.length > 1 ? 's' : ''} seleccionado${checked.length > 1 ? 's' : ''}`;
      } else {
        bulkActions.style.display = 'none';
      }
    };
    
    window.clearSelection = function() {
      document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('select-all').checked = false;
      updateSelection();
    };
    
    window.getSelectedIds = function() {
      return Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
    };
    
    window.bulkActivate = function() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      if (confirm(`¬øActivar ${ids.length} producto${ids.length > 1 ? 's' : ''}?`)) {
        bulkUpdateStatus(ids, 1, 'activar');
      }
    };
    
    window.bulkDeactivate = function() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      if (confirm(`¬øDesactivar ${ids.length} producto${ids.length > 1 ? 's' : ''}?`)) {
        bulkUpdateStatus(ids, 0, 'desactivar');
      }
    };
    
    window.bulkDelete = function() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      if (confirm(`¬øELIMINAR PERMANENTEMENTE ${ids.length} producto${ids.length > 1 ? 's' : ''}?\n\nEsta acci√≥n no se puede deshacer.`)) {
        bulkDeleteProducts(ids);
      }
    };
    
    window.bulkUpdateStatus = function(ids, status, action) {
      const formData = new FormData();
      formData.append('ids', JSON.stringify(ids));
      formData.append('is_active', status);
      
      fetch('/api/bulk_update_products.php', {
        method: 'POST',
        body: formData
      })
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.text();
      })
      .then(text => {
        try {
          const result = JSON.parse(text);
          if (result.success) {
            alert(`‚úÖ ${ids.length} producto${ids.length > 1 ? 's' : ''} ${action === 'activar' ? 'activado' : 'desactivado'}${ids.length > 1 ? 's' : ''} correctamente`);
            clearSelection();
            loadProducts();
          } else {
            alert('‚ùå Error: ' + result.error);
          }
        } catch (e) {
          alert('‚ùå Respuesta inv√°lida del servidor: ' + text.substring(0, 100));
        }
      })
      .catch(error => {
        alert('‚ùå Error: ' + error.message);
      });
    };
    
    window.bulkDeleteProducts = function(ids) {
      const formData = new FormData();
      formData.append('ids', JSON.stringify(ids));
      
      fetch('/api/bulk_delete_products.php', {
        method: 'POST',
        body: formData
      })
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.text();
      })
      .then(text => {
        try {
          const result = JSON.parse(text);
          if (result.success) {
            alert(`‚úÖ ${ids.length} producto${ids.length > 1 ? 's' : ''} eliminado${ids.length > 1 ? 's' : ''} correctamente`);
            clearSelection();
            loadProducts();
          } else {
            alert('‚ùå Error: ' + result.error);
          }
        } catch (e) {
          alert('‚ùå Respuesta inv√°lida del servidor: ' + text.substring(0, 100));
        }
      })
      .catch(error => {
        alert('‚ùå Error: ' + error.message);
      });
    };
    
    window.bulkAdjustPrice = function() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      
      modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 400px;">
          <h2 style="margin-bottom: 16px;">üí∞ Ajustar Precio (${ids.length} productos)</h2>
          <form id="adjustPriceForm">
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tipo de ajuste:</label>
              <select id="adjustType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="add">‚ûï Sumar al precio actual</option>
                <option value="subtract">‚ûñ Restar al precio actual</option>
                <option value="set">üéØ Establecer precio fijo</option>
              </select>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500;">Monto ($):</label>
              <input type="number" id="adjustAmount" required step="1" placeholder="Ej: 190" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
              <div style="font-size: 12px; color: #666; margin-top: 4px;">Ejemplo: 190 para aumentar $190 a cada producto</div>
            </div>
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
              <div style="font-size: 13px; color: #0369a1; font-weight: 500; margin-bottom: 4px;">Vista previa:</div>
              <div id="preview" style="font-size: 12px; color: #0c4a6e;">Ingresa un monto para ver el resultado</div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button type="button" onclick="closeAdjustModal()" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
              <button type="submit" style="padding: 8px 16px; background: #0a0a0a; color: white; border: none; border-radius: 4px; cursor: pointer;">Aplicar Cambios</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Funci√≥n para cerrar modal
      window.closeAdjustModal = function() {
        if (modal && modal.parentElement) {
          modal.parentElement.removeChild(modal);
        }
      };
      
      // Preview en tiempo real
      const adjustType = document.getElementById('adjustType');
      const adjustAmount = document.getElementById('adjustAmount');
      const preview = document.getElementById('preview');
      
      function updatePreview() {
        const type = adjustType.value;
        const amount = parseFloat(adjustAmount.value) || 0;
        
        if (amount === 0) {
          preview.textContent = 'Ingresa un monto para ver el resultado';
          return;
        }
        
        const selectedProducts = allProducts.filter(p => ids.includes(p.id.toString()));
        const examples = selectedProducts.slice(0, 3).map(p => {
          const currentPrice = parseFloat(p.price) || 0;
          let newPrice = currentPrice;
          
          if (type === 'add') newPrice = currentPrice + amount;
          else if (type === 'subtract') newPrice = Math.max(0, currentPrice - amount);
          else if (type === 'set') newPrice = amount;
          
          return `${p.name}: $${new Intl.NumberFormat('es-CL').format(currentPrice)} ‚Üí $${new Intl.NumberFormat('es-CL').format(newPrice)}`;
        });
        
        preview.innerHTML = examples.join('<br>') + (selectedProducts.length > 3 ? '<br>...' : '');
      }
      
      adjustType.addEventListener('change', updatePreview);
      adjustAmount.addEventListener('input', updatePreview);
      
      document.getElementById('adjustPriceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const type = adjustType.value;
        const amount = parseFloat(adjustAmount.value);
        
        if (!amount || amount === 0) {
          alert('Ingresa un monto v√°lido');
          return;
        }
        
        const formData = new FormData();
        formData.append('ids', JSON.stringify(ids));
        formData.append('adjust_type', type);
        formData.append('amount', amount);
        
        fetch('/api/bulk_adjust_price.php', {
          method: 'POST',
          body: formData
        })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.text();
        })
        .then(text => {
          try {
            const result = JSON.parse(text);
            if (result.success) {
              alert(`‚úÖ Precios actualizados en ${ids.length} productos`);
              closeAdjustModal();
              clearSelection();
              loadProducts();
            } else {
              alert('‚ùå Error: ' + result.error);
            }
          } catch (e) {
            alert('‚ùå Respuesta inv√°lida del servidor');
          }
        })
        .catch(error => {
          alert('‚ùå Error: ' + error.message);
        });
      });
    };
    
    window.bulkEdit = function() {
      const ids = getSelectedIds();
      if (ids.length === 0) return;
      
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      
      modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px;">
          <h2 style="margin-bottom: 16px;">Editar ${ids.length} Productos</h2>
          <form id="bulkEditForm">
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Precio:</label>
              <input type="number" id="bulkPrice" step="0.01" placeholder="Dejar vac√≠o para no cambiar" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Costo:</label>
              <input type="number" id="bulkCost" step="0.01" placeholder="Dejar vac√≠o para no cambiar" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Categor√≠a:</label>
              <select id="bulkCategory" onchange="updateBulkSubcategories()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">No cambiar</option>
                <option value="1">La Ruta 11</option>
                <option value="2">Sandwiches</option>
                <option value="3">Hamburguesas</option>
                <option value="4">Completos</option>
                <option value="5">Snacks</option>
                <option value="6">Personalizar</option>
                <option value="8">Combos</option>
              </select>
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Subcategor√≠a:</label>
              <select id="bulkSubcategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">No cambiar</option>
              </select>
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Stock M√≠nimo:</label>
              <input type="number" id="bulkMinStock" placeholder="Dejar vac√≠o para no cambiar" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" onclick="document.body.removeChild(this.closest('div').parentElement)" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
              <button type="submit" style="padding: 8px 16px; background: #0a0a0a; color: white; border: none; border-radius: 4px; cursor: pointer;">Actualizar</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('bulkEditForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const updates = {};
        const price = document.getElementById('bulkPrice').value;
        const cost = document.getElementById('bulkCost').value;
        const category = document.getElementById('bulkCategory').value;
        const minStock = document.getElementById('bulkMinStock').value;
        
        if (price) updates.price = price;
        if (cost) updates.cost_price = cost;
        if (category) updates.category_id = category;
        
        const subcategory = document.getElementById('bulkSubcategory').value;
        if (subcategory) updates.subcategory_id = subcategory;
        if (minStock) updates.min_stock_level = minStock;
        
        if (Object.keys(updates).length === 0) {
          alert('Selecciona al menos un campo para actualizar');
          return;
        }
        
        const formData = new FormData();
        formData.append('ids', JSON.stringify(ids));
        formData.append('updates', JSON.stringify(updates));
        
        fetch('/api/bulk_edit_products.php', {
          method: 'POST',
          body: formData
        })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.text();
        })
        .then(text => {
          try {
            const result = JSON.parse(text);
            if (result.success) {
              alert(`‚úÖ ${ids.length} productos actualizados correctamente`);
              document.body.removeChild(modal);
              clearSelection();
              loadProducts();
            } else {
              alert('‚ùå Error: ' + result.error);
            }
          } catch (e) {
            alert('‚ùå Respuesta inv√°lida: ' + text.substring(0, 100));
          }
        })
        .catch(error => {
          alert('‚ùå Error: ' + error.message);
        });
      });
    };
    
    window.logout = function() {
      fetch('/api/admin_logout.php').then(() => window.location.href = '/admin/login');
    };
    

    
    let charts = {};
    let currentSalesView = '1d'; // '1d', '1w', '1m', '3m', '6m', '1y', 'all'
    
    window.loadUsersCount = function() {
      fetch('/api/users/get_users.php')
        .then(r => r.json())
        .then(response => {
          const users = response.success ? response.data : (Array.isArray(response) ? response : []);
          const userCount = Array.isArray(users) ? users.length : 0;
          const el = document.getElementById('total-users');
          if (el) el.textContent = userCount;
        })
        .catch(() => {
          const el = document.getElementById('total-users');
          if (el) el.textContent = 'Error';
        });
    };
    
    window.loadQualityScore = function() {
      const el = document.getElementById('quality-score');
      if (!el) return;
      
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        import('/src/mock/quality-api.js')
          .then(module => {
            const score = Math.round(module.mockQualityScore.average_score || 0);
            el.textContent = score + '%';
          })
          .catch(() => {
            el.textContent = '57.1%';
          });
      } else {
        fetch('/api/get_quality_score.php')
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              const score = Math.round(data.average_score || 0);
              el.textContent = score + '%';
            } else {
              el.textContent = 'N/A';
            }
          })
          .catch(() => {
            el.textContent = 'Error';
          });
      }
    };
    
    window.loadSalesData = function() {
      // Cargar desde inicio de operaciones (14 oct 2024) hasta hoy
      const startDate = '2024-10-14';
      const endDate = new Date().toISOString().split('T')[0];
      
      fetch(`/api/tuu/get_from_mysql.php?start_date=${startDate}&end_date=${endDate}&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          if (data.success && data.data) {
            const transactions = data.data.all_transactions || [];
            const chartData = processSalesDataByPayment(transactions, currentSalesView);
            createSalesChart(chartData, transactions);
          }
        })
        .catch(error => {
          console.error('Error loading sales data:', error);
        });
    };
    
    window.changeSalesView = function(view) {
      currentSalesView = view;
      
      // Actualizar botones activos
      ['1d', '1w', '1m', '3m', '6m', '1y', 'all'].forEach(v => {
        const btn = document.getElementById(`view-${v}`);
        if (btn) {
          btn.style.background = v === view ? '#0a0a0a' : '#f5f5f5';
          btn.style.color = v === view ? 'white' : '#0a0a0a';
        }
      });
      
      loadSalesData();
    };
    
    // NUEVO: Ventas por Per√≠odo 2 (simplificado con l√≥gica de turnos)
    let currentSalesView2 = '7d';
    
    window.changeSalesView2 = function(view) {
      currentSalesView2 = view;
      ['7d', '15d', '30d', '60d', '90d'].forEach(v => {
        const btn = document.getElementById(`view2-${v}`);
        if (btn) {
          btn.style.background = v === view ? '#0a0a0a' : '#f5f5f5';
          btn.style.color = v === view ? 'white' : '#0a0a0a';
        }
      });
      loadSalesChart2();
    };
    
    window.loadSalesChart2 = function() {
      const days = parseInt(currentSalesView2);
      
      fetch(`/api/get_sales_by_period.php?days=${days}&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) return;
          
          const salesByDay = data.data.salesByDay || [];
          const dayNames = ['D', 'L', 'M', 'Mi', 'J', 'V', 'S'];
          
          const labels = [];
          const salesData = [];
          const dateObjects = [];
          
          salesByDay.forEach(day => {
            const date = new Date(day.date + 'T12:00:00');
            const netSales = day.total - day.delivery;
            const dayNum = date.getDate();
            const dayName = dayNames[day.weekday];
            labels.push(`${dayNum}${dayName}`);
            salesData.push(netSales);
            dateObjects.push(date);
          });
          if (charts.sales2) charts.sales2.destroy();
          
          const ctx = document.getElementById('salesChart2');
          const isMobile = window.innerWidth < 640;
          
          // Ajustar stepSize seg√∫n per√≠odo
          let stepSize = 10000; // Default para 7d y 15d
          if (days >= 90) {
            stepSize = 50000; // 90d: escala m√°s amplia
          } else if (days >= 30) {
            stepSize = 25000; // 30d y 60d: escala media
          }
          
          charts.sales2 = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Ventas Netas',
                data: salesData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: isMobile ? 2 : 3,
                pointRadius: isMobile ? 2 : 3,
                pointHoverRadius: isMobile ? 4 : 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { 
                  display: !isMobile,
                  position: 'bottom',
                  labels: { font: { size: isMobile ? 10 : 12 } }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return '$' + new Intl.NumberFormat('es-CL').format(Math.round(context.parsed.y));
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: stepSize,
                    font: { size: isMobile ? 9 : 11 },
                    maxTicksLimit: isMobile ? 5 : 8,
                    callback: function(value) {
                      if (isMobile) {
                        return '$' + (value >= 1000 ? Math.round(value/1000) + 'k' : value);
                      }
                      return '$' + new Intl.NumberFormat('es-CL').format(value);
                    }
                  }
                },
                x: {
                  ticks: {
                    maxRotation: isMobile ? 90 : 45,
                    minRotation: isMobile ? 45 : 0,
                    autoSkip: false, // Mostrar TODOS los d√≠as
                    color: function(context) {
                      if (dateObjects[context.index]) {
                        return dateObjects[context.index].getDay() === 0 ? '#dc2626' : '#666';
                      }
                      return '#666';
                    },
                    font: function(context) {
                      if (dateObjects[context.index]) {
                        return { 
                          weight: dateObjects[context.index].getDay() === 0 ? 'bold' : 'normal',
                          size: isMobile ? 8 : 10 // Reducir tama√±o para que quepan todos
                        };
                      }
                      return { weight: 'normal', size: isMobile ? 8 : 10 };
                    }
                  }
                }
              }
            }
          });
        })
        .catch(error => console.error('Error loading sales chart 2:', error));
    };
    
    // Nuevo: Gr√°fico de ventas por direcci√≥n
    window.loadSalesByAddressChart = function() {
      fetch(`/api/get_sales_by_address.php?t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success || !data.data) return;
          
          const addressData = data.data;
          const labels = addressData.map(item => item.address);
          const salesData = addressData.map(item => item.total_sales);
          const ordersData = addressData.map(item => item.order_count);
          const deliveryData = addressData.map(item => item.total_delivery);
          
          // Colores para las barras
          const colors = addressData.map(item => 
            item.delivery_type === 'pickup' ? '#10b981' : '#3b82f6'
          );
          
          if (charts.salesByAddress) charts.salesByAddress.destroy();
          
          const ctx = document.getElementById('salesByAddressChart');
          if (!ctx) return;
          
          const isMobile = window.innerWidth < 640;
          
          charts.salesByAddress = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Ventas Totales',
                data: salesData,
                backgroundColor: colors,
                borderRadius: 6,
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: 'y',
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    title: function(context) {
                      const index = context[0].dataIndex;
                      return labels[index];
                    },
                    label: function(context) {
                      const index = context.dataIndex;
                      return [
                        'Ventas: $' + new Intl.NumberFormat('es-CL').format(Math.round(salesData[index])),
                        'Pedidos: ' + ordersData[index],
                        'Delivery: $' + new Intl.NumberFormat('es-CL').format(Math.round(deliveryData[index]))
                      ];
                    }
                  }
                }
              },
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      if (isMobile) {
                        return '$' + (value >= 1000 ? Math.round(value/1000) + 'k' : value);
                      }
                      return '$' + new Intl.NumberFormat('es-CL').format(value);
                    },
                    font: { size: isMobile ? 9 : 11 }
                  }
                },
                y: {
                  ticks: {
                    font: { size: isMobile ? 10 : 12 },
                    callback: function(value, index) {
                      const label = labels[index];
                      if (isMobile && label && label.length > 20) {
                        return label.substring(0, 17) + '...';
                      }
                      return label;
                    }
                  }
                }
              }
            }
          });
        })
        .catch(error => console.error('Error loading sales by address chart:', error));
    };
    
    window.processSalesDataByPayment = function(transactions, view) {
      const labels = [];
      const salesData = [];
      const detailData = [];
      const dateObjects = [];
      const today = new Date();
      
      let startDate = new Date();
      let groupBy = 'day';
      
      if (view === '1d') {
        startDate.setHours(0, 0, 0, 0);
        startDate.setDate(today.getDate() - 1);
        groupBy = 'hour';
      } else if (view === '1w') {
        startDate.setHours(0, 0, 0, 0);
        startDate.setDate(today.getDate() - 7);
        groupBy = 'day';
      } else if (view === '1m') {
        startDate.setHours(0, 0, 0, 0);
        startDate.setDate(today.getDate() - 30);
        groupBy = 'day';
      } else if (view === '3m') {
        startDate.setHours(0, 0, 0, 0);
        startDate.setDate(today.getDate() - 90);
        groupBy = 'day';
      } else if (view === '6m') {
        startDate.setHours(0, 0, 0, 0);
        startDate.setDate(today.getDate() - 180);
        groupBy = 'week';
      } else if (view === '1y') {
        startDate.setHours(0, 0, 0, 0);
        startDate.setDate(today.getDate() - 365);
        groupBy = 'month';
      } else {
        const allDates = transactions.map(t => new Date(t.created_at || t.payment_date_time)).filter(d => !isNaN(d)).sort((a, b) => a - b);
        if (allDates.length > 0) {
          startDate = allDates[0];
        } else {
          startDate = new Date('2024-10-14');
        }
        groupBy = 'month';
      }
      
      // Filtrar transacciones por rango de fechas
      const filteredTransactions = transactions.filter(t => {
        const tDate = new Date(t.created_at || t.payment_date_time);
        return tDate >= startDate && tDate <= today;
      });
      
      if (groupBy === 'hour') {
        const hourMap = {};
        for (let i = 0; i < 24; i++) {
          const d = new Date(startDate);
          d.setHours(d.getHours() + i);
          const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}-${d.getHours()}`;
          hourMap[key] = { hour: d.getHours(), breakdown: { cash: 0, card: 0, transfer: 0, webpay: 0, pedidosya: 0 } };
        }
        
        filteredTransactions.forEach(t => {
          const tDate = new Date(t.created_at || t.payment_date_time);
          const key = `${tDate.getFullYear()}-${tDate.getMonth()}-${tDate.getDate()}-${tDate.getHours()}`;
          if (hourMap[key]) {
            const amount = parseFloat(t.amount || 0);
            const deliveryFee = parseFloat(t.delivery_fee || 0);
            const netAmount = amount - deliveryFee;
            const method = t.payment_method || 'cash';
            if (hourMap[key].breakdown[method] !== undefined) hourMap[key].breakdown[method] += netAmount;
          }
        });
        
        Object.keys(hourMap).sort().forEach(key => {
          const data = hourMap[key];
          labels.push(`${data.hour}:00`);
          const total = Object.values(data.breakdown).reduce((a, b) => a + b, 0);
          salesData.push(total);
          detailData.push(data.breakdown);
        });
        
      } else if (groupBy === 'day') {
        const dayMap = {};
        const dayNames = ['D', 'L', 'M', 'Mi', 'J', 'V', 'S'];
        
        // Procesar transacciones y agrupar por D√çA DEL TURNO
        filteredTransactions.forEach(t => {
          const tDate = new Date(t.created_at || t.payment_date_time);
          const shiftDate = getShiftDate(tDate);
          const key = shiftDate.toISOString().split('T')[0];
          
          if (!dayMap[key]) {
            dayMap[key] = { cash: 0, card: 0, transfer: 0, webpay: 0, pedidosya: 0 };
          }
          
          const amount = parseFloat(t.amount || 0);
          const deliveryFee = parseFloat(t.delivery_fee || 0);
          const netAmount = amount - deliveryFee;
          const method = t.payment_method || 'cash';
          
          if (dayMap[key][method] !== undefined) {
            dayMap[key][method] += netAmount;
          } else {
            dayMap[key][method] = netAmount;
          }
        });
        
        // Convertir a arrays ordenados con labels mejorados
        Object.keys(dayMap).sort().forEach(key => {
          const date = new Date(key + 'T12:00:00');
          const dayNum = date.getDate();
          const dayName = dayNames[date.getDay()];
          labels.push(`${dayNum}${dayName}`);
          dateObjects.push(date);
          const breakdown = dayMap[key];
          const total = Object.values(breakdown).reduce((sum, val) => sum + val, 0);
          salesData.push(total);
          detailData.push(breakdown);
        });
        
      } else if (groupBy === 'week') {
        const weekMap = {};
        
        filteredTransactions.forEach(t => {
          const tDate = new Date(t.created_at || t.payment_date_time);
          const shiftDate = getShiftDate(tDate);
          const weekStart = new Date(shiftDate);
          weekStart.setDate(shiftDate.getDate() - shiftDate.getDay());
          const weekKey = weekStart.toISOString().split('T')[0];
          
          if (!weekMap[weekKey]) {
            weekMap[weekKey] = { 
              date: weekStart,
              total: 0, 
              breakdown: { cash: 0, card: 0, transfer: 0, webpay: 0, pedidosya: 0 } 
            };
          }
          const amount = parseFloat(t.amount || 0);
          const deliveryFee = parseFloat(t.delivery_fee || 0);
          const netAmount = amount - deliveryFee;
          const method = t.payment_method || 'cash';
          weekMap[weekKey].total += netAmount;
          if (weekMap[weekKey].breakdown[method] !== undefined) {
            weekMap[weekKey].breakdown[method] += netAmount;
          }
        });
        
        Object.keys(weekMap).sort().forEach(key => {
          const data = weekMap[key];
          labels.push(data.date.toLocaleDateString('es-CL', { day: 'numeric', month: 'short' }));
          salesData.push(data.total);
          detailData.push(data.breakdown);
        });
        
      } else if (groupBy === 'month') {
        const monthMap = {};
        
        filteredTransactions.forEach(t => {
          const tDate = new Date(t.created_at || t.payment_date_time);
          const shiftDate = getShiftDate(tDate);
          const monthKey = `${shiftDate.getFullYear()}-${String(shiftDate.getMonth() + 1).padStart(2, '0')}`;
          
          if (!monthMap[monthKey]) {
            monthMap[monthKey] = { 
              year: shiftDate.getFullYear(),
              month: shiftDate.getMonth(),
              breakdown: { cash: 0, card: 0, transfer: 0, webpay: 0, pedidosya: 0 } 
            };
          }
          const amount = parseFloat(t.amount || 0);
          const deliveryFee = parseFloat(t.delivery_fee || 0);
          const netAmount = amount - deliveryFee;
          const method = t.payment_method || 'cash';
          if (monthMap[monthKey].breakdown[method] !== undefined) {
            monthMap[monthKey].breakdown[method] += netAmount;
          }
        });
        
        const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        Object.keys(monthMap).sort().forEach(key => {
          const data = monthMap[key];
          labels.push(`${monthNames[data.month]} ${data.year}`);
          const total = Object.values(data.breakdown).reduce((a, b) => a + b, 0);
          salesData.push(total);
          detailData.push(data.breakdown);
        });
      }
      
      return { labels, salesData, detailData, dateObjects };
    };
    
    window.createSalesChart = function(chartData, transactions) {
      const ctx = document.getElementById('salesChart');
      if (!ctx) return;
      
      if (charts.sales) {
        charts.sales.destroy();
      }
      const methodLabels = {
        cash: 'üíµ Efectivo',
        card: 'üí≥ Tarjeta',
        transfer: 'üè¶ Transferencia',
        webpay: 'üí≥ Webpay',
        pedidosya: 'üõµ PedidosYA'
      };
      
      charts.sales = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Ventas Totales',
            data: chartData.salesData,
            borderColor: '#0a0a0a',
            backgroundColor: 'rgba(10, 10, 10, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3,
            pointRadius: 3,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: function(context) {
                  return chartData.labels[context[0].dataIndex];
                },
                label: function(context) {
                  return 'Total: $' + new Intl.NumberFormat('es-CL').format(context.parsed.y);
                },
                afterLabel: function(context) {
                  const breakdown = chartData.detailData[context.dataIndex];
                  const lines = ['\nDesglose:'];
                  Object.entries(breakdown).forEach(([method, amount]) => {
                    if (amount > 0) {
                      lines.push(`${methodLabels[method]}: $${new Intl.NumberFormat('es-CL').format(amount)}`);
                    }
                  });
                  return lines.join('\n');
                }
              }
            }
          },
          scales: { 
            y: { 
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + new Intl.NumberFormat('es-CL').format(value);
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 0,
                color: function(context) {
                  // Pintar domingos en rojo
                  if (chartData.dateObjects && chartData.dateObjects[context.index]) {
                    const date = chartData.dateObjects[context.index];
                    return date.getDay() === 0 ? '#dc2626' : '#666';
                  }
                  return '#666';
                },
                font: function(context) {
                  // Domingos en negrita
                  if (chartData.dateObjects && chartData.dateObjects[context.index]) {
                    const date = chartData.dateObjects[context.index];
                    return {
                      weight: date.getDay() === 0 ? 'bold' : 'normal'
                    };
                  }
                  return { weight: 'normal' };
                }
              }
            }
          }
        }
      });
    };
    
    let currentProjectionMode = 'simple'; // Default: simple hist√≥rico
    
    window.changeProjectionMode = function(mode) {
      // Ya no se usa - siempre mostramos las 3 l√≠neas
    };
    
    window.createPaymentMethodsChart = function(paymentMethods, totalDeliveryFee) {
      const ctx = document.getElementById('paymentMethodsChart');
      if (!ctx) return;
      
      // Ordenar por ventas descendente
      const sortedMethods = Object.entries(paymentMethods).sort((a, b) => b[1].sales - a[1].sales);
      
      const labels = sortedMethods.map(([k, d]) => d.label);
      const costsData = sortedMethods.map(([k, d]) => d.cost);
      const profitsData = sortedMethods.map(([k, d]) => d.sales - d.cost);
      const ordersData = sortedMethods.map(([k, d]) => d.orders);
      
      // Si el gr√°fico ya existe, solo actualizar datos (sin parpadeo)
      if (charts.paymentMethods) {
        charts.paymentMethods.data.labels = labels;
        charts.paymentMethods.data.datasets[0].data = costsData;
        charts.paymentMethods.data.datasets[1].data = profitsData;
        // Actualizar ordersData en el contexto del tooltip
        charts.paymentMethods.options.plugins.tooltip.callbacks.title = function(context) {
          const index = context[0].dataIndex;
          return labels[index] + ' (' + ordersData[index] + ' pedidos)';
        };
        charts.paymentMethods.options.plugins.tooltip.callbacks.footer = function(context) {
          const index = context[0].dataIndex;
          const total = costsData[index] + profitsData[index];
          const margin = total > 0 ? ((profitsData[index] / total) * 100).toFixed(1) : 0;
          return [
            'Total: $' + new Intl.NumberFormat('es-CL').format(Math.round(total)),
            'Margen: ' + margin + '%'
          ];
        };
        charts.paymentMethods.update('none'); // 'none' = sin animaci√≥n para actualizaciones autom√°ticas
        return;
      }
      
      // Crear gr√°fico por primera vez
      charts.paymentMethods = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Costo',
              data: costsData,
              backgroundColor: '#94a3b8',
              borderRadius: 4,
              stack: 'stack0'
            },
            {
              label: 'Utilidad',
              data: profitsData,
              backgroundColor: '#22c55e',
              borderRadius: 4,
              stack: 'stack0'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 750,
            easing: 'easeInOutQuart'
          },
          plugins: {
            legend: {
              position: 'top',
              labels: { font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const index = context[0].dataIndex;
                  return labels[index] + ' (' + ordersData[index] + ' pedidos)';
                },
                label: function(context) {
                  return context.dataset.label + ': $' + new Intl.NumberFormat('es-CL').format(Math.round(context.parsed.y));
                },
                footer: function(context) {
                  const index = context[0].dataIndex;
                  const total = costsData[index] + profitsData[index];
                  const margin = total > 0 ? ((profitsData[index] / total) * 100).toFixed(1) : 0;
                  return [
                    'Total: $' + new Intl.NumberFormat('es-CL').format(Math.round(total)),
                    'Margen: ' + margin + '%'
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              ticks: { font: { size: 11 } }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + new Intl.NumberFormat('es-CL', { notation: 'compact' }).format(value);
                }
              }
            }
          }
        }
      });
    };
    
    window.createProjectionChart = function() {
      if (charts.projection) charts.projection.destroy();
      
      const ctx = document.getElementById('projectionChart');
      if (!ctx) return;
      
      fetch(`/api/get_smart_projection_shifts.php?mode=${currentProjectionMode}&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) return;
          
          const projection = data.data.projection || [];
          const totalReal = data.data.totalReal || 0;
          const totalSimple = data.data.totalMonthProjectionSimple || 0;
          const totalWeighted = data.data.totalMonthProjectionWeighted || 0;
          const currentDay = data.data.currentDay || 1;
          const daysWithRealData = data.data.daysWithRealData || 0;
          const totalSampleSimple = data.data.totalSampleSimple || 0;
          const totalSampleWeighted = data.data.totalSampleWeighted || 0;
          
          const labels = [];
          const realData = [];
          const simpleData = [];
          const weightedData = [];
          const dateObjects = [];
          const dayNames = ['D', 'L', 'M', 'Mi', 'J', 'V', 'S'];
          
          projection.forEach(item => {
            const itemDate = new Date(item.year, item.month - 1, item.day);
            const dayName = dayNames[itemDate.getDay()];
            labels.push(`${item.day}${dayName}`);
            dateObjects.push(itemDate);
            
            realData.push(item.isPast || item.isToday ? (item.real || 0) : null);
            simpleData.push(item.projectedSimple || 0);
            weightedData.push(item.projectedWeighted || 0);
          });
          
          const isMobile = window.innerWidth < 640;
          
          charts.projection = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: isMobile ? 'Real' : `Ventas Reales ($${new Intl.NumberFormat('es-CL').format(Math.round(totalReal))}) | ${daysWithRealData}d`,
                  data: realData,
                  borderColor: '#0a0a0a',
                  backgroundColor: 'rgba(10, 10, 10, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: isMobile ? 2 : 3,
                  pointRadius: isMobile ? 2 : 3,
                  pointHoverRadius: isMobile ? 4 : 5,
                  spanGaps: false
                },
                {
                  label: isMobile ? 'Hist√≥rico' : `Hist√≥rico Simple ($${new Intl.NumberFormat('es-CL').format(Math.round(totalSimple))}) | ${totalSampleSimple}d`,
                  data: simpleData,
                  borderColor: '#3b82f6',
                  backgroundColor: 'transparent',
                  borderDash: [5, 5],
                  tension: 0.4,
                  fill: false,
                  borderWidth: isMobile ? 1.5 : 2,
                  pointRadius: isMobile ? 1 : 2,
                  pointHoverRadius: isMobile ? 3 : 4,
                  spanGaps: false
                },
                {
                  label: isMobile ? 'Tendencia' : `Tendencia Ponderada ($${new Intl.NumberFormat('es-CL').format(Math.round(totalWeighted))}) | ${totalSampleWeighted}d`,
                  data: weightedData,
                  borderColor: '#10b981',
                  backgroundColor: 'transparent',
                  borderDash: [5, 5],
                  tension: 0.4,
                  fill: false,
                  borderWidth: isMobile ? 1.5 : 2,
                  pointRadius: isMobile ? 1 : 2,
                  pointHoverRadius: isMobile ? 3 : 4,
                  spanGaps: false
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { 
                  position: 'bottom', 
                  labels: { 
                    font: { size: isMobile ? 9 : 11 },
                    boxWidth: isMobile ? 20 : 40
                  } 
                },
                tooltip: {
                  callbacks: {
                    title: function(context) {
                      const index = context[0].dataIndex;
                      const item = projection[index];
                      return `D√≠a ${item.day} (${item.dayName})`;
                    },
                    label: function(context) {
                      const value = context.parsed.y;
                      if (value === null) return null;
                      const label = context.datasetIndex === 0 ? 'Real' : 'Proy';
                      return label + ': $' + new Intl.NumberFormat('es-CL').format(Math.round(value));
                    },
                    afterLabel: function(context) {
                      const index = context.dataIndex;
                      const item = projection[index];
                      if (item.isPast && item.delivery > 0) {
                        return [
                          `Venta Total: $${new Intl.NumberFormat('es-CL').format(Math.round(item.realWithDelivery))}`,
                          `Delivery: -$${new Intl.NumberFormat('es-CL').format(Math.round(item.delivery))}`
                        ];
                      }
                      return null;
                    },
                    footer: function(context) {
                      const index = context[0].dataIndex;
                      const item = projection[index];
                      if (data.data.avgByWeekday && data.data.avgByWeekday[item.weekday]) {
                        const weekdayAvg = data.data.avgByWeekday[item.weekday];
                        return `Promedio ${item.dayName}s: $${new Intl.NumberFormat('es-CL').format(Math.round(weekdayAvg))}`;
                      }
                      return null;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 25000,
                    font: { size: isMobile ? 9 : 11 },
                    maxTicksLimit: isMobile ? 5 : 8,
                    callback: function(value) {
                      if (isMobile) {
                        return '$' + (value >= 1000 ? Math.round(value/1000) + 'k' : value);
                      }
                      return '$' + new Intl.NumberFormat('es-CL').format(value);
                    }
                  }
                },
                x: { 
                  title: { display: !isMobile, text: 'D√≠a del Mes' },
                  ticks: {
                    maxRotation: isMobile ? 90 : 0,
                    minRotation: isMobile ? 45 : 0,
                    autoSkip: false,
                    maxTicksLimit: 31,
                    color: function(context) {
                      // Pintar domingos en rojo
                      if (dateObjects[context.index]) {
                        const date = dateObjects[context.index];
                        return date.getDay() === 0 ? '#dc2626' : '#666';
                      }
                      return '#666';
                    },
                    font: function(context) {
                      // Domingos en negrita con tama√±o responsive
                      if (dateObjects[context.index]) {
                        const date = dateObjects[context.index];
                        return {
                          weight: date.getDay() === 0 ? 'bold' : 'normal',
                          size: isMobile ? 9 : 11
                        };
                      }
                      return { weight: 'normal', size: isMobile ? 9 : 11 };
                    }
                  }
                }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error loading smart projection:', error);
          createSimpleProjectionChart();
        });
    };
    
    window.createSimpleProjectionChart = function() {
      if (charts.projection) charts.projection.destroy();
      
      const ctx = document.getElementById('projectionChart');
      if (!ctx) return;
      
      fetch(`/api/get_smart_projection_shifts.php?t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success || !data.data) return;
          
          const projection = data.data.projection || [];
          const totalReal = data.data.totalReal || 0;
          const totalSimple = data.data.totalMonthProjectionSimple || 0;
          const totalWeighted = data.data.totalMonthProjectionWeighted || 0;
          const daysWithRealData = data.data.daysWithRealData || 0;
          const totalSampleSimple = data.data.totalSampleSimple || 0;
          const totalSampleWeighted = data.data.totalSampleWeighted || 0;
          
          const labels = [];
          const realData = [];
          const simpleData = [];
          const weightedData = [];
          const dayNames = ['D', 'L', 'M', 'Mi', 'J', 'V', 'S'];
          
          projection.forEach(item => {
            const dayName = dayNames[item.weekday];
            labels.push(`${item.day}${dayName}`);
            realData.push(item.isPast ? (item.real || 0) : null);
            simpleData.push(item.projectedSimple || 0);
            weightedData.push(item.projectedWeighted || 0);
          });
          
          charts.projection = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: `Ventas Reales ($${new Intl.NumberFormat('es-CL').format(Math.round(totalReal))}) | ${daysWithRealData}d`,
                  data: realData,
                  borderColor: '#0a0a0a',
                  backgroundColor: 'rgba(10, 10, 10, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3,
                  spanGaps: false
                },
                {
                  label: `Hist√≥rico Simple ($${new Intl.NumberFormat('es-CL').format(Math.round(totalSimple))}) | ${totalSampleSimple}d`,
                  data: simpleData,
                  borderColor: '#3b82f6',
                  backgroundColor: 'transparent',
                  borderDash: [5, 5],
                  tension: 0.4,
                  fill: false,
                  borderWidth: 2,
                  spanGaps: false
                },
                {
                  label: `Tendencia Ponderada ($${new Intl.NumberFormat('es-CL').format(Math.round(totalWeighted))}) | ${totalSampleWeighted}d`,
                  data: weightedData,
                  borderColor: '#10b981',
                  backgroundColor: 'transparent',
                  borderDash: [5, 5],
                  tension: 0.4,
                  fill: false,
                  borderWidth: 2,
                  spanGaps: false
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const value = context.parsed.y;
                      if (value === null) return null;
                      return context.dataset.label.split('(')[0] + ': $' + new Intl.NumberFormat('es-CL').format(Math.round(value));
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return '$' + new Intl.NumberFormat('es-CL').format(value);
                    }
                  }
                },
                x: { title: { display: true, text: 'D√≠a del Mes' } }
              }
            }
          });
        })
        .catch(error => {
          console.error('Error loading fallback projection:', error);
        });
    };
    
    window.createMonthComparisonChart = function() {
      if (charts.monthComparison) charts.monthComparison.destroy();
      
      const ctx = document.getElementById('monthComparisonChart');
      if (!ctx) return;
      
      fetch(`/api/get_month_comparison.php?t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) return;
          
          const current = data.data.currentMonth;
          const previous = data.data.previousMonth;
          const weekdayNames = data.data.weekdayNames || ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
          
          const labels = weekdayNames;
          const currentMonthData = current.salesByWeekday || [];
          const previousMonthData = previous.salesByWeekday || [];
          
          const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
          
          charts.monthComparison = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: `${monthNames[current.month - 1]} ${current.year}`,
                  data: currentMonthData,
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3
                },
                {
                  label: `${monthNames[previous.month - 1]} ${previous.year}`,
                data: previousMonthData,
                borderColor: '#6b7280',
                backgroundColor: 'rgba(107, 114, 128, 0.1)',
                tension: 0.4,
                fill: false,
                borderWidth: 2,
                borderDash: [5, 5]
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': $' + new Intl.NumberFormat('es-CL').format(context.parsed.y);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + new Intl.NumberFormat('es-CL').format(value);
                  }
                }
              },
              x: { title: { display: true, text: 'D√≠a del Mes' } }
            }
          }
          });
        })
        .catch(error => {
          console.error('Error loading month comparison:', error);
        });
    };
    
    window.loadPreviousMonth = function() {
      const today = new Date();
      const previousMonth = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
      const previousYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      // Guardar mes anterior como vista actual
      currentViewMonth = { month: previousMonth, year: previousYear };
      
      // DESHABILITAR auto-refresh cuando se ve mes anterior
      if (dashboardAutoRefreshInterval) {
        clearInterval(dashboardAutoRefreshInterval);
        dashboardAutoRefreshInterval = null;
      }
      
      // Actualizar display del mes
      const monthYearDisplay = document.getElementById('month-year-display');
      const prevMonthBtn = document.getElementById('prev-month-btn');
      const currentMonthBtn = document.getElementById('current-month-btn');
      
      if (monthYearDisplay) {
        monthYearDisplay.textContent = `${monthNames[previousMonth]} ${previousYear}`;
      }
      if (prevMonthBtn) prevMonthBtn.style.display = 'none';
      if (currentMonthBtn) currentMonthBtn.style.display = 'inline-flex';
      
      // Recargar TODO el dashboard con datos del mes anterior
      loadDashboardForMonth(previousMonth, previousYear);
    };
    
    window.loadCurrentMonth = function() {
      const today = new Date();
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      
      // Volver a mes actual
      currentViewMonth = null;
      
      // RE-HABILITAR auto-refresh cuando se vuelve a mes actual
      if (!dashboardAutoRefreshInterval) {
        dashboardAutoRefreshInterval = setInterval(() => { 
          if (window.loadDashboardTUU && !currentViewMonth) window.loadDashboardTUU(); 
        }, 30000);
      }
      
      // Actualizar display del mes
      const monthYearDisplay = document.getElementById('month-year-display');
      const prevMonthBtn = document.getElementById('prev-month-btn');
      const currentMonthBtn = document.getElementById('current-month-btn');
      
      if (monthYearDisplay) {
        monthYearDisplay.textContent = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
      }
      if (prevMonthBtn) prevMonthBtn.style.display = 'inline-flex';
      if (currentMonthBtn) currentMonthBtn.style.display = 'none';
      
      // Recargar TODO el dashboard con datos del mes actual
      loadDashboardMetrics();
      if (window.loadOperationalCards) window.loadOperationalCards();
    };
    
    window.loadDashboardForMonth = function(month, year) {
      // Calcular fechas del mes espec√≠fico
      const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
      const lastDay = new Date(year, month + 1, 0).getDate();
      const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${lastDay}`;
      
      // Cargar datos TUU del mes espec√≠fico
      fetch(`/api/tuu/get_from_mysql.php?start_date=${startDate}&end_date=${endDate}&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          if (data.success && data.data) {
            // Usar la misma l√≥gica de loadDashboardTUU pero con datos del mes espec√≠fico
            const MONTHLY_SALARIES = 1590000;
            
            // üî• INYECCI√ìN HARDCODEADA OCTUBRE 2025 - SOLO TPV FALTANTE
            const OCTOBER_2025_TPV_INJECTION = {
              sales: 695433,
              delivery: 0,
              orders: 1
            };
            
            const isOctober2025 = year === 2025 && month === 9;
            
            const stats = data.data.combined_stats;
            const transactions = data.data.all_transactions || [];
            
            let totalDeliveryFee = 0;
            transactions.forEach(t => {
              totalDeliveryFee += parseFloat(t.delivery_fee || 0);
            });
            
            const totalSalesWithDelivery = (stats.total_revenue || 0);
            let totalSales = totalSalesWithDelivery - totalDeliveryFee;
            
            // üî• INYECTAR VENTAS TPV EN OCTUBRE 2025
            if (isOctober2025) {
              totalSales += OCTOBER_2025_TPV_INJECTION.sales;
            }
            
            // Actualizar nota del mes
            const monthNotice = document.getElementById('month-notice');
            if (monthNotice) {
              const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
              let noticeHTML = `üìÖ ${monthNames[month]} ${year}`;
              if (totalDeliveryFee > 0) {
                noticeHTML += ` | üèçÔ∏è Delivery: $${new Intl.NumberFormat('es-CL').format(totalDeliveryFee)}`;
              }
              monthNotice.innerHTML = noticeHTML;
              monthNotice.style.display = 'block';
            }
            
            let totalCost = 0;
            const paymentMethods = {
              'webpay':{icon:'credit-card',label:'Webpay',sales:0,cost:0,orders:0,delivery:0},
              'transfer':{icon:'building-2',label:'Transferencia',sales:0,cost:0,orders:0,delivery:0},
              'card':{icon:'credit-card',label:'Tarjeta',sales:0,cost:0,orders:0,delivery:0},
              'cash':{icon:'banknote',label:'Efectivo',sales:0,cost:0,orders:0,delivery:0},
              'pedidosya':{icon:'bike',label:'PedidosYA',sales:0,cost:0,orders:0,delivery:0}
            };
            
            transactions.forEach(t => {
              const amount = parseFloat(t.amount || 0);
              const deliveryFee = parseFloat(t.delivery_fee || 0);
              const orderCost = parseFloat(t.order_cost || 0);
              const cost = orderCost > 0 ? orderCost : amount * 0.38;
              const method = t.payment_method || 'cash';
              
              totalCost += cost;
              if (paymentMethods[method]) { 
                paymentMethods[method].sales += amount; 
                paymentMethods[method].cost += cost; 
                paymentMethods[method].orders += 1;
                paymentMethods[method].delivery += deliveryFee;
              }
            });
            
            const costPercentage = totalSales > 0 ? (totalCost / totalSales) : 0.38;
            
            // üî• INYECTAR SOLO TPV FALTANTE COMO CARD EN OCTUBRE 2025
            if (isOctober2025) {
              const tpvCost = OCTOBER_2025_TPV_INJECTION.sales * costPercentage;
              paymentMethods.card.sales += OCTOBER_2025_TPV_INJECTION.sales;
              paymentMethods.card.cost += tpvCost;
              paymentMethods.card.orders += OCTOBER_2025_TPV_INJECTION.orders;
              paymentMethods.card.delivery += OCTOBER_2025_TPV_INJECTION.delivery;
              totalCost += tpvCost;
            }
            
            const totalExpenses = totalCost + MONTHLY_SALARIES;
            const realProfit = totalSales - totalExpenses;
            const salesNeededForBreakeven = MONTHLY_SALARIES / (1 - costPercentage);
            const additionalSalesNeeded = Math.max(0, salesNeededForBreakeven - totalSales);
            const breakEvenWith10Percent = totalExpenses * 1.1;
            const daysInMonth = lastDay;
            const dailyGoal = breakEvenWith10Percent / daysInMonth;
            const dailyAverage = totalSales / daysInMonth;
            const expectedToDate = dailyGoal * daysInMonth;
            const percentageOfExpected = ((totalSales / expectedToDate) * 100).toFixed(1);
            const percentOfMonthlyGoal = ((totalSales / breakEvenWith10Percent) * 100).toFixed(1);
            
            // Actualizar KPIs principales
            const salesEl = document.getElementById('dash-sales');
            const costsEl = document.getElementById('dash-costs');
            const costsPercentEl = document.getElementById('dash-costs-percent');
            const profitEl = document.getElementById('dash-profit');
            const profitPercentEl = document.getElementById('dash-profit-percent');
            const ordersEl = document.getElementById('dash-orders');
            const salesPercentageEl = document.getElementById('dash-sales-percentage');
            const salesColor = parseFloat(percentageOfExpected) >= 100 ? '#10b981' : parseFloat(percentageOfExpected) >= 80 ? '#f59e0b' : '#dc2626';
            const salesCardEl = document.getElementById('dash-sales-card');
            const salesLabelEl = document.getElementById('dash-sales-label');
            
            if (salesEl) {
              salesEl.textContent = percentageOfExpected + '%';
              salesEl.style.color = salesColor;
            }
            if (salesLabelEl) {
              salesLabelEl.textContent = `Ventas (${percentOfMonthlyGoal}% meta mes)`;
            }
            if (salesPercentageEl) {
              salesPercentageEl.innerHTML = `<span style="color: #666;">$${new Intl.NumberFormat('es-CL').format(Math.round(totalSales))}</span><br><span style="color: #999; font-size: 0.9em;">Meta mes: $${new Intl.NumberFormat('es-CL').format(Math.round(breakEvenWith10Percent))}</span>`;
            }
            if (salesCardEl) {
              salesCardEl.style.borderLeftColor = salesColor;
            }
            
            if (totalSales > 0) {
              const costsPercent = ((totalCost / totalSales) * 100).toFixed(1);
              if (costsPercentEl) costsPercentEl.textContent = costsPercent + '%';
              if (costsEl) costsEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(totalCost);
            }
            
            const profitCard = document.getElementById('dash-profit-card');
            const profitIcon = document.getElementById('dash-profit-icon');
            const profitLabel = document.getElementById('dash-profit-label');
            
            if (totalSales > 0) {
              const marginPercent = (((totalSales - totalCost) / totalSales) * 100).toFixed(1);
              
              if (realProfit >= 0) {
                if (profitPercentEl) {
                  profitPercentEl.textContent = marginPercent + '%';
                  profitPercentEl.style.color = '#10b981';
                }
                if (profitLabel) profitLabel.textContent = 'Margen Bruto';
                if (profitIcon) profitIcon.style.color = '#10b981';
                if (profitEl) {
                  profitEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(realProfit));
                  profitEl.style.color = '#10b981';
                }
                if (profitCard) profitCard.style.borderLeft = '4px solid #10b981';
              } else {
                const lossAmount = Math.abs(realProfit);
                if (profitPercentEl) {
                  profitPercentEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(lossAmount));
                  profitPercentEl.style.color = '#dc2626';
                }
                if (profitLabel) profitLabel.textContent = '‚ö†Ô∏è P√©rdida Acumulada';
                if (profitIcon) profitIcon.style.color = '#dc2626';
                if (profitEl) {
                  profitEl.innerHTML = `<span style="color: #666;">Margen: ${marginPercent}%</span><br><span style="color: #999; font-size: 0.9em;">Faltaron $${new Intl.NumberFormat('es-CL').format(Math.round(additionalSalesNeeded))} para equilibrio</span>`;
                  profitEl.style.color = '#666';
                }
                if (profitCard) profitCard.style.borderLeft = '4px solid #dc2626';
              }
            }
            
            if (ordersEl) ordersEl.textContent = stats.total_transactions || 0;
            
            const ticketEl = document.getElementById('dash-ticket');
            const totalOrders = stats.total_transactions || 0;
            if (ticketEl && totalOrders > 0) {
              const avgTicket = totalSales / totalOrders;
              ticketEl.textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(avgTicket));
            }
            
            // Actualizar m√©todos de pago
            const grid = document.getElementById('dash-payment-methods-grid');
            if (grid) {
              grid.innerHTML = Object.entries(paymentMethods).map(([k,d]) => {
                const salesWithoutDelivery = d.sales - d.delivery;
                const profit = salesWithoutDelivery - d.cost;
                const profitPercent = salesWithoutDelivery > 0 ? ((profit / salesWithoutDelivery) * 100).toFixed(1) : 0;
                
                const isCardWithInjection = k === 'card' && isOctober2025;
                const injectionNote = isCardWithInjection ? `<div style="font-size:clamp(0.65rem,1.4vw,0.75rem);color:#7c3aed;margin-bottom:0.25rem;font-weight:600">üí≥ Incluye TPV: $${new Intl.NumberFormat('es-CL').format(OCTOBER_2025_TPV_INJECTION.sales)} (${OCTOBER_2025_TPV_INJECTION.orders} pedido)</div>` : '';
                
                return `<div class="stat-card" style="border-left:4px solid ${d.sales>0?'#10b981':'#e5e5e5'};text-align:left"><div style="display:flex;align-items:center;gap:8px;margin-bottom:0.5rem"><i data-lucide="${d.icon}" style="width:24px;height:24px;color:#059669"></i><span style="font-size:clamp(1.25rem,3vw,1.5rem);font-weight:700;color:#059669">$${new Intl.NumberFormat('es-CL').format(salesWithoutDelivery)}</span></div><div style="font-size:clamp(0.75rem,1.8vw,0.875rem);color:#666;margin-bottom:0.5rem;font-weight:600">${d.label}</div>${injectionNote}${d.delivery > 0 ? `<div style="font-size:clamp(0.7rem,1.5vw,0.8rem);color:#f59e0b;margin-bottom:0.25rem">üèçÔ∏è Delivery: $${new Intl.NumberFormat('es-CL').format(d.delivery)}</div>` : ''}<div style="font-size:clamp(0.7rem,1.5vw,0.8rem);color:#999;margin-bottom:0.25rem">üì¶ Costo: $${new Intl.NumberFormat('es-CL').format(d.cost)}</div><div style="font-size:clamp(0.7rem,1.5vw,0.8rem);color:#0284c7;margin-bottom:0.25rem">üìà Utilidad: $${new Intl.NumberFormat('es-CL').format(profit)} (${profitPercent}%)</div><div style="font-size:clamp(0.7rem,1.5vw,0.8rem);color:#666">${d.orders} pedidos</div></div>`;
              }).join('');
              
              // Agregar card de "Falta Vender"
              const breakEven = totalExpenses - totalSales;
              grid.innerHTML += `<div class="stat-card" style="border-left:4px solid ${breakEven > 0 ? '#dc2626' : '#10b981'};text-align:left"><div style="font-size:clamp(1.25rem,3vw,1.5rem);font-weight:700;color:${breakEven > 0 ? '#dc2626' : '#10b981'};margin-bottom:0.5rem">${breakEven > 0 ? '‚ö†Ô∏è' : '‚úÖ'} $${new Intl.NumberFormat('es-CL').format(Math.round(additionalSalesNeeded))}</div><div style="font-size:clamp(0.75rem,1.8vw,0.875rem);color:#666;font-weight:600">${breakEven > 0 ? 'Falta Vender (Punto Equilibrio)' : 'Super√°vit'}</div><div style="font-size:clamp(0.65rem,1.4vw,0.75rem);color:#999;margin-top:0.5rem;line-height:1.5"><strong>Gastos del mes:</strong><br>üì¶ Costos: $${new Intl.NumberFormat('es-CL').format(Math.round(totalCost))} (${(costPercentage*100).toFixed(1)}%)<br>üë• Sueldos: $${new Intl.NumberFormat('es-CL').format(MONTHLY_SALARIES)}</div></div>`;
            }
            
            // Actualizar KPIs de metas
            const kpiMonthlyGoal = document.getElementById('kpi-monthly-goal');
            const kpiMonthlyProgress = document.getElementById('kpi-monthly-progress');
            const kpiDailyProgress = document.getElementById('kpi-daily-progress');
            const kpiBreakevenValue = document.getElementById('kpi-breakeven-value');
            const kpiBreakevenStatus = document.getElementById('kpi-breakeven-status');
            const kpiBreakevenCard = document.getElementById('kpi-breakeven-card');
            const kpiDailyAvg = document.getElementById('kpi-daily-avg');
            
            const monthlyPercentage = breakEvenWith10Percent > 0 ? ((totalSales / breakEvenWith10Percent) * 100).toFixed(1) : 0;
            if (kpiMonthlyGoal) {
              kpiMonthlyGoal.textContent = monthlyPercentage + '%';
              kpiMonthlyGoal.style.color = monthlyPercentage >= 100 ? '#10b981' : monthlyPercentage >= 80 ? '#f59e0b' : '#dc2626';
            }
            if (kpiMonthlyProgress) { 
              kpiMonthlyProgress.innerHTML = `<span style="color: #666;">$${new Intl.NumberFormat('es-CL').format(Math.round(totalSales))}</span><br><span style="color: #999; font-size: 0.9em;">Meta: $${new Intl.NumberFormat('es-CL').format(Math.round(breakEvenWith10Percent))}</span>`;
            }
            
            const dailyPercentage = dailyGoal > 0 ? ((dailyAverage / dailyGoal) * 100).toFixed(1) : 0;
            if (kpiDailyAvg) {
              kpiDailyAvg.textContent = dailyPercentage + '%';
              kpiDailyAvg.style.color = dailyPercentage >= 100 ? '#10b981' : dailyPercentage >= 80 ? '#f59e0b' : '#dc2626';
            }
            if (kpiDailyProgress) { 
              kpiDailyProgress.innerHTML = `<span style="color: #666;">$${new Intl.NumberFormat('es-CL').format(Math.round(dailyAverage))}</span><br><span style="color: #999; font-size: 0.9em;">Meta: $${new Intl.NumberFormat('es-CL').format(Math.round(dailyGoal))}/d√≠a</span>`;
            }
            
            const percentOfBreakeven = ((totalSales / salesNeededForBreakeven) * 100).toFixed(1);
            if (kpiBreakevenValue) { 
              kpiBreakevenValue.textContent = percentOfBreakeven + '%'; 
              kpiBreakevenValue.style.color = percentOfBreakeven >= 100 ? '#10b981' : percentOfBreakeven >= 80 ? '#f59e0b' : '#dc2626';
            }
            if (kpiBreakevenStatus) kpiBreakevenStatus.textContent = totalSales >= salesNeededForBreakeven ? `‚úÖ Superado por $${new Intl.NumberFormat('es-CL').format(totalSales - salesNeededForBreakeven)}` : `‚ö†Ô∏è Faltaron $${new Intl.NumberFormat('es-CL').format(Math.round(additionalSalesNeeded))} para equilibrio`;
            if (kpiBreakevenCard) kpiBreakevenCard.style.borderLeftColor = percentOfBreakeven >= 100 ? '#10b981' : percentOfBreakeven >= 80 ? '#f59e0b' : '#dc2626';
            
            // Actualizar gr√°ficos con datos del mes espec√≠fico
            setTimeout(() => {
              createProjectionChartForMonth(month, year);
              createMonthComparisonChart();
            }, 500);
          }
        })
        .catch(error => {
          console.error('Error cargando datos del mes:', error);
        });
      
      setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 100);
    };
    
    window.createProjectionChartForMonth = function(month, year) {
      if (charts.projection) charts.projection.destroy();
      
      const ctx = document.getElementById('projectionChart');
      if (!ctx) return;
      
      const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
      const lastDay = new Date(year, month + 1, 0).getDate();
      const endDate = `${year}-${String(month + 1).padStart(2, '0')}-${lastDay}`;
      
      fetch(`/api/tuu/get_from_mysql.php?start_date=${startDate}&end_date=${endDate}&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          if (!data.success) return;
          
          const transactions = data.data.all_transactions || [];
          const daysInMonth = lastDay;
          
          const salesByDay = {};
          transactions.forEach(t => {
            const date = new Date(t.created_at);
            const day = date.getDate();
            const amount = parseFloat(t.amount || 0);
            salesByDay[day] = (salesByDay[day] || 0) + amount;
          });
          
          const totalSales = Object.values(salesByDay).reduce((a, b) => a + b, 0);
          const avgDaily = totalSales / daysInMonth;
          
          const labels = [];
          const realData = [];
          
          for (let day = 1; day <= daysInMonth; day++) {
            labels.push(day);
            realData.push(salesByDay[day] || 0);
          }
          
          const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
          
          charts.projection = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: `Ventas ${monthNames[month]} ${year} ($${new Intl.NumberFormat('es-CL').format(Math.round(totalSales))} total)`,
                  data: realData,
                  borderColor: '#0a0a0a',
                  backgroundColor: 'rgba(10, 10, 10, 0.1)',
                  tension: 0.4,
                  fill: true,
                  borderWidth: 3
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'Ventas: $' + new Intl.NumberFormat('es-CL').format(context.parsed.y);
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return '$' + new Intl.NumberFormat('es-CL').format(value);
                    }
                  }
                },
                x: { title: { display: true, text: 'D√≠a del Mes' } }
              }
            }
          });
        });
    };
    
    window.createAnalyticsCharts = function(data) {
      // Destruir gr√°ficos existentes
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });
      
      // 1. Gr√°fico de visitas √∫ltimos 7 d√≠as
      const visitsCtx = document.getElementById('visitsChart');
      if (!visitsCtx) return;
      
      const visitsData = data.charts.visits_7days || [];
      const visitLabels = visitsData.map(v => new Date(v.date).toLocaleDateString('es-CL', { weekday: 'short', day: 'numeric' }));
      const visitCounts = visitsData.map(v => v.count);
      
      charts.visits = new Chart(visitsCtx, {
        type: 'line',
        data: {
          labels: visitLabels,
          datasets: [{
            label: 'Visitas',
            data: visitCounts,
            borderColor: '#0a0a0a',
            backgroundColor: 'rgba(10, 10, 10, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
      
      // 2. Interacciones por tipo
      const interactionsCtx = document.getElementById('interactionsChart');
      if (!interactionsCtx) return;
      
      const interactionsData = data.charts.interactions_by_type || [];
      
      charts.interactions = new Chart(interactionsCtx, {
        type: 'doughnut',
        data: {
          labels: interactionsData.map(i => i.action_type),
          datasets: [{
            data: interactionsData.map(i => i.count),
            backgroundColor: ['#0a0a0a', '#333333', '#666666', '#999999', '#cccccc']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } }
        }
      });
      
      // 3. Productos m√°s vistos
      const productsCtx = document.getElementById('productsChart');
      if (!productsCtx) return;
      
      const productsData = data.charts.top_products || [];
      
      charts.products = new Chart(productsCtx, {
        type: 'bar',
        data: {
          labels: productsData.map(p => p.name.substring(0, 15) + '...'),
          datasets: [{
            label: 'Vistas',
            data: productsData.map(p => p.views_count),
            backgroundColor: '#0a0a0a'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
      
      // 4. Actividad por horas
      const hourlyCtx = document.getElementById('hourlyChart');
      if (!hourlyCtx) return;
      
      const hourlyData = data.charts.hourly_activity || [];
      
      charts.hourly = new Chart(hourlyCtx, {
        type: 'line',
        data: {
          labels: hourlyData.map(h => h.hour + ':00'),
          datasets: [{
            label: 'Interacciones',
            data: hourlyData.map(h => h.count),
            borderColor: '#0a0a0a',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
      
      // 5. Tipos de dispositivos
      const devicesCtx = document.getElementById('devicesChart');
      if (!devicesCtx) return;
      
      const devicesData = data.charts.device_types || [];
      
      charts.devices = new Chart(devicesCtx, {
        type: 'pie',
        data: {
          labels: devicesData.map(d => d.device_type),
          datasets: [{
            data: devicesData.map(d => d.count),
            backgroundColor: ['#0a0a0a', '#666666', '#cccccc']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } }
        }
      });
      
      // 6. Conversi√≥n de carrito
      const conversionCtx = document.getElementById('conversionChart');
      if (!conversionCtx) return;
      
      const conversionData = data.charts.cart_conversion || {};
      
      charts.conversion = new Chart(conversionCtx, {
        type: 'bar',
        data: {
          labels: ['Vistas', 'Agregados al Carrito', 'Compras'],
          datasets: [{
            data: [conversionData.views || 0, conversionData.cart_adds || 0, conversionData.purchases || 0],
            backgroundColor: ['#cccccc', '#666666', '#0a0a0a']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    };
    

    
    window.closeUserModal = function(button) {
      let modal = button;
      while (modal && !modal.style.cssText.includes('position: fixed')) {
        modal = modal.parentElement;
      }
      if (modal) {
        modal.remove();
      }
    };
    
    // TUU variables moved to separate page
    
    // TUU functions moved to separate page
    
    // Funci√≥n para toggle del men√∫ m√≥vil
    window.toggleMobileMenu = function() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      
      sidebar.classList.toggle('open');
      overlay.classList.toggle('show');
    };
    
    // Cerrar men√∫ al hacer clic en nav items en m√≥vil
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (window.innerWidth < 768) {
          toggleMobileMenu();
        }
      });
    });
    
    // Inicializar iconos Lucide
    setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 200);
    
    // Funciones del concurso
    let concursoRefreshInterval;
    
    window.loadConcursoStats = function() {
      loadConcursoData();
      
      // Auto-refresh cada 30 segundos
      if (concursoRefreshInterval) clearInterval(concursoRefreshInterval);
      concursoRefreshInterval = setInterval(loadConcursoData, 30000);
    };
    
    window.loadConcursoData = function() {
      fetch('/api/get_concurso_stats.php')
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          console.log('Concurso data received:', data);
          
          if (data.success && data.stats) {
            const stats = data.stats;
            
            // Actualizar KPIs
            document.getElementById('concurso-total-visits').textContent = stats.total_visits || 0;
            document.getElementById('concurso-today-visits').textContent = stats.today_visits || 0;
            document.getElementById('concurso-participants').textContent = stats.participants || 0;
            document.getElementById('concurso-conversion').textContent = (stats.conversion_rate || 0) + '%';
            
            // Crear gr√°ficos
            createConcursoCharts(data);
            
            // Actualizar tabla de fuentes
            updateConcursoSourcesTable(data.sources || []);
          } else {
            console.error('Invalid data structure:', data);
            // Mostrar datos de prueba si no hay datos reales
            document.getElementById('concurso-total-visits').textContent = '0';
            document.getElementById('concurso-today-visits').textContent = '0';
            document.getElementById('concurso-participants').textContent = '0';
            document.getElementById('concurso-conversion').textContent = '0%';
            
            // Crear gr√°ficos vac√≠os
            createConcursoCharts({ daily_visits: [], sources: [] });
            updateConcursoSourcesTable([]);
          }
        })
        .catch(error => {
          console.error('Error loading concurso stats:', error);
          // Mostrar mensaje de error en la interfaz
          document.getElementById('concurso-total-visits').textContent = 'Error';
          document.getElementById('concurso-today-visits').textContent = 'Error';
          document.getElementById('concurso-participants').textContent = 'Error';
          document.getElementById('concurso-conversion').textContent = 'Error';
        });
    };
    
    window.createConcursoCharts = function(data) {
      try {
        // Gr√°fico de visitas por d√≠a
        if (charts.concursoVisits) charts.concursoVisits.destroy();
        
        const visitsCtx = document.getElementById('concursoVisitsChart');
        if (!visitsCtx) return;
        
        const dailyData = data.daily_visits || [];
        
        // Si no hay datos, crear datos de ejemplo
        const chartData = dailyData.length > 0 ? dailyData : [
          { date: new Date().toISOString().split('T')[0], visits: 0 }
        ];
        
        charts.concursoVisits = new Chart(visitsCtx, {
          type: 'line',
          data: {
            labels: chartData.map(d => {
              try {
                return new Date(d.date).toLocaleDateString('es-CL', { weekday: 'short', day: 'numeric' });
              } catch {
                return d.date;
              }
            }),
            datasets: [{
              label: 'Visitas',
              data: chartData.map(d => parseInt(d.visits) || 0),
              borderColor: '#0a0a0a',
              backgroundColor: 'rgba(10, 10, 10, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
        
        // Gr√°fico de fuentes
        if (charts.concursoSources) charts.concursoSources.destroy();
        
        const sourcesCtx = document.getElementById('concursoSourcesChart');
        if (!sourcesCtx) return;
        
        const sourcesData = data.sources || [];
        
        // Si no hay datos, mostrar mensaje
        const sourceChartData = sourcesData.length > 0 ? sourcesData : [
          { source: 'Sin datos', visits: 1 }
        ];
        
        charts.concursoSources = new Chart(sourcesCtx, {
          type: 'doughnut',
          data: {
            labels: sourceChartData.map(s => s.source || 'DIRECT'),
            datasets: [{
              data: sourceChartData.map(s => parseInt(s.visits) || 0),
              backgroundColor: ['#0a0a0a', '#666666', '#cccccc']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
          }
        });
        
      } catch (error) {
        console.error('Error creating concurso charts:', error);
      }
    };
    
    window.updateConcursoSourcesTable = function(sources) {
      const tbody = document.querySelector('#concursoSourcesTable tbody');
      if (!tbody) return;
      
      try {
        if (Array.isArray(sources) && sources.length > 0) {
          tbody.innerHTML = sources.map(source => `
            <tr>
              <td><strong>${source.source || 'DIRECT'}</strong></td>
              <td>${parseInt(source.visits) || 0}</td>
              <td>${parseInt(source.today_visits) || 0}</td>
              <td>${parseInt(source.participants) || 0}</td>
              <td>${parseFloat(source.conversion_rate || 0).toFixed(1)}%</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No hay datos disponibles</td></tr>';
        }
      } catch (error) {
        console.error('Error updating sources table:', error);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #ef4444;">Error cargando datos</td></tr>';
      }
    };
    
    window.copyConcursoLink = function(url, button) {
      navigator.clipboard.writeText(url).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì Copiado';
        button.style.background = '#22c55e';
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = '#0a0a0a';
        }, 2000);
      }).catch(() => {
        // Fallback para navegadores antiguos
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const originalText = button.innerHTML;
        button.innerHTML = '‚úì Copiado';
        button.style.background = '#22c55e';
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = '#0a0a0a';
        }, 2000);
      });
    };
    
    // Funciones de concursantes
    let concursantes = [];
    
    window.loadConcursantes = function() {
      fetch('/api/get_participantes_concurso.php?admin=1')
        .then(r => r.json())
        .then(data => {
          if (data.participantes) {
            concursantes = data.participantes;
            renderConcursantes();
          }
        })
        .catch(() => {
          document.getElementById('concursantes-grid').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error al cargar</div>';
        });
    };
    
    window.renderConcursantes = function() {
      const grid = document.getElementById('concursantes-grid');
      if (!grid) return;
      
      if (concursantes.length === 0) {
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No hay concursantes registrados</div>';
        return;
      }
      
      grid.innerHTML = concursantes.map(c => {
        const statusColor = c.payment_status === 'paid' ? '#22c55e' : c.payment_status === 'failed' ? '#ef4444' : '#f59e0b';
        const statusText = c.payment_status === 'paid' ? '‚úÖ Pagado' : c.payment_status === 'failed' ? '‚ùå Fallido' : '‚è≥ Pendiente';
        
        return `
          <div class="card" style="padding: 16px; border: 1px solid #ccc;">
            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
              <img src="${c.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNmM2Y0ZjYiLz4KPHN2ZyB4PSIxNSIgeT0iMTUiIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjOWNhM2FmIj4KPHA+8J+RpDwvcD4KPC9zdmc+Cjwvc3ZnPgo='}" 
                   style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; border: 2px solid #e5e5e5;" 
                   alt="${c.nombre}" 
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div style="width: 60px; height: 60px; background: #f3f4f6; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 24px; color: #9ca3af; border: 2px solid #e5e5e5;">üë§</div>
              <div style="flex: 1;">
                <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600;">${c.nombre}</h3>
                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${c.rut || 'Sin RUT'}</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" onclick="editConcursante(${c.id})" style="padding: 4px 8px; font-size: 12px;">‚úèÔ∏è</button>
                <button class="btn btn-danger" onclick="deleteConcursante(${c.id})" style="padding: 4px 8px; font-size: 12px;">üóëÔ∏è</button>
              </div>
            </div>
            <div style="font-size: 14px; margin-bottom: 8px;">
              <div><strong>Email:</strong> ${c.email}</div>
              <div><strong>Tel√©fono:</strong> ${c.telefono || 'No registrado'}</div>
              <div><strong>Peso:</strong> ${c.peso || 'No registrado'}kg</div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 12px; color: ${statusColor}; font-weight: 500;">${statusText}</span>
              <span style="font-size: 11px; color: #999;">${new Date(c.fecha_registro).toLocaleDateString('es-CL')}</span>
            </div>
          </div>
        `;
      }).join('');
    };
    
    window.addConcursante = function() {
      showConcursanteModal();
    };
    
    window.editConcursante = function(id) {
      const concursante = concursantes.find(c => c.id == id);
      if (concursante) {
        showConcursanteModal(concursante);
      }
    };
    
    window.deleteConcursante = function(id) {
      if (confirm('¬øEliminar este concursante?')) {
        fetch('/api/delete_concursante.php', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id: id})
        })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            loadConcursantes();
          } else {
            alert('Error: ' + result.error);
          }
        });
      }
    };
    
    let uploadedImageUrl = null;
    
    window.showConcursanteModal = function(concursante = null) {
      uploadedImageUrl = null;
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      
      modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 400px;">
          <h2 style="margin-bottom: 16px;">${concursante ? 'Editar' : 'Agregar'} Concursante</h2>
          <form id="concursanteForm">
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Nombre *:</label>
              <input type="text" id="modalNombre" required value="${concursante?.nombre || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">RUT *:</label>
              <input type="text" id="modalRut" required value="${concursante?.rut || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Email *:</label>
              <input type="email" id="modalEmail" required value="${concursante?.email || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Tel√©fono *:</label>
              <input type="tel" id="modalTelefono" required value="${concursante?.telefono || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Peso (kg) *:</label>
              <input type="number" id="modalPeso" required value="${concursante?.peso || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Estado de Pago:</label>
              <select id="modalPaymentStatus" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="unpaid" ${concursante?.payment_status === 'unpaid' ? 'selected' : ''}>No Pagado</option>
                <option value="paid" ${concursante?.payment_status === 'paid' ? 'selected' : ''}>Pagado</option>
                <option value="failed" ${concursante?.payment_status === 'failed' ? 'selected' : ''}>Fallido</option>
              </select>
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Imagen del Concursante:</label>
              <input type="file" id="modalImage" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <div id="imagePreview" style="margin-top: 10px; display: none;">
                <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 1px solid #d1d5db;">
                <div id="uploadStatus" style="margin-top: 8px; font-size: 12px; color: #6b7280;"></div>
              </div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" onclick="closeConcursanteModal(this)" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
              <button type="submit" style="padding: 8px 16px; background: #0a0a0a; color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Manejar preview y subida de imagen
      const imageInput = document.getElementById('modalImage');
      const imagePreview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      const uploadStatus = document.getElementById('uploadStatus');
      
      imageInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) {
          imagePreview.style.display = 'none';
          uploadedImageUrl = null;
          return;
        }
        
        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          imagePreview.style.display = 'block';
          uploadStatus.textContent = 'Preparando subida...';
          uploadStatus.style.color = '#f59e0b';
        };
        reader.readAsDataURL(file);
        
        // Subir a AWS
        try {
          uploadStatus.textContent = 'Subiendo imagen...';
          uploadStatus.style.color = '#f59e0b';
          
          const formData = new FormData();
          formData.append('image', file);
          
          const response = await fetch('/api/upload_image.php', {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            uploadedImageUrl = result.url;
            uploadStatus.textContent = '‚úÖ Imagen subida exitosamente';
            uploadStatus.style.color = '#22c55e';
          } else {
            uploadedImageUrl = null;
            uploadStatus.textContent = '‚ùå Error: ' + result.error;
            uploadStatus.style.color = '#ef4444';
          }
        } catch (error) {
          uploadedImageUrl = null;
          uploadStatus.textContent = '‚ùå Error de conexi√≥n';
          uploadStatus.style.color = '#ef4444';
        }
      });
      
      document.getElementById('concursanteForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
          nombre: document.getElementById('modalNombre').value,
          rut: document.getElementById('modalRut').value,
          email: document.getElementById('modalEmail').value,
          telefono: document.getElementById('modalTelefono').value,
          peso: parseInt(document.getElementById('modalPeso').value),
          payment_status: document.getElementById('modalPaymentStatus').value,
          mayor_18: 1,
          image_url: uploadedImageUrl
        };
        
        if (concursante) {
          formData.id = concursante.id;
        }
        
        const url = concursante ? '/api/update_concursante.php' : '/api/add_concursante_manual.php';
        
        fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(formData)
        })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            document.body.removeChild(modal);
            loadConcursantes();
          } else {
            alert('Error: ' + result.error);
          }
        });
      });
    };
    
    window.closeConcursanteModal = function(button) {
      let modal = button;
      while (modal && modal.style.position !== 'fixed') {
        modal = modal.parentElement;
      }
      if (modal && modal.parentElement) {
        modal.parentElement.removeChild(modal);
      }
    };
    
    // Funciones de combos
    let productos = [];
    let combos = [];
    
    window.loadCombos = function() {
      Promise.all([
        fetch('/api/get_productos.php').then(r => r.json()),
        fetch('/api/get_combos.php').then(r => r.json())
      ])
      .then(([productosData, combosData]) => {
        productos = Array.isArray(productosData) ? productosData : [];
        combos = combosData.success ? combosData.combos : [];
        renderCombos();
      })
      .catch(() => {
        document.getElementById('combos-grid').innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error al cargar combos</div>';
      });
    };
    
    window.renderCombos = function() {
      const grid = document.getElementById('combos-grid');
      if (!grid) return;
      
      if (combos.length === 0) {
        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No hay combos creados a√∫n</div>';
        return;
      }
      
      grid.innerHTML = combos.map(combo => `
        <div class="card" style="padding: 16px; margin-bottom: 16px; border: 1px solid #e5e5e5; border-radius: 8px; background: white;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">${combo.name}</h3>
              <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${combo.description || ''}</p>
              <p style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: #059669;">$${new Intl.NumberFormat('es-CL').format(combo.price)}</p>
              <div style="display: flex; gap: 8px;">
                <span style="font-size: 12px; background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px;">
                  ${combo.fixed_items?.length || 0} productos incluidos
                </span>
                <span style="font-size: 12px; background: #ede9fe; color: #5b21b6; padding: 2px 6px; border-radius: 4px;">
                  ${Object.keys(combo.selection_groups || {}).length} grupos seleccionables
                </span>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" onclick="editCombo(${combo.id})" style="padding: 6px 12px; font-size: 12px;">Editar</button>
              <button class="btn btn-danger" onclick="deleteCombo(${combo.id})" style="padding: 6px 12px; font-size: 12px;">Eliminar</button>
            </div>
          </div>
        </div>
      `).join('');
    };
    
    window.addCombo = function() {
      showComboModal();
    };
    
    window.editCombo = function(id) {
      const combo = combos.find(c => c.id == id);
      if (combo) {
        showComboModal(combo);
      }
    };
    
    window.loadComboData = function(combo) {
      // Cargar productos fijos existentes
      if (combo && combo.fixed_items) {
        const fixedContainer = document.getElementById('fixedItems');
        combo.fixed_items.forEach(item => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'fixed-item';
          itemDiv.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 8px;';
          itemDiv.innerHTML = `
            <select class="product-select" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Seleccionar producto...</option>
              ${productos.map(p => `<option value="${p.id}" ${p.id == item.product_id ? 'selected' : ''}>${p.name}</option>`).join('')}
            </select>
            <input type="number" class="quantity-input" placeholder="Cant" min="1" value="${item.quantity}" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
            <button type="button" onclick="this.parentElement.remove()" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">√ó</button>
          `;
          fixedContainer.appendChild(itemDiv);
        });
      }
      
      // Cargar grupos de selecci√≥n existentes
      if (combo && combo.selection_groups) {
        const groupsContainer = document.getElementById('selectionGroups');
        Object.keys(combo.selection_groups).forEach(groupName => {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'selection-group';
          groupDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 4px; padding: 8px; margin-bottom: 8px; background: white;';
          groupDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <input type="text" class="group-name" placeholder="Nombre del grupo (ej: Bebidas)" value="${groupName}" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
              <div style="display: flex; align-items: center; gap: 4px;">
                <label style="font-size: 12px; color: #666;">M√°x:</label>
                <input type="number" class="max-selections" placeholder="1" min="1" value="1" style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" title="M√°ximo de selecciones permitidas">
              </div>
              <button type="button" onclick="this.closest('.selection-group').remove()" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
            </div>
            <div class="group-options" style="margin-bottom: 8px;"></div>
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
              <button type="button" onclick="addGroupOption(this)" style="padding: 4px 8px; background: #059669; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">+ Opci√≥n Manual</button>
              <button type="button" onclick="addBulkOptions(this)" style="padding: 4px 8px; background: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üöÄ Auto Bebidas</button>
              <button type="button" onclick="addBulkSalsas(this)" style="padding: 4px 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üå∂Ô∏è Auto Salsas</button>
            </div>
          `;
          
          const optionsContainer = groupDiv.querySelector('.group-options');
          combo.selection_groups[groupName].forEach(option => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'group-option';
            optionDiv.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 4px;';
            optionDiv.innerHTML = `
              <select class="option-product" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Seleccionar producto...</option>
                ${productos.map(p => `<option value="${p.id}" ${p.id == option.product_id ? 'selected' : ''}>${p.name}</option>`).join('')}
              </select>
              <input type="number" class="option-price" placeholder="Precio extra" step="0.01" value="${option.additional_price}" style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
              <button type="button" onclick="this.parentElement.remove()" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">√ó</button>
            `;
            optionsContainer.appendChild(optionDiv);
          });
          
          groupsContainer.appendChild(groupDiv);
        });
      }
    };
    
    window.deleteCombo = function(id) {
      if (confirm('¬øEliminar este combo?')) {
        fetch('/api/delete_combo.php', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id: id})
        })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            loadCombos();
          } else {
            alert('Error: ' + result.error);
          }
        });
      }
    };
    
    window.showComboModal = function(combo = null) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      
      modal.innerHTML = `
        <div style="background: white; padding: 24px; border-radius: 8px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
          <h2 style="margin-bottom: 16px;">${combo ? 'Editar' : 'Nuevo'} Combo</h2>
          <form id="comboForm">
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Nombre *:</label>
              <input type="text" id="comboName" required value="${combo?.name || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Descripci√≥n:</label>
              <textarea id="comboDescription" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 60px;">${combo?.description || ''}</textarea>
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">Precio *:</label>
              <input type="number" id="comboPrice" required step="0.01" value="${combo?.price || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 4px; font-weight: 500;">URL Imagen:</label>
              <input type="url" id="comboImage" value="${combo?.image_url || ''}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <!-- Productos incluidos -->
            <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #e5e5e5; border-radius: 6px; background: #f9fafb;">
              <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Productos Incluidos</h4>
              <div id="fixedItems" style="margin-bottom: 12px;">
                <!-- Items se cargan aqu√≠ -->
              </div>
              <button type="button" onclick="addFixedItem()" style="padding: 6px 12px; background: #059669; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Agregar Producto</button>
            </div>
            
            <!-- Grupos seleccionables -->
            <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #e5e5e5; border-radius: 6px; background: #f9fafb;">
              <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Opciones Seleccionables</h4>
              <div id="selectionGroups" style="margin-bottom: 12px;">
                <!-- Grupos se cargan aqu√≠ -->
              </div>
              <button type="button" onclick="addSelectionGroup()" style="padding: 6px 12px; background: #7c3aed; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">+ Agregar Grupo</button>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" onclick="closeComboModal(this)" style="padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
              <button type="submit" style="padding: 8px 16px; background: #0a0a0a; color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar</button>
            </div>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Cargar datos existentes del combo si es edici√≥n
      if (combo) {
        loadComboData(combo);
      }
      
      document.getElementById('comboForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
          name: document.getElementById('comboName').value,
          description: document.getElementById('comboDescription').value,
          price: parseFloat(document.getElementById('comboPrice').value),
          image_url: document.getElementById('comboImage').value,
          active: 1,
          fixed_items: [],
          selection_groups: {}
        };
        
        if (combo) {
          formData.id = combo.id;
        }
        
        // Recopilar productos fijos
        document.querySelectorAll('#fixedItems .fixed-item').forEach(item => {
          const productId = item.querySelector('.product-select').value;
          const quantity = parseInt(item.querySelector('.quantity-input').value) || 1;
          console.log('Fixed item:', productId, quantity);
          if (productId && productId !== '') {
            formData.fixed_items.push({ product_id: parseInt(productId), quantity });
          }
        });
        
        // Recopilar grupos de selecci√≥n
        document.querySelectorAll('#selectionGroups .selection-group').forEach(group => {
          const groupName = group.querySelector('.group-name').value;
          const maxSelections = parseInt(group.querySelector('.max-selections').value) || 1;
          console.log('Selection group:', groupName, maxSelections);
          if (groupName) {
            formData.selection_groups[groupName] = {
              max_selections: maxSelections,
              options: []
            };
            group.querySelectorAll('.group-option').forEach(option => {
              const productId = option.querySelector('.option-product').value;
              const additionalPrice = parseFloat(option.querySelector('.option-price').value) || 0;
              console.log('Group option:', productId, additionalPrice);
              if (productId && productId !== '') {
                formData.selection_groups[groupName].options.push({
                  product_id: parseInt(productId),
                  additional_price: additionalPrice
                });
              }
            });
          }
        });
        
        console.log('Final formData:', formData);
        
        fetch('/api/save_combo.php', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(formData)
        })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            document.body.removeChild(modal);
            loadCombos();
          } else {
            alert('Error: ' + result.error);
          }
        });
      });
    };
    
    window.addFixedItem = function() {
      const container = document.getElementById('fixedItems');
      const itemDiv = document.createElement('div');
      itemDiv.className = 'fixed-item';
      itemDiv.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 8px;';
      itemDiv.innerHTML = `
        <select class="product-select" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">Seleccionar producto...</option>
          ${productos.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
        </select>
        <input type="number" class="quantity-input" placeholder="Cant" min="1" value="1" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
        <button type="button" onclick="this.parentElement.remove()" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">√ó</button>
      `;
      container.appendChild(itemDiv);
    };
    
    window.addSelectionGroup = function() {
      const container = document.getElementById('selectionGroups');
      const groupDiv = document.createElement('div');
      groupDiv.className = 'selection-group';
      groupDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 4px; padding: 8px; margin-bottom: 8px; background: white;';
      groupDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 8px;">
          <input type="text" class="group-name" placeholder="Nombre del grupo (ej: Bebidas)" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
          <div style="display: flex; align-items: center; gap: 4px;">
            <label style="font-size: 12px; color: #666;">M√°x:</label>
            <input type="number" class="max-selections" placeholder="1" min="1" value="1" style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" title="M√°ximo de selecciones permitidas">
          </div>
          <button type="button" onclick="this.closest('.selection-group').remove()" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
        </div>
        <div class="group-options" style="margin-bottom: 8px;"></div>
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <button type="button" onclick="addGroupOption(this)" style="padding: 4px 8px; background: #059669; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">+ Opci√≥n Manual</button>
          <button type="button" onclick="addBulkOptions(this)" style="padding: 4px 8px; background: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üöÄ Auto Bebidas</button>
          <button type="button" onclick="addBulkSalsas(this)" style="padding: 4px 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">üå∂Ô∏è Auto Salsas</button>
        </div>
      `;
      container.appendChild(groupDiv);
    };
    
    window.addGroupOption = function(button) {
      const optionsContainer = button.closest('.selection-group').querySelector('.group-options');
      const optionDiv = document.createElement('div');
      optionDiv.className = 'group-option';
      optionDiv.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 4px;';
      optionDiv.innerHTML = `
        <select class="option-product" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">Seleccionar producto...</option>
          ${productos.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
        </select>
        <input type="number" class="option-price" placeholder="Precio extra" step="0.01" value="0" style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
        <button type="button" onclick="this.parentElement.remove()" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">√ó</button>
      `;
      optionsContainer.appendChild(optionDiv);
    };
    
    window.addBulkOptions = function(button) {
      const optionsContainer = button.closest('.selection-group').querySelector('.group-options');
      const groupNameInput = button.closest('.selection-group').querySelector('.group-name');
      
      // Auto-llenar nombre del grupo si est√° vac√≠o
      if (!groupNameInput.value) {
        groupNameInput.value = 'Bebidas';
      }
      
      // Filtrar bebidas 350ml activas con stock
      const bebidas = productos.filter(p => {
        const text = `${p.name} ${p.description || ''}`.toLowerCase();
        const is350ml = text.includes('350ml') || text.includes('lata') || text.includes('350');
        const isBebida = text.includes('coca') || text.includes('sprite') || text.includes('fanta') || 
                        text.includes('bebida') || text.includes('pepsi') || text.includes('jugo');
        const hasStock = (p.stock_quantity || 0) > 0;
        
        return is350ml && isBebida && p.is_active == 1 && hasStock;
      });
      
      // Agregar cada bebida encontrada
      bebidas.forEach(bebida => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'group-option';
        optionDiv.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 4px;';
        optionDiv.innerHTML = `
          <select class="option-product" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="${bebida.id}" selected>${bebida.name}</option>
          </select>
          <input type="number" class="option-price" placeholder="Precio extra" step="0.01" value="0" style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
          <button type="button" onclick="this.parentElement.remove()" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">√ó</button>
        `;
        optionsContainer.appendChild(optionDiv);
      });
      
      if (bebidas.length === 0) {
        alert('No se encontraron bebidas 350ml activas con stock');
      } else {
        alert(`‚úÖ Agregadas ${bebidas.length} bebidas 350ml con stock`);
      }
    };
    
    window.addBulkSalsas = function(button) {
      const optionsContainer = button.closest('.selection-group').querySelector('.group-options');
      const groupNameInput = button.closest('.selection-group').querySelector('.group-name');
      
      // Auto-llenar nombre del grupo si est√° vac√≠o
      if (!groupNameInput.value) {
        groupNameInput.value = 'Salsas';
      }
      
      // Filtrar salsas
      const salsas = productos.filter(p => {
        const text = `${p.name} ${p.description || ''}`.toLowerCase();
        return (text.includes('salsa') || text.includes('mayo') || text.includes('ketchup') ||
                text.includes('mostaza') || text.includes('aj√≠') || text.includes('palta')) &&
               p.is_active == 1;
      });
      
      // Agregar cada salsa encontrada
      salsas.forEach(salsa => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'group-option';
        optionDiv.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 4px;';
        optionDiv.innerHTML = `
          <select class="option-product" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="${salsa.id}" selected>${salsa.name}</option>
          </select>
          <input type="number" class="option-price" placeholder="Precio extra" step="0.01" value="0" style="width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
          <button type="button" onclick="this.parentElement.remove()" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">√ó</button>
        `;
        optionsContainer.appendChild(optionDiv);
      });
      
      if (salsas.length === 0) {
        alert('No se encontraron salsas activas');
      }
    };
    
    window.closeComboModal = function(button) {
      let modal = button;
      while (modal && modal.style.position !== 'fixed') {
        modal = modal.parentElement;
      }
      if (modal && modal.parentElement) {
        modal.parentElement.removeChild(modal);
      }
    };
    
    // Plan de Compras
    let currentPlanDays = 2;
    let nextPurchaseData = null;
    
    window.changePlanDays = function(days) {
      currentPlanDays = days;
      document.querySelectorAll('[id^="plan-"]').forEach(btn => {
        if (btn.id.includes('days')) {
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-secondary');
          btn.style.background = '#f5f5f5';
          btn.style.color = '#0a0a0a';
        }
      });
      const activeBtn = document.getElementById(`plan-${days}days`);
      if (activeBtn) {
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
        activeBtn.style.background = '#0a0a0a';
        activeBtn.style.color = 'white';
      }
      loadPurchasePlan();
    };
    
    window.calculateNextPurchaseDay = function() {
      // C√°lculo din√°mico basado en stock cr√≠tico
      if (!nextPurchaseData || !nextPurchaseData.purchase_list) {
        return { daysUntil: 0, nextDay: 'Pendiente', priority: 'low' };
      }
      
      const criticalItems = nextPurchaseData.purchase_list.filter(item => {
        const stockRatio = item.current_stock / item.needed;
        return stockRatio < 0.3; // Menos del 30% del stock necesario
      });
      
      const urgentItems = nextPurchaseData.purchase_list.filter(item => {
        const stockRatio = item.current_stock / item.needed;
        return stockRatio < 0.1; // Menos del 10% - URGENTE
      });
      
      let daysUntil, nextDay, priority;
      
      if (urgentItems.length > 0) {
        daysUntil = 0;
        nextDay = 'HOY';
        priority = 'urgent';
      } else if (criticalItems.length > 0) {
        daysUntil = 1;
        nextDay = 'Ma√±ana';
        priority = 'high';
      } else {
        daysUntil = 2;
        nextDay = 'En 2 d√≠as';
        priority = 'normal';
      }
      
      return { daysUntil, nextDay, priority, criticalItems: criticalItems.length, urgentItems: urgentItems.length };
    };
    
    window.updatePurchaseDayCounter = function() {
      const { daysUntil, nextDay, priority, criticalItems, urgentItems } = calculateNextPurchaseDay();
      const badge = document.getElementById('days-until-purchase');
      const btn = document.getElementById('next-purchase-btn');
      
      const colors = {
        urgent: '#dc2626',
        high: '#f59e0b',
        normal: '#10b981',
        low: '#6b7280'
      };
      
      const bgColor = colors[priority] || colors.normal;
      
      if (badge) {
        badge.textContent = daysUntil;
        badge.style.background = bgColor;
      }
      
      if (btn) {
        const icon = priority === 'urgent' ? '‚ö†Ô∏è' : priority === 'high' ? 'üî¥' : 'üìÖ';
        btn.innerHTML = `${icon} ${nextDay}<span id="days-until-purchase" style="position: absolute; top: -8px; right: -8px; background: ${bgColor}; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">${daysUntil}</span>`;
      }
    };
    
    window.openPurchaseModal = function() {
      if (!nextPurchaseData || !nextPurchaseData.purchase_list) {
        alert('Cargando datos...');
        return;
      }
      
      const { daysUntil, nextDay } = calculateNextPurchaseDay();
      const purchaseList = nextPurchaseData.purchase_list;
      const totalCost = nextPurchaseData.total_cost;
      
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px;';
      
      const formatQuantity = (value, unit) => {
        if (unit === 'kg') return value.toFixed(2) + ' kg';
        if (unit === 'unidad') return value.toFixed(0) + ' u';
        return value.toFixed(2);
      };
      
      const getPriority = (item) => {
        if (item.current_stock === 0 || item.current_stock < (item.needed * 0.1)) {
          return { icon: 'üî¥', label: 'CR√çTICO', color: '#fef2f2', border: '#dc2626' };
        }
        if (item.current_stock < (item.needed * 0.5)) {
          return { icon: 'üü°', label: 'URGENTE', color: '#fefce8', border: '#f59e0b' };
        }
        return { icon: 'üü¢', label: 'NORMAL', color: '#f0fdf4', border: '#10b981' };
      };
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
          <div style="padding: 24px; border-bottom: 1px solid #e5e5e5; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h2 style="margin: 0 0 8px 0; font-size: 24px;">üõí Lista de Compras - ${nextDay}</h2>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;">${daysUntil === 0 ? '¬°Compra HOY!' : `Faltan ${daysUntil} d√≠a${daysUntil > 1 ? 's' : ''}`} | Total: $${new Intl.NumberFormat('es-CL').format(Math.round(totalCost))}</p>
              </div>
              <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%;">&times;</button>
            </div>
          </div>
          <div style="flex: 1; overflow-y: auto; padding: 24px;">
            ${purchaseList.length === 0 ? '<div style="text-align: center; padding: 60px 20px; color: #10b981;"><div style="font-size: 64px;">‚úÖ</div><h3>¬°Todo en orden!</h3></div>' :
              `<div style="display: grid; gap: 12px;">${purchaseList.map(item => {
                const priority = getPriority(item);
                return `<div style="background: ${priority.color}; border: 2px solid ${priority.border}; border-radius: 8px; padding: 16px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                    <div style="flex: 1;">
                      <div style="font-weight: 700; font-size: 16px;">${priority.icon} ${item.ingredient_name}</div>
                      ${item.products_using && item.products_using.length > 0 ? `<div style="font-size: 12px; color: #666;">Usado en: ${item.products_using.slice(0, 2).map(p => p.product).join(', ')}</div>` : ''}
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 20px; font-weight: 700; color: #059669;">$${new Intl.NumberFormat('es-CL').format(Math.round(item.total_cost))}</div>
                      <div style="font-size: 11px; color: #666;">${priority.label}</div>
                    </div>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding-top: 12px; border-top: 1px solid ${priority.border}40;">
                    <div><div style="font-size: 11px; color: #666;">Stock</div><div style="font-weight: 600;">${formatQuantity(item.current_stock, item.unit)}</div></div>
                    <div><div style="font-size: 11px; color: #666;">Necesario</div><div style="font-weight: 600;">${formatQuantity(item.needed, item.unit)}</div></div>
                    <div><div style="font-size: 11px; color: #666;">A Comprar</div><div style="font-weight: 700; font-size: 18px;">${formatQuantity(item.to_buy, item.unit)}</div></div>
                  </div>
                </div>`;
              }).join('')}</div>`}
          </div>
          <div style="padding: 20px 24px; border-top: 1px solid #e5e5e5; background: #f9fafb;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
              <div><div style="font-size: 14px; color: #666;">Total a Invertir</div><div style="font-size: 28px; font-weight: 700;">$${new Intl.NumberFormat('es-CL').format(Math.round(totalCost))}</div></div>
              <div style="display: flex; gap: 8px;">
                <button onclick="showPurchaseRecommendations()" class="btn" style="background: #0284c7; color: white; padding: 12px 24px;">üí° Recomendaciones</button>
                <button onclick="copyToWhatsApp()" class="btn" style="background: #25d366; color: white; padding: 12px 24px;">üì± Copiar WhatsApp</button>
                <button onclick="this.closest('div[style*=fixed]').remove()" class="btn" style="background: #10b981; color: white; padding: 12px 32px;">Entendido</button>
              </div>
            </div>
          </div>
        </div>`;
      
      document.body.appendChild(modal);
    };
    
    window.showPurchaseRecommendations = async function() {
      try {
        const response = await fetch(`/api/get_purchase_recommendation.php?t=${Date.now()}`);
        const data = await response.json();
        
        console.log('üìä Recomendaciones:', data);
        
        if (!data.success) {
          alert('Error: ' + (data.error || 'Error desconocido'));
          return;
        }
        
        const recs = data.data.recommendations;
        const sales = data.data.sales_analysis;
        const stock = data.data.stock_analysis;
        const freq = data.data.suggested_frequency;
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001; padding: 16px;';
        
        modal.innerHTML = `
          <div style="background: white; border-radius: 12px; width: 100%; max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 24px; border-bottom: 1px solid #e5e5e5; background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); color: white;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h2 style="margin: 0 0 8px 0; font-size: 24px;">üí° Recomendaciones Inteligentes</h2>
                  <p style="margin: 0; opacity: 0.9; font-size: 14px;">Basado en an√°lisis de ventas y stock</p>
                </div>
                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 28px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%;">&times;</button>
              </div>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 24px;">
              <div style="background: #f0f9ff; border: 2px solid #0284c7; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <div style="font-weight: 700; margin-bottom: 8px;">üìà An√°lisis de Demanda</div>
                <div style="font-size: 14px; color: #666;">Promedio: ${sales.avg_orders_per_day} pedidos/d√≠a | Frecuencia sugerida: <strong>cada ${freq.days} d√≠as</strong></div>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">${freq.reason}</div>
              </div>
              
              <div style="background: ${stock.critical_ingredients > 0 ? '#fef2f2' : '#f0fdf4'}; border: 2px solid ${stock.critical_ingredients > 0 ? '#dc2626' : '#10b981'}; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                <div style="font-weight: 700; margin-bottom: 8px;">üì¶ Estado de Stock</div>
                <div style="font-size: 14px;">
                  <span style="color: #dc2626; font-weight: 600;">${stock.critical_ingredients} cr√≠ticos</span> | 
                  <span style="color: #f59e0b; font-weight: 600;">${stock.urgent_ingredients} urgentes</span> | 
                  <span style="color: #666;">${stock.total_ingredients} total</span>
                </div>
              </div>
              
              <h3 style="margin: 0 0 16px 0; font-size: 16px;">üìÖ Cu√°ndo Comprar</h3>
              <div style="display: grid; gap: 12px;">
                ${recs.map(rec => `
                  <div style="background: white; border: 2px solid ${rec.color}; border-radius: 8px; padding: 16px;">
                    <div style="display: flex; justify-content: between; align-items: start; gap: 12px;">
                      <div style="flex: 1;">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">${rec.day}</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${rec.reason}</div>
                        <div style="font-size: 12px; color: ${rec.color}; font-weight: 600;">${rec.action}</div>
                      </div>
                      <div style="background: ${rec.color}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; white-space: nowrap;">${rec.priority}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div style="padding: 20px 24px; border-top: 1px solid #e5e5e5; background: #f9fafb; display: flex; justify-content: space-between; align-items: center;">
              <button onclick="this.closest('div[style*=fixed]').remove(); openPurchaseModal();" class="btn" style="background: #10b981; color: white; padding: 12px 24px;">üõí Ver Lista Completa</button>
              <button onclick="this.closest('div[style*=fixed]').remove()" class="btn" style="background: #0284c7; color: white; padding: 12px 32px;">Entendido</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error:', error);
        alert('Error cargando recomendaciones');
      }
    };
    
    window.copyToWhatsApp = function() {
      if (!nextPurchaseData || !nextPurchaseData.purchase_list) {
        alert('No hay datos de compra');
        return;
      }
      
      const { nextDay } = calculateNextPurchaseDay();
      const purchaseList = nextPurchaseData.purchase_list;
      const totalCost = nextPurchaseData.total_cost;
      
      const formatQuantity = (value, unit) => {
        if (unit === 'kg') return value.toFixed(2) + ' kg';
        if (unit === 'unidad') return value.toFixed(0) + ' u';
        return value.toFixed(2);
      };
      
      let whatsappText = `üõí *LISTA DE COMPRAS - ${nextDay}*\n`;
      whatsappText += `üìÖ Plan para ${currentPlanDays} d√≠as\n`;
      whatsappText += `üí∞ Total: $${new Intl.NumberFormat('es-CL').format(Math.round(totalCost))}\n\n`;
      
      if (purchaseList.length === 0) {
        whatsappText += '‚úÖ *No necesitas comprar nada*\nStock suficiente para el per√≠odo.';
      } else {
        purchaseList.forEach((item, index) => {
          const priority = item.current_stock === 0 || item.current_stock < (item.needed * 0.1) ? 'üî¥' : 
                          item.current_stock < (item.needed * 0.5) ? 'üü°' : 'üü¢';
          
          whatsappText += `${index + 1}. ${priority} *${item.ingredient_name}*\n`;
          whatsappText += `   ‚Ä¢ Comprar: *${formatQuantity(item.to_buy, item.unit)}*\n`;
          whatsappText += `   ‚Ä¢ Costo: $${new Intl.NumberFormat('es-CL').format(Math.round(item.total_cost))}\n`;
          whatsappText += `   ‚Ä¢ Stock actual: ${formatQuantity(item.current_stock, item.unit)}\n\n`;
        });
        
        whatsappText += `---\nüíµ *TOTAL A INVERTIR: $${new Intl.NumberFormat('es-CL').format(Math.round(totalCost))}*`;
      }
      
      navigator.clipboard.writeText(whatsappText).then(() => {
        alert('‚úÖ Lista copiada al portapapeles!\n\nAhora puedes pegarla en WhatsApp.');
      }).catch(() => {
        alert('Error al copiar. Intenta de nuevo.');
      });
    };
    
    window.loadPurchasePlan = function() {
      console.log('üõí Cargando plan de compras para', currentPlanDays, 'd√≠as');
      fetch(`/api/get_purchase_plan.php?days=${currentPlanDays}&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          console.log('üì¶ Plan de compras:', data);
          if (data.success) {
            const plan = data.data;
            nextPurchaseData = plan;
            
            document.getElementById('plan-total-ingredients').textContent = plan.summary.total_ingredients;
            document.getElementById('plan-total-cost').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(plan.total_cost));
            document.getElementById('plan-total-products').textContent = plan.summary.total_products;
            document.getElementById('plan-days').textContent = plan.days;
            document.getElementById('forecast-days').textContent = plan.days;
            
            updatePurchaseListTable(plan.purchase_list);
            updateForecastTable(plan.products_forecast);
            updatePurchaseDayCounter();
          }
        })
        .catch(error => {
          console.error('Error loading purchase plan:', error);
        });
    };
    
    window.updatePurchaseListTable = function(purchaseList) {
      const tbody = document.querySelector('#purchaseListTable tbody');
      if (!tbody) return;
      
      if (purchaseList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #22c55e;">‚úÖ No necesitas comprar nada. Stock suficiente para el per√≠odo.</td></tr>';
        return;
      }
      
      // Funci√≥n helper para formatear cantidades CON unidad
      const formatQuantity = (value, unit) => {
        if (unit === 'kg') {
          return value.toFixed(2) + ' kg';
        }
        if (unit === 'unidad') {
          return value.toFixed(0) + ' u';
        }
        return value.toFixed(2);
      };
      
      // Funci√≥n helper para formatear costo unitario
      const formatUnitCost = (cost, unit) => {
        if (unit === 'kg') {
          return '$' + new Intl.NumberFormat('es-CL').format(Math.round(cost)) + '/kg';
        }
        return '$' + new Intl.NumberFormat('es-CL').format(Math.round(cost));
      };
      
      // Funci√≥n para determinar prioridad REAL basada en stock y costo
      const getPriority = (item) => {
        // üî¥ CR√çTICO: Stock = 0 o muy bajo (menos del 10% de lo necesario)
        if (item.current_stock === 0 || item.current_stock < (item.needed * 0.1)) {
          return { icon: 'üî¥', label: 'CR√çTICO', color: '#fef2f2' };
        }
        // üü° URGENTE: Stock < 50% de lo necesario
        if (item.current_stock < (item.needed * 0.5)) {
          return { icon: 'üü°', label: 'URGENTE', color: '#fefce8' };
        }
        // üü¢ NORMAL: Stock >= 50% pero insuficiente
        return { icon: 'üü¢', label: 'NORMAL', color: '' };
      };
      
      tbody.innerHTML = purchaseList.map((item, index) => {
        const priority = getPriority(item);
        
        return `
          <tr style="${priority.color ? 'background: ' + priority.color + ';' : ''}">
            <td>
              <div style="font-weight: 600;">${priority.icon} ${item.ingredient_name}</div>
              ${item.products_using && item.products_using.length > 0 ? `
              <div style="font-size: 11px; color: #666; margin-top: 4px;">
                Usado en: ${item.products_using.slice(0, 3).map(p => p.product).join(', ')}${item.products_using.length > 3 ? '...' : ''}
              </div>` : ''}
            </td>
            <td style="text-align: center; color: ${item.current_stock < item.needed ? '#ef4444' : '#22c55e'};">${formatQuantity(item.current_stock, item.unit)}</td>
            <td style="text-align: center; font-weight: 600;">${formatQuantity(item.needed, item.unit)}</td>
            <td style="text-align: center; font-weight: 700; color: #0a0a0a; font-size: 16px;">${formatQuantity(item.to_buy, item.unit)}</td>
            <td style="text-align: center;">${formatUnitCost(item.cost_per_unit, item.unit)}</td>
            <td style="text-align: center; font-weight: 600; color: #059669;">$${new Intl.NumberFormat('es-CL').format(Math.round(item.total_cost))}</td>
          </tr>
        `;
      }).join('');
    };
    
    window.updateForecastTable = function(forecast) {
      const tbody = document.querySelector('#forecastTable tbody');
      if (!tbody) return;
      
      if (forecast.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: #666;">No hay datos de ventas para generar forecast</td></tr>';
        return;
      }
      
      tbody.innerHTML = forecast.map(item => `
        <tr>
          <td><strong>${item.product_name}</strong></td>
          <td style="text-align: center; color: #666;">${item.avg_daily} unidades/d√≠a</td>
          <td style="text-align: center; font-weight: 600; color: #0a0a0a;">${item.forecast_qty} unidades</td>
        </tr>
      `).join('');
    };
    
    // Control Ventas
    let currentPeriod = 'day';
    
    window.changePeriod = function(period) {
      currentPeriod = period;
      document.querySelectorAll('[id^="period-"]').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
        btn.style.background = '#f5f5f5';
        btn.style.color = '#0a0a0a';
      });
      const activeBtn = document.getElementById(`period-${period}`);
      if (activeBtn) {
        activeBtn.classList.remove('btn-secondary');
        activeBtn.classList.add('btn-primary');
        activeBtn.style.background = '#0a0a0a';
        activeBtn.style.color = 'white';
      }
      loadSalesAnalytics();
    };
    
    window.loadSalesAnalytics = function() {
      console.log('üöÄ loadSalesAnalytics() ejecut√°ndose con per√≠odo:', currentPeriod);
      fetch(`/api/get_sales_analytics.php?period=${currentPeriod}&t=${Date.now()}`)
        .then(r => r.json())
        .then(data => {
          console.log('üìä Sales Analytics Data:', data);
          if (data.success) {
            const products = data.data.products || [];
            const topProducts = data.data.top_products || [];
            const period = data.data.period;
            
            // Actualizar 4 tarjetas KPI resumen
            if (data.data.summary_kpis) {
              const kpis = data.data.summary_kpis;
              console.log('üîç KPIs Control Ventas:', kpis);
              document.getElementById('summary-total-orders').textContent = kpis.total_orders || 0;
              document.getElementById('summary-total-revenue').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(kpis.total_revenue || 0));
              document.getElementById('summary-total-profit').textContent = '$' + new Intl.NumberFormat('es-CL').format(Math.round(kpis.total_profit || 0));
              document.getElementById('summary-margin-label').textContent = 'Utilidad (' + (kpis.avg_margin || 0) + '%)';
              document.getElementById('summary-avg-ticket').textContent = '$' + new Intl.NumberFormat('es-CL').format(kpis.avg_ticket || 0);
              
              // Mostrar delivery como descuento
              const deliverySpan = document.getElementById('summary-delivery-discount');
              if (kpis.total_delivery && kpis.total_delivery > 0) {
                deliverySpan.textContent = '(-$' + new Intl.NumberFormat('es-CL').format(Math.round(kpis.total_delivery)) + ' delivery)';
              } else {
                deliverySpan.textContent = '';
              }
            }
            
            // Actualizar 4 tarjetas KPI detalle
            const totalSold = products.reduce((sum, p) => sum + parseInt(p.total_quantity), 0);
            const totalSoldEl = document.getElementById('total-products-sold');
            totalSoldEl.textContent = totalSold;
            
            // Agregar badge para per√≠odo 'all' y 'month'
            const statLabel = totalSoldEl.nextElementSibling;
            if (currentPeriod === 'all' || currentPeriod === 'month') {
              statLabel.innerHTML = 'Productos Vendidos <span style="display: inline-block; margin-left: 8px; padding: 2px 8px; background: #fef3c7; color: #92400e; border-radius: 12px; font-size: 10px; font-weight: 600;">~40% fuera del sistema</span>';
            } else {
              statLabel.textContent = 'Productos Vendidos';
            }
            
            if (topProducts.length > 0) {
              document.getElementById('top-product-name').textContent = topProducts[0].product_name;
              document.getElementById('top-product-quantity').textContent = topProducts[0].total_quantity + ' unidades vendidas';
              // Calcular promedio del TOTAL, no suma de promedios individuales
              const daysInPeriod = period.days || 1;
              const avgDay = totalSold / daysInPeriod;
              const avgWeek = avgDay * 7;
              document.getElementById('avg-per-day').textContent = Math.round(avgDay);
              document.getElementById('avg-per-week').textContent = Math.round(avgWeek);
            }
            
            // Crear gr√°fico
            createTopProductsChart(topProducts);
            
            // Actualizar iconos Lucide
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 100);
            
            // Actualizar tabla
            updateProductsTable(products, period.days);
          }
        })
        .catch(error => {
          console.error('Error loading sales analytics:', error);
        });
    };
    

    
    window.createTopProductsChart = function(topProducts) {
      if (charts.topProducts) charts.topProducts.destroy();
      
      const ctx = document.getElementById('topProductsChart');
      if (!ctx) {
        console.warn('Canvas topProductsChart no encontrado');
        return;
      }
      
      charts.topProducts = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topProducts.map(p => p.product_name.length > 20 ? p.product_name.substring(0, 20) + '...' : p.product_name),
          datasets: [
            {
              label: 'Utilidad ($)',
              data: topProducts.map(p => {
                const cost = parseFloat(p.total_cost || 0);
                const revenue = parseFloat(p.total_revenue || 0);
                return Math.round(revenue - cost);
              }),
              type: 'line',
              borderColor: '#059669',
              backgroundColor: 'rgba(5, 150, 105, 0.1)',
              borderWidth: 4,
              pointRadius: 6,
              pointBackgroundColor: '#059669',
              pointBorderColor: '#10b981',
              pointBorderWidth: 2,
              yAxisID: 'y1',
              tension: 0.3,
              order: 1
            },
            {
              label: 'Cantidad Vendida',
              data: topProducts.map(p => parseInt(p.total_quantity)),
              backgroundColor: 'rgba(250, 204, 21, 0.3)',
              borderColor: '#facc15',
              borderWidth: 2,
              borderRadius: 6,
              yAxisID: 'y',
              order: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const product = topProducts[context.dataIndex];
                  const cost = parseFloat(product.total_cost || 0);
                  const revenue = parseFloat(product.total_revenue || 0);
                  const profit = revenue - cost;
                  const marginPercent = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;
                  
                  if (context.dataset.label === 'Cantidad Vendida') {
                    return 'Vendidos: ' + context.parsed.y + ' unidades';
                  } else {
                    return [
                      'Utilidad: $' + new Intl.NumberFormat('es-CL').format(Math.round(profit)),
                      'Margen: ' + marginPercent + '%'
                    ];
                  }
                }
              }
            }
          },
          scales: { 
            y: { 
              type: 'linear',
              display: true,
              position: 'left',
              beginAtZero: true,
              ticks: { precision: 0 },
              title: {
                display: true,
                text: 'Cantidad'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              beginAtZero: true,
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                callback: function(value) {
                  return '$' + new Intl.NumberFormat('es-CL', { notation: 'compact' }).format(value);
                }
              },
              title: {
                display: true,
                text: 'Utilidad ($)'
              }
            }
          }
        }
      });
    };
    
    window.updateProductsTable = function(products, days) {
      const tbody = document.querySelector('#productsAnalyticsTable tbody');
      if (!tbody) return;
      
      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #666;">No hay datos para este per√≠odo</td></tr>';
        return;
      }
      
      tbody.innerHTML = products.map(p => {
        const avgMonth = parseFloat(p.avg_per_week) * 4;
        const cost = parseFloat(p.total_cost || 0);
        const revenue = parseFloat(p.total_revenue || 0);
        const profit = revenue - cost;
        const marginPercent = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : 0;
        const marginColor = marginPercent >= 50 ? '#059669' : marginPercent >= 30 ? '#f59e0b' : '#dc2626';
        
        return `
          <tr>
            <td><strong>${p.product_name}</strong></td>
            <td style="text-align: center; font-weight: 600; color: #0a0a0a;">${p.total_quantity}</td>
            <td style="text-align: center; color: #666;">${p.avg_per_day}</td>
            <td style="text-align: center; color: #666;">${p.avg_per_week}</td>
            <td style="text-align: center; color: #666;">${avgMonth.toFixed(2)}</td>
            <td style="text-align: center; color: #3b82f6;">${p.order_count}</td>
            <td style="text-align: center; font-weight: 600; color: #059669;">$${new Intl.NumberFormat('es-CL').format(revenue)}</td>
            <td style="text-align: center; font-weight: 600; color: ${marginColor};">${marginPercent}%</td>
            <td style="text-align: center; font-weight: 600; color: ${marginColor};">$${new Intl.NumberFormat('es-CL').format(Math.round(profit))}</td>
          </tr>
        `;
      }).join('');
    };
    
    // Inicializar despu√©s de cargar
    fetch('/api/check_admin_auth.php')
      .then(r => r.json())
      .then(data => {
        if (!data.authenticated) window.location.href = '/admin/login';
        const usernameEl = document.getElementById('username');
        if (usernameEl) usernameEl.textContent = data.user;
        showView('dashboard');
        
      });
  </script>
</body>
</html>

    window.loadReportes = function() {
      // El iframe ya carga autom√°ticamente
    };
