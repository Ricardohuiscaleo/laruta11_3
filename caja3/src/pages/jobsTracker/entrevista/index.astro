---
export const prerender = false;
---

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrevista - La Ruta 11</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">

<header class="bg-white shadow p-4">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button onclick="history.back()" class="p-2 hover:bg-gray-100 rounded">â†</button>
            <h1 class="text-xl font-bold">Entrevista</h1>
        </div>
        <div id="candidate-header" class="text-right text-sm"></div>
    </div>
    <div id="candidate-details" class="mt-4 p-4 bg-gray-50 rounded hidden">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div id="process-status"></div>
        </div>
    </div>
</header>

<main class="container mx-auto p-4 max-w-4xl">
    
    <div id="loading" class="text-center py-8">
        <p>Cargando entrevista...</p>
    </div>

    <div id="interview-form" class="hidden">
        
        <!-- Preguntas SÃ­/No -->
        <div class="bg-white rounded shadow p-4 mb-4">
            <h3 class="font-semibold mb-4">Preguntas SÃ­/No</h3>
            <div id="yesno-questions" class="space-y-4"></div>
        </div>

        <!-- Preguntas Abiertas -->
        <div class="bg-white rounded shadow p-4 mb-4">
            <h3 class="font-semibold mb-4">Preguntas Abiertas</h3>
            <div id="open-questions" class="space-y-4"></div>
        </div>

        <!-- Notas -->
        <div class="bg-white rounded shadow p-4 mb-4">
            <h3 class="font-semibold mb-4">Notas Adicionales</h3>
            <textarea id="notes" rows="4" class="w-full border rounded px-3 py-2" placeholder="Observaciones generales..."></textarea>
        </div>

        <!-- Botones -->
        <div class="flex gap-3">
            <button onclick="guardar()" class="bg-green-600 text-white px-6 py-2 rounded">
                Guardar Entrevista
            </button>
            <button onclick="history.back()" class="bg-gray-300 px-6 py-2 rounded">
                Cancelar
            </button>
        </div>
    </div>
</main>

<script is:inline>
let candidateId = null;
let questions = [];
let answers = { yesno: {}, open: {} };

function init() {
    const params = new URLSearchParams(window.location.search);
    candidateId = params.get('id') || params.get('candidate_id');
    
    if (!candidateId) {
        // Mostrar selector de candidato
        mostrarSelectorCandidato();
        return;
    }
    
    cargarEntrevista();
}

function mostrarSelectorCandidato() {
    document.getElementById('loading').innerHTML = `
        <div class="bg-white rounded shadow p-6">
            <h3 class="font-semibold mb-4">Seleccionar Candidato</h3>
            <div class="flex gap-3">
                <input type="number" id="candidate-input" placeholder="ID del candidato" class="border rounded px-3 py-2">
                <button onclick="seleccionarCandidato()" class="bg-blue-600 text-white px-4 py-2 rounded">Continuar</button>
            </div>
        </div>
    `;
}

function seleccionarCandidato() {
    const input = document.getElementById('candidate-input');
    candidateId = input.value.trim();
    
    if (!candidateId) {
        alert('Ingrese un ID de candidato');
        return;
    }
    
    document.getElementById('loading').innerHTML = '<p>Cargando entrevista...</p>';
    cargarEntrevista();
}

function cargarEntrevista() {
    fetch('/api/tracker/interview.php?candidate_id=' + candidateId)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.data) {
                const { candidate, interview, questions: loadedQuestions, yes_no_answers, open_answers } = data.data;
                
                // Mostrar header del candidato
                const flagEmoji = candidate.nacionalidad === 'chile' ? 'ğŸ‡¨ğŸ‡±' : 'ğŸ‡µğŸ‡ª';
                const instagramLink = candidate.instagram ? 
                    `<a href="https://instagram.com/${candidate.instagram.replace('@', '')}" target="_blank" class="text-pink-600 hover:text-pink-800">ğŸ“· @${candidate.instagram.replace('@', '')}</a>` : '';
                const phoneLink = candidate.telefono ? 
                    `<a href="tel:${candidate.telefono}" class="text-green-600 hover:text-green-800 font-bold">ğŸ“ ${candidate.telefono}</a>` : '';
                
                document.getElementById('candidate-header').innerHTML = `
                    <div class="font-semibold">${candidate.nombre}</div>
                    <div class="text-gray-600">
                        ${flagEmoji} ${candidate.position} | 
                        ${candidate.score || 0}% | 
                        ${candidate.attempts || 1} intento${candidate.attempts > 1 ? 's' : ''} | 
                        ${candidate.status || 'draft'} | 
                        ${new Date(candidate.created_at).toLocaleDateString('es-ES')}
                    </div>
                    <div class="flex gap-4 mt-2">
                        ${phoneLink}
                        ${instagramLink}
                    </div>
                `;
                
                // Mostrar detalles del proceso
                const interviewProgress = calculateProgress(yes_no_answers, open_answers, loadedQuestions);
                const emailLink = candidate.email ? 
                    `<a href="mailto:${candidate.email}" class="text-blue-600 hover:text-blue-800">ğŸ“§ ${candidate.email}</a>` : candidate.email || 'No disponible';
                
                document.getElementById('candidate-details').innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm">
                        <div><strong>PosiciÃ³n:</strong><br>${candidate.position}</div>
                        <div><strong>Estado:</strong><br>${getStatusIcon(candidate.status)} ${candidate.status}</div>
                        <div><strong>Fecha:</strong><br>${new Date(candidate.created_at).toLocaleDateString('es-ES')}</div>
                        <div><strong>Progreso:</strong><br>${candidate.score || interviewProgress}%</div>
                        <div><strong>Intentos:</strong><br>${candidate.attempts || 1} intento${candidate.attempts > 1 ? 's' : ''}</div>
                        <div><strong>Estado del proceso:</strong><br>
                            ğŸ“ ğŸ‘ï¸ ğŸ—£ï¸ ${candidate.status === 'completed' ? 'âœ…' : 'âŒ'}
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div><strong>Email:</strong><br>${emailLink}</div>
                            <div><strong>TelÃ©fono:</strong><br>${candidate.telefono ? `<a href="tel:${candidate.telefono}" class="text-green-600 hover:text-green-800 font-bold">ğŸ“ ${candidate.telefono}</a>` : 'No disponible'}</div>
                            <div><strong>Instagram:</strong><br>${candidate.instagram ? `<a href="https://instagram.com/${candidate.instagram.replace('@', '')}" target="_blank" class="text-pink-600 hover:text-pink-800">ğŸ“· @${candidate.instagram.replace('@', '')}</a>` : 'No disponible'}</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('candidate-details').classList.remove('hidden');
                
                questions = loadedQuestions || [];
                answers.yesno = yes_no_answers || {};
                answers.open = open_answers || {};
                
                document.getElementById('notes').value = interview.notes || '';
                
                mostrarPreguntas();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('interview-form').classList.remove('hidden');
            } else {
                alert('Error cargando entrevista');
                history.back();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexiÃ³n');
            history.back();
        });
}

function mostrarPreguntas() {
    const yesnoDiv = document.getElementById('yesno-questions');
    const openDiv = document.getElementById('open-questions');
    
    // Preguntas SÃ­/No
    const yesnoQuestions = questions.filter(q => q.question_type === 'yesno');
    yesnoDiv.innerHTML = yesnoQuestions.map(q => `
        <div class="border rounded p-4">
            <p class="mb-3">${q.question_text}</p>
            <div class="flex gap-4">
                <label class="flex items-center">
                    <input type="radio" name="yesno_${q.id}" value="si" ${answers.yesno[q.id] === 'si' ? 'checked' : ''} 
                           onchange="answers.yesno[${q.id}] = 'si'">
                    <span class="ml-2">SÃ­</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="yesno_${q.id}" value="no" ${answers.yesno[q.id] === 'no' ? 'checked' : ''} 
                           onchange="answers.yesno[${q.id}] = 'no'">
                    <span class="ml-2">No</span>
                </label>
            </div>
        </div>
    `).join('');
    
    // Preguntas Abiertas
    const openQuestions = questions.filter(q => q.question_type === 'open');
    openDiv.innerHTML = openQuestions.map(q => `
        <div class="border rounded p-4">
            <p class="mb-3">${q.question_text}</p>
            <textarea rows="3" class="w-full border rounded px-3 py-2" 
                      placeholder="Respuesta del candidato..."
                      onchange="answers.open[${q.id}] = this.value">${answers.open[q.id] || ''}</textarea>
        </div>
    `).join('');
}

function guardar() {
    const notes = document.getElementById('notes').value;
    
    fetch('/api/tracker/interview.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            candidate_id: candidateId,
            yes_no_answers: answers.yesno,
            open_answers: answers.open,
            notes: notes
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Entrevista guardada correctamente');
            history.back();
        } else {
            alert('Error guardando entrevista');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexiÃ³n');
    });
}

function getStatusIcon(status) {
    switch(status) {
        case 'completada': return 'âœ…';
        case 'completed': return 'âœ…';
        case 'pendiente': return 'ğŸ“';
        case 'draft': return 'ğŸ“';
        case 'en_proceso': return 'ğŸ”„';
        case 'in_progress': return 'ğŸ”„';
        default: return 'ğŸ“';
    }
}

function calculateProgress(yesnoAnswers, openAnswers, questions) {
    if (!questions || questions.length === 0) return 0;
    
    let answered = 0;
    questions.forEach(q => {
        if (q.question_type === 'yesno' && yesnoAnswers[q.id]) answered++;
        if (q.question_type === 'open' && openAnswers[q.id] && openAnswers[q.id].trim()) answered++;
    });
    
    return Math.round((answered / questions.length) * 100);
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>