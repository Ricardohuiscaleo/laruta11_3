---
import Layout from '../layouts/Layout.astro';
---

<Layout title="La Ruta11 - Gestor de Im√°genes">
  <div class="min-h-screen bg-white">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-5xl font-bold text-ruta-red mb-2">
          üöö La Ruta<span class="text-yellow-400">11</span>
        </h1>
        <p class="text-xl text-gray-600">Gestor de Im√°genes del Men√∫</p>
        <div class="w-24 h-1 bg-gradient-to-r from-ruta-red to-ruta-orange mx-auto mt-4 rounded-full"></div>
      </div>
      
      <!-- Upload Section -->
      <div class="bg-white border-2 border-gray-100 rounded-2xl shadow-lg p-8 mb-8">
        <div class="flex items-center mb-6">
          <div class="bg-gradient-to-r from-ruta-red to-ruta-orange p-3 rounded-xl mr-4">
            <span class="text-2xl">üì∏</span>
          </div>
          <h2 class="text-3xl font-bold text-gray-800">Subir Nuevas Im√°genes</h2>
        </div>
        <form id="uploadForm" enctype="multipart/form-data" class="space-y-6">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-gray-700 font-semibold mb-3 text-lg">üìù Nombre personalizado (opcional)</label>
              <input 
                type="text" 
                id="customName" 
                name="custom_name" 
                placeholder="ej: hamburguesa-especial"
                class="w-full p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-800 placeholder-gray-500 focus:border-ruta-red focus:bg-white focus:outline-none transition-all duration-200"
              />
              <p class="text-gray-500 text-sm mt-2">üí° Se numerar√° autom√°ticamente si subes varias</p>
            </div>
            <div>
              <label class="block text-gray-700 font-semibold mb-3 text-lg">üñºÔ∏è Seleccionar im√°genes</label>
              <input 
                type="file" 
                id="imageFile" 
                name="images[]" 
                accept="image/*" 
                multiple
                required
                class="w-full p-4 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-gray-800 hover:border-ruta-red hover:bg-gray-100 transition-all duration-200 cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-ruta-red file:text-white file:font-semibold file:cursor-pointer hover:file:bg-ruta-orange"
              />
              <p class="text-gray-500 text-sm mt-2">üí° Ctrl/Cmd + click para m√∫ltiples archivos</p>
            </div>
          </div>
          <div class="bg-gray-50 rounded-xl p-4">
            <label class="flex items-center cursor-pointer">
              <input 
                type="checkbox" 
                id="compressImages" 
                checked
                class="w-5 h-5 text-ruta-red bg-gray-100 border-gray-300 rounded focus:ring-ruta-red focus:ring-2 cursor-pointer"
              />
              <div class="ml-3">
                <span class="text-gray-700 font-semibold">üóÉÔ∏è Comprimir im√°genes autom√°ticamente</span>
                <p class="text-sm text-gray-500">Reduce el tama√±o de archivos grandes (>500KB) manteniendo buena calidad</p>
              </div>
            </label>
          </div>
          <button 
            type="submit" 
            class="w-full bg-gradient-to-r from-ruta-red to-ruta-orange text-white font-bold py-4 px-8 rounded-xl hover:from-ruta-orange hover:to-ruta-red transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg cursor-pointer"
          >
            üöÄ SUBIR IM√ÅGENES
          </button>
        </form>
        <div id="uploadResult" class="mt-6"></div>
      </div>
      
      <!-- Config Test Section -->
      <div class="bg-white border-2 border-gray-100 rounded-2xl shadow-lg p-8 mb-8">
        <div class="flex items-center mb-6">
          <div class="bg-gradient-to-r from-green-500 to-green-600 p-3 rounded-xl mr-4">
            <span class="text-2xl">‚öôÔ∏è</span>
          </div>
          <h2 class="text-3xl font-bold text-gray-800">Test de Configuraci√≥n</h2>
        </div>
        <div class="grid md:grid-cols-3 gap-4 mb-6">
          <button 
            id="testConfigBtn"
            class="bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 px-6 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg cursor-pointer"
          >
            üîç TEST CONFIG
          </button>
          <button 
            id="testS3Btn"
            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 px-6 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg cursor-pointer"
          >
            ‚òÅÔ∏è TEST S3
          </button>
          <button 
            id="testAwsBtn"
            class="bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-4 px-6 rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg cursor-pointer"
          >
            üîß DEBUG AWS
          </button>
        </div>
        <div id="configTestResult" class="hidden"></div>
      </div>

      <!-- URLs Section -->
      <div class="bg-white border-2 border-gray-100 rounded-2xl shadow-lg p-8 mb-8">
        <div class="flex items-center mb-6">
          <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-3 rounded-xl mr-4">
            <span class="text-2xl">üîó</span>
          </div>
          <h2 class="text-3xl font-bold text-gray-800">URLs de Im√°genes</h2>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <button 
            id="getUrlsBtn"
            class="bg-gradient-to-r from-purple-500 to-purple-600 text-white font-bold py-4 px-8 rounded-xl hover:from-purple-600 hover:to-purple-700 transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg cursor-pointer"
          >
            üìù OBTENER TODAS LAS URLS
          </button>
          <button 
            id="copyAllUrlsBtn"
            class="bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 px-8 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg cursor-pointer"
            disabled
          >
            üìã COPIAR TODAS
          </button>
        </div>
        <div id="urlsResult" class="hidden"></div>
      </div>

      <!-- Gallery Section -->
      <div class="bg-white border-2 border-gray-100 rounded-2xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-8">
          <div class="flex items-center">
            <div class="bg-gradient-to-r from-ruta-red to-ruta-orange p-3 rounded-xl mr-4">
              <span class="text-2xl">üñºÔ∏è</span>
            </div>
            <h2 class="text-3xl font-bold text-gray-800">Galer√≠a de Im√°genes</h2>
          </div>
          <button 
            id="refreshBtn"
            class="bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-3 rounded-xl hover:from-gray-700 hover:to-gray-800 transition-all duration-200 transform hover:scale-105 cursor-pointer font-semibold"
          >
            üîÑ Actualizar
          </button>
        </div>
        <div id="galleryContent" class="text-center py-12 text-gray-500">
          <div class="animate-pulse">
            <div class="text-4xl mb-4">‚è≥</div>
            <div class="text-lg">Cargando im√°genes...</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal -->
  <div id="imageModal" class="fixed inset-0 bg-black/80 z-50 items-center justify-center p-4" style="display: none;">
    <div class="bg-white rounded-2xl max-w-4xl max-h-[90vh] overflow-auto shadow-2xl">
      <div class="p-8">
        <div class="flex justify-between items-center mb-6">
          <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
          <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-bold cursor-pointer transition-colors duration-200">&times;</button>
        </div>
        <img id="modalImage" src="" alt="" class="w-full h-auto rounded-xl mb-6 shadow-lg" />
        <div id="modalInfo" class="text-gray-600 bg-gray-50 p-4 rounded-xl"></div>
      </div>
    </div>
  </div>

  <script is:inline>
    // @ts-nocheck
    const API_URL = '/api/s3-manager.php';
    
    function addEventListeners() {
      document.querySelectorAll('.copy-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          copyUrl(btn.dataset.url);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          deleteImage(btn.dataset.key);
        });
      });
      
      document.querySelectorAll('.rename-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          renameImage(btn.dataset.key, btn.dataset.name);
        });
      });
      
      document.querySelectorAll('.modal-trigger').forEach(function(img) {
        img.addEventListener('click', function() {
          showModal(img.dataset.url, img.dataset.name, formatBytes(parseInt(img.dataset.size)), formatDate(img.dataset.modified));
        });
      });
    }
    
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const fileInput = document.getElementById('imageFile');
      const files = fileInput.files;
      const customName = document.getElementById('customName').value;
      const resultDiv = document.getElementById('uploadResult');
      
      if (files.length === 0) {
        resultDiv.innerHTML = '<div class="bg-red-100 text-red-800 p-3 rounded-lg">‚ùå Selecciona al menos una imagen</div>';
        return;
      }
      
      resultDiv.innerHTML = '<div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6"><div class="flex items-center mb-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div><h3 class="text-lg font-semibold text-blue-800">Subiendo ' + files.length + ' imagen(es)</h3></div><div class="space-y-3" id="uploadProgress"></div><div class="mt-4 bg-blue-200 rounded-full h-3"><div id="progressBar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div></div><div id="progressText" class="text-sm text-blue-600 mt-2 font-medium">Preparando subida...</div></div>';
      
      const progressContainer = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      let successCount = 0;
      let errorCount = 0;
      let totalBytes = 0;
      let uploadedBytes = 0;
      
      for (let i = 0; i < files.length; i++) {
        totalBytes += files[i].size;
      }
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileSize = formatBytes(file.size);
        
        const fileDiv = document.createElement('div');
        fileDiv.id = 'file-' + i;
        fileDiv.className = 'flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200';
        fileDiv.innerHTML = '<div class="flex items-center"><div class="animate-pulse w-4 h-4 bg-blue-400 rounded-full mr-3"></div><span class="font-medium text-gray-700">' + file.name + '</span><span class="text-sm text-gray-500 ml-2">(' + fileSize + ')</span></div><span class="text-blue-600 font-medium">Subiendo...</span>';
        progressContainer.appendChild(fileDiv);
        
        const progress = ((i) / files.length) * 100;
        progressBar.style.width = progress + '%';
        progressText.textContent = 'Subiendo ' + file.name + ' (' + (i + 1) + '/' + files.length + ')';
        
        const formData = new FormData();
        formData.append('action', 'upload');
        formData.append('image', file);
        
        const compressCheckbox = document.getElementById('compressImages');
        if (!compressCheckbox.checked || file.size > 8388608) {
          formData.append('no_compress', 'true');
        }
        
        if (customName && files.length === 1) {
          formData.append('custom_name', customName);
        } else if (customName && files.length > 1) {
          const ext = file.name.split('.').pop();
          formData.append('custom_name', customName + '-' + (i + 1) + '.' + ext);
        }
        
        try {
          const response = await fetch(API_URL, {
            method: 'POST',
            body: formData
          });
          
          const responseText = await response.text();
          let data;
          
          try {
            data = JSON.parse(responseText);
          } catch (e) {
            errorCount++;
            fileDiv.innerHTML = '<div class="flex items-center"><div class="w-4 h-4 bg-red-500 rounded-full mr-3"></div><span class="font-medium text-gray-700">' + file.name + '</span><span class="text-sm text-gray-500 ml-2">(' + fileSize + ')</span></div><span class="text-red-600 font-medium">‚ùå Error de formato</span>';
            continue;
          }
          
          if (data.success) {
            successCount++;
            uploadedBytes += file.size;
            const compressionInfo = data.data && data.data.compression_ratio > 0 ? ' üóÉÔ∏è -' + data.data.compression_ratio + '%' : '';
            fileDiv.innerHTML = '<div class="flex items-center"><div class="w-4 h-4 bg-green-500 rounded-full mr-3"></div><span class="font-medium text-gray-700">' + file.name + '</span><span class="text-sm text-gray-500 ml-2">(' + fileSize + compressionInfo + ')</span></div><span class="text-green-600 font-medium">‚úÖ ' + (data.message || 'Subida exitosa') + '</span>';
          } else {
            errorCount++;
            fileDiv.innerHTML = '<div class="flex items-center"><div class="w-4 h-4 bg-red-500 rounded-full mr-3"></div><span class="font-medium text-gray-700">' + file.name + '</span><span class="text-sm text-gray-500 ml-2">(' + fileSize + ')</span></div><span class="text-red-600 font-medium">‚ùå ' + (data.error || 'Error desconocido') + '</span>';
          }
        } catch (error) {
          errorCount++;
          fileDiv.innerHTML = '<div class="flex items-center"><div class="w-4 h-4 bg-red-500 rounded-full mr-3"></div><span class="font-medium text-gray-700">' + file.name + '</span><span class="text-sm text-gray-500 ml-2">(' + fileSize + ')</span></div><span class="text-red-600 font-medium">‚ùå Error de conexi√≥n</span>';
        }
      }
      
      progressBar.style.width = '100%';
      const uploadedSize = formatBytes(uploadedBytes);
      const totalSize = formatBytes(totalBytes);
      
      progressText.innerHTML = '<div class="flex justify-between items-center"><span>üèÅ Completado: ' + successCount + ' exitosas, ' + errorCount + ' errores</span><span>üíæ ' + uploadedSize + ' de ' + totalSize + ' subidos</span></div>';
      
      if (successCount > 0) {
        setTimeout(function() {
          e.target.reset();
          loadGallery();
        }, 1500);
      }
    });
    
    async function loadGallery() {
      const galleryContent = document.getElementById('galleryContent');
      galleryContent.innerHTML = '<div class="text-center py-8 text-gray-500">üîÑ Cargando im√°genes...</div>';
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=list'
        });
        
        const data = await response.json();
        
        if (data.success && data.images && data.images.length > 0) {
          let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">';
          for (let i = 0; i < data.images.length; i++) {
            const img = data.images[i];
            html += '<div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden hover:shadow-xl hover:border-ruta-red/20 transition-all duration-300 transform hover:scale-[1.02]"><div class="relative overflow-hidden"><img src="' + img.url + '" alt="' + img.name + '" class="w-full h-56 object-cover cursor-pointer hover:scale-110 transition-transform duration-300 modal-trigger" data-url="' + img.url + '" data-name="' + img.name + '" data-size="' + img.size + '" data-modified="' + img.modified + '"/></div><div class="p-6"><h3 class="font-bold text-gray-800 mb-2 truncate text-lg">' + img.name + '</h3><p class="text-sm text-gray-500 mb-4 bg-gray-50 px-3 py-2 rounded-lg">üìä ' + formatBytes(img.size) + ' ‚Ä¢ üìÖ ' + formatDate(img.modified) + '</p><div class="flex gap-2"><button data-url="' + img.url + '" class="copy-btn flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-2 rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-200 cursor-pointer">üìã</button><button data-key="' + img.key + '" data-name="' + img.name + '" class="rename-btn flex-1 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white px-3 py-2 rounded-lg text-xs font-semibold hover:from-yellow-600 hover:to-yellow-700 transition-all duration-200 cursor-pointer">‚úèÔ∏è</button><button data-key="' + img.key + '" class="delete-btn flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-2 rounded-lg text-xs font-semibold hover:from-red-600 hover:to-red-700 transition-all duration-200 cursor-pointer">üóëÔ∏è</button></div></div></div>';
          }
          html += '</div>';
          galleryContent.innerHTML = html;
          addEventListeners();
        } else {
          galleryContent.innerHTML = '<div class="text-center py-16"><div class="text-6xl mb-4">üì∑</div><h3 class="text-2xl font-bold text-gray-600 mb-2">No hay im√°genes a√∫n</h3><p class="text-gray-500 text-lg">¬°Sube la primera imagen usando el formulario de arriba!</p></div>';
        }
      } catch (error) {
        console.error('Gallery load error:', error);
        galleryContent.innerHTML = '<div class="text-center py-16"><div class="text-6xl mb-4">‚ö†Ô∏è</div><h3 class="text-2xl font-bold text-red-600 mb-2">Error al cargar im√°genes</h3><p class="text-red-500 mb-4">Error: ' + error.message + '</p><button onclick="testS3Connection()" class="mr-2 bg-blue-500 text-white px-4 py-2 rounded-xl hover:bg-blue-600 transition-colors cursor-pointer">üîç Test S3</button><button onclick="loadGallery()" class="bg-red-500 text-white px-4 py-2 rounded-xl hover:bg-red-600 transition-colors cursor-pointer">üîÑ Reintentar</button></div>';
      }
    }
    
    async function deleteImage(key) {
      if (!confirm('¬øEst√°s seguro de que quieres eliminar esta imagen?')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=delete&key=' + encodeURIComponent(key)
        });
        
        const data = await response.json();
        if (data.success) loadGallery();
      } catch (error) {
        alert('Error de conexi√≥n');
      }
    }
    
    async function renameImage(key, currentName) {
      const newName = prompt('Nuevo nombre para la imagen:', currentName.replace(/\.[^/.]+$/, ''));
      if (!newName || newName === currentName.replace(/\.[^/.]+$/, '')) return;
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=rename&old_key=' + encodeURIComponent(key) + '&new_name=' + encodeURIComponent(newName)
        });
        
        const data = await response.json();
        if (data.success) {
          alert('‚úÖ Imagen renombrada exitosamente');
          loadGallery();
        } else {
          alert('‚ùå Error: ' + data.error);
        }
      } catch (error) {
        alert('‚ùå Error de conexi√≥n');
      }
    }
    
    function copyUrl(url) {
      navigator.clipboard.writeText(url).then(function() {
        alert('‚úÖ URL copiada al portapapeles');
      });
    }
    
    function showModal(url, name, size, date) {
      const modalImage = document.getElementById('modalImage');
      const modalTitle = document.getElementById('modalTitle');
      const modalInfo = document.getElementById('modalInfo');
      const imageModal = document.getElementById('imageModal');
      
      modalImage.src = url;
      modalTitle.textContent = name;
      modalInfo.innerHTML = '<p><strong>Tama√±o:</strong> ' + size + '</p><p><strong>Fecha:</strong> ' + date + '</p><p><strong>URL:</strong> <a href="' + url + '" target="_blank" class="text-blue-600 hover:underline">' + url + '</a></p>';
      imageModal.style.display = 'flex';
    }
    
    function closeModal() {
      const imageModal = document.getElementById('imageModal');
      imageModal.style.display = 'none';
    }
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    document.getElementById('imageModal').addEventListener('click', function(e) {
      if (e.target.id === 'imageModal') {
        closeModal();
      }
    });
    

    
    async function testS3Connection() {
      const resultDiv = document.getElementById('configTestResult');
      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-xl p-6"><div class="flex items-center mb-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div><h3 class="text-lg font-semibold text-blue-800">Probando conexi√≥n AWS S3...</h3></div></div>';
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=list'
        });
        
        const data = await response.json();
        
        if (data.success) {
          resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 rounded-xl p-6"><h3 class="text-lg font-semibold text-green-800 mb-2">‚úÖ AWS S3 Conectado</h3><p class="text-green-600">Conexi√≥n exitosa. Im√°genes encontradas: ' + (data.images ? data.images.length : 0) + '</p></div>';
        } else {
          resultDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-xl p-6"><h3 class="text-lg font-semibold text-red-800 mb-2">‚ùå Error en AWS S3</h3><p class="text-red-600">' + (data.error || 'Error desconocido') + '</p></div>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-xl p-6"><h3 class="text-lg font-semibold text-red-800 mb-2">‚ùå Error de conexi√≥n</h3><p class="text-red-600">' + error.message + '</p></div>';
      }
    }
    

    
    async function testConfig() {
      const resultDiv = document.getElementById('configTestResult');
      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-xl p-6"><div class="flex items-center mb-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div><h3 class="text-lg font-semibold text-blue-800">Probando configuraci√≥n...</h3></div></div>';
      
      try {
        const response = await fetch('/api/config-test.php');
        const data = await response.json();
        
        let html = '<div class="bg-white border border-gray-200 rounded-xl p-6"><h3 class="text-xl font-bold text-gray-800 mb-4">üìä Resultados del Test</h3><div class="grid gap-4">';
        
        Object.entries(data).forEach(([key, value]) => {
          const isOk = value === 'OK';
          const isDefault = (key === 'aws_region' && value === 'us-east-1') || (key === 's3_bucket' && value === 'laruta11-images');
          const isMissing = value === 'MISSING' || value === '';
          
          let icon, colorClass;
          if (isOk || isDefault) {
            icon = '‚úÖ';
            colorClass = 'text-green-600 bg-green-50 border-green-200';
          } else if (isMissing) {
            icon = '‚ùå';
            colorClass = 'text-red-600 bg-red-50 border-red-200';
          } else {
            icon = '‚ö†Ô∏è';
            colorClass = 'text-yellow-600 bg-yellow-50 border-yellow-200';
          }
          
          const displayValue = isDefault ? `${value} (por defecto)` : value;
          html += `<div class="flex items-center justify-between p-3 rounded-lg border ${colorClass}"><span class="font-medium">${icon} ${key.replace('_', ' ').toUpperCase()}</span><span class="text-sm">${displayValue}</span></div>`;
        });
        
        html += '</div></div>';
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-xl p-6"><h3 class="text-lg font-semibold text-red-800 mb-2">‚ùå Error en el test</h3><p class="text-red-600">' + error.message + '</p></div>';
      }
    }
    
    async function testAwsDetailed() {
      const resultDiv = document.getElementById('configTestResult');
      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = '<div class="bg-orange-50 border border-orange-200 rounded-xl p-6"><div class="flex items-center mb-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-orange-600 mr-3"></div><h3 class="text-lg font-semibold text-orange-800">Diagnosticando AWS...</h3></div></div>';
      
      try {
        const response = await fetch('/api/simple-test.php');
        const data = await response.json();
        
        let html = '<div class="bg-white border border-gray-200 rounded-xl p-6"><h3 class="text-xl font-bold text-gray-800 mb-4">üîß Diagn√≥stico AWS Detallado</h3><div class="grid gap-3">';
        
        Object.entries(data).forEach(([key, value]) => {
          const isOk = value === 'OK' || value.toString().startsWith('OK');
          const isError = value.toString().startsWith('ERROR');
          const isDefault = (key === 'aws_region' && value === 'us-east-1') || (key === 's3_bucket' && value === 'laruta11-images');
          const isConfigPath = key === 'config_path';
          
          let icon, colorClass;
          if (isOk || isDefault) {
            icon = '‚úÖ';
            colorClass = 'text-green-600 bg-green-50 border-green-200';
          } else if (isError) {
            icon = '‚ùå';
            colorClass = 'text-red-600 bg-red-50 border-red-200';
          } else {
            icon = '‚ö†Ô∏è';
            colorClass = 'text-yellow-600 bg-yellow-50 border-yellow-200';
          }
          
          let displayValue = value;
          if (isDefault) {
            displayValue = `${value} (por defecto)`;
          } else if (isConfigPath) {
            displayValue = `${value} (encontrado)`;
          }
          
          html += `<div class="flex items-center justify-between p-3 rounded-lg border ${colorClass}"><span class="font-medium">${icon} ${key.replace('_', ' ').toUpperCase()}</span><span class="text-sm font-mono">${displayValue}</span></div>`;
        });
        
        html += '</div></div>';
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-xl p-6"><h3 class="text-lg font-semibold text-red-800 mb-2">‚ùå Error en diagn√≥stico AWS</h3><p class="text-red-600">' + error.message + '</p></div>';
      }
    }
    
    let allImageUrls = [];
    
    async function getAllUrls() {
      const resultDiv = document.getElementById('urlsResult');
      const copyBtn = document.getElementById('copyAllUrlsBtn');
      
      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 rounded-xl p-6"><div class="flex items-center mb-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div><h3 class="text-lg font-semibold text-blue-800">Obteniendo URLs...</h3></div></div>';
      
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'action=list'
        });
        
        const data = await response.json();
        
        if (data.success && data.images && data.images.length > 0) {
          allImageUrls = data.images.map(img => img.url);
          
          let html = '<div class="bg-white border border-gray-200 rounded-xl p-6">';
          html += '<h3 class="text-xl font-bold text-gray-800 mb-4">üîó ' + allImageUrls.length + ' URLs Encontradas</h3>';
          html += '<div class="bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto">';
          html += '<div class="space-y-2">';
          
          allImageUrls.forEach((url, index) => {
            html += '<div class="flex items-center justify-between p-2 bg-white rounded border">';
            html += '<span class="text-sm font-mono text-gray-600 truncate flex-1 mr-2">' + url + '</span>';
            html += '<button onclick="copyUrl(\'' + url + '\')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 cursor-pointer">üìã</button>';
            html += '</div>';
          });
          
          html += '</div></div>';
          html += '<div class="mt-4 p-4 bg-green-50 rounded-lg">';
          html += '<p class="text-green-700 font-medium">Total: ' + allImageUrls.length + ' im√°genes</p>';
          html += '<p class="text-green-600 text-sm">Usa el bot√≥n "COPIAR TODAS" para copiar todas las URLs al portapapeles</p>';
          html += '</div></div>';
          
          resultDiv.innerHTML = html;
          copyBtn.disabled = false;
          copyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          resultDiv.innerHTML = '<div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6"><h3 class="text-lg font-semibold text-yellow-800 mb-2">‚ö†Ô∏è No hay im√°genes</h3><p class="text-yellow-600">No se encontraron im√°genes en AWS S3</p></div>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-xl p-6"><h3 class="text-lg font-semibold text-red-800 mb-2">‚ùå Error</h3><p class="text-red-600">' + error.message + '</p></div>';
      }
    }
    
    function copyAllUrls() {
      if (allImageUrls.length === 0) {
        alert('‚ùå Primero obt√©n las URLs');
        return;
      }
      
      const urlsText = allImageUrls.join('\n');
      navigator.clipboard.writeText(urlsText).then(function() {
        alert('‚úÖ ' + allImageUrls.length + ' URLs copiadas al portapapeles');
      }).catch(function() {
        // Fallback para navegadores que no soportan clipboard API
        const textArea = document.createElement('textarea');
        textArea.value = urlsText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('‚úÖ ' + allImageUrls.length + ' URLs copiadas al portapapeles');
      });
    }
    
    document.getElementById('getUrlsBtn').addEventListener('click', getAllUrls);
    document.getElementById('copyAllUrlsBtn').addEventListener('click', copyAllUrls);
    document.getElementById('testConfigBtn').addEventListener('click', testConfig);
    document.getElementById('testS3Btn').addEventListener('click', testS3Connection);
    document.getElementById('testAwsBtn').addEventListener('click', testAwsDetailed);
    document.getElementById('refreshBtn').addEventListener('click', loadGallery);
    loadGallery();
  </script>
</Layout>